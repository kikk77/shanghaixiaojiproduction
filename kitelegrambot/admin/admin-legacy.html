<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram营销机器人 - 完整管理后台</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { margin-bottom: 5px; }
        .header p { opacity: 0.9; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: white; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s; font-size: 14px; }
        .tab.active { background: #667eea; color: white; }
        .tab:hover { transform: translateY(-2px); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h3 { margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 10px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; 
            font-size: 14px; transition: border-color 0.3s; 
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
            outline: none; border-color: #667eea; 
        }
        .form-group small { color: #666; font-size: 12px; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; 
                     border: 1px solid #eee; border-radius: 5px; margin-bottom: 10px; }
        .list-item:hover { background: #f9f9f9; }
        .list-item-content { flex: 1; }
        .list-item-actions { display: flex; gap: 5px; }
        
        .badge { background: #e0e0e0; color: #666; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px; }
        .badge.success { background: #4CAF50; color: white; }
        .badge.warning { background: #ff9800; color: white; }
        .badge.info { background: #2196F3; color: white; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .button-builder { border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px; }
        .button-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .button-preview { background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .preview-button { background: #667eea; color: white; padding: 8px 16px; border-radius: 4px; margin: 2px; display: inline-block; }
        
        .template-preview { background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-top: 10px; }
        .template-preview img { max-width: 200px; border-radius: 5px; margin-bottom: 10px; }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .tabs { justify-content: center; }
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🤖 Telegram营销机器人 - 完整管理后台</h1>
        <p>触发词监听 | 定时发送 | 消息模板 | 数据统计</p>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">📊 仪表盘</button>
            <button class="tab" onclick="showTab('bind-codes')">🔑 绑定码管理</button>
            <button class="tab" onclick="showTab('regions')">📍 地区管理</button>
            <button class="tab" onclick="showTab('merchants')">👥 商家管理</button>
            <button class="tab" onclick="showTab('templates')">📝 消息模板</button>
            <button class="tab" onclick="showTab('triggers')">🎯 触发词配置</button>
            <button class="tab" onclick="showTab('tasks')">⏰ 定时任务</button>
            <button class="tab" onclick="showTab('buttons')">🔘 按钮管理</button>
            <button class="tab" onclick="showTab('test')">🧪 测试发送</button>
            <button class="tab" onclick="window.open('admin/orders.html', '_blank')">📈 订单统计</button>
        </div>

        <!-- 仪表盘 -->
        <div id="dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalOrders">0</div>
                    <div>📋 总订单</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bookedOrders">0</div>
                    <div>📅 已预约订单</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="incompleteOrders">0</div>
                    <div>⏳ 待处理订单</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedOrders">0</div>
                    <div>✅ 已完成订单</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgPrice">¥0</div>
                    <div>💰 平均订单价格</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgUserRating">-</div>
                    <div>👤 平均用户评分</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgMerchantRating">-</div>
                    <div>👩‍🏫 平均出击素质</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completionRate">0%</div>
                    <div>📊 完成率</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalMerchants">0</div>
                    <div>👨‍🏫 商家数量</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalBindCodes">0</div>
                    <div>🔑 绑定码总数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRegions">0</div>
                    <div>📍 地区数量</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTemplates">0</div>
                    <div>📝 消息模板</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClicks">0</div>
                    <div>👆 总点击数</div>
                </div>
            </div>
            
            <div class="card">
                <h3>📈 系统状态</h3>
                <div id="systemStatus">
                    <p>✅ 机器人运行正常</p>
                    <p>✅ 数据库连接正常</p>
                    <p>✅ 定时任务调度器运行中</p>
                    <p>✅ 触发词监听已启用</p>
                </div>
            </div>

            <div class="card">
                <h3>👥 商家预约统计</h3>
                <div id="merchantBookingStats">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>加载中...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>📊 消息互动统计</h3>
                <div id="messageStats">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>加载中...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>🕒 最近预约记录</h3>
                <div id="recentBookings">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>加载中...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>🔘 按钮点击统计</h3>
                <div id="buttonStats">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>加载中...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 绑定码管理 -->
        <div id="bind-codes" class="tab-content">
            <div class="card">
                <h3>🔑 生成新绑定码</h3>
                <form onsubmit="createBindCode(event)">
                    <div class="form-group">
                        <label>绑定码描述</label>
                        <input type="text" id="bindCodeDescription" required placeholder="例如：VIP商家专用绑定码">
                        <small>用于标识绑定码的用途</small>
                    </div>
                    <button type="submit" class="btn btn-primary">生成绑定码</button>
                </form>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>📋 绑定码列表</h3>
                    <button class="btn btn-success btn-small" onclick="loadBindCodes(true)">🔄 刷新数据</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-danger" onclick="batchDeleteTestBindCodes()">🗑️ 批量删除测试绑定码</button>
                    <small style="margin-left: 10px; color: #666;">将删除所有描述中包含"测试"的绑定码（包括已使用的）</small>
                </div>
                <div id="bindCodesList"></div>
            </div>
        </div>

        <!-- 地区管理 -->
        <div id="regions" class="tab-content">
            <div class="card">
                <h3>📍 添加新地区</h3>
                <form onsubmit="createRegion(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>地区名称</label>
                            <input type="text" id="regionName" required placeholder="例如：北京">
                        </div>
                        <div class="form-group">
                            <label>排序顺序</label>
                            <input type="number" id="regionSortOrder" value="0" min="0" placeholder="数字越小越靠前">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">添加地区</button>
                </form>
            </div>

            <div class="card">
                <h3>🗺️ 地区列表</h3>
                <div id="regionsList"></div>
            </div>
        </div>

        <!-- 消息模板管理 -->
        <div id="templates" class="tab-content">
            <div class="card">
                <h3>➕ 创建消息模板</h3>
                <form onsubmit="createTemplate(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>模板名称</label>
                            <input type="text" id="templateName" required placeholder="例如：客服联系模板">
                        </div>
                        <div class="form-group">
                            <label>图片URL（可选）</label>
                            <input type="url" id="templateImage" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>消息内容</label>
                        <textarea id="templateContent" rows="4" required placeholder="输入消息内容，支持HTML格式"></textarea>
                        <small>支持HTML格式：&lt;b&gt;粗体&lt;/b&gt; &lt;i&gt;斜体&lt;/i&gt; &lt;code&gt;代码&lt;/code&gt;</small>
                    </div>
                    
                    <div class="button-builder">
                        <label>按钮配置</label>
                        <div id="buttonRows"></div>
                        <button type="button" onclick="addButtonRow()" class="btn btn-success btn-small">+ 添加按钮行</button>
                    </div>
                    
                    <div class="template-preview" id="templatePreview" style="display: none;">
                        <h4>预览效果：</h4>
                        <div id="previewContent"></div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">创建模板</button>
                    <button type="button" onclick="previewTemplate()" class="btn btn-warning">预览效果</button>
                </form>
            </div>

            <div class="card">
                <h3>📋 模板列表</h3>
                <div id="templatesList"></div>
            </div>
        </div>

        <!-- 触发词配置 -->
        <div id="triggers" class="tab-content">
            <div class="card">
                <h3>🎯 添加触发词</h3>
                <form onsubmit="createTrigger(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>触发词</label>
                            <input type="text" id="triggerWord" required placeholder="例如：联系客服">
                            <small>支持中英文，不区分大小写</small>
                        </div>
                        <div class="form-group">
                            <label>匹配模式</label>
                            <select id="triggerMatchType" required>
                                <option value="exact">精确匹配</option>
                                <option value="contains">包含匹配</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>关联模板</label>
                            <select id="triggerTemplate" required>
                                <option value="">选择消息模板</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>群组ID</label>
                            <input type="text" id="triggerChatId" required placeholder="-1001234567890">
                            <small>群组ID通常为负数</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">添加触发词</button>
                </form>
            </div>

            <div class="card">
                <h3>📝 触发词列表</h3>
                <div id="triggersList"></div>
            </div>
        </div>

        <!-- 定时任务 -->
        <div id="tasks" class="tab-content">
            <div class="card">
                <h3>⏰ 创建定时任务</h3>
                <form onsubmit="createTask(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>任务名称</label>
                            <input type="text" id="taskName" required placeholder="例如：每日营销推送">
                        </div>
                        <div class="form-group">
                            <label>关联模板</label>
                            <select id="taskTemplate" required>
                                <option value="">选择消息模板</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>群组ID</label>
                            <input type="text" id="taskChatId" required placeholder="-1001234567890">
                        </div>
                        <div class="form-group">
                            <label>调度类型</label>
                            <select id="taskScheduleType" required onchange="updateScheduleInput()">
                                <option value="daily">每日执行</option>
                                <option value="weekly">每周执行</option>
                                <option value="cron">自定义Cron</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label id="scheduleLabel">执行时间</label>
                        <input type="text" id="taskScheduleTime" required placeholder="09:00">
                        <small id="scheduleHelp">格式：HH:MM（24小时制）</small>
                    </div>
                    <button type="submit" class="btn btn-primary">创建任务</button>
                </form>
            </div>

            <div class="card">
                <h3>📅 任务列表</h3>
                <div id="tasksList"></div>
            </div>
        </div>

        <!-- 商家管理 -->
        <div id="merchants" class="tab-content">
            <div class="card">
                <h3>📊 绑定统计</h3>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalBindCodes">0</div>
                        <div>总绑定码</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="usedBindCodes">0</div>
                        <div>已使用</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="boundMerchants">0</div>
                        <div>已绑定商家</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="bindingInProgress">0</div>
                        <div>绑定中</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="section-header">
                    <h3>📊 已绑定商家列表</h3>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="openNewMerchantModal()">➕ 新增商家</button>
                        <button class="btn btn-info" onclick="refreshFollowStatus()">🔄 刷新关注状态</button>
                    </div>
                </div>
                <div id="merchantsList"></div>
            </div>

            <!-- 商家编辑模态框 -->
            <div id="merchantEditModal" class="modal">
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="closeMerchantEditModal()">&times;</span>
                    <h3>✏️ 编辑商家信息模板</h3>
                    <form onsubmit="updateMerchant(event)">
                        <input type="hidden" id="editMerchantId">
                        
                        <!-- 基本信息 -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>📋 基本信息</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>地区：#<span id="regionPrefix"></span></label>
                                    <select id="editRegionId" required onchange="updateRegionPrefix()">
                                        <option value="">选择地区</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>艺名：</label>
                                    <input type="text" id="editTeacherName" required placeholder="请输入艺名">
                                </div>
                            </div>
                        </div>

                        <!-- 描述信息 -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>📝 描述信息</h4>
                            <div class="form-group">
                                <label>优点：</label>
                                <textarea id="editAdvantages" rows="3" placeholder="请输入优点描述，支持文字、空格、emoji"></textarea>
                            </div>
                            <div class="form-group">
                                <label>缺点：</label>
                                <textarea id="editDisadvantages" rows="3" placeholder="请输入缺点描述，支持文字、空格、emoji"></textarea>
                            </div>
                        </div>

                        <!-- 价格信息 -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>💰 价格信息</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>价格1：</label>
                                    <div style="display: flex; align-items: center;">
                                        <select id="editPrice1" style="flex: 1;">
                                            <option value="">选择价格</option>
                                        </select>
                                        <span style="margin-left: 5px; font-weight: bold;">p</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>价格2：</label>
                                    <div style="display: flex; align-items: center;">
                                        <select id="editPrice2" style="flex: 1;">
                                            <option value="">选择价格</option>
                                        </select>
                                        <span style="margin-left: 5px; font-weight: bold;">pp</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 联系方式 -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>📞 联系方式</h4>
                            <div class="form-group">
                                <label>联系：</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="editContact" placeholder="@username" style="flex: 1;">
                                    <button type="button" class="btn btn-small" onclick="useBindContact()" style="white-space: nowrap;">使用绑定联系方式</button>
                                </div>
                                <small>可以手动编辑或使用商家绑定时填写的联系方式</small>
                            </div>
                            <div class="form-group">
                                <label>频道链接：</label>
                                <input type="text" id="editChannelLink" placeholder="https://t.me/channelname">
                                <small>用户点击"关注老师频道"按钮时跳转的链接</small>
                            </div>
                        </div>

                        <!-- 图片管理 -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>🖼️ 图片管理</h4>
                            <div class="form-group">
                                <label>商家图片：</label>
                                <div style="display: flex; gap: 10px; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <div id="imageDropZone" style="border: 2px dashed #ccc; border-radius: 5px; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 10px;" onclick="document.getElementById('editImageFile').click()">
                                            <p style="margin: 0; color: #666;">点击选择图片或拖拽图片到此处</p>
                                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">支持 JPG、PNG、GIF 格式，最大 5MB</p>
                                        </div>
                                        <input type="file" id="editImageFile" accept="image/*" onchange="handleImageFileUpload(event)" style="display: none;">
                                        <small>图片将保存到数据库中，显示在商家信息上方</small>
                                    </div>
                                    <button type="button" class="btn btn-small btn-warning" onclick="clearMerchantImage()" style="white-space: nowrap;">清除图片</button>
                                </div>
                                <div id="imagePreview" style="margin-top: 10px; display: none;">
                                    <img id="previewImage" style="max-width: 200px; max-height: 200px; border-radius: 5px; border: 1px solid #ddd;">
                                </div>
                            </div>
                        </div>

                        <!-- 绑定码管理 -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>🔗 绑定码管理</h4>
                            <div class="form-group">
                                <label>当前绑定码：</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="editBindCode" placeholder="未设置绑定码" style="flex: 1;">
                                    <button type="button" class="btn btn-small" onclick="generateNewBindCode()" style="white-space: nowrap;">生成新绑定码</button>
                                    <button type="button" class="btn btn-small btn-warning" onclick="clearBindCode()" style="white-space: nowrap;">清除绑定码</button>
                                </div>
                                <small>绑定码用于商家绑定，如果修改将影响现有绑定关系</small>
                            </div>
                        </div>

                        <!-- 基本功信息 -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>💃 老师自填基本功</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>💦洗：</label>
                                    <input type="text" id="editWash" placeholder="请填写">
                                </div>
                                <div class="form-group">
                                    <label>👄吹：</label>
                                    <input type="text" id="editBlow" placeholder="请填写">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>❤️做：</label>
                                    <input type="text" id="editDo" placeholder="请填写">
                                </div>
                                <div class="form-group">
                                    <label>🐍吻：</label>
                                    <input type="text" id="editKiss" placeholder="请填写">
                                </div>
                            </div>
                        </div>

                        <!-- 预览区域 -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>👀 信息预览</h4>
                            <div id="merchantInfoPreview" style="background: #f9f9f9; padding: 15px; border-radius: 5px; white-space: pre-line; font-family: monospace;"></div>
                        </div>

                        <div class="form-actions">
                            <button type="button" onclick="closeMerchantEditModal()" class="btn btn-secondary">取消</button>
                            <button type="button" onclick="previewMerchantInfo()" class="btn btn-warning">预览</button>
                            <button type="submit" class="btn btn-primary">保存修改</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 新增商家模态框 -->
            <div id="newMerchantModal" class="modal">
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="closeNewMerchantModal()">&times;</span>
                    <h3>➕ 新增商家</h3>
                    <form onsubmit="createNewMerchant(event)">
                        <div class="form-group">
                            <label>商家名称：</label>
                            <input type="text" id="newMerchantName" required placeholder="请输入商家名称">
                            <small>此名称将作为商家的艺名显示</small>
                        </div>
                        <div class="form-group">
                            <label>Telegram用户名：</label>
                            <input type="text" id="newMerchantUsername" required placeholder="请输入用户名，例如：username">
                            <small>不需要输入@符号，只需要输入用户名部分</small>
                        </div>
                        <div class="form-group">
                            <label>绑定码：</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="newMerchantBindCode" readonly style="flex: 1;">
                                <button type="button" class="btn btn-small" onclick="generateBindCodeForNewMerchant()">生成绑定码</button>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" onclick="closeNewMerchantModal()" class="btn btn-secondary">取消</button>
                            <button type="submit" class="btn btn-primary">创建商家</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 按钮管理 -->
        <div id="buttons" class="tab-content">
            <div class="card">
                <h3>➕ 创建新按钮</h3>
                <form onsubmit="createButton(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>按钮标题</label>
                            <input type="text" id="buttonTitle" required placeholder="例如：联系客服">
                        </div>
                        <div class="form-group">
                            <label>关联商家</label>
                            <select id="buttonMerchant" required>
                                <option value="">选择商家</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>回复消息</label>
                        <textarea id="buttonMessage" rows="3" placeholder="用户点击按钮后收到的消息"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">创建按钮</button>
                </form>
            </div>

            <div class="card">
                <h3>🔘 按钮列表</h3>
                <div id="buttonsList"></div>
            </div>
        </div>

        <!-- 测试发送 -->
        <div id="test" class="tab-content">
            <div class="card">
                <h3>📤 发送信息</h3>
                <form onsubmit="sendTestMessage(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>群组ID</label>
                            <input type="text" id="testChatId" required placeholder="例如：-1001234567890">
                            <small>群组ID通常为负数，可以通过添加机器人到群组获取</small>
                        </div>
                        <div class="form-group">
                            <label>模块选择</label>
                            <select id="testModuleType" onchange="handleModuleTypeChange()">
                                <option value="">请选择发送模块</option>
                                <option value="merchant">商家信息选择</option>
                                <option value="template">消息模板选择</option>
                                <option value="custom">自定义消息内容</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 商家信息选择 -->
                    <div id="merchantModule" class="form-group" style="display: none;">
                        <label>选择商家</label>
                        <select id="testMerchant">
                            <option value="">请选择商家</option>
                        </select>
                        <div id="merchantPreview" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; display: none;">
                            <h4>商家信息预览：</h4>
                            <div id="merchantPreviewContent"></div>
                        </div>
                    </div>
                    
                    <!-- 消息模板选择 -->
                    <div id="templateModule" class="form-group" style="display: none;">
                        <label>选择消息模板</label>
                        <select id="testTemplate" onchange="handleTemplateChange()">
                            <option value="">请选择消息模板</option>
                        </select>
                        <div id="templatePreviewTest" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; display: none;">
                            <h4>模板预览：</h4>
                            <div id="templatePreviewTestContent"></div>
                        </div>
                    </div>
                    
                    <!-- 自定义消息内容 -->
                    <div id="customModule" class="form-group" style="display: none;">
                        <label>消息内容</label>
                        <textarea id="testMessage" rows="5" placeholder="请输入自定义消息内容"></textarea>
                        <div class="form-group" style="margin-top: 10px;">
                            <label>图片URL（可选）</label>
                            <input type="url" id="testImageUrl" placeholder="https://example.com/image.jpg">
                    </div>
                        <div class="form-group">
                            <label>按钮配置（可选）</label>
                            <div id="testButtonRows"></div>
                            <button type="button" onclick="addTestButtonRow()" class="btn btn-secondary" style="margin-top: 5px;">+ 添加按钮</button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success">发送到群组</button>
                </form>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>处理中...</p>
    </div>

    <script>
        // 全局变量
        let merchants = [];
        let regions = [];
        let bindCodes = [];
        let botUsername = ''; // Bot用户名

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadMerchants();
            loadRegions();
            loadBindCodes();
            loadBotUsername(); // 加载Bot用户名
        });

        // 加载Bot用户名
        async function loadBotUsername() {
            try {
                const response = await fetch('/api/bot-username');
                if (response.ok) {
                    const data = await response.json();
                    // 兼容两种响应格式
                    botUsername = data.username || data.data?.username || 'xiaojisystembot';
                    window.BOT_USERNAME = botUsername; // 设置全局变量
                    console.log('Bot用户名加载成功:', botUsername);
                } else {
                    console.error('获取Bot用户名失败:', response.status);
                    botUsername = 'xiaojisystembot'; // 默认值
                    window.BOT_USERNAME = botUsername;
                }
            } catch (error) {
                console.error('加载Bot用户名失败:', error);
                botUsername = 'xiaojisystembot'; // 默认值
                window.BOT_USERNAME = botUsername;
            }
        }

        // 复制商家URL链接
        function copyMerchantUrl(url) {
            if (navigator.clipboard && window.isSecureContext) {
                // 现代浏览器支持Clipboard API
                navigator.clipboard.writeText(url).then(() => {
                    showAlert('链接已复制到剪贴板！', 'success');
                }).catch(err => {
                    console.error('复制失败:', err);
                    fallbackCopyTextToClipboard(url);
                });
            } else {
                // 旧浏览器的回退方案
                fallbackCopyTextToClipboard(url);
            }
        }

        // 回退的复制方法
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // 避免在屏幕上显示
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.width = "2em";
            textArea.style.height = "2em";
            textArea.style.padding = "0";
            textArea.style.border = "none";
            textArea.style.outline = "none";
            textArea.style.boxShadow = "none";
            textArea.style.background = "transparent";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showAlert('链接已复制到剪贴板！', 'success');
                } else {
                    showAlert('复制失败，请手动复制链接', 'error');
                }
            } catch (err) {
                console.error('Fallback: 复制失败', err);
                showAlert('复制失败，请手动复制链接', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // 测试商家URL链接
        function openMerchantUrl(url) {
            window.open(url, '_blank');
            showAlert('已在新窗口打开测试链接', 'info');
        }

        let buttons = [];
        let templates = [];
        let triggers = [];
        let tasks = [];
        let buttonRowCount = 0;

        // 获取Bot用户名
        async function fetchBotUsername() {
            try {
                const response = await fetch('/api/bot-username');
                if (response.ok) {
                    const data = await response.json();
                    window.BOT_USERNAME = data.username;
                    console.log('✅ 获取Bot用户名成功:', data.username);
                } else {
                    console.warn('⚠️ 获取Bot用户名失败，使用环境默认值');
                    // 根据页面URL判断环境
                    const hostname = window.location.hostname;
                    if (hostname.includes('staging') || hostname.includes('test')) {
                        window.BOT_USERNAME = 'xiaoji_daniao_bot'; // 测试环境
                    } else {
                        window.BOT_USERNAME = 'xiaojisystembot'; // 生产环境
                    }
                }
            } catch (error) {
                console.error('❌ 获取Bot用户名出错:', error);
                // 根据页面URL判断环境
                const hostname = window.location.hostname;
                if (hostname.includes('staging') || hostname.includes('test')) {
                    window.BOT_USERNAME = 'xiaoji_daniao_bot'; // 测试环境
                } else {
                    window.BOT_USERNAME = 'xiaojisystembot'; // 生产环境
                }
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchBotUsername(); // 先获取Bot用户名
            initializePriceSelectors();
            loadAllData();
        });

        // 初始化价格选择器
        function initializePriceSelectors() {
            const price1Select = document.getElementById('editPrice1');
            const price2Select = document.getElementById('editPrice2');
            
            // 生成价格选项，从100到5000，间隔100
            for (let price = 100; price <= 5000; price += 100) {
                const option1 = document.createElement('option');
                option1.value = price;
                option1.textContent = price;
                price1Select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = price;
                option2.textContent = price;
                price2Select.appendChild(option2);
            }
        }

        // 显示提示信息
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // 显示加载状态
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // 切换标签页
        function showTab(tabName) {
            // 隐藏所有标签内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有标签的激活状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签内容
            document.getElementById(tabName).classList.add('active');
            
            // 激活选中的标签
            event.target.classList.add('active');
            
            // 加载对应数据
            if (tabName === 'dashboard') {
                loadStats();
                loadMerchantBookingStats();
                loadMessageStats();
                loadRecentBookings();
                loadButtonStats();
            } else if (tabName === 'bind-codes') {
                // 强制清空缓存并重新加载绑定码数据
                bindCodes = [];
                loadBindCodes(true); // 强制刷新
            } else if (tabName === 'regions') {
                loadRegions();
            } else if (tabName === 'merchants') {
                loadMerchants();
            } else if (tabName === 'templates') {
                loadTemplates();
            } else if (tabName === 'triggers') {
                loadTriggers();
            } else if (tabName === 'tasks') {
                loadTasks();
            } else if (tabName === 'buttons') {
                loadButtons();
            }
        }

        // 加载所有数据
        async function loadAllData() {
            showLoading();
            try {
                await Promise.all([
                    loadMerchants(),
                    loadButtons(),
                    loadTemplates(),
                    loadTriggers(),
                    loadTasks(),
                    loadBindCodes(),
                    loadRegions(),
                    loadStats()
                ]);
                updateSelects();
                // 确保测试发送页面的商家选择器也得到更新
                if (typeof updateMerchantSelect === 'function') {
                    updateMerchantSelect();
                }
                loadChatId(); // 加载保存的群组ID
            } catch (error) {
                showAlert('加载数据失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // API请求封装
        async function apiRequest(url, method = 'GET', data = null, forceRefresh = false) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            // 对于强制刷新的GET请求，添加缓存控制头和时间戳
            if (forceRefresh && method === 'GET') {
                options.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate';
                options.headers['Pragma'] = 'no-cache';
                // 添加时间戳参数确保URL唯一
                const separator = url.includes('?') ? '&' : '?';
                url = `${url}${separator}_t=${Date.now()}`;
            }
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(url, options);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || result.message || '请求失败');
            }
            
            // 对于GET请求返回data，对于其他请求返回完整结果以保留message等信息
            if (method === 'GET') {
                return result.data || result;
            } else {
                return result;
            }
        }

        // 加载绑定码数据
        async function loadBindCodes(forceRefresh = false) {
            try {
                // 先清空旧数据
                bindCodes = [];
                const freshData = await apiRequest('/api/bind-codes', 'GET', null, forceRefresh);
                bindCodes = freshData;
                renderBindCodes();
                console.log('✅ 绑定码数据已刷新' + (forceRefresh ? ' (强制刷新)' : ''));
            } catch (error) {
                console.error('❌ 加载绑定码失败:', error);
                // 出错时也要清空数据，避免显示旧数据
                bindCodes = [];
                renderBindCodes();
                showAlert('加载绑定码数据失败: ' + error.message, 'error');
            }
        }

        // 渲染绑定码列表
        function renderBindCodes() {
            const container = document.getElementById('bindCodesList');
            if (!container) return;

            if (bindCodes.length === 0) {
                container.innerHTML = '<p>暂无绑定码</p>';
                return;
            }

            container.innerHTML = bindCodes.map(code => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>🔑 ${code.code}</strong>
                        <div style="color: #666; font-size: 14px; margin-top: 5px;">
                            📝 ${code.description || '无描述'}
                        </div>
                        <div style="color: #666; font-size: 12px; margin-top: 5px;">
                            ${code.used ? 
                                `✅ 已使用 - 绑定商家: ${code.teacher_name || '未知'} (@${code.username || '未知'})` : 
                                '⏳ 未使用'
                            }
                        </div>
                        <div style="color: #999; font-size: 12px;">
                            创建时间: ${new Date(code.created_at * 1000).toLocaleString()}
                        </div>
                    </div>
                    <div class="list-item-actions">
                        ${!code.used ? 
                            `<button class="btn btn-danger btn-small" onclick="deleteBindCode(${code.id})">删除</button>` : 
                            `<button class="btn btn-warning btn-small" onclick="forceDeleteBindCode(${code.id})">强制删除</button>`
                        }
                    </div>
                </div>
            `).join('');
        }

        // 创建绑定码
        async function createBindCode(event) {
            event.preventDefault();
            const description = document.getElementById('bindCodeDescription').value;

            try {
                showLoading();
                const result = await apiRequest('/api/bind-codes', 'POST', { description });
                showAlert(`绑定码创建成功！绑定码：${result.code}`);
                document.getElementById('bindCodeDescription').value = '';
                await loadBindCodes();
            } catch (error) {
                showAlert('创建绑定码失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 删除绑定码 - 需要管理员密码验证
        async function deleteBindCode(id) {
            // 首先检查绑定码状态
            const bindCode = bindCodes.find(bc => bc.id == id); // 使用 == 而不是 === 以处理类型转换
            
            if (!bindCode) {
                showAlert('绑定码不存在，可能是缓存问题。正在重新加载数据...', 'warning');
                await loadBindCodes();
                return;
            }
            
            if (bindCode.used) {
                showAlert('已使用的绑定码无法删除，请使用强制删除功能', 'error');
                return;
            }
            
            if (!confirm('确定要删除这个绑定码吗？')) return;

            try {
                showLoading();
                const response = await apiRequest(`/api/bind-codes/${id}`, 'DELETE');
                
                showAlert(response.message || '绑定码删除成功');
                await loadBindCodes();
            } catch (error) {
                // 处理API返回的错误信息
                if (error.message.includes('BIND_CODE_IN_USE')) {
                    const confirmForce = confirm(
                        `${error.message}\n\n是否要强制删除？\n⚠️ 警告：强制删除将同时删除相关的商家记录！`
                    );
                    if (confirmForce) {
                        await forceDeleteBindCode(id);
                        return;
                    }
                } else {
                    showAlert('删除绑定码失败: ' + error.message, 'error');
                }
            } finally {
                hideLoading();
            }
        }

        // 强制删除已使用的绑定码 - 需要管理员密码验证
        async function forceDeleteBindCode(id) {
            // 如果是从deleteBindCode调用的，不需要再次确认
            const needConfirm = arguments.length === 1;
            
            if (needConfirm && !confirm('确定要强制删除这个已使用的绑定码吗？\n⚠️ 注意：这将同时删除相关的商家记录！')) {
                return;
            }

            // 要求输入管理员密码
            const adminPassword = prompt('⚠️ 强制删除需要管理员密码验证\n请输入管理员密码:');
            if (!adminPassword) {
                showAlert('操作已取消', 'info');
                return;
            }
            
            // 简单的密码验证（实际项目中应该使用更安全的方式）
                            const isValid = await verifyAdminPassword(adminPassword, '强制删除绑定码');
                if (!isValid) {
                    showAlert('管理员密码错误！', 'error');
                    return;
                }

            try {
                showLoading();
                const response = await apiRequest(`/api/bind-codes/${id}/force`, 'DELETE');
                
                showAlert(response.message || '绑定码已强制删除');
                await loadBindCodes();
                // 如果删除了商家，也要刷新商家列表
                if (response.data && response.data.deletedMerchant) {
                    await loadMerchants();
                }
            } catch (error) {
                showAlert('强制删除绑定码失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 批量删除测试绑定码
        async function batchDeleteTestBindCodes() {
            if (!confirm('确定要批量删除所有测试绑定码吗？\n⚠️ 这将删除所有描述中包含"测试"的绑定码（包括已使用的）！\n⚠️ 已使用的绑定码将同时删除相关商家记录！')) return;

            try {
                showLoading();
                const response = await apiRequest('/api/bind-codes/batch-delete-test', 'DELETE');
                
                showAlert(response.message || '批量删除成功');
                await loadBindCodes();
                // 如果删除了商家，也要刷新商家列表
                if (response.data && response.data.deletedMerchants > 0) {
                    await loadMerchants();
                }
            } catch (error) {
                showAlert('批量删除测试绑定码失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 加载地区数据
        async function loadRegions() {
            try {
                regions = await apiRequest('/api/regions');
                renderRegions();
            } catch (error) {
                console.error('加载地区失败:', error);
            }
        }

        // 渲染地区列表
        function renderRegions() {
            const container = document.getElementById('regionsList');
            if (!container) return;

            if (regions.length === 0) {
                container.innerHTML = '<p>暂无地区配置</p>';
                return;
            }

            container.innerHTML = regions.map(region => {
                // 计算绑定到此地区的商家数量
                const merchantCount = merchants.filter(m => m.region_id === region.id).length;
                
                return `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>📍 ${region.name}</strong>
                        <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                排序: ${region.sort_order} | 绑定商家: ${merchantCount} 个
                        </div>
                            ${merchantCount > 0 ? `<div style="margin-top: 5px;">
                                <span class="badge info">${merchantCount} 个商家</span>
                            </div>` : ''}
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-warning btn-small" onclick="editRegion(${region.id}, '${region.name}', ${region.sort_order})">编辑</button>
                            <button class="btn btn-danger btn-small" onclick="deleteRegion(${region.id})" ${merchantCount > 0 ? 'title="有商家绑定，无法删除"' : ''}>删除</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // 创建地区
        async function createRegion(event) {
            event.preventDefault();
            const name = document.getElementById('regionName').value;
            const sortOrder = parseInt(document.getElementById('regionSortOrder').value) || 0;

            try {
                showLoading();
                await apiRequest('/api/regions', 'POST', { name, sortOrder });
                showAlert('地区添加成功');
                document.getElementById('regionName').value = '';
                document.getElementById('regionSortOrder').value = '0';
                await loadRegions();
            } catch (error) {
                showAlert('添加地区失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 编辑地区
        function editRegion(id, currentName, currentSortOrder) {
            const name = prompt('请输入新的地区名称:', currentName);
            if (!name) return;

            const sortOrder = prompt('请输入排序顺序:', currentSortOrder);
            if (sortOrder === null) return;

            updateRegion(id, name, parseInt(sortOrder) || 0);
        }

        // 更新地区
        async function updateRegion(id, name, sortOrder) {
            try {
                showLoading();
                await apiRequest('/api/regions', 'PUT', { id, name, sortOrder });
                showAlert('地区更新成功');
                await loadRegions();
            } catch (error) {
                showAlert('更新地区失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 删除地区
        async function deleteRegion(id) {
            try {
                showLoading();
                
                // 首先检查依赖关系
                const dependencies = await apiRequest(`/api/regions/${id}/dependencies`);
                
                if (dependencies.merchants > 0) {
                    hideLoading();
                    showAlert(`无法删除地区：还有 ${dependencies.merchants} 个商家绑定到此地区。请先将这些商家转移到其他地区或删除商家后再删除地区。`, 'error');
                    return;
                }
                
                if (!confirm('确定要删除这个地区吗？此操作不可恢复。')) {
                    hideLoading();
                    return;
                }

                // 删除地区 - apiRequest在成功时不会抛出异常，所以直接认为成功
                await apiRequest('/api/regions', 'DELETE', { id });
                
                showAlert('地区删除成功');
                await loadRegions();
                await loadMerchants(); // 刷新商家列表
                
            } catch (error) {
                showAlert('删除地区失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 加载统计数据
        async function loadStats() {
            try {
                console.log('开始加载统计数据...');
                
                // 获取8个核心订单指标
                const orderStats = await apiRequest('/api/stats/optimized');
                console.log('获取订单统计数据:', orderStats);
                
                // 获取基础系统数据
                const basicStats = await apiRequest('/api/stats');
                console.log('获取基础统计数据:', basicStats);
                
                // 更新8个核心订单指标
                document.getElementById('totalOrders').textContent = orderStats.totalOrders || 0;
                document.getElementById('bookedOrders').textContent = orderStats.bookedOrders || 0;
                document.getElementById('incompleteOrders').textContent = orderStats.incompleteOrders || 0;
                document.getElementById('completedOrders').textContent = orderStats.completedOrders || 0;
                document.getElementById('avgPrice').textContent = orderStats.avgPrice ? `¥${orderStats.avgPrice}` : '¥0';
                document.getElementById('avgUserRating').textContent = orderStats.avgUserRating > 0 ? `${orderStats.avgUserRating}/10` : '-';
                document.getElementById('avgMerchantRating').textContent = orderStats.avgMerchantRating > 0 ? `${orderStats.avgMerchantRating}/10` : '-';
                document.getElementById('completionRate').textContent = `${orderStats.completionRate || 0}%`;
                
                // 更新基础系统数据
                document.getElementById('totalMerchants').textContent = basicStats.totalMerchants || 0;
                document.getElementById('totalBindCodes').textContent = basicStats.totalBindCodes || 0;
                document.getElementById('totalRegions').textContent = basicStats.totalRegions || 0;
                document.getElementById('totalTemplates').textContent = basicStats.totalTemplates || 0;
                document.getElementById('totalClicks').textContent = basicStats.totalClicks || 0;
                
                console.log('统计数据加载完成');
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 加载商家预约统计
        async function loadMerchantBookingStats() {
            try {
                const stats = await apiRequest('/api/merchant-bookings');
                const container = document.getElementById('merchantBookingStats');
                
                if (stats.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">暂无预约记录</p>';
                    return;
                }

                // 计算总预约数
                const totalBookings = stats.reduce((sum, merchant) => sum + merchant.booking_count, 0);
                document.getElementById('totalBookings').textContent = totalBookings;

                container.innerHTML = stats.map(merchant => {
                    const bookingDetails = merchant.booking_details ? 
                        merchant.booking_details.split('; ').filter(detail => detail.trim()).map(detail => {
                            const [username, courseType, time] = detail.split('|');
                            return `<div style="font-size: 12px; color: #666; margin: 2px 0;">
                                ${username} - ${courseType} - ${time}
                            </div>`;
                        }).join('') : '';

                    return `
                        <div class="list-item">
                            <div class="list-item-content">
                                <strong>👨‍🏫 ${merchant.teacher_name || '未知老师'}</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    📍 地区: ${merchant.region_name || '未设置'}
                                </div>
                                <div style="margin-top: 8px;">
                                    <span class="badge success">预约次数: ${merchant.booking_count}</span>
                                </div>
                                ${bookingDetails ? `<div style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 8px;">
                                    <strong style="font-size: 12px;">预约详情:</strong>
                                    ${bookingDetails}
                                </div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('加载商家预约统计失败:', error);
                document.getElementById('merchantBookingStats').innerHTML = '<p style="color: red;">加载失败</p>';
            }
        }

        // 加载消息统计
        async function loadMessageStats() {
            try {
                const stats = await apiRequest('/api/message-stats');
                const container = document.getElementById('messageStats');
                
                if (stats.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">暂无消息互动记录</p>';
                    return;
                }

                container.innerHTML = stats.map(stat => {
                    const actionTypeText = {
                        'click': '按钮点击',
                        'template_click': '模板点击',
                        'view': '消息浏览'
                    }[stat.action_type] || stat.action_type;

                    return `
                        <div class="list-item">
                            <div class="list-item-content">
                                <strong>📊 ${actionTypeText}</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    💬 群组ID: ${stat.chat_id}
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    👥 独立用户: ${stat.unique_users} 人
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    🕒 最后互动: ${stat.last_interaction || '未知'}
                                </div>
                                <div style="margin-top: 8px;">
                                    <span class="badge info">总次数: ${stat.count}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('加载消息统计失败:', error);
                document.getElementById('messageStats').innerHTML = '<p style="color: red;">加载失败</p>';
            }
        }

        // 加载最近预约记录
        async function loadRecentBookings() {
            try {
                const bookings = await apiRequest('/api/recent-bookings');
                const container = document.getElementById('recentBookings');
                
                if (bookings.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">暂无最近预约记录</p>';
                    return;
                }

                container.innerHTML = bookings.map(booking => {
                    // 构建用户显示名称
                    const fullName = `${booking.first_name || ''} ${booking.last_name || ''}`.trim() || '未设置名称';
                    const username = booking.username ? `@${booking.username}` : '未设置用户名';
                    const displayName = `${fullName}（${username}）`;
                    
                    return `
                        <div class="list-item">
                            <div class="list-item-content">
                                <strong>👤 ${displayName}</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    👨‍🏫 预约老师: ${booking.teacher_name || '未知'}
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    📍 地区: ${booking.region_name || '未设置'}
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    🕒 预约时间: ${booking.booking_time}
                                </div>
                                <div style="margin-top: 8px;">
                                    <span class="badge info">${booking.course_type}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('加载最近预约记录失败:', error);
                document.getElementById('recentBookings').innerHTML = '<p style="color: red;">加载失败</p>';
            }
        }

        // 加载按钮点击统计
        async function loadButtonStats() {
            try {
                const stats = await apiRequest('/api/button-stats');
                const container = document.getElementById('buttonStats');
                
                if (stats.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">暂无按钮点击记录</p>';
                    return;
                }

                container.innerHTML = stats.map(button => `
                    <div class="list-item">
                        <div class="list-item-content">
                            <strong>🔘 ${button.title}</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                👨‍🏫 关联商家: ${button.merchant_name || '无'}
                            </div>
                            <div style="color: #666; font-size: 14px;">
                                🕒 最后点击: ${button.last_click || '从未点击'}
                            </div>
                            <div style="margin-top: 8px;">
                                <span class="badge success">点击次数: ${button.click_count}</span>
                                <span class="badge info">互动记录: ${button.interaction_count}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载按钮统计失败:', error);
                document.getElementById('buttonStats').innerHTML = '<p style="color: red;">加载失败</p>';
            }
        }

        // 加载商家数据
        async function loadMerchants() {
            try {
                // 添加时间戳避免浏览器缓存
                const timestamp = Date.now();
                merchants = await apiRequest(`/api/merchants?t=${timestamp}`);
                renderMerchants();
                updateSelects(); // 更新下拉选择框
            } catch (error) {
                console.error('加载商家数据失败:', error);
                showAlert('加载商家数据失败: ' + error.message, 'error');
                document.getElementById('merchantsList').innerHTML = '<p style="color: red;">加载商家数据失败</p>';
            }
        }

        // 渲染商家列表
        function renderMerchants() {
            const container = document.getElementById('merchantsList');
            if (!container) return;

            if (merchants.length === 0) {
                container.innerHTML = '<p>暂无商家数据</p>';
                return;
            }

            container.innerHTML = merchants.map(merchant => {
                // 生成商家跳转URL链接
                const merchantUrl = `https://t.me/${window.BOT_USERNAME}?start=merchant_${merchant.id}`;
                
                return `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>👨‍🏫 ${merchant.teacher_name || '未知老师'}</strong>
                        <div class="merchant-info">
                            <span class="info-item">📍 地区: ${merchant.region_name || '未设置'}</span>
                            <span class="info-item">📞 联系方式: ${merchant.contact || '未设置'}</span>
                            <span class="info-item">💰 价格: ${merchant.price1 || '未设置'}p / ${merchant.price2 || '未设置'}pp</span>
                            <span class="info-item">👤 用户ID: ${merchant.user_id || '未绑定'}</span>
                            <span class="info-item">📱 用户名: ${merchant.username ? '@' + merchant.username : '未设置'}</span>
                            <span class="info-item">🔗 绑定码: ${merchant.bind_code || '无'}</span>
                            <span class="info-item status-${merchant.status}">
                                📊 状态: ${merchant.status === 'active' ? '✅ 激活' : '❌ 停用'}
                            </span>
                            <span class="info-item">
                                📋 绑定步骤: ${merchant.bind_step}/5
                            </span>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-radius: 5px; border-left: 4px solid #007bff;">
                            <strong style="color: #007bff;">🔗 频道推广链接：</strong>
                            <div style="margin-top: 5px;">
                                <input type="text" value="${merchantUrl}" readonly 
                                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-family: monospace; font-size: 12px;" 
                                       onclick="this.select()" title="点击选择全部">
                            </div>
                            <div style="margin-top: 5px; display: flex; gap: 5px;">
                                <button class="btn btn-small" style="background: #28a745; color: white;" onclick="copyMerchantUrl('${merchantUrl}')">📋 复制链接</button>
                                <button class="btn btn-small" style="background: #17a2b8; color: white;" onclick="openMerchantUrl('${merchantUrl}')">🔗 测试链接</button>
                            </div>
                            <div style="margin-top: 3px; font-size: 11px; color: #666;">
                                💡 用户点击此链接可直接跳转到机器人查看商家信息并开始约课流程
                            </div>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-primary btn-small" onclick="editMerchant(${merchant.id})">编辑</button>
                        <button class="btn ${merchant.status === 'active' ? 'btn-warning' : 'btn-success'} btn-small" 
                                onclick="toggleMerchantStatus(${merchant.id}, '${merchant.status}')">
                            ${merchant.status === 'active' ? '停用' : '激活'}
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteMerchant(${merchant.id})">删除</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // 验证管理员密码
        async function verifyAdminPassword(password, actionName = '操作') {
            try {
                const response = await fetch('/api/admin/verify-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error('验证请求失败');
                }
                
                return result.valid;
            } catch (error) {
                console.error('密码验证失败:', error);
                showAlert(`密码验证失败: ${error.message}`, 'error');
                return false;
            }
        }

        // 编辑商家信息
        async function editMerchant(id) {
            // 验证管理员密码
            const password = prompt('请输入管理员密码以进行编辑操作：');
            if (!password) {
                return;
            }
            
            const isValid = await verifyAdminPassword(password, '编辑商家');
            if (!isValid) {
                showAlert('管理员密码错误，编辑操作已取消', 'error');
                return;
            }

            const merchant = merchants.find(m => m.id == id); // 使用松散比较，避免类型问题
            if (!merchant) return;

            // 填充基本信息
            document.getElementById('editMerchantId').value = id;
            document.getElementById('editTeacherName').value = merchant.teacher_name || '';
            document.getElementById('editRegionId').value = merchant.region_id || '';
            document.getElementById('editContact').value = merchant.contact || '';
            document.getElementById('editChannelLink').value = merchant.channel_link || '';
            document.getElementById('editBindCode').value = merchant.bind_code || '';
            
            // 填充模板信息
            document.getElementById('editAdvantages').value = merchant.advantages || '';
            document.getElementById('editDisadvantages').value = merchant.disadvantages || '';
            document.getElementById('editPrice1').value = merchant.price1 || '';
            document.getElementById('editPrice2').value = merchant.price2 || '';
            document.getElementById('editWash').value = merchant.skill_wash || '';
            document.getElementById('editBlow').value = merchant.skill_blow || '';
            document.getElementById('editDo').value = merchant.skill_do || '';
            document.getElementById('editKiss').value = merchant.skill_kiss || '';
            
            // 更新地区选择框
            const regionSelect = document.getElementById('editRegionId');
            regionSelect.innerHTML = '<option value="">选择地区</option>' + 
                regions.map(r => `<option value="${r.id}" ${r.id === merchant.region_id ? 'selected' : ''}>${r.name}</option>`).join('');
            
            // 更新地区前缀显示
            updateRegionPrefix();
            
            // 填充图片信息
            if (merchant.image_url) {
                showImagePreview(merchant.image_url);
                window.currentMerchantImageData = merchant.image_url;
            } else {
                hideImagePreview();
                window.currentMerchantImageData = null;
            }
            
            // 存储原始联系方式用于"使用绑定联系方式"功能
            window.currentMerchantBindContact = merchant.contact;
            
            document.getElementById('merchantEditModal').style.display = 'block';
        }

        // 关闭编辑模态框
        function closeMerchantEditModal() {
            document.getElementById('merchantEditModal').style.display = 'none';
        }

        // 更新地区前缀显示
        function updateRegionPrefix() {
            const regionSelect = document.getElementById('editRegionId');
            const regionPrefix = document.getElementById('regionPrefix');
            
            if (regionSelect.value) {
                const selectedRegion = regions.find(r => r.id == regionSelect.value);
                if (selectedRegion) {
                    regionPrefix.textContent = selectedRegion.name;
                } else {
                    regionPrefix.textContent = 'xx';
                }
            } else {
                regionPrefix.textContent = 'xx';
            }
        }

        // 使用绑定联系方式
        function useBindContact() {
            const contactInput = document.getElementById('editContact');
            if (window.currentMerchantBindContact) {
                contactInput.value = window.currentMerchantBindContact;
                showAlert('已填入绑定时的联系方式', 'info');
            } else {
                showAlert('未找到绑定时的联系方式', 'warning');
            }
        }

        // 生成新绑定码
        async function generateNewBindCode() {
            try {
                showLoading();
                const response = await apiRequest('/api/bind-codes', 'POST', {
                    description: '商家编辑-手动生成'
                });
                
                // 使用与绑定码管理页面完全相同的响应处理逻辑
                let bindCode = null;
                if (response && response.success && response.data && response.data.code) {
                    bindCode = response.data.code;
                } else if (response && response.code) {
                    bindCode = response.code;
                } else {
                    console.error('响应格式错误:', response);
                    throw new Error('生成绑定码失败：服务器响应格式错误');
                }
                
                document.getElementById('editBindCode').value = bindCode;
                showAlert('新绑定码生成成功', 'success');
                
                // 刷新绑定码列表以保持数据同步
                await loadBindCodes();
            } catch (error) {
                console.error('生成绑定码失败:', error);
                showAlert('生成绑定码失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 清除绑定码
        function clearBindCode() {
            if (confirm('确定要清除当前绑定码吗？清除后商家将无法使用此绑定码进行绑定。')) {
                document.getElementById('editBindCode').value = '';
                showAlert('绑定码已清除', 'info');
            }
        }

        // 处理图片文件上传
        async function handleImageFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                showAlert('请选择图片文件', 'error');
                return;
            }

            // 检查文件大小（限制为5MB）
            if (file.size > 5 * 1024 * 1024) {
                showAlert('图片文件大小不能超过5MB', 'error');
                return;
            }

            try {
                showLoading();
                
                // 将图片转换为base64
                const base64 = await fileToBase64(file);
                
                // 显示预览
                showImagePreview(base64);
                
                // 将base64数据存储到全局变量中，保存时一起提交
                window.currentMerchantImageData = base64;
                
                hideLoading();
                showAlert('图片已选择，点击保存按钮完成上传', 'success');
                
            } catch (error) {
                hideLoading();
                console.error('图片处理错误:', error);
                showAlert('图片处理失败: ' + error.message, 'error');
            }
        }

        // 将文件转换为base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // 显示图片预览
        function showImagePreview(imageUrl) {
            const preview = document.getElementById('imagePreview');
            const img = document.getElementById('previewImage');
            
            img.src = imageUrl;
            img.onload = function() {
                preview.style.display = 'block';
            };
            img.onerror = function() {
                preview.style.display = 'none';
                showAlert('图片加载失败，请检查URL是否正确', 'warning');
            };
        }

        // 隐藏图片预览
        function hideImagePreview() {
            document.getElementById('imagePreview').style.display = 'none';
        }

        // 清除商家图片
        function clearMerchantImage() {
            if (confirm('确定要清除商家图片吗？')) {
                document.getElementById('editImageFile').value = '';
                window.currentMerchantImageData = null;
                hideImagePreview();
                showAlert('图片已清除', 'info');
            }
        }

        // 预览商家信息
        function previewMerchantInfo() {
            const regionSelect = document.getElementById('editRegionId');
            const selectedRegion = regions.find(r => r.id == regionSelect.value);
            const regionName = selectedRegion ? selectedRegion.name : 'xx';
            
            const teacherName = document.getElementById('editTeacherName').value || '未填写';
            const advantages = document.getElementById('editAdvantages').value || '未填写';
            const disadvantages = document.getElementById('editDisadvantages').value || '未填写';
            const price1 = document.getElementById('editPrice1').value || '未填写';
            const price2 = document.getElementById('editPrice2').value || '未填写';
            const contact = document.getElementById('editContact').value || '未填写';
            const skillWash = document.getElementById('editWash').value || '未填写';
            const skillBlow = document.getElementById('editBlow').value || '未填写';
            const skillDo = document.getElementById('editDo').value || '未填写';
            const skillKiss = document.getElementById('editKiss').value || '未填写';
            const imageData = window.currentMerchantImageData;

            const preview = `地区：#${regionName}              艺名：${teacherName}
优点：${advantages}
缺点：${disadvantages}
价格：${price1}p              ${price2}pp
联系：${contact}

老师💃自填基本功：
💦洗:${skillWash}
👄吹:${skillBlow}
❤️做:${skillDo}
🐍吻:${skillKiss}`;

            const previewContainer = document.getElementById('merchantInfoPreview');
            
            // 如果有图片，显示图片预览
            if (imageData) {
                previewContainer.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <img src="${imageData}" style="max-width: 200px; max-height: 200px; border-radius: 5px; border: 1px solid #ddd;" onerror="this.style.display='none'">
                    </div>
                    <pre style="white-space: pre-line; font-family: monospace; margin: 0;">${preview}</pre>
                `;
            } else {
                previewContainer.innerHTML = `<pre style="white-space: pre-line; font-family: monospace; margin: 0;">${preview}</pre>`;
            }
        }

        // 更新商家信息
        async function updateMerchant(event) {
            event.preventDefault();
            
            const id = document.getElementById('editMerchantId').value;
            const teacherName = document.getElementById('editTeacherName').value;
            const regionId = document.getElementById('editRegionId').value;
            const contact = document.getElementById('editContact').value;
            const channelLink = document.getElementById('editChannelLink').value;
            const bindCode = document.getElementById('editBindCode').value;
            const advantages = document.getElementById('editAdvantages').value;
            const disadvantages = document.getElementById('editDisadvantages').value;
            const price1 = document.getElementById('editPrice1').value ? parseInt(document.getElementById('editPrice1').value) : null;
            const price2 = document.getElementById('editPrice2').value ? parseInt(document.getElementById('editPrice2').value) : null;
            const skillWash = document.getElementById('editWash').value;
            const skillBlow = document.getElementById('editBlow').value;
            const skillDo = document.getElementById('editDo').value;
            const skillKiss = document.getElementById('editKiss').value;
            const imageData = window.currentMerchantImageData;

            try {
                showLoading();
                await apiRequest(`/api/merchants/${id}`, 'PUT', {
                    teacherName,
                    regionId,
                    contact,
                    channelLink,
                    bindCode,
                    advantages,
                    disadvantages,
                    price1,
                    price2,
                    skillWash,
                    skillBlow,
                    skillDo,
                    skillKiss,
                    imageData
                });
                showAlert('商家信息模板更新成功');
                closeMerchantEditModal();
                await loadMerchants();
            } catch (error) {
                showAlert('更新商家信息失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 暂停/启动商家
        async function toggleMerchantStatus(id, status) {
            console.log('toggleMerchantStatus 调用:', { id, idType: typeof id, merchantsLength: merchants.length, merchants });
            const merchant = merchants.find(m => m.id == id); // 使用松散比较，避免类型问题
            console.log('找到的商家:', merchant);
            if (!merchant) {
                console.error('未找到商家，ID:', id);
                showAlert('未找到指定的商家，请刷新页面后重试', 'error');
                return;
            }

            const action = status === 'active' ? '暂停' : '启动';
            
            // 验证管理员密码
            const password = prompt(`请输入管理员密码以${action}商家：`);
            if (!password) {
                return;
            }
            
            const isValid = await verifyAdminPassword(password, action + '商家');
            if (!isValid) {
                showAlert('管理员密码错误，操作已取消', 'error');
                return;
            }

            if (!confirm(`确定要${action}这个商家吗？`)) return;

            try {
                showLoading();
                await apiRequest(`/api/merchants/${id}/toggle-status`, 'POST');
                showAlert(`商家${action}成功`);
                await loadMerchants();
            } catch (error) {
                showAlert(`${action}商家失败: ` + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 删除商家
        async function deleteMerchant(id) {
            // 找到要删除的商家
            const merchant = merchants.find(m => m.id == id); // 使用松散比较，避免类型问题
            if (!merchant) {
                showAlert('未找到指定的商家', 'error');
                return;
            }

            if (!confirm(`确定要删除商家"${merchant.teacher_name}"吗？\n\n⚠️ 这将同时删除：\n- 相关的按钮数据\n- 相关的交互记录\n- 相关的预约数据\n\n此操作不可撤销！`)) return;

            // 验证管理员密码
            const password = prompt('请输入管理员密码以确认删除操作：');
            if (!password) {
                return;
            }
            
            const isValid = await verifyAdminPassword(password, '删除商家');
            if (!isValid) {
                showAlert('管理员密码错误，删除操作已取消', 'error');
                return;
            }

            try {
                console.log(`开始删除商家: ID=${id}, 姓名=${merchant.teacher_name}`);
                showLoading();
                
                // 先检查依赖关系
                console.log('检查商家依赖关系...');
                const checkResponse = await fetch(`/api/merchants/${id}/dependencies`);
                if (checkResponse.ok) {
                    const dependencies = await checkResponse.json();
                    if (dependencies.data && dependencies.data.total > 0) {
                        const details = [];
                        if (dependencies.data.orders > 0) details.push(`${dependencies.data.orders}个订单`);
                        if (dependencies.data.bookingSessions > 0) details.push(`${dependencies.data.bookingSessions}个预约`);
                        if (dependencies.data.buttons > 0) details.push(`${dependencies.data.buttons}个按钮`);
                        
                        const confirmMessage = `该商家有以下相关数据：\n${details.join('、')}\n\n继续删除将清除所有相关数据，确定继续吗？`;
                        if (!confirm(confirmMessage)) {
                            hideLoading();
                            return;
                        }
                    }
                }
                
                const response = await fetch(`/api/merchants/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                console.log('删除API响应:', result);
                
                if (!result.success) {
                    throw new Error(result.error || result.message || '删除失败');
                }

                showAlert(`商家"${merchant.teacher_name}"删除成功`, 'success');
                console.log('删除成功，开始重新加载数据...');
                
                // 清空本地缓存
                merchants = [];
                buttons = [];
                
                // 重新加载所有相关数据
                await Promise.all([
                    loadMerchants(),
                    loadButtons(),
                    loadStats() // 如果存在统计数据也需要刷新
                ]);
                
                console.log('数据重新加载完成');
                
            } catch (error) {
                console.error('删除商家失败:', error);
                
                // 详细的错误信息处理
                let errorMessage = '删除商家失败';
                if (error.message) {
                    if (error.message.includes('FOREIGN KEY constraint')) {
                        errorMessage = '删除失败：该商家仍有相关数据引用，请先删除相关的订单、预约或其他关联数据';
                    } else if (error.message.includes('HTTP错误')) {
                        errorMessage = `网络错误：${error.message}`;
                    } else {
                        errorMessage = `删除失败：${error.message}`;
                    }
                }
                
                showAlert(errorMessage, 'error');
            } finally {
                hideLoading();
            }
        }

        // 加载按钮数据
        async function loadButtons() {
            const timestamp = Date.now();
            buttons = await apiRequest(`/api/buttons?t=${timestamp}`);
            renderButtons();
        }

        function renderButtons() {
            const container = document.getElementById('buttonsList');
            if (buttons.length === 0) {
                container.innerHTML = '<p>暂无按钮数据</p>';
                return;
            }
            
            container.innerHTML = buttons.map(button => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>${button.title}</strong>
                        <div>商家: ${button.merchant_name || '未关联'}</div>
                        <div>点击次数: <span class="badge info">${button.click_count}</span></div>
                    </div>
                    <div class="list-item-actions">
                        <button onclick="deleteButton(${button.id})" class="btn btn-danger btn-small">删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 加载消息模板
        async function loadTemplates() {
            templates = await apiRequest('/api/templates');
            renderTemplates();
        }

        function renderTemplates() {
            const container = document.getElementById('templatesList');
            if (templates.length === 0) {
                container.innerHTML = '<p>暂无模板数据</p>';
                return;
            }
            
            container.innerHTML = templates.map(template => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>${template.name}</strong>
                        <div>${template.content.substring(0, 100)}${template.content.length > 100 ? '...' : ''}</div>
                        ${template.image_url ? '<div><span class="badge info">包含图片</span></div>' : ''}
                        ${template.buttons_config ? '<div><span class="badge success">包含按钮</span></div>' : ''}
                    </div>
                    <div class="list-item-actions">
                        <button onclick="deleteTemplate(${template.id})" class="btn btn-danger btn-small">删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 加载触发词
        async function loadTriggers() {
            triggers = await apiRequest('/api/triggers');
            renderTriggers();
        }

        function renderTriggers() {
            const container = document.getElementById('triggersList');
            if (triggers.length === 0) {
                container.innerHTML = '<p>暂无触发词数据</p>';
                return;
            }
            
            container.innerHTML = triggers.map(trigger => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>"${trigger.word}"</strong>
                        <div>模板: ${trigger.template_name || '未关联'}</div>
                        <div>匹配模式: <span class="badge">${trigger.match_type === 'exact' ? '精确匹配' : '包含匹配'}</span></div>
                        <div>群组ID: ${trigger.chat_id} | 触发次数: <span class="badge info">${trigger.trigger_count}</span></div>
                    </div>
                    <div class="list-item-actions">
                        <button onclick="deleteTrigger(${trigger.id})" class="btn btn-danger btn-small">删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 加载定时任务
        async function loadTasks() {
            tasks = await apiRequest('/api/tasks');
            renderTasks();
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            if (tasks.length === 0) {
                container.innerHTML = '<p>暂无定时任务</p>';
                return;
            }
            
            container.innerHTML = tasks.map(task => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>${task.name}</strong>
                        <div>模板: ${task.template_name || '未关联'}</div>
                        <div>类型: <span class="badge">${getScheduleTypeText(task.schedule_type)}</span> | 时间: ${task.schedule_time}</div>
                        <div>群组ID: ${task.chat_id} | 状态: <span class="badge ${task.active ? 'success' : 'warning'}">${task.active ? '启用' : '暂停'}</span></div>
                    </div>
                    <div class="list-item-actions">
                        <button onclick="deleteTask(${task.id})" class="btn btn-danger btn-small">删除</button>
                    </div>
                </div>
            `).join('');
        }

        function getScheduleTypeText(type) {
            const types = {
                'daily': '每日执行',
                'weekly': '每周执行',
                'cron': '自定义Cron'
            };
            return types[type] || type;
        }

        // 更新下拉选择框
        function updateSelects() {
            // 更新商家选择框
            const merchantSelects = document.querySelectorAll('#buttonMerchant, #testMerchant');
            merchantSelects.forEach(select => {
                const defaultOption = select.id === 'testMerchant' ? '<option value="">请选择商家</option>' : '<option value="">选择商家</option>';
                select.innerHTML = defaultOption + 
                    merchants.map(m => `<option value="${m.id}">${m.teacher_name || '未知商家'}</option>`).join('');
            });

            // 更新模板选择框
            const templateSelects = document.querySelectorAll('#triggerTemplate, #taskTemplate, #testTemplate');
            templateSelects.forEach(select => {
                const defaultOption = select.id === 'testTemplate' ? '<option value="">请选择消息模板</option>' : '<option value="">选择消息模板</option>';
                select.innerHTML = defaultOption + 
                    templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            });
        }

        // 按钮构建器
        function addButtonRow() {
            buttonRowCount++;
            const container = document.getElementById('buttonRows');
            const rowDiv = document.createElement('div');
            rowDiv.className = 'button-row';
            rowDiv.innerHTML = `
                <input type="text" placeholder="按钮文字" class="button-text" style="flex: 1;">
                <input type="text" placeholder="回调数据(可选)" class="button-callback" style="flex: 1;">
                <button type="button" onclick="removeButtonRow(this)" class="btn btn-danger btn-small">删除</button>
            `;
            container.appendChild(rowDiv);
        }

        function removeButtonRow(button) {
            button.parentElement.remove();
        }

        // 预览模板
        function previewTemplate() {
            const name = document.getElementById('templateName').value;
            const content = document.getElementById('templateContent').value;
            const imageUrl = document.getElementById('templateImage').value;
            
            if (!content) {
                showAlert('请输入消息内容', 'error');
                return;
            }

            const previewDiv = document.getElementById('templatePreview');
            const previewContent = document.getElementById('previewContent');
            
            let html = '';
            if (imageUrl) {
                html += `<img src="${imageUrl}" alt="预览图片" onerror="this.style.display='none'"><br>`;
            }
            html += `<div>${content}</div>`;
            
            // 添加按钮预览
            const buttonRows = document.querySelectorAll('#buttonRows .button-row');
            if (buttonRows.length > 0) {
                html += '<div style="margin-top: 10px;">';
                buttonRows.forEach(row => {
                    const text = row.querySelector('.button-text').value;
                    if (text) {
                        html += `<span class="preview-button">${text}</span>`;
                    }
                });
                html += '</div>';
            }
            
            previewContent.innerHTML = html;
            previewDiv.style.display = 'block';
        }

        // 更新调度输入
        function updateScheduleInput() {
            const type = document.getElementById('taskScheduleType').value;
            const input = document.getElementById('taskScheduleTime');
            const label = document.getElementById('scheduleLabel');
            const help = document.getElementById('scheduleHelp');
            
            switch (type) {
                case 'daily':
                    label.textContent = '执行时间';
                    input.placeholder = '09:00';
                    help.textContent = '格式：HH:MM（24小时制）';
                    break;
                case 'weekly':
                    label.textContent = '执行时间';
                    input.placeholder = '1:09:00';
                    help.textContent = '格式：星期:HH:MM（星期1-7，周日为0）';
                    break;
                case 'cron':
                    label.textContent = 'Cron表达式';
                    input.placeholder = '0 9 * * *';
                    help.textContent = '格式：分 时 日 月 周（标准Cron格式）';
                    break;
            }
        }



        // 创建按钮
        async function createButton(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const title = document.getElementById('buttonTitle').value;
                const message = document.getElementById('buttonMessage').value;
                const merchantId = document.getElementById('buttonMerchant').value;
                
                await apiRequest('/api/buttons', 'POST', { title, message, merchantId });
                
                showAlert('按钮创建成功！');
                document.getElementById('buttonTitle').value = '';
                document.getElementById('buttonMessage').value = '';
                document.getElementById('buttonMerchant').value = '';
                
                await loadButtons();
            } catch (error) {
                showAlert('创建失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 创建消息模板
        async function createTemplate(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const name = document.getElementById('templateName').value;
                const content = document.getElementById('templateContent').value;
                const imageUrl = document.getElementById('templateImage').value;
                
                // 收集按钮配置
                const buttonRows = document.querySelectorAll('#buttonRows .button-row');
                const buttonsConfig = [];
                
                if (buttonRows.length > 0) {
                    const currentRow = [];
                    buttonRows.forEach(row => {
                        const text = row.querySelector('.button-text').value;
                        const callback = row.querySelector('.button-callback').value;
                        if (text) {
                            currentRow.push({
                                text: text,
                                callback_data: callback || `template_btn_${text}`
                            });
                        }
                    });
                    if (currentRow.length > 0) {
                        buttonsConfig.push(currentRow);
                    }
                }
                
                await apiRequest('/api/templates', 'POST', {
                    name, content, imageUrl, buttonsConfig
                });
                
                showAlert('模板创建成功！');
                document.getElementById('templateName').value = '';
                document.getElementById('templateContent').value = '';
                document.getElementById('templateImage').value = '';
                document.getElementById('buttonRows').innerHTML = '';
                document.getElementById('templatePreview').style.display = 'none';
                buttonRowCount = 0;
                
                await loadTemplates();
                updateSelects();
            } catch (error) {
                showAlert('创建失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 创建触发词
        async function createTrigger(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const word = document.getElementById('triggerWord').value;
                const templateId = document.getElementById('triggerTemplate').value;
                const matchType = document.getElementById('triggerMatchType').value;
                const chatId = document.getElementById('triggerChatId').value;
                
                await apiRequest('/api/triggers', 'POST', {
                    word, templateId, matchType, chatId
                });
                
                showAlert('触发词创建成功！');
                document.getElementById('triggerWord').value = '';
                document.getElementById('triggerTemplate').value = '';
                document.getElementById('triggerChatId').value = '';
                
                await loadTriggers();
            } catch (error) {
                showAlert('创建失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 创建定时任务
        async function createTask(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const name = document.getElementById('taskName').value;
                const templateId = document.getElementById('taskTemplate').value;
                const chatId = document.getElementById('taskChatId').value;
                const scheduleType = document.getElementById('taskScheduleType').value;
                const scheduleTime = document.getElementById('taskScheduleTime').value;
                
                await apiRequest('/api/tasks', 'POST', {
                    name, templateId, chatId, scheduleType, scheduleTime
                });
                
                showAlert('定时任务创建成功！');
                document.getElementById('taskName').value = '';
                document.getElementById('taskTemplate').value = '';
                document.getElementById('taskChatId').value = '';
                document.getElementById('taskScheduleTime').value = '';
                
                await loadTasks();
            } catch (error) {
                showAlert('创建失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 处理模块类型变化
        function handleModuleTypeChange() {
            const moduleType = document.getElementById('testModuleType').value;
            
            // 隐藏所有模块
            document.getElementById('merchantModule').style.display = 'none';
            document.getElementById('templateModule').style.display = 'none';
            document.getElementById('customModule').style.display = 'none';
            
            // 显示选中的模块
            if (moduleType === 'merchant') {
                document.getElementById('merchantModule').style.display = 'block';
                updateMerchantSelect();
            } else if (moduleType === 'template') {
                document.getElementById('templateModule').style.display = 'block';
            } else if (moduleType === 'custom') {
                document.getElementById('customModule').style.display = 'block';
            }
        }

        // 更新商家选择器
        function updateMerchantSelect() {
            const select = document.getElementById('testMerchant');
            const currentValue = select.value; // 保存当前选中的值
            select.innerHTML = '<option value="">请选择商家</option>';
            
            console.log('🔍 当前商家数据:', merchants);
            
            merchants.forEach(merchant => {
                // 放宽筛选条件：只要有商家名称就可以选择
                if (merchant.teacher_name) {
                    const option = document.createElement('option');
                    option.value = merchant.id;
                    option.textContent = `${merchant.teacher_name} - ${merchant.region_name || '未知地区'}`;
                    select.appendChild(option);
                    console.log(`✅ 添加商家选项: ${merchant.teacher_name} (ID: ${merchant.id})`);
                }
            });
            
            // 如果没有可选商家，显示提示
            if (select.children.length === 1) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '暂无商家数据，请检查商家管理页面';
                option.disabled = true;
                select.appendChild(option);
                console.log('⚠️ 没有找到可用商家');
            } else {
                console.log(`✅ 共添加了 ${select.children.length - 1} 个商家选项`);
            }
            
            // 恢复之前选中的值
            if (currentValue) {
                select.value = currentValue;
                // 如果恢复了选中值，触发预览更新
                handleMerchantChange();
            }
            
            select.onchange = handleMerchantChange;
        }

        // 处理商家选择变化
        function handleMerchantChange() {
            const merchantId = document.getElementById('testMerchant').value;
            const preview = document.getElementById('merchantPreview');
            const content = document.getElementById('merchantPreviewContent');
            
            if (!merchantId) {
                preview.style.display = 'none';
                return;
            }
            
            const merchant = merchants.find(m => m.id == merchantId); // 已经使用松散比较
            if (merchant) {
                // 使用与商家管理页面相同的格式
                const previewText = `地区：#${merchant.region_name || 'xx'}              艺名：${merchant.teacher_name || '未填写'}
优点：${merchant.advantages || '未填写'}
缺点：${merchant.disadvantages || '未填写'}
价格：${merchant.price1 || '未填写'}p              ${merchant.price2 || '未填写'}pp
联系：${merchant.contact || '未填写'}

老师💃自填基本功：
💦洗:${merchant.skill_wash || '未填写'}
👄吹:${merchant.skill_blow || '未填写'}
❤️做:${merchant.skill_do || '未填写'}
🐍吻:${merchant.skill_kiss || '未填写'}`;
                
                content.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${previewText}</pre>`;
                preview.style.display = 'block';
            }
        }

        // 处理模板选择变化
        function handleTemplateChange() {
            const templateId = document.getElementById('testTemplate').value;
            const preview = document.getElementById('templatePreviewTest');
            const content = document.getElementById('templatePreviewTestContent');
            
            if (!templateId) {
                preview.style.display = 'none';
                return;
            }
            
            const template = templates.find(t => t.id == templateId);
            if (template) {
                let previewHtml = `<p><strong>📝 内容：</strong>${template.content}</p>`;
                
                if (template.image_url) {
                    previewHtml += `<p><strong>🖼️ 图片：</strong><img src="${template.image_url}" style="max-width: 200px; max-height: 100px;" /></p>`;
                }
                
                if (template.buttons_config) {
                    try {
                        const buttons = JSON.parse(template.buttons_config);
                        if (buttons.length > 0) {
                            previewHtml += '<p><strong>🔘 按钮：</strong></p>';
                            buttons.forEach(row => {
                                row.forEach(btn => {
                                    previewHtml += `<button style="margin: 2px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px;">${btn.text}</button>`;
                                });
                            });
                        }
                    } catch (e) {
                        console.error('解析按钮配置失败:', e);
                    }
                }
                
                content.innerHTML = previewHtml;
                preview.style.display = 'block';
            }
        }

        // 添加测试按钮行
        let testButtonRowCount = 0;
        function addTestButtonRow() {
            testButtonRowCount++;
            const container = document.getElementById('testButtonRows');
            const row = document.createElement('div');
            row.className = 'button-row';
            row.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            row.innerHTML = `
                <input type="text" class="button-text" placeholder="按钮文字" style="flex: 1;">
                <input type="text" class="button-callback" placeholder="回调数据（可选）" style="flex: 1;">
                <button type="button" onclick="removeTestButtonRow(this)" class="btn btn-danger" style="padding: 5px 10px;">删除</button>
            `;
            container.appendChild(row);
        }

        // 删除测试按钮行
        function removeTestButtonRow(button) {
            button.parentElement.remove();
        }

        // 保存群组ID到本地存储
        function saveChatId(chatId) {
            if (chatId) {
                localStorage.setItem('lastChatId', chatId);
            }
        }

        // 从本地存储加载群组ID
        function loadChatId() {
            const lastChatId = localStorage.getItem('lastChatId');
            if (lastChatId) {
                document.getElementById('testChatId').value = lastChatId;
            }
        }

        // 发送测试消息
        async function sendTestMessage(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const chatId = document.getElementById('testChatId').value;
                const moduleType = document.getElementById('testModuleType').value;
                
                // 保存群组ID
                saveChatId(chatId);
                
                let sendData = { chatId };
                
                if (moduleType === 'merchant') {
                    // 商家信息模式
                    const merchantId = document.getElementById('testMerchant').value;
                    if (!merchantId) {
                        showAlert('请选择商家', 'error');
                        return;
                    }
                    sendData.type = 'merchant';
                    sendData.merchantId = merchantId;
                    
                } else if (moduleType === 'template') {
                    // 消息模板模式
                    const templateId = document.getElementById('testTemplate').value;
                    if (!templateId) {
                        showAlert('请选择消息模板', 'error');
                        return;
                    }
                    sendData.type = 'template';
                    sendData.templateId = templateId;
                    
                } else if (moduleType === 'custom') {
                    // 自定义消息模式
                const message = document.getElementById('testMessage').value;
                    if (!message.trim()) {
                        showAlert('请输入消息内容', 'error');
                        return;
                    }
                    
                    sendData.type = 'custom';
                    sendData.message = message;
                    sendData.imageUrl = document.getElementById('testImageUrl').value;
                    
                    // 收集按钮配置
                    const buttonRows = document.querySelectorAll('#testButtonRows .button-row');
                    const buttonsConfig = [];
                    
                    if (buttonRows.length > 0) {
                        const currentRow = [];
                        buttonRows.forEach(row => {
                            const text = row.querySelector('.button-text').value;
                            const callback = row.querySelector('.button-callback').value;
                            if (text.trim()) {
                                currentRow.push({
                                    text: text.trim(),
                                    callback_data: callback.trim() || `test_btn_${text.trim()}`
                                });
                            }
                        });
                        if (currentRow.length > 0) {
                            buttonsConfig.push(currentRow);
                        }
                    }
                    
                    if (buttonsConfig.length > 0) {
                        sendData.buttonsConfig = buttonsConfig;
                    }
                    
                } else {
                    showAlert('请选择发送模块', 'error');
                    return;
                }
                
                await apiRequest('/api/test-send', 'POST', sendData);
                
                showAlert('测试消息发送成功！');
            } catch (error) {
                showAlert('发送失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 删除操作
        async function deleteButton(id) {
            if (!confirm('确定要删除这个按钮吗？')) return;
            
            try {
                await apiRequest('/api/buttons', 'DELETE', { id });
                showAlert('按钮删除成功！');
                await loadButtons();
            } catch (error) {
                showAlert('删除失败: ' + error.message, 'error');
            }
        }

        async function deleteTemplate(id) {
            if (!confirm('确定要删除这个模板吗？')) return;
            
            try {
                await apiRequest('/api/templates', 'DELETE', { id });
                showAlert('模板删除成功！');
                await loadTemplates();
                updateSelects();
            } catch (error) {
                showAlert('删除失败: ' + error.message, 'error');
            }
        }

        async function deleteTrigger(id) {
            if (!confirm('确定要删除这个触发词吗？')) return;
            
            try {
                await apiRequest('/api/triggers', 'DELETE', { id });
                showAlert('触发词删除成功！');
                await loadTriggers();
            } catch (error) {
                showAlert('删除失败: ' + error.message, 'error');
            }
        }

        async function deleteTask(id) {
            if (!confirm('确定要删除这个定时任务吗？')) return;
            
            try {
                await apiRequest('/api/tasks', 'DELETE', { id });
                showAlert('定时任务删除成功！');
                await loadTasks();
            } catch (error) {
                showAlert('删除失败: ' + error.message, 'error');
            }
        }

        // 复制商家URL链接
        function copyMerchantUrl(url) {
            if (navigator.clipboard && window.isSecureContext) {
                // 现代浏览器支持Clipboard API
                navigator.clipboard.writeText(url).then(() => {
                    showAlert('链接已复制到剪贴板！', 'success');
                }).catch(err => {
                    console.error('复制失败:', err);
                    fallbackCopyTextToClipboard(url);
                });
            } else {
                // 旧浏览器的回退方案
                fallbackCopyTextToClipboard(url);
            }
        }

        // 回退的复制方法
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // 避免在屏幕上显示
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.width = "2em";
            textArea.style.height = "2em";
            textArea.style.padding = "0";
            textArea.style.border = "none";
            textArea.style.outline = "none";
            textArea.style.boxShadow = "none";
            textArea.style.background = "transparent";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showAlert('链接已复制到剪贴板！', 'success');
                } else {
                    showAlert('复制失败，请手动复制链接', 'error');
                }
            } catch (err) {
                console.error('Fallback: 复制失败', err);
                showAlert('复制失败，请手动复制链接', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // 测试商家URL链接
        function openMerchantUrl(url) {
            window.open(url, '_blank');
            showAlert('已在新窗口打开测试链接', 'info');
        }

        // 初始化按钮构建器
        addButtonRow();

        // 新增商家模态框
        function openNewMerchantModal() {
            document.getElementById('newMerchantModal').style.display = 'block';
        }

        // 关闭新增商家模态框
        function closeNewMerchantModal() {
            document.getElementById('newMerchantModal').style.display = 'none';
        }

        // 创建新商家 - 强制要求商家名称和用户名
        async function createNewMerchant(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const name = document.getElementById('newMerchantName').value.trim();
                const username = document.getElementById('newMerchantUsername').value.trim();
                const bindCode = document.getElementById('newMerchantBindCode').value.trim();
                
                // 强制验证必填字段
                if (!name) {
                    throw new Error('商家名称不能为空！');
                }
                if (!username) {
                    throw new Error('用户名不能为空！');
                }
                
                // 验证用户名格式
                if (username.includes('@')) {
                    throw new Error('用户名不需要包含@符号，请直接输入用户名');
                }
                if (username.length < 3) {
                    throw new Error('用户名长度不能少于3个字符');
                }
                
                const requestData = {
                    teacher_name: name,
                    username: username
                };
                
                // 如果有绑定码，包含在请求中
                if (bindCode) {
                    requestData.bind_code = bindCode;
                }
                
                const response = await apiRequest('/api/merchants', 'POST', requestData);
                
                let message = '新商家创建成功！';
                if (response.bindCode) {
                    message += `\n绑定码：${response.bindCode}`;
                }
                
                // 显示自动检测结果
                if (response.detectedUserId) {
                    message += `\n✅ 已自动检测到Telegram ID: ${response.detectedUserId}`;
                    message += '\n商家现在可以直接收到预约通知！';
                } else {
                    message += '\n⚠️ 未能自动检测到Telegram ID';
                    message += '\n商家需要使用绑定码主动绑定才会收到通知。';
                }
                
                showAlert(message, response.detectedUserId ? 'success' : 'warning');
                closeNewMerchantModal();
                
                // 清空表单
                document.getElementById('newMerchantName').value = '';
                document.getElementById('newMerchantUsername').value = '';
                document.getElementById('newMerchantBindCode').value = '';
                
                await loadMerchants();
                await loadBindCodes(); // 刷新绑定码列表
            } catch (error) {
                showAlert('创建新商家失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 生成绑定码
        async function generateBindCodeForNewMerchant() {
            try {
                showLoading();
                const name = document.getElementById('newMerchantName').value;
                const username = document.getElementById('newMerchantUsername').value;
                
                if (!name || !username) {
                    showAlert('请先填写商家名称和用户名', 'error');
                    return;
                }
                
                console.log('正在生成绑定码...');
                const response = await apiRequest('/api/bind-codes', 'POST', {
                    description: `管理员创建: ${name} (@${username})`
                });
                
                console.log('API响应:', response);
                
                // 兼容不同的响应格式
                let bindCode = null;
                if (response && response.success && response.data && response.data.code) {
                    bindCode = response.data.code;
                } else if (response && response.code) {
                    bindCode = response.code;
                } else {
                    console.error('响应格式错误:', response);
                    throw new Error('生成绑定码失败：服务器响应格式错误');
                }
                
                document.getElementById('newMerchantBindCode').value = bindCode;
                showAlert('绑定码生成成功！');
                
            } catch (error) {
                console.error('生成绑定码失败:', error);
                showAlert('生成绑定码失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 刷新所有商家关注状态
        async function refreshFollowStatus() {
            try {
                showLoading();
                
                if (merchants.length === 0) {
                    showAlert('没有商家数据需要检查', 'warning');
                    return;
                }
                
                // 获取所有商家ID
                const merchantIds = merchants.map(m => m.id);
                
                // 调用API检查关注状态
                const response = await apiRequest('/api/merchants/check-follow-status', 'POST', {
                    merchantIds: merchantIds
                });
                
                if (response.success) {
                    // 更新商家数据中的关注状态
                    merchants.forEach(merchant => {
                        if (response.result[merchant.id]) {
                            merchant.followStatus = response.result[merchant.id];
                        }
                    });
                    
                    // 重新渲染商家列表
                    renderMerchants();
                    
                    // 统计关注情况
                    const followedCount = merchants.filter(m => m.followStatus && m.followStatus.followed).length;
                    const totalCount = merchants.length;
                    
                    showAlert(`关注状态刷新完成！\n已关注: ${followedCount}/${totalCount} 个商家`);
                } else {
                    throw new Error(response.message || '检查关注状态失败');
                }
            } catch (error) {
                showAlert('刷新关注状态失败: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 刷新单个商家关注状态
        async function refreshSingleMerchantFollowStatus(merchantId) {
            try {
                showLoading();
                
                const merchant = merchants.find(m => m.id == merchantId);
                if (!merchant) {
                    showAlert('商家不存在', 'error');
                    return;
                }
                
                // 调用API检查单个商家的关注状态
                const response = await apiRequest('/api/merchants/check-follow-status', 'POST', {
                    merchantIds: [merchantId]
                });
                
                if (response.success && response.result[merchantId]) {
                    // 更新该商家的关注状态
                    merchant.followStatus = response.result[merchantId];
                    
                    // 重新渲染商家列表
                    renderMerchants();
                    
                    // 显示检测结果
                    const status = merchant.followStatus.followed ? '已关注机器人' : '未关注机器人';
                    const reason = merchant.followStatus.reason ? ` (${merchant.followStatus.reason})` : '';
                    showAlert(`商家 ${merchant.teacher_name} 的关注状态：${status}${reason}`, 
                             merchant.followStatus.followed ? 'success' : 'warning');
                } else {
                    throw new Error(response.message || '检查关注状态失败');
                }
            } catch (error) {
                showAlert(`检测商家关注状态失败: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // 测试单个商家详细关注状态（调试用）
        async function testSingleMerchantFollowStatus(merchantId) {
            try {
                showLoading();
                
                const merchant = merchants.find(m => m.id == merchantId);
                if (!merchant) {
                    showAlert('商家不存在', 'error');
                    return;
                }
                
                console.log(`🔍 开始测试商家 ${merchant.teacher_name} (${merchant.username}) 的详细关注状态...`);
                
                // 调用详细测试API
                const response = await apiRequest('/api/merchants/test-follow-status', 'POST', {
                    merchantId: merchantId
                });
                
                if (response.success) {
                    const data = response.result;
                    
                    console.log('📊 详细测试结果:', data);
                    
                    // 构建详细信息显示
                    let message = `商家详细关注状态测试结果：\n\n`;
                    message += `商家信息：\n`;
                    message += `- ID: ${data.merchant_info.id}\n`;
                    message += `- 艺名: ${data.merchant_info.teacher_name}\n`;
                    message += `- 用户名: ${data.merchant_info.username}\n`;
                    message += `- 绑定的Telegram ID: ${data.merchant_info.user_id || '未绑定'}\n\n`;
                    
                    message += `关注状态：\n`;
                    message += `- 状态: ${data.follow_status.followed ? '✅ 已关注' : '❌ 未关注'}\n`;
                    if (data.follow_status.reason) {
                        message += `- 原因: ${data.follow_status.reason}\n`;
                    }
                    if (data.follow_status.last_status) {
                        message += `- 最近状态: ${data.follow_status.last_status}\n`;
                    }
                    
                    if (data.user_record) {
                        message += `\n用户记录：\n`;
                        message += `- Telegram ID: ${data.user_record.user_id}\n`;
                        message += `- 真实用户名: ${data.user_record.username}\n`;
                        message += `- 姓名: ${data.user_record.first_name || ''} ${data.user_record.last_name || ''}\n`;
                        message += `- 交互次数: ${data.interaction_count}\n`;
                        
                        if (data.recent_status_updates && data.recent_status_updates.length > 0) {
                            message += `\n最近状态更新：\n`;
                            data.recent_status_updates.forEach((update, index) => {
                                const date = new Date(update.timestamp * 1000).toLocaleString();
                                message += `${index + 1}. ${update.action_type} - ${date}\n`;
                            });
                        }
                    } else {
                        message += `\n❌ 未找到用户交互记录\n`;
                        message += `这意味着用户名 @${data.merchant_info.username} 从未与机器人交互过。\n`;
                    }
                    
                    // 添加建议
                    message += `\n💡 建议：\n`;
                    if (!data.user_record) {
                        message += `1. 请确认用户名 @${data.merchant_info.username} 是否正确\n`;
                        message += `2. 让商家主动发送 /start 命令给机器人\n`;
                        message += `3. 商家需要先关注机器人才能收到通知\n`;
                    } else if (!data.follow_status.followed) {
                        if (data.follow_status.reason === '用户已屏蔽机器人') {
                            message += `1. 商家已屏蔽机器人，需要重新启动机器人\n`;
                            message += `2. 让商家在Telegram中搜索机器人并点击"开始"按钮\n`;
                        } else {
                            message += `1. 让商家发送 /start 命令给机器人\n`;
                            message += `2. 确保商家与机器人有过有效交互\n`;
                        }
                    } else {
                        message += `✅ 商家状态正常，可以正常接收预约通知！\n`;
                    }
                    
                    // 根据状态选择alert类型
                    const alertType = data.follow_status.followed ? 'success' : 'warning';
                    showAlert(message, alertType);
                    
                } else {
                    throw new Error(response.message || '测试失败');
                }
            } catch (error) {
                console.error('测试商家详细状态失败:', error);
                showAlert(`测试失败: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // 设置拖拽上传功能
        function setupImageDragDrop() {
            const dropZone = document.getElementById('imageDropZone');
            if (!dropZone) return;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#007bff';
                dropZone.style.backgroundColor = '#f8f9fa';
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ccc';
                dropZone.style.backgroundColor = 'transparent';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ccc';
                dropZone.style.backgroundColor = 'transparent';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const fileInput = document.getElementById('editImageFile');
                    fileInput.files = files;
                    handleImageFileUpload({ target: { files: files } });
                }
            });
        }

        // 页面加载完成后初始化数据
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            setupImageDragDrop();
        });
    </script>
</body>
</html> 