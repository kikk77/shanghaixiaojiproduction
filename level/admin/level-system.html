<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>等级系统管理中心</title>
    <link rel="stylesheet" href="/level/admin/styles/level-system.css">
    <style>
        /* 基础样式 */
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 系统状态 */
        .system-status {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-enabled { background: #d4edda; color: #155724; padding: 5px 10px; border-radius: 3px; }
        .status-disabled { background: #f8d7da; color: #721c24; padding: 5px 10px; border-radius: 3px; }
        
        /* 标签页 */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            border-radius: 5px 5px 0 0;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .tab:hover { background: #e9ecef; }
        .tab.active { background: #2196F3; color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* 表单样式 */
        .form-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 15px 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary { background: #2196F3; color: white; }
        .btn-primary:hover { background: #1976D2; }
        
        .btn-success { background: #4CAF50; color: white; }
        .btn-success:hover { background: #388E3C; }
        
        .btn-warning { background: #FF9800; color: white; }
        .btn-warning:hover { background: #F57C00; }
        
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #D32F2F; }
        
        /* 表格样式 */
        .config-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .config-table th,
        .config-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .config-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .config-table tr:hover {
            background: #f5f5f5;
        }
        
        /* 警告框 */
        .warning-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        
        /* 成功框 */
        .success-box {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }
        
        /* 信息框 */
        .info-box {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #17a2b8;
        }
        
        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2196F3;
        }
        
        /* 勋章样式 */
        .badge-item {
            display: inline-block;
            background: #fff3cd;
            padding: 8px 12px;
            margin: 5px;
            border-radius: 20px;
            border: 1px solid #ffeaa7;
        }
        
        .badge-rarity-common { background: #e0e0e0; }
        .badge-rarity-rare { background: #bbdefb; }
        .badge-rarity-epic { background: #ce93d8; }
        .badge-rarity-legendary { background: #ffcc80; }
        
        /* 模态框 */
        .modal, [class*="modal"], .popup, .dialog, .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            text-align: center;
        }
        
        .modal:before, [class*="modal"]:before, .popup:before, .dialog:before, .overlay:before {
            content: '';
            display: inline-block;
            height: 100%;
            vertical-align: middle;
        }
        
        .modal-content, [class*="modal"] > div, .popup > div, .dialog > div, .overlay > div {
            display: inline-block;
            vertical-align: middle;
            background: white;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            text-align: left;
        }
        
        .modal-close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        /* 变量按钮 */
        .variable-btn {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .variable-btn:hover {
            background: #bbdefb;
        }
        
        /* 预览框 */
        .preview-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>🏆 等级系统管理中心</h1>
        
        <!-- 系统状态 -->
        <div class="system-status">
            <div>
                <strong>等级系统状态：</strong>
                <span id="systemStatus" class="status-enabled">已启用</span>
                <span style="margin-left: 20px;">数据库：level_system.db</span>
            </div>
            <button class="btn btn-warning" onclick="toggleLevelSystem()">切换状态</button>
        </div>
        
        <!-- 统计概览 -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>👥 总用户数</h3>
                <div class="stat-value" id="totalUsers">-</div>
            </div>
            <div class="stat-card">
                <h3>🏆 总积分发放</h3>
                <div class="stat-value" id="totalPoints">-</div>
            </div>
            <div class="stat-card">
                <h3>⭐ 平均等级</h3>
                <div class="stat-value" id="avgLevel">-</div>
            </div>
            <div class="stat-card">
                <h3>🎖️ 勋章总数</h3>
                <div class="stat-value" id="totalBadges">-</div>
            </div>
        </div>
        
        <!-- 标签页 -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('users')">👥 用户管理</button>
            <button class="tab" onclick="switchTab('levels')">⭐ 等级配置</button>
            <button class="tab" onclick="switchTab('rewards')">🎁 奖励规则</button>
            <button class="tab" onclick="switchTab('badges')">🏆 勋章管理</button>
            <button class="tab" onclick="switchTab('broadcast')">📢 播报配置</button>
            <button class="tab" onclick="switchTab('groups')">👥 群组管理</button>
            <button class="tab" onclick="switchTab('data')">💾 数据管理</button>
        </div>
        
        <!-- 用户管理 -->
        <div id="users-tab" class="tab-content active">
            <div class="form-section">
                <h2>🔍 用户搜索</h2>
                <div class="form-grid">
                    <div>
                        <input type="text" id="userSearchInput" placeholder="输入用户ID或显示名称">
                        <button class="btn btn-primary" onclick="searchUser()">搜索</button>
                    </div>
                </div>
                
                <div id="userSearchResult" style="display: none;">
                    <!-- 搜索结果将显示在这里 -->
                </div>
            </div>
            
            <div class="form-section">
                <h2>📊 用户排行榜</h2>
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>用户</th>
                            <th>等级</th>
                            <th>经验值</th>
                            <th>积分</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="userRankingBody">
                        <tr><td colspan="6" style="text-align: center;">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 等级配置 -->
        <div id="levels-tab" class="tab-content">
            <div class="form-section">
                <h2>⚙️ 等级配置管理</h2>
                
                <div class="form-group">
                    <label>选择群组：</label>
                    <select id="levelGroupSelect" onchange="loadGroupLevelConfig()">
                        <option value="default">默认群组</option>
                    </select>
                    <button class="btn btn-success" onclick="createNewGroup()">创建新群组</button>
                </div>
                
                <table class="config-table" id="levelConfigTable">
                    <thead>
                        <tr>
                            <th>等级</th>
                            <th>等级名称</th>
                            <th>所需经验值</th>
                            <th>所需评价次数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="levelConfigBody">
                        <!-- 动态生成 -->
                    </tbody>
                </table>
                
                <button class="btn btn-primary" onclick="addLevelRow()">➕ 添加等级</button>
                <button class="btn btn-success" onclick="saveLevelConfig()">💾 保存配置</button>
                <button class="btn btn-warning" onclick="resetLevelConfig()">🔄 重置为默认</button>
            </div>
        </div>
        
        <!-- 奖励规则 -->
        <div id="rewards-tab" class="tab-content">
            <div class="form-section">
                <h2>🎁 奖励规则配置</h2>
                
                <h3>基础奖励（经验值 + 积分）</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>🎯 完成出击</label>
                        <input type="number" id="attackExp" placeholder="经验值" value="20">
                        <input type="number" id="attackPoints" placeholder="积分" value="10">
                    </div>
                    <div class="form-group">
                        <label>📝 12项评价</label>
                        <input type="number" id="userEvalExp" placeholder="经验值" value="30">
                        <input type="number" id="userEvalPoints" placeholder="积分" value="25">
                    </div>
                    <div class="form-group">
                        <label>🏪 商家评价</label>
                        <input type="number" id="merchantEvalExp" placeholder="经验值" value="25">
                        <input type="number" id="merchantEvalPoints" placeholder="积分" value="20">
                    </div>
                    <div class="form-group">
                        <label>✍️ 文字评价</label>
                        <input type="number" id="textEvalExp" placeholder="经验值" value="15">
                        <input type="number" id="textEvalPoints" placeholder="积分" value="15">
                    </div>
                </div>
                
                <h3>特殊奖励</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>💯 满分奖励</label>
                        <input type="number" id="perfectScoreExp" placeholder="额外经验值" value="50">
                        <input type="number" id="perfectScorePoints" placeholder="额外积分" value="100">
                    </div>
                    <div class="form-group">
                        <label>🎊 升级奖励</label>
                        <input type="number" id="levelUpPoints" placeholder="奖励积分" value="50">
                    </div>
                </div>
                
                <h3>奖励倍数</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>经验值倍数</label>
                        <input type="number" id="expMultiplier" step="0.1" value="1.0">
                    </div>
                    <div class="form-group">
                        <label>积分倍数</label>
                        <input type="number" id="pointsMultiplier" step="0.1" value="1.0">
                    </div>
                    <div class="form-group">
                        <label>周末奖励倍数</label>
                        <input type="number" id="weekendBonus" step="0.1" value="1.2">
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveRewardsConfig()">💾 保存奖励配置</button>
            </div>
        </div>
        
        <!-- 勋章管理 -->
        <div id="badges-tab" class="tab-content">
            <div class="form-section">
                <h2>🏆 勋章管理</h2>
                
                <button class="btn btn-primary" onclick="showCreateBadgeModal()">➕ 创建新勋章</button>
                
                <div id="badgesList" style="margin-top: 20px;">
                    <!-- 勋章列表 -->
                </div>
            </div>
        </div>
        
        <!-- 播报配置 -->
        <div id="broadcast-tab" class="tab-content">
            <div class="form-section">
                <h2>📢 播报配置</h2>
                
                <h3>播报开关</h3>
                <div class="form-grid">
                    <label><input type="checkbox" id="enableLevelUp" checked> 升级播报</label>
                    <label><input type="checkbox" id="enableBadgeUnlock" checked> 勋章解锁播报</label>
                    <label><input type="checkbox" id="enableMilestone"> 里程碑播报</label>
                    <label><input type="checkbox" id="enablePerfectScore"> 满分播报</label>
                </div>
                
                <h3>播报模板</h3>
                <div class="form-group">
                    <label>升级播报模板：</label>
                    <textarea id="levelUpTemplate" rows="5">🎉 恭喜 {{user_name}} 升级了！
⭐ Lv.{{old_level}} → Lv.{{new_level}} {{level_name}}
💎 升级奖励：{{level_up_points}}积分
继续努力，成为传说勇士！💪</textarea>
                    <div class="variable-list">
                        可用变量：
                        <button class="variable-btn" onclick="insertVariable('levelUpTemplate', '{{user_name}}')">{{user_name}}</button>
                        <button class="variable-btn" onclick="insertVariable('levelUpTemplate', '{{old_level}}')">{{old_level}}</button>
                        <button class="variable-btn" onclick="insertVariable('levelUpTemplate', '{{new_level}}')">{{new_level}}</button>
                        <button class="variable-btn" onclick="insertVariable('levelUpTemplate', '{{level_name}}')">{{level_name}}</button>
                        <button class="variable-btn" onclick="insertVariable('levelUpTemplate', '{{level_up_points}}')">{{level_up_points}}</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>勋章解锁模板：</label>
                    <textarea id="badgeUnlockTemplate" rows="4">🏆 {{user_name}} 解锁了新勋章！
{{badge_emoji}} {{badge_name}}
{{badge_desc}}</textarea>
                    <div class="variable-list">
                        可用变量：
                        <button class="variable-btn" onclick="insertVariable('badgeUnlockTemplate', '{{user_name}}')">{{user_name}}</button>
                        <button class="variable-btn" onclick="insertVariable('badgeUnlockTemplate', '{{badge_emoji}}')">{{badge_emoji}}</button>
                        <button class="variable-btn" onclick="insertVariable('badgeUnlockTemplate', '{{badge_name}}')">{{badge_name}}</button>
                        <button class="variable-btn" onclick="insertVariable('badgeUnlockTemplate', '{{badge_desc}}')">{{badge_desc}}</button>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveBroadcastConfig()">💾 保存播报配置</button>
                <button class="btn btn-primary" onclick="testBroadcast()">🧪 测试播报</button>
            </div>
        </div>
        
        <!-- 群组管理 -->
        <div id="groups-tab" class="tab-content">
            <div class="form-section">
                <h2>👥 群组管理</h2>
                
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>群组ID</th>
                            <th>群组名称</th>
                            <th>用户数</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="groupsTableBody">
                        <tr><td colspan="5" style="text-align: center;">加载中...</td></tr>
                    </tbody>
                </table>
                
                <button class="btn btn-primary" onclick="showCreateGroupModal()">➕ 创建新群组</button>
            </div>
        </div>
        
        <!-- 数据管理 -->
        <div id="data-tab" class="tab-content">
            <div class="form-section">
                <h2>💾 数据管理</h2>
                
                <div class="info-box">
                    <p><strong>数据库文件：</strong>level_system.db</p>
                    <p><strong>数据库大小：</strong><span id="dbSize">-</span></p>
                    <p><strong>最后更新：</strong><span id="lastUpdate">-</span></p>
                </div>
                
                <h3>数据导出</h3>
                <div class="form-grid">
                    <button class="btn btn-primary" onclick="exportAllData()">📤 导出完整数据</button>
                    <button class="btn btn-primary" onclick="exportUserData()">👥 导出用户数据</button>
                    <button class="btn btn-primary" onclick="exportConfig()">⚙️ 导出配置</button>
                </div>
                
                <h3>数据导入</h3>
                <div class="warning-box">
                    ⚠️ 导入数据会覆盖现有数据，请谨慎操作！
                </div>
                <input type="file" id="importFile" accept=".json">
                <button class="btn btn-warning" onclick="importData()">📥 导入数据</button>
                
                <h3>群组迁移</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>源群组：</label>
                        <select id="sourceGroup">
                            <option value="">选择源群组</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>目标群组ID：</label>
                        <input type="text" id="targetGroupId" placeholder="-1001234567890">
                    </div>
                </div>
                <button class="btn btn-warning" onclick="migrateGroup()">🔄 迁移群组</button>
            </div>
        </div>
    </div>
    
    <!-- 创建勋章模态框 -->
    <div id="createBadgeModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('createBadgeModal')">&times;</span>
            <h2>✨ 创建新勋章</h2>
            
            <div class="form-group">
                <label>勋章ID：</label>
                <input type="text" id="newBadgeId" placeholder="例如：perfect_warrior">
            </div>
            
            <div class="form-group">
                <label>勋章名称：</label>
                <input type="text" id="newBadgeName" placeholder="例如：完美战士">
            </div>
            
            <div class="form-group">
                <label>勋章图标：</label>
                <input type="text" id="newBadgeEmoji" placeholder="例如：🏆" value="🏆">
            </div>
            
            <div class="form-group">
                <label>勋章描述：</label>
                <textarea id="newBadgeDesc" placeholder="例如：连续10次获得满分评价"></textarea>
            </div>
            
            <div class="form-group">
                <label>稀有度：</label>
                <select id="newBadgeRarity">
                    <option value="common">普通 ⚪</option>
                    <option value="rare">稀有 🔵</option>
                    <option value="epic">史诗 🟣</option>
                    <option value="legendary">传说 🟡</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>解锁条件类型：</label>
                <select id="badgeConditionType" onchange="updateConditionForm()">
                    <option value="stat_based">基于统计数据</option>
                    <option value="evaluation_streak">评价连击</option>
                    <option value="manual">手动授予</option>
                </select>
            </div>
            
            <div id="conditionDetails">
                <!-- 动态生成条件表单 -->
            </div>
            
            <button class="btn btn-success" onclick="createBadge()">创建勋章</button>
        </div>
    </div>
    
    <!-- 创建群组模态框 -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('createGroupModal')">&times;</span>
            <h2>➕ 创建新群组</h2>
            
            <div class="form-group">
                <label>群组ID：</label>
                <input type="text" id="newGroupId" placeholder="例如：-1001234567890">
                <small style="display: block; color: #666;">请输入Telegram群组ID（通常以-100开头）</small>
            </div>
            
            <div class="form-group">
                <label>群组名称：</label>
                <input type="text" id="newGroupName" placeholder="例如：测试群组">
            </div>
            
            <button class="btn btn-success" onclick="createGroup()">创建群组</button>
        </div>
    </div>
    
    <!-- 用户详情模态框 -->
    <div id="userDetailModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('userDetailModal')">&times;</span>
            <h2>👤 用户详情</h2>
            
            <div id="userDetailContent">
                <!-- 用户详情内容 -->
            </div>
            
            <h3>调整等级数据</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>经验值调整：</label>
                    <input type="number" id="adjustExp" placeholder="正数增加，负数减少">
                </div>
                <div class="form-group">
                    <label>积分调整：</label>
                    <input type="number" id="adjustPoints" placeholder="正数增加，负数减少">
                </div>
            </div>
            <div class="form-group">
                <label>调整原因：</label>
                <input type="text" id="adjustReason" placeholder="请输入调整原因">
            </div>
            <button class="btn btn-warning" onclick="adjustUserData()">执行调整</button>
            
            <h3>授予勋章</h3>
            <div class="form-group">
                <select id="awardBadgeSelect">
                    <option value="">选择勋章</option>
                </select>
                <button class="btn btn-success" onclick="awardBadge()">授予勋章</button>
            </div>
        </div>
    </div>
    
    <!-- 消息容器 -->
    <div id="messageContainer"></div>
    
    <script src="/level/admin/level-system.js"></script>
</body>
</html> 