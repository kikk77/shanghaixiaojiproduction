# å°é¸¡ç®¡å®¶ç­‰çº§ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ï¼ˆå®Œæ•´ç‰ˆBï¼‰

## ðŸŽ¯ ç‰ˆæœ¬Aæ ¸å¿ƒå‰æï¼ˆä¸å¯è¿èƒŒçš„è®¾è®¡åŽŸåˆ™ï¼‰

### ðŸ”’ å®Œå…¨ç‹¬ç«‹åŽŸåˆ™
- **ç‹¬ç«‹æ•°æ®åº“**ï¼šä½¿ç”¨ç‹¬ç«‹çš„ `level_system.db` æ–‡ä»¶ï¼Œä¸ŽçŽ°æœ‰ç”Ÿäº§æ•°æ®å®Œå…¨éš”ç¦»
- **ç‹¬ç«‹æœåŠ¡**ï¼šåˆ›å»ºç‹¬ç«‹çš„ç­‰çº§æœåŠ¡æ¨¡å—ï¼Œä¸ä¿®æ”¹çŽ°æœ‰ä»£ç 
- **é›¶ç ´åæ€§**ï¼šç»ä¸ä¿®æ”¹çŽ°æœ‰æ•°æ®åº“ç»“æž„å’Œæ•°æ®
- **å¯é€†é›†æˆ**ï¼šå¯éšæ—¶ç¦ç”¨æˆ–å¸è½½ï¼Œä¸å½±å“çŽ°æœ‰åŠŸèƒ½

### ðŸš‚ Railwayéƒ¨ç½²å…¼å®¹
- **Volumeæ”¯æŒ**ï¼šå®Œå…¨å…¼å®¹Railway VolumeæŒ‚è½½
- **çŽ¯å¢ƒå˜é‡æŽ§åˆ¶**ï¼šé€šè¿‡çŽ¯å¢ƒå˜é‡æŽ§åˆ¶å¯ç”¨/ç¦ç”¨
- **è‡ªåŠ¨å‘çŽ°æ•°æ®è·¯å¾„**ï¼šè‡ªåŠ¨é€‚åº”ç”Ÿäº§/æµ‹è¯•çŽ¯å¢ƒ

### ðŸ”Œ çŽ°æœ‰æŽ¥å£å¤ç”¨
- **å¤ç”¨BotæœåŠ¡**ï¼šä½¿ç”¨çŽ°æœ‰çš„ `botService.js` æ’­æŠ¥æ–¹æ³•
- **å¤ç”¨æ•°æ®åº“æ“ä½œ**ï¼šä½¿ç”¨çŽ°æœ‰çš„ `dbOperations.js` æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
- **æœ€å°åŒ–ä¿®æ”¹**ï¼šçŽ°æœ‰ä»£ç ä»…æ·»åŠ äº‹ä»¶è§¦å‘ï¼Œå…¶ä½™å®Œå…¨ä¸å˜

---

## é¡¹ç›®æ¦‚è¿°

åŸºäºŽçŽ°æœ‰çš„å°é¸¡ç®¡å®¶Telegramæœºå™¨äººç³»ç»Ÿï¼Œè®¾è®¡å¹¶å®žçŽ°ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·ç­‰çº§ç³»ç»Ÿã€‚**ä¸¥æ ¼éµå¾ªç‰ˆæœ¬Açš„ç‹¬ç«‹åŽŸåˆ™**ï¼Œä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“æ–‡ä»¶ï¼Œä¸ŽçŽ°æœ‰ç³»ç»Ÿæ— ç¼é›†æˆä½†å®Œå…¨éš”ç¦»ã€‚

## å½“å‰ç³»ç»Ÿåˆ†æž

### 1. çŽ°æœ‰æž¶æž„ç‰¹ç‚¹
- **å¤šæ•°æ®åº“æž¶æž„**ï¼šcore.dbï¼ˆæ ¸å¿ƒæ•°æ®ï¼‰ã€templates.dbï¼ˆæ¨¡æ¿é…ç½®ï¼‰ã€users_YYYY_MM.dbï¼ˆç”¨æˆ·æ•°æ®ï¼‰
- **EAVæ•°æ®æ¨¡åž‹**ï¼šçµæ´»çš„å®žä½“-å±žæ€§-å€¼å­˜å‚¨æ¨¡å¼
- **è¯„ä»·ç³»ç»Ÿ**ï¼šç”¨æˆ·è¯„ä»·å•†å®¶12é¡¹è¯„åˆ†ï¼Œå•†å®¶è¯„ä»·ç”¨æˆ·3é¡¹è¯„åˆ†
- **ç”¨æˆ·æ ‡è¯†**ï¼šåŸºäºŽTelegram IDï¼ˆå”¯ä¸€ä¸å˜ï¼‰å’Œusernameï¼ˆå¯å˜ï¼‰

### 2. çŽ°æœ‰æŸ¥è¯¢æ–¹å¼
- **EAVæŸ¥è¯¢**ï¼š`getEntity(entityKey, schemaName)`ã€`getBatchEntities(entityKeys, schemaName)`
- **é«˜æ€§èƒ½ç´¢å¼•**ï¼š`idx_eav_entity_schema`ã€`idx_eav_field_value`
- **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒäº‹åŠ¡å’Œå¹¶å‘æŸ¥è¯¢

## ç­‰çº§ç³»ç»Ÿè®¾è®¡

### 1. æ ¸å¿ƒéœ€æ±‚
1. **ç­‰çº§ç³»ç»Ÿ**ï¼šç”±ç»éªŒå€¼é©±åŠ¨ï¼Œç»éªŒå€¼æ°¸ä¸æ¶ˆè´¹ï¼Œè‡ªåŠ¨å‡çº§
2. **ç§¯åˆ†ç³»ç»Ÿ**ï¼šå®Œå…¨ç‹¬ç«‹çš„"é‡‘å¸"ç³»ç»Ÿï¼Œå¯æ¶ˆè´¹ï¼Œæ”¯æŒæœªæ¥æŠ½å¥–åŠŸèƒ½
3. **åŒé‡å¥–åŠ±**ï¼šæ‰€æœ‰è¡Œä¸ºåŒæ—¶èŽ·å¾—ç»éªŒå€¼å’Œç§¯åˆ†ï¼Œæ•°é¢å¯ç‹¬ç«‹é…ç½®
4. **å‹‹ç« æˆå°±ç³»ç»Ÿ**ï¼šåŸºäºŽè¯„ä»·æ•°æ®è§¦å‘ç‰¹æ®Šæˆå°±ï¼Œç®¡ç†å‘˜å¯è‡ªå®šä¹‰
5. **èŽ·å–æ–¹å¼ç»Ÿä¸€**ï¼šå‡ºå‡»ã€12é¡¹è¯„ä»·ã€å•†å®¶è¯„ä»·ã€æ–‡å­—è¯„ä»·ã€ç®¡ç†å‘˜è°ƒæ•´
6. **å¤šç¾¤ç®¡ç†**ï¼šæ¯ä¸ªç¾¤ç‹¬ç«‹é…ç½®ï¼Œæ”¯æŒæ•°æ®è¿ç§»
7. **å®Œæ•´ç®¡ç†æƒé™**ï¼šç®¡ç†å‘˜å¯é…ç½®æ‰€æœ‰è§„åˆ™ã€æ‰‹åŠ¨è°ƒæ•´ã€ç®¡ç†å‹‹ç« 

### 2. ç‹¬ç«‹æ•°æ®åº“æž¶æž„ï¼ˆéµå¾ªç‰ˆæœ¬Aè®¾è®¡ï¼‰

#### 2.1 ç‹¬ç«‹æ•°æ®åº“é…ç½®ï¼ˆåŸºäºŽç‰ˆæœ¬Aï¼‰
```javascript
// config/levelDatabase.js - å®Œå…¨ç‹¬ç«‹çš„ç­‰çº§ç³»ç»Ÿæ•°æ®åº“
// åŸºäºŽç‰ˆæœ¬Açš„è®¾è®¡åŽŸåˆ™ï¼Œç¡®ä¿å®Œå…¨éš”ç¦»
class LevelDatabaseManager {
    constructor() {
        // ä½¿ç”¨ä¸ŽçŽ°æœ‰ç³»ç»Ÿç›¸åŒçš„è·¯å¾„é€»è¾‘ï¼Œä½†ç‹¬ç«‹çš„æ•°æ®åº“æ–‡ä»¶
        const nodeEnv = process.env.NODE_ENV || process.env.RAILWAY_ENVIRONMENT_NAME || 'development';
        const isProduction = nodeEnv === 'production';
        const isStaging = nodeEnv === 'staging';
        
        // æ•°æ®ç›®å½•è·¯å¾„ï¼ˆä¸ŽçŽ°æœ‰ç³»ç»Ÿä¸€è‡´ï¼‰
        let dataDir;
        if (isProduction || isStaging) {
            const volumeDataDir = process.env.RAILWAY_VOLUME_MOUNT_PATH || '/app/data';
            const localDataDir = path.join(__dirname, '..', 'data');
            
            try {
                if (fs.existsSync(volumeDataDir)) {
                    fs.accessSync(volumeDataDir, fs.constants.W_OK);
                    dataDir = volumeDataDir;
                } else {
                    throw new Error('Volumeç›®å½•ä¸å­˜åœ¨');
                }
            } catch (error) {
                dataDir = localDataDir;
            }
        } else {
            dataDir = path.join(__dirname, '..', 'data');
        }
        
        // ç‹¬ç«‹çš„ç­‰çº§ç³»ç»Ÿæ•°æ®åº“æ–‡ä»¶
        const dbFileName = isProduction ? 'level_system.db' : 'level_system_dev.db';
        this.dbPath = path.join(dataDir, dbFileName);
        
        console.log(`ðŸ† ç­‰çº§ç³»ç»Ÿæ•°æ®åº“è·¯å¾„: ${this.dbPath}`);
        
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨ç­‰çº§ç³»ç»Ÿ
        this.enabled = process.env.LEVEL_SYSTEM_ENABLED === 'true';
        if (!this.enabled) {
            console.log('ðŸ† ç­‰çº§ç³»ç»Ÿå·²ç¦ç”¨ï¼Œè®¾ç½® LEVEL_SYSTEM_ENABLED=true å¯ç”¨');
            return;
        }
        
        this.initializeDatabase();
  }
}
```

#### 2.2 ç‹¬ç«‹æ•°æ®åº“è¡¨ç»“æž„ï¼ˆåŸºäºŽç‰ˆæœ¬Aç®€åŒ–è®¾è®¡ï¼‰
```sql
-- ç­‰çº§ç³»ç»Ÿç‹¬ç«‹æ•°æ®åº“è¡¨ç»“æž„
-- æ–‡ä»¶ï¼šlevel_system.db
-- åŸºäºŽç‰ˆæœ¬Açš„6è¡¨è®¾è®¡ï¼Œå®Œå…¨ç‹¬ç«‹äºŽçŽ°æœ‰æ•°æ®åº“

-- 1. ç­‰çº§ç³»ç»Ÿå…ƒä¿¡æ¯è¡¨
CREATE TABLE IF NOT EXISTS level_meta (
    key TEXT PRIMARY KEY,
    value TEXT,
    description TEXT,
    created_at INTEGER DEFAULT (strftime('%s', 'now')),
    updated_at INTEGER DEFAULT (strftime('%s', 'now'))
);

-- 2. ç”¨æˆ·ç­‰çº§æ•°æ®è¡¨ï¼ˆæ ¸å¿ƒè¡¨ï¼‰
CREATE TABLE IF NOT EXISTS user_levels (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    group_id TEXT NOT NULL DEFAULT 'default',
    level INTEGER DEFAULT 1,
    total_exp INTEGER DEFAULT 0,
    available_points INTEGER DEFAULT 0,
    total_points_earned INTEGER DEFAULT 0,
    total_points_spent INTEGER DEFAULT 0,
    attack_count INTEGER DEFAULT 0,
    user_eval_count INTEGER DEFAULT 0,
    merchant_eval_count INTEGER DEFAULT 0,
    text_eval_count INTEGER DEFAULT 0,
    badges TEXT DEFAULT '[]', -- JSONæ•°ç»„å­˜å‚¨å‹‹ç« ID
    display_name TEXT,
    last_milestone_points INTEGER DEFAULT 0,
    created_at INTEGER DEFAULT (strftime('%s', 'now')),
    updated_at INTEGER DEFAULT (strftime('%s', 'now')),
    UNIQUE(user_id, group_id)
);

-- 3. ç§¯åˆ†å˜æ›´æ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS points_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    group_id TEXT NOT NULL DEFAULT 'default',
    action_type TEXT NOT NULL, -- 'attack', 'user_eval', 'merchant_eval', 'text_eval', 'admin_adjust', 'consume'
    exp_change INTEGER DEFAULT 0,
    points_change INTEGER DEFAULT 0,
    exp_after INTEGER NOT NULL,
    points_after INTEGER NOT NULL,
    description TEXT,
    related_eval_id INTEGER,
    admin_id INTEGER,
    timestamp INTEGER DEFAULT (strftime('%s', 'now'))
);

-- 4. ç¾¤ç»„é…ç½®è¡¨
CREATE TABLE IF NOT EXISTS group_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_id TEXT NOT NULL UNIQUE,
    group_name TEXT,
    level_config TEXT, -- JSONé…ç½®ï¼ˆç­‰çº§åç§°ã€æ‰€éœ€ç»éªŒç­‰ï¼‰
    points_config TEXT, -- JSONé…ç½®ï¼ˆç§¯åˆ†å¥–åŠ±è§„åˆ™ï¼‰
    broadcast_config TEXT, -- JSONé…ç½®ï¼ˆæ’­æŠ¥è®¾ç½®ï¼‰
    status TEXT DEFAULT 'active',
    created_at INTEGER DEFAULT (strftime('%s', 'now')),
    updated_at INTEGER DEFAULT (strftime('%s', 'now'))
);

-- 5. å‹‹ç« å®šä¹‰è¡¨
CREATE TABLE IF NOT EXISTS badge_definitions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    badge_id TEXT NOT NULL,
    group_id TEXT NOT NULL DEFAULT 'default',
    badge_name TEXT NOT NULL,
    badge_emoji TEXT DEFAULT 'ðŸ†',
    badge_desc TEXT,
    unlock_conditions TEXT, -- JSONæ ¼å¼å­˜å‚¨è§£é”æ¡ä»¶
    badge_type TEXT DEFAULT 'auto', -- 'auto', 'manual', 'special'
    rarity TEXT DEFAULT 'common', -- 'common', 'rare', 'epic', 'legendary'
    status TEXT DEFAULT 'active',
    created_at INTEGER DEFAULT (strftime('%s', 'now')),
    UNIQUE(badge_id, group_id)
);

-- 6. å‹‹ç« èŽ·å¾—è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS user_badges (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    group_id TEXT NOT NULL DEFAULT 'default',
    badge_id TEXT NOT NULL,
    awarded_by TEXT DEFAULT 'system', -- 'system', 'admin', user_id
    awarded_reason TEXT,
    awarded_at INTEGER DEFAULT (strftime('%s', 'now'))
);

-- åˆ›å»ºæ€§èƒ½ä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_user_levels_user_group ON user_levels(user_id, group_id);
CREATE INDEX IF NOT EXISTS idx_user_levels_level ON user_levels(level DESC);
CREATE INDEX IF NOT EXISTS idx_user_levels_points ON user_levels(available_points DESC);
CREATE INDEX IF NOT EXISTS idx_points_log_user_time ON points_log(user_id, timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_user_badges_user_group ON user_badges(user_id, group_id);
CREATE INDEX IF NOT EXISTS idx_group_configs_group_id ON group_configs(group_id);
CREATE INDEX IF NOT EXISTS idx_badge_definitions_group ON badge_definitions(group_id, status);
```

#### 2.3 çŽ°æœ‰æŽ¥å£å¤ç”¨è®¾è®¡ï¼ˆåŸºäºŽç‰ˆæœ¬Aï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Aæ‰¾åˆ°çš„çŽ°æœ‰æŽ¥å£ï¼Œå®Œå–„å¤ç”¨è®¾è®¡
class LevelService {
    constructor() {
        this.levelDb = require('../config/levelDatabase');
        
        // å¤ç”¨çŽ°æœ‰çš„BotæœåŠ¡å’Œæ•°æ®åº“æ“ä½œï¼ˆä¸ä¿®æ”¹ï¼‰
        this.botService = require('./botService'); // çŽ°æœ‰çš„BotæœåŠ¡
        this.dbOperations = require('../models/dbOperations'); // çŽ°æœ‰çš„æ•°æ®åº“æ“ä½œ
        
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨
        this.enabled = process.env.LEVEL_SYSTEM_ENABLED === 'true';
    }
    
    // å¤ç”¨çŽ°æœ‰çš„æ’­æŠ¥æ–¹æ³•
    async broadcastLevelUp(userId, levelUpData) {
        if (!this.enabled) return;
        
        try {
            // ä½¿ç”¨çŽ°æœ‰çš„ç¾¤ç»„æ’­æŠ¥é€»è¾‘
            const GROUP_CHAT_ID = process.env.GROUP_CHAT_ID;
            if (!GROUP_CHAT_ID) return;
            
            const message = this.formatLevelUpMessage(levelUpData);
            
            // ç›´æŽ¥ä½¿ç”¨çŽ°æœ‰çš„botå®žä¾‹
            if (this.botService.bot) {
                const sentMessage = await this.botService.bot.sendMessage(GROUP_CHAT_ID, message, {
                    parse_mode: 'Markdown'
                });
                
                // ä½¿ç”¨çŽ°æœ‰çš„ç½®é¡¶é€»è¾‘
                try {
                    await this.botService.bot.pinChatMessage(GROUP_CHAT_ID, sentMessage.message_id);
                } catch (pinError) {
                    console.log('ç½®é¡¶æ¶ˆæ¯å¤±è´¥:', pinError.message);
                }
            }
        } catch (error) {
            console.error('ç­‰çº§ç³»ç»Ÿæ’­æŠ¥å¤±è´¥:', error);
        }
    }
    
    // å¤ç”¨çŽ°æœ‰çš„ç”¨æˆ·ä¿¡æ¯èŽ·å–
    async getUserInfo(userId) {
        try {
            // ä½¿ç”¨çŽ°æœ‰çš„æ•°æ®åº“æ“ä½œèŽ·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆåªè¯»ï¼Œä¸ä¿®æ”¹ï¼‰
            const userRecord = this.dbOperations.getUserRecord ? 
                this.dbOperations.getUserRecord(userId) : null;
            
            return {
                userId: userId,
                username: userRecord?.username || null,
                displayName: userRecord?.display_name || null
            };
        } catch (error) {
            console.error('èŽ·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            return { userId, username: null, displayName: null };
        }
  }
}
```

#### 2.4 æœ€å°åŒ–é›†æˆè®¾è®¡ï¼ˆåŸºäºŽç‰ˆæœ¬Aäº‹ä»¶ç›‘å¬ï¼‰
```javascript
// åœ¨çŽ°æœ‰çš„evaluationService.jsä¸­æ·»åŠ éžç ´åæ€§çš„é’©å­
// é€šè¿‡äº‹ä»¶ç›‘å¬æ¨¡å¼é›†æˆï¼Œä¸ä¿®æ”¹çŽ°æœ‰ä»£ç 

// models/levelServiceHook.js - æ–°å»ºé’©å­æœåŠ¡
class LevelServiceHook {
    constructor() {
        this.levelService = require('../services/levelService');
        this.enabled = process.env.LEVEL_SYSTEM_ENABLED === 'true';
        
        if (this.enabled) {
            this.initializeHooks();
        }
    }
    
    initializeHooks() {
        // ç›‘å¬è¯„ä»·å®Œæˆäº‹ä»¶ï¼ˆéžç ´åæ€§ï¼‰
        if (global.evaluationEvents) {
            global.evaluationEvents.on('evaluation_completed', this.handleEvaluationCompleted.bind(this));
        } else {
            // åˆ›å»ºå…¨å±€äº‹ä»¶ç³»ç»Ÿï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
            const EventEmitter = require('events');
            global.evaluationEvents = new EventEmitter();
            global.evaluationEvents.on('evaluation_completed', this.handleEvaluationCompleted.bind(this));
        }
    }
    
    async handleEvaluationCompleted(evaluationData) {
        try {
            await this.levelService.processEvaluationReward(evaluationData);
        } catch (error) {
            console.error('ç­‰çº§ç³»ç»Ÿå¤„ç†è¯„ä»·å¥–åŠ±å¤±è´¥:', error);
        }
    }
    
    // æä¾›ç»™çŽ°æœ‰ä»£ç è°ƒç”¨çš„éžç ´åæ€§æ–¹æ³•
    static triggerEvaluationCompleted(evaluationData) {
        if (global.evaluationEvents) {
            global.evaluationEvents.emit('evaluation_completed', evaluationData);
        }
    }
}

// è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆä»…åœ¨å¯ç”¨æ—¶ï¼‰
if (process.env.LEVEL_SYSTEM_ENABLED === 'true') {
    new LevelServiceHook();
}
```

### 2.5 æ•°æ®éš”ç¦»ä¿è¯ï¼ˆç‰ˆæœ¬Aæ ¸å¿ƒåŽŸåˆ™ï¼‰
```javascript
// ç¡®ä¿ä¸ŽçŽ°æœ‰ç³»ç»Ÿå®Œå…¨éš”ç¦»çš„è®¾è®¡
const DATA_ISOLATION_GUARANTEE = {
    independent_database: {
        file: "level_system.db",
        path: "ä¸ŽçŽ°æœ‰ç³»ç»Ÿç›¸åŒçš„dataç›®å½•ï¼Œä½†ç‹¬ç«‹æ–‡ä»¶",
        isolation: "å®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¸Žmarketing_bot.dbäº§ç”Ÿä»»ä½•å…³è”",
        volume_support: "å®Œå…¨å…¼å®¹Railway VolumeæŒ‚è½½"
    },
    
    read_only_access: {
        existing_data: "åªè¯»è®¿é—®çŽ°æœ‰ç”¨æˆ·ä¿¡æ¯",
        no_modification: "ç»ä¸ä¿®æ”¹çŽ°æœ‰æ•°æ®åº“è¡¨ç»“æž„å’Œæ•°æ®",
        safe_queries: "ä½¿ç”¨çŽ°æœ‰çš„dbOperations.jså®‰å…¨æŸ¥è¯¢",
        user_info_only: "ä»…èŽ·å–ç”¨æˆ·IDã€ç”¨æˆ·åã€æ˜¾ç¤ºåç§°ç­‰åŸºç¡€ä¿¡æ¯"
    },
    
    reversible_integration: {
        enable_disable: "é€šè¿‡çŽ¯å¢ƒå˜é‡LEVEL_SYSTEM_ENABLEDæŽ§åˆ¶",
        complete_removal: "åˆ é™¤level_system.dbæ–‡ä»¶å³å¯å®Œå…¨ç§»é™¤",
        no_trace: "ç§»é™¤åŽä¸åœ¨çŽ°æœ‰ç³»ç»Ÿç•™ä¸‹ä»»ä½•ç—•è¿¹",
        rollback_safety: "ä»»ä½•æ—¶å€™éƒ½å¯ä»¥å®‰å…¨å›žé€€"
    },
    
    railway_compatibility: {
        auto_path_detection: "è‡ªåŠ¨æ£€æµ‹Railway Volumeè·¯å¾„",
        environment_adaptation: "è‡ªåŠ¨é€‚é…production/staging/developmentçŽ¯å¢ƒ",
        volume_mount: "å®Œç¾Žæ”¯æŒ/app/data VolumeæŒ‚è½½",
        fallback_strategy: "Volumeä¸å¯ç”¨æ—¶è‡ªåŠ¨å›žé€€åˆ°æœ¬åœ°è·¯å¾„"
    }
};
```

### 2.6 çŽ°æœ‰ä»£ç æœ€å°åŒ–ä¿®æ”¹ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
```javascript
// åœ¨çŽ°æœ‰çš„evaluationService.jsæ–‡ä»¶ä¸­ï¼Œåªéœ€è¦åœ¨è¯„ä»·å®Œæˆæ—¶æ·»åŠ ä¸€è¡Œä»£ç ï¼š

// çŽ°æœ‰çš„è¯„ä»·å®Œæˆé€»è¾‘...
// ... çŽ°æœ‰ä»£ç ä¸å˜ ...

// åœ¨è¯„ä»·å®ŒæˆåŽæ·»åŠ è¿™ä¸€è¡Œï¼ˆéžç ´åæ€§ï¼‰
if (global.evaluationEvents) {
    global.evaluationEvents.emit('evaluation_completed', {
        userId: evaluation.evaluator_id,
        evaluationId: evaluation.id,
        type: 'user_evaluation', // æˆ–å…¶ä»–ç±»åž‹
        timestamp: Date.now()
    });
}

// è¿™æ ·çŽ°æœ‰ä»£ç å‡ ä¹Žä¸éœ€è¦ä¿®æ”¹ï¼Œç­‰çº§ç³»ç»Ÿå®Œå…¨ç‹¬ç«‹è¿è¡Œ
```

### 3. ç­‰çº§è§„åˆ™è®¾è®¡ï¼ˆç®¡ç†å‘˜å¯é…ç½®ï¼‰

#### 3.1 é»˜è®¤ç­‰çº§é…ç½®æ¨¡æ¿
```javascript
const DEFAULT_LEVEL_CONFIG = {
  group_id: "-1001234567890",
  group_name: "ç¤ºä¾‹ç¾¤ç»„",
  levels: [
    { level: 1, name: "æ–°æ‰‹å‹‡å£« ðŸŸ¢", required_evals: 0, required_exp: 0 },
    { level: 2, name: "åˆçº§å‹‡å£« ðŸ”µ", required_evals: 3, required_exp: 50 },
    { level: 3, name: "ä¸­çº§å‹‡å£« ðŸŸ£", required_evals: 8, required_exp: 150 },
    { level: 4, name: "é«˜çº§å‹‡å£« ðŸŸ ", required_evals: 15, required_exp: 300 },
    { level: 5, name: "ä¸“å®¶å‹‡å£« ðŸ”´", required_evals: 25, required_exp: 500 },
    { level: 6, name: "å¤§å¸ˆå‹‡å£« ðŸŸ¡", required_evals: 40, required_exp: 750 },
    { level: 7, name: "ä¼ è¯´å‹‡å£« âšª", required_evals: 60, required_exp: 1050 },
    { level: 8, name: "å²è¯—å‹‡å£« ðŸŸ¤", required_evals: 85, required_exp: 1400 },
    { level: 9, name: "ç¥žè¯å‹‡å£« âš«", required_evals: 120, required_exp: 1800 },
    { level: 10, name: "è‡³å°Šå‹‡å£« ðŸŒŸ", required_evals: 160, required_exp: 2250 }
  ],
  max_level: 10
};
```

#### 3.2 åŒé‡å¥–åŠ±ç³»ç»Ÿé…ç½®ï¼ˆåŸºäºŽç‰ˆæœ¬Aç®€åŒ–è®¾è®¡ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“å­˜å‚¨çš„åŒé‡å¥–åŠ±é…ç½®
const DEFAULT_REWARD_CONFIG = {
  group_id: "-1001234567890",
  
  // åŸºç¡€å¥–åŠ±è§„åˆ™ï¼ˆç»éªŒå€¼+ç§¯åˆ†åŒé‡å¥–åŠ±ï¼‰
  base_rewards: {
    attack: {
      exp: 20,           // ç»éªŒå€¼ï¼ˆæ°¸ä¸æ¶ˆè´¹ï¼Œé©±åŠ¨ç­‰çº§ï¼‰
      points: 10,        // ç§¯åˆ†ï¼ˆå¯æ¶ˆè´¹ï¼Œç‹¬ç«‹ç³»ç»Ÿï¼‰
      desc: "å®Œæˆå‡ºå‡»",
      cooldown: 0        // æ— å†·å´æ—¶é—´
    },
    user_eval_12: {
      exp: 30,
      points: 25,
      desc: "å®Œæˆ12é¡¹æŒ‰é’®è¯„ä»·",
      cooldown: 0
    },
    merchant_eval: {
      exp: 25,
      points: 20,
      desc: "å•†å®¶è¯„ä»·ç”¨æˆ·ï¼ˆç´ è´¨+è¯¦ç»†ï¼‰",
      cooldown: 0
    },
    text_eval: {
      exp: 15,
      points: 15,
      desc: "å®Œæˆæ–‡å­—è¯¦ç»†è¯„ä»·",
      cooldown: 0
    },
    level_up_bonus: {
      exp: 0,            // å‡çº§ä¸é¢å¤–ç»™ç»éªŒ
      points: 50,        // å‡çº§å¥–åŠ±50ç§¯åˆ†
      desc: "å‡çº§å¥–åŠ±ç§¯åˆ†",
      auto_trigger: true
    }
  },
  
  // ç‰¹æ®Šå¥–åŠ±ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„ç®€åŒ–å®žçŽ°ï¼‰
  special_rewards: {
    perfect_score: {
      exp: 50,
      points: 100,
      desc: "èŽ·å¾—æ»¡åˆ†è¯„ä»·ï¼ˆ10åˆ†ï¼‰å¥–åŠ±",
      trigger_condition: "score >= 10"
    },
    first_evaluation: {
      exp: 10,
      points: 20,
      desc: "é¦–æ¬¡è¯„ä»·å¥–åŠ±",
      one_time: true
    },
    daily_active: {
      exp: 5,
      points: 5,
      desc: "æ¯æ—¥æ´»è·ƒå¥–åŠ±",
      daily_limit: 1
    }
  },
  
  // ç®¡ç†å‘˜å¯è°ƒæ•´çš„é…ç½®ï¼ˆåŸºäºŽç‰ˆæœ¬AçŽ¯å¢ƒå˜é‡ï¼‰
  adjustable_multipliers: {
    exp_multiplier: 1.0,      // ç»éªŒå€¼å€æ•°
    points_multiplier: 1.0,   // ç§¯åˆ†å€æ•°
    weekend_bonus: 1.2,       // å‘¨æœ«å¥–åŠ±å€æ•°
    event_bonus: 1.0          // æ´»åŠ¨å¥–åŠ±å€æ•°
  },
  
  // ç§¯åˆ†é‡Œç¨‹ç¢‘å¥–åŠ±ï¼ˆç‰ˆæœ¬Aç®€åŒ–è®¾è®¡ï¼‰
  milestone_rewards: [
    { points_earned: 100, bonus_points: 10, desc: "æ–°æ‰‹å¥–åŠ±" },
    { points_earned: 500, bonus_points: 50, desc: "æ´»è·ƒå¥–åŠ±" },
    { points_earned: 1000, bonus_points: 100, desc: "ä¸“å®¶å¥–åŠ±" },
    { points_earned: 5000, bonus_points: 500, desc: "å¤§å¸ˆå¥–åŠ±" },
    { points_earned: 10000, bonus_points: 1000, desc: "ä¼ è¯´å¥–åŠ±" }
  ]
};
```

#### 3.3 åŒé‡å¥–åŠ±è®¡ç®—é€»è¾‘ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“çš„å¥–åŠ±è®¡ç®—å®žçŽ°
class DualRewardCalculator {
  constructor(levelDb) {
    this.levelDb = levelDb; // ç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“
  }
  
  // è®¡ç®—åŒé‡å¥–åŠ±ï¼ˆç»éªŒå€¼+ç§¯åˆ†ï¼‰
  calculateRewards(actionType, userProfile, groupConfig) {
    const baseReward = groupConfig.base_rewards[actionType];
    if (!baseReward) return { exp: 0, points: 0 };
    
    let expReward = baseReward.exp;
    let pointsReward = baseReward.points;
    
    // åº”ç”¨å€æ•°ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„ç®€åŒ–é…ç½®ï¼‰
    const multipliers = groupConfig.adjustable_multipliers;
    expReward = Math.floor(expReward * multipliers.exp_multiplier);
    pointsReward = Math.floor(pointsReward * multipliers.points_multiplier);
    
    // å‘¨æœ«åŠ æˆ
    if (this.isWeekend()) {
      expReward = Math.floor(expReward * multipliers.weekend_bonus);
      pointsReward = Math.floor(pointsReward * multipliers.weekend_bonus);
    }
    
    return {
      exp: expReward,
      points: pointsReward,
      desc: baseReward.desc,
      breakdown: {
        base_exp: baseReward.exp,
        base_points: baseReward.points,
        multiplier_applied: multipliers.exp_multiplier,
        weekend_bonus: this.isWeekend()
      }
    };
  }
  
  // æ£€æŸ¥ç‰¹æ®Šå¥–åŠ±ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„ç®€åŒ–å®žçŽ°ï¼‰
  checkSpecialRewards(actionType, actionData, userProfile, groupConfig) {
    const specialRewards = [];
    
    // æ»¡åˆ†å¥–åŠ±æ£€æŸ¥
    if (actionData.score >= 10 && groupConfig.special_rewards.perfect_score) {
      specialRewards.push({
        type: 'perfect_score',
        exp: groupConfig.special_rewards.perfect_score.exp,
        points: groupConfig.special_rewards.perfect_score.points,
        desc: groupConfig.special_rewards.perfect_score.desc
      });
    }
    
    // é¦–æ¬¡è¯„ä»·å¥–åŠ±
    if (userProfile.user_eval_count === 0 && actionType === 'user_eval_12') {
      specialRewards.push({
        type: 'first_evaluation',
        exp: groupConfig.special_rewards.first_evaluation.exp,
        points: groupConfig.special_rewards.first_evaluation.points,
        desc: groupConfig.special_rewards.first_evaluation.desc
      });
    }
    
    return specialRewards;
  }
  
  // æ›´æ–°ç”¨æˆ·åŒé‡å¥–åŠ±æ•°æ®ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
  async updateUserRewards(userId, groupId, expChange, pointsChange, actionType, description) {
    const stmt = this.levelDb.db.prepare(`
      UPDATE user_levels 
      SET 
        total_exp = total_exp + ?,
        available_points = available_points + ?,
        total_points_earned = total_points_earned + ?,
        updated_at = ?
      WHERE user_id = ? AND group_id = ?
    `);
    
    const result = stmt.run(expChange, pointsChange, pointsChange, Date.now(), userId, groupId);
    
    // è®°å½•å¥–åŠ±åŽ†å²
    await this.recordRewardHistory(userId, groupId, expChange, pointsChange, actionType, description);
    
    return result;
  }
  
  // è®°å½•å¥–åŠ±åŽ†å²ï¼ˆç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
  async recordRewardHistory(userId, groupId, expChange, pointsChange, actionType, description) {
    const stmt = this.levelDb.db.prepare(`
      INSERT INTO points_log 
      (user_id, group_id, action_type, exp_change, points_change, description, timestamp)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `);
    
    return stmt.run(userId, groupId, actionType, expChange, pointsChange, description, Date.now());
  }
  
  isWeekend() {
    const day = new Date().getDay();
    return day === 0 || day === 6; // å‘¨æ—¥æˆ–å‘¨å…­
  }
}

#### 3.4 å‹‹ç« ç³»ç»Ÿè®¾è®¡ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“è¡¨ï¼šbadge_definitions, user_badges
// ç›´æŽ¥æ“ä½œlevel_system.dbï¼Œä¸ä½¿ç”¨EAV

class BadgeSystemManager {
  constructor(levelDb, dbOperations) {
    this.levelDb = levelDb;              // ç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“
    this.dbOperations = dbOperations;    // ç‰ˆæœ¬Aè¦æ±‚ï¼šå¤ç”¨çŽ°æœ‰æ•°æ®åº“æ“ä½œ
  }
  
  // èŽ·å–ç¾¤ç»„å‹‹ç« å®šä¹‰
  getGroupBadges(groupId) {
    const stmt = this.levelDb.db.prepare(`
      SELECT * FROM badge_definitions 
      WHERE group_id = ? AND status = 'active'
      ORDER BY rarity_order, created_at
    `);
    return stmt.all(groupId);
  }
  
  // åˆ›å»ºé»˜è®¤å‹‹ç« ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„ç®€åŒ–è®¾è®¡ï¼‰
  initializeDefaultBadges(groupId) {
    const defaultBadges = [
      {
        badge_id: "first_blood",
        badge_name: "é¦–æ¬¡å‡ºå‡»",
        badge_emoji: "ðŸ¥‡",
        badge_desc: "å®Œæˆç¬¬ä¸€æ¬¡å‡ºå‡»",
      badge_type: "auto",
        rarity: "common",
        rarity_order: 1,
        unlock_conditions: JSON.stringify({
          type: "stat_based",
          field: "attack_count",
          operator: ">=",
          target: 1
        })
      },
      {
        badge_id: "evaluation_novice",
        badge_name: "è¯„ä»·æ–°æ‰‹",
      badge_emoji: "ðŸ“",
        badge_desc: "å®Œæˆ10æ¬¡ç”¨æˆ·è¯„ä»·",
      badge_type: "auto",
        rarity: "common",
        rarity_order: 1,
        unlock_conditions: JSON.stringify({
          type: "stat_based",
        field: "user_eval_count",
          operator: ">=",
          target: 10
        })
    },
    {
        badge_id: "experience_hunter",
        badge_name: "ç»éªŒçŒŽæ‰‹",
      badge_emoji: "â­",
        badge_desc: "ç´¯è®¡ç»éªŒå€¼è¾¾åˆ°1000",
      badge_type: "auto",
      rarity: "rare",
        rarity_order: 2,
        unlock_conditions: JSON.stringify({
        type: "stat_based",
        field: "total_exp",
          operator: ">=",
          target: 1000
        })
    },
    {
        badge_id: "points_collector",
      badge_name: "ç§¯åˆ†æ”¶é›†å®¶",
      badge_emoji: "ðŸ’°",
        badge_desc: "ç´¯è®¡èŽ·å¾—ç§¯åˆ†1000",
      badge_type: "auto",
      rarity: "rare",
        rarity_order: 2,
        unlock_conditions: JSON.stringify({
        type: "stat_based",
        field: "total_points_earned",
          operator: ">=",
          target: 1000
        })
      },
      {
        badge_id: "level_master",
        badge_name: "ç­‰çº§å¤§å¸ˆ",
        badge_emoji: "ðŸŒŸ",
        badge_desc: "è¾¾åˆ°5çº§",
      badge_type: "auto",
        rarity: "epic",
        rarity_order: 3,
        unlock_conditions: JSON.stringify({
        type: "stat_based",
          field: "level",
          operator: ">=",
          target: 5
        })
      },
      {
        badge_id: "perfect_score",
        badge_name: "å®Œç¾Žè¯„ä»·",
        badge_emoji: "ðŸ’¯",
        badge_desc: "èŽ·å¾—æ»¡åˆ†è¯„ä»·",
        badge_type: "auto",
        rarity: "epic",
        rarity_order: 3,
        unlock_conditions: JSON.stringify({
          type: "evaluation_streak",
          evaluation_type: "merchant_eval",
          score: 10,
          count: 1,
          consecutive: false
        })
      },
      {
        badge_id: "admin_choice",
        badge_name: "ç®¡ç†å‘˜ä¹‹é€‰",
      badge_emoji: "ðŸŽ–ï¸",
      badge_desc: "ç®¡ç†å‘˜ç‰¹åˆ«æŽˆäºˆçš„è£èª‰å‹‹ç« ",
      badge_type: "manual",
      rarity: "legendary",
        rarity_order: 4,
        unlock_conditions: JSON.stringify({
        type: "admin_only",
        desc: "ä»…ç®¡ç†å‘˜å¯æŽˆäºˆ"
        })
      }
    ];
    
    // æ‰¹é‡æ’å…¥é»˜è®¤å‹‹ç« 
    const stmt = this.levelDb.db.prepare(`
      INSERT OR IGNORE INTO badge_definitions 
      (group_id, badge_id, badge_name, badge_emoji, badge_desc, badge_type, 
       rarity, rarity_order, unlock_conditions, status, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', ?)
    `);
    
    for (const badge of defaultBadges) {
      stmt.run(
        groupId, badge.badge_id, badge.badge_name, badge.badge_emoji,
        badge.badge_desc, badge.badge_type, badge.rarity, badge.rarity_order,
        badge.unlock_conditions, Date.now()
      );
    }
  }
  
  // æ£€æŸ¥ç”¨æˆ·å‹‹ç« è§£é”ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„ç®€åŒ–é€»è¾‘ï¼‰
  async checkUserBadgeUnlocks(userId, groupId) {
    // èŽ·å–ç”¨æˆ·å½“å‰æ¡£æ¡ˆ
    const userProfile = await this.getUserProfile(userId, groupId);
    if (!userProfile) return [];
    
    // èŽ·å–æ‰€æœ‰è‡ªåŠ¨è§£é”å‹‹ç« 
    const autoBadges = this.levelDb.db.prepare(`
      SELECT * FROM badge_definitions 
      WHERE group_id = ? AND badge_type = 'auto' AND status = 'active'
    `).all(groupId);
    
    // èŽ·å–ç”¨æˆ·å·²æœ‰å‹‹ç« 
    const userBadges = this.levelDb.db.prepare(`
      SELECT badge_id FROM user_badges 
      WHERE user_id = ? AND group_id = ?
    `).all(userId, groupId).map(row => row.badge_id);
    
    const newBadges = [];
    
    for (const badge of autoBadges) {
      if (userBadges.includes(badge.badge_id)) continue;
      
      const conditions = JSON.parse(badge.unlock_conditions);
      const unlocked = await this.checkBadgeCondition(userId, groupId, conditions, userProfile);
      
      if (unlocked) {
        newBadges.push(badge);
        // ç«‹å³æŽˆäºˆå‹‹ç« 
        await this.awardBadge(userId, groupId, badge.badge_id, 'system');
      }
    }
    
    return newBadges;
  }
  
  // æ£€æŸ¥å‹‹ç« è§£é”æ¡ä»¶ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„ç®€åŒ–å®žçŽ°ï¼‰
  async checkBadgeCondition(userId, groupId, conditions, userProfile) {
    switch (conditions.type) {
      case 'stat_based':
        const fieldValue = userProfile[conditions.field];
        if (typeof fieldValue === 'undefined') return false;
        
        switch (conditions.operator) {
          case '>=': return fieldValue >= conditions.target;
          case '<=': return fieldValue <= conditions.target;
          case '==': return fieldValue == conditions.target;
          default: return false;
        }
        
      case 'evaluation_streak':
        // è¿™é‡Œéœ€è¦æŸ¥è¯¢çŽ°æœ‰çš„è¯„ä»·æ•°æ®ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼šå¤ç”¨çŽ°æœ‰æŽ¥å£ï¼‰
        return await this.checkEvaluationStreak(userId, conditions);
        
      case 'admin_only':
        return false; // ç®¡ç†å‘˜æ‰‹åŠ¨æŽˆäºˆ
        
      default:
        return false;
    }
  }
  
  // æ£€æŸ¥è¯„ä»·è¿žå‡»ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„çŽ°æœ‰æŽ¥å£å¤ç”¨ï¼‰
  async checkEvaluationStreak(userId, conditions) {
    try {
      // å¤ç”¨çŽ°æœ‰çš„è¯„ä»·æŸ¥è¯¢æŽ¥å£ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
      if (!this.dbOperations.getUserEvaluationHistory) {
        return false; // å¦‚æžœæŽ¥å£ä¸å­˜åœ¨ï¼Œè¿”å›žfalse
      }
      
      const evaluationHistory = await this.dbOperations.getUserEvaluationHistory(userId, conditions.count);
      
      if (!evaluationHistory || evaluationHistory.length < conditions.count) {
        return false;
      }
      
      // æ£€æŸ¥è¯„ä»·åˆ†æ•°
      let qualifyingCount = 0;
      for (const evaluation of evaluationHistory) {
        if (evaluation.score >= conditions.score) {
          qualifyingCount++;
          if (qualifyingCount >= conditions.count) {
            return true;
          }
        } else if (conditions.consecutive) {
          qualifyingCount = 0; // è¿žç»­è¦æ±‚æ—¶é‡ç½®è®¡æ•°
        }
      }
      
      return qualifyingCount >= conditions.count;
    } catch (error) {
      console.error('æ£€æŸ¥è¯„ä»·è¿žå‡»å¤±è´¥:', error);
      return false;
    }
  }
  
  // æŽˆäºˆå‹‹ç« ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
  async awardBadge(userId, groupId, badgeId, awardedBy = 'system', adminId = null) {
    const stmt = this.levelDb.db.prepare(`
      INSERT OR IGNORE INTO user_badges 
      (user_id, group_id, badge_id, awarded_by, admin_id, awarded_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);
    
    const result = stmt.run(userId, groupId, badgeId, awardedBy, adminId, Date.now());
    
    if (result.changes > 0) {
      // æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆä¸­çš„å‹‹ç« åˆ—è¡¨
      await this.updateUserBadgesList(userId, groupId);
      return true;
    }
    
    return false;
  }
  
  // æ›´æ–°ç”¨æˆ·å‹‹ç« åˆ—è¡¨ï¼ˆåœ¨user_levelsè¡¨ä¸­åŒæ­¥ï¼‰
  async updateUserBadgesList(userId, groupId) {
    const userBadges = this.levelDb.db.prepare(`
      SELECT badge_id FROM user_badges 
      WHERE user_id = ? AND group_id = ?
      ORDER BY awarded_at DESC
    `).all(userId, groupId).map(row => row.badge_id);
    
    this.levelDb.db.prepare(`
      UPDATE user_levels 
      SET badges = ?, updated_at = ?
      WHERE user_id = ? AND group_id = ?
    `).run(JSON.stringify(userBadges), Date.now(), userId, groupId);
  }
  
  getUserProfile(userId, groupId) {
    return this.levelDb.db.prepare(`
      SELECT * FROM user_levels WHERE user_id = ? AND group_id = ?
    `).get(userId, groupId);
  }
}

// å‹‹ç« ç¨€æœ‰åº¦å®šä¹‰ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„ç®€åŒ–è®¾è®¡ï¼‰
const BADGE_RARITY_CONFIG = {
  common: { name: "æ™®é€š", color: "#95a5a6", emoji: "âšª", order: 1 },
  rare: { name: "ç¨€æœ‰", color: "#3498db", emoji: "ðŸ”µ", order: 2 },
  epic: { name: "å²è¯—", color: "#9b59b6", emoji: "ðŸŸ£", order: 3 },
  legendary: { name: "ä¼ è¯´", color: "#f39c12", emoji: "ðŸŸ¡", order: 4 }
};
```

#### 3.4 å‹‹ç« è§£é”æ¡ä»¶ç±»åž‹è¯´æ˜Ž
```javascript
const BADGE_CONDITION_TYPES = {
  // ç»Ÿè®¡æ•°æ®ç±»åž‹
  stat_based: {
    fields: ["total_exp", "available_points", "total_points_earned", "total_points_spent", 
             "attack_count", "user_eval_count", "merchant_eval_count", "text_eval_count"],
    operators: [">=", "<=", "=="],
    desc: "åŸºäºŽç”¨æˆ·ç»Ÿè®¡æ•°æ®çš„æ¡ä»¶"
  },
  
  // è¯„ä»·æ•°æ®ç±»åž‹
  evaluation_streak: {
    evaluation_types: ["merchant_quality", "merchant_detail", "user_12_items"],
    score_range: [1, 10],
    count_required: true,
    consecutive_option: true,
    desc: "åŸºäºŽè¯„ä»·åˆ†æ•°çš„è¿žç»­æˆå°±"
  },
  
  // è®¡æ•°ç±»åž‹
  count_based: {
    fields: ["attack_count", "user_eval_count", "merchant_eval_count"],
    target_required: true,
    desc: "åŸºäºŽè¡Œä¸ºæ¬¡æ•°çš„æˆå°±"
  },
  
  // ç»„åˆæ¡ä»¶ç±»åž‹
  combined: {
    conditions: ["AND", "OR"],
    multiple_rules: true,
    desc: "å¤šä¸ªæ¡ä»¶çš„ç»„åˆ"
  },
  
  // ä»…ç®¡ç†å‘˜
  admin_only: {
    auto_unlock: false,
    desc: "ä»…ç®¡ç†å‘˜å¯æ‰‹åŠ¨æŽˆäºˆ"
  }
};
```

#### 3.3 ç¾¤é…ç½®æ•°æ®ç»“æž„
```javascript
const GROUP_CONFIG_EXAMPLE = {
  group_id: "-1001234567890",
  group_name: "å°é¸¡ç®¡å®¶æµ‹è¯•ç¾¤",
  level_config: DEFAULT_LEVEL_CONFIG,
  points_config: DEFAULT_POINTS_CONFIG,
  settings: {
    enable_level_system: true,
    enable_points_system: true,
    enable_ranking: true,
    enable_notifications: true,
    auto_announce_levelup: true,
    point_decay_enabled: false,
    point_decay_days: 365
  },
  created_at: 1705312200,
  updated_at: 1705312200
};
```

### 4. ç‹¬ç«‹æ•°æ®åº“æ•°æ®å­˜å‚¨ï¼ˆåŸºäºŽç‰ˆæœ¬Aè®¾è®¡ï¼‰

#### 4.1 ç¾¤æ¡£æ¡ˆé…ç½®å­˜å‚¨ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“è¡¨ï¼šgroup_configs
// ç›´æŽ¥æ“ä½œlevel_system.dbï¼Œä¸ä½¿ç”¨EAV

class GroupConfigManager {
  constructor(levelDb) {
    this.levelDb = levelDb; // ç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“
  }
  
  // èŽ·å–ç¾¤ç»„ç­‰çº§é…ç½®
  getGroupLevelConfig(groupId) {
    const stmt = this.levelDb.db.prepare(`
      SELECT level_config FROM group_configs WHERE group_id = ?
    `);
    const result = stmt.get(groupId);
    
    if (result) {
      return JSON.parse(result.level_config);
    }
    
    // è¿”å›žé»˜è®¤é…ç½®
    return this.getDefaultLevelConfig();
  }
  
  // æ›´æ–°ç¾¤ç»„ç­‰çº§é…ç½®
  updateGroupLevelConfig(groupId, levelConfig) {
    const stmt = this.levelDb.db.prepare(`
      INSERT OR REPLACE INTO group_configs 
      (group_id, level_config, updated_at)
      VALUES (?, ?, ?)
    `);
    
    return stmt.run(groupId, JSON.stringify(levelConfig), Date.now());
  }
  
  // é»˜è®¤ç­‰çº§é…ç½®ï¼ˆåŸºäºŽç‰ˆæœ¬Aï¼‰
  getDefaultLevelConfig() {
    return {
      levels: [
        { level: 1, name: "æ–°æ‰‹å‹‡å£« ðŸŸ¢", required_evals: 0, required_exp: 0 },
        { level: 2, name: "åˆçº§å‹‡å£« ðŸ”µ", required_evals: 3, required_exp: 50 },
        { level: 3, name: "ä¸­çº§å‹‡å£« ðŸŸ£", required_evals: 8, required_exp: 150 },
        { level: 4, name: "é«˜çº§å‹‡å£« ðŸŸ ", required_evals: 15, required_exp: 300 },
        { level: 5, name: "ä¸“å®¶å‹‡å£« ðŸ”´", required_evals: 25, required_exp: 500 },
        { level: 6, name: "å¤§å¸ˆå‹‡å£« ðŸŸ¡", required_evals: 40, required_exp: 750 },
        { level: 7, name: "ä¼ è¯´å‹‡å£« âšª", required_evals: 60, required_exp: 1050 },
        { level: 8, name: "å²è¯—å‹‡å£« ðŸŸ¤", required_evals: 85, required_exp: 1400 },
        { level: 9, name: "ç¥žè¯å‹‡å£« âš«", required_evals: 120, required_exp: 1800 },
        { level: 10, name: "è‡³å°Šå‹‡å£« ðŸŒŸ", required_evals: 160, required_exp: 2250 }
      ],
      max_level: 10,
      customizable: true,
      version: "1.0"
    };
  }
}

// ç¤ºä¾‹æ•°æ®ç»“æž„ï¼ˆå­˜å‚¨åœ¨group_configsè¡¨çš„level_configå­—æ®µï¼‰
const EXAMPLE_GROUP_CONFIG = {
  group_id: "-1001234567890",
  group_name: "å°é¸¡ç®¡å®¶æµ‹è¯•ç¾¤",
  level_config: {
    levels: [
      { level: 1, name: "æ–°æ‰‹å‹‡å£« ðŸŸ¢", required_evals: 0, required_exp: 0 },
      { level: 2, name: "åˆçº§å‹‡å£« ðŸ”µ", required_evals: 3, required_exp: 50 },
        // ... æ›´å¤šç­‰çº§é…ç½®
      ],
    max_level: 10
  },
  points_config: {
    base_rewards: {
      attack: { exp: 20, points: 10, desc: "å®Œæˆå‡ºå‡»" },
      user_eval_12: { exp: 30, points: 25, desc: "å®Œæˆ12é¡¹æŒ‰é’®è¯„ä»·" },
      merchant_eval: { exp: 25, points: 20, desc: "å•†å®¶è¯„ä»·ç”¨æˆ·" },
      text_eval: { exp: 15, points: 15, desc: "æ–‡å­—è¯¦ç»†è¯„ä»·" }
    }
  },
  status: "active",
  created_at: 1705312200,
  updated_at: 1705312200
};
```

#### 4.2 ç”¨æˆ·æ¡£æ¡ˆæ•°æ®å­˜å‚¨ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“è¡¨ï¼šuser_levels
// ç›´æŽ¥æ“ä½œlevel_system.dbï¼Œä¸ä½¿ç”¨EAV

class UserProfileManager {
  constructor(levelDb) {
    this.levelDb = levelDb; // ç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“
  }
  
  // èŽ·å–ç”¨æˆ·æ¡£æ¡ˆ
  getUserProfile(userId, groupId) {
    const stmt = this.levelDb.db.prepare(`
      SELECT * FROM user_levels 
      WHERE user_id = ? AND group_id = ?
    `);
    return stmt.get(userId, groupId);
  }
  
  // åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆ
  upsertUserProfile(userId, groupId, profileData) {
    const stmt = this.levelDb.db.prepare(`
      INSERT OR REPLACE INTO user_levels 
      (user_id, group_id, level, total_exp, available_points, total_points_earned, 
       total_points_spent, attack_count, user_eval_count, merchant_eval_count, 
       text_eval_count, badges, display_name, updated_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `);
    
    return stmt.run(
      userId, groupId, profileData.level || 1, profileData.total_exp || 0,
      profileData.available_points || 0, profileData.total_points_earned || 0,
      profileData.total_points_spent || 0, profileData.attack_count || 0,
      profileData.user_eval_count || 0, profileData.merchant_eval_count || 0,
      profileData.text_eval_count || 0, JSON.stringify(profileData.badges || []),
      profileData.display_name || null, Date.now()
    );
  }
}

// ç¤ºä¾‹ç”¨æˆ·æ¡£æ¡ˆæ•°æ®ï¼ˆå­˜å‚¨åœ¨user_levelsè¡¨ä¸­ï¼‰
const EXAMPLE_USER_PROFILE = {
  id: 123,
  user_id: 12345,
  group_id: "-1001234567890",
  level: 4,
  total_exp: 450,          // æ€»ç»éªŒå€¼ï¼ˆæ°¸ä¸å‡å°‘ï¼‰
  available_points: 280,   // å¯ç”¨ç§¯åˆ†ï¼ˆå¯æ¶ˆè´¹ï¼‰
  total_points_earned: 380,// ç´¯è®¡èŽ·å¾—ç§¯åˆ†
  total_points_spent: 100, // ç´¯è®¡æ¶ˆè´¹ç§¯åˆ†
  attack_count: 15,        // å‡ºå‡»æ¬¡æ•°
  user_eval_count: 8,      // ç”¨æˆ·è¯„ä»·æ¬¡æ•°
  merchant_eval_count: 12, // å•†å®¶è¯„ä»·æ¬¡æ•°
  text_eval_count: 6,      // æ–‡å­—è¯„ä»·æ¬¡æ•°
  badges: ["badge_1", "badge_2"], // JSONæ ¼å¼å‹‹ç« åˆ—è¡¨
  display_name: "é’¢é“ä¾ ",
  created_at: 1705312200,
  updated_at: 1705312200
};
```

#### 4.3 ç§¯åˆ†åŽ†å²æ—¥å¿—å­˜å‚¨ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“è¡¨ï¼špoints_log
// ç›´æŽ¥æ“ä½œlevel_system.dbï¼Œä¸ä½¿ç”¨EAV

class PointsLogManager {
  constructor(levelDb) {
    this.levelDb = levelDb; // ç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“
  }
  
  // è®°å½•ç§¯åˆ†å˜æ›´
  recordPointsChange(userId, groupId, actionType, expChange, pointsChange, description, relatedEvalId = null, adminId = null) {
    // å…ˆèŽ·å–å˜æ›´åŽçš„å€¼
    const userProfile = this.getUserProfile(userId, groupId);
    const expAfter = userProfile.total_exp;
    const pointsAfter = userProfile.available_points;
    
    const stmt = this.levelDb.db.prepare(`
      INSERT INTO points_log 
      (user_id, group_id, action_type, exp_change, points_change, exp_after, 
       points_after, description, related_eval_id, admin_id, timestamp)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `);
    
    return stmt.run(
      userId, groupId, actionType, expChange, pointsChange, expAfter,
      pointsAfter, description, relatedEvalId, adminId, Date.now()
    );
  }
  
  // èŽ·å–ç”¨æˆ·ç§¯åˆ†åŽ†å²
  getUserPointsHistory(userId, groupId, limit = 10) {
    const stmt = this.levelDb.db.prepare(`
      SELECT * FROM points_log 
      WHERE user_id = ? AND group_id = ?
      ORDER BY timestamp DESC 
      LIMIT ?
    `);
    return stmt.all(userId, groupId, limit);
  }
  
  // èŽ·å–ç¾¤ç»„ç§¯åˆ†ç»Ÿè®¡
  getGroupPointsStats(groupId, days = 30) {
    const since = Date.now() - (days * 24 * 60 * 60 * 1000);
    
    const stmt = this.levelDb.db.prepare(`
      SELECT 
        action_type,
        COUNT(*) as count,
        SUM(points_change) as total_points,
        SUM(exp_change) as total_exp
      FROM points_log 
      WHERE group_id = ? AND timestamp > ?
      GROUP BY action_type
      ORDER BY total_points DESC
    `);
    
    return stmt.all(groupId, since);
  }
}

// ç¤ºä¾‹ç§¯åˆ†åŽ†å²è®°å½•ï¼ˆå­˜å‚¨åœ¨points_logè¡¨ä¸­ï¼‰
const EXAMPLE_POINTS_LOG = {
  id: 789,
  user_id: 12345,
  group_id: "-1001234567890",
  action_type: "user_eval_12",     // æ“ä½œç±»åž‹
  exp_change: 30,                  // ç»éªŒå€¼å˜åŒ–
  points_change: 25,               // ç§¯åˆ†å˜åŒ–
  exp_after: 450,                  // å˜åŒ–åŽç»éªŒå€¼
  points_after: 280,               // å˜åŒ–åŽç§¯åˆ†
  description: "å®Œæˆ12é¡¹æŒ‰é’®è¯„ä»·",
  related_eval_id: 456,            // å…³è”è¯„ä»·ID
  admin_id: null,                  // ç®¡ç†å‘˜IDï¼ˆå¦‚æžœæ˜¯ç®¡ç†å‘˜æ“ä½œï¼‰
  timestamp: 1705312200
};
```

### 5. ä¸šåŠ¡æµç¨‹è®¾è®¡

#### 5.1 è¯„ä»·å®Œæˆè‡ªåŠ¨å‡çº§æµç¨‹
```
1. ç”¨æˆ·å®Œæˆè¯„ä»· â†’ è§¦å‘evaluationService.updateEvaluation()
2. æ£€æµ‹è¯„ä»·ç±»åž‹ï¼ˆæ™®é€š/è¯¦ç»†/æ–‡å­—è¯„ä»·ï¼‰
3. è°ƒç”¨LevelService.processEvaluationReward()
4. èŽ·å–ç”¨æˆ·å½“å‰ç­‰çº§æ•°æ®
5. è®¡ç®—ç§¯åˆ†å’Œç»éªŒå¥–åŠ±
6. æ›´æ–°ç”¨æˆ·ç­‰çº§æ•°æ®
7. è®°å½•ç§¯åˆ†åŽ†å²
8. æ£€æŸ¥æ˜¯å¦å‡çº§
9. å‘é€å‡çº§é€šçŸ¥æ¶ˆæ¯
```

#### 5.2 ç§¯åˆ†æŸ¥è¯¢æµç¨‹
```
1. ç”¨æˆ·å‘é€æŸ¥è¯¢æŒ‡ä»¤ â†’ /æˆ‘çš„ç­‰çº§ æˆ– /ç§¯åˆ†æŸ¥è¯¢
2. ä¸€æ¬¡EAVæŸ¥è¯¢èŽ·å–å®Œæ•´ç”¨æˆ·æ¡£æ¡ˆï¼ˆç­‰çº§+ç§¯åˆ†ï¼‰
3. æŸ¥è¯¢ç§¯åˆ†åŽ†å²è®°å½•ï¼ˆæœ€è¿‘10æ¡ï¼‰
4. æ ¼å¼åŒ–æ˜¾ç¤ºç­‰çº§ä¿¡æ¯
5. å‘é€æŸ¥è¯¢ç»“æžœæ¶ˆæ¯
```

#### 5.3 ç§¯åˆ†æ¶ˆè´¹æµç¨‹
```
1. ç”¨æˆ·å‘èµ·æ¶ˆè´¹è¯·æ±‚
2. æ£€æŸ¥å¯ç”¨ç§¯åˆ†ä½™é¢
3. å¼€å§‹æ•°æ®åº“äº‹åŠ¡
4. æ›´æ–°ç”¨æˆ·ç§¯åˆ†æ•°æ®
5. è®°å½•æ¶ˆè´¹åŽ†å²
6. æäº¤äº‹åŠ¡
7. è¿”å›žæ¶ˆè´¹ç»“æžœ
```

### 6. æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰

#### 6.1 ç‹¬ç«‹æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–ï¼ˆåŸºäºŽç‰ˆæœ¬Aè®¾è®¡ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
class LevelSystemPerformanceOptimizer {
  constructor(levelDb) {
    this.levelDb = levelDb;  // ç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“
    this.queryCache = new Map();
    this.batchOperations = [];
    this.CACHE_TTL = 300000; // 5åˆ†é’Ÿç¼“å­˜
    this.BATCH_SIZE = 50;    // æ‰¹é‡æ“ä½œå¤§å°
  }

  // 1. æŸ¥è¯¢ä¼˜åŒ–ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
  async optimizeQueries() {
    // åˆ›å»ºä¸“é—¨çš„ç´¢å¼•ï¼ˆä¸å½±å“çŽ°æœ‰ç³»ç»Ÿï¼‰
    const indexQueries = [
      'CREATE INDEX IF NOT EXISTS idx_user_levels_composite ON user_levels(user_id, group_id, level)',
      'CREATE INDEX IF NOT EXISTS idx_points_log_user_time ON points_log(user_id, timestamp DESC)',
      'CREATE INDEX IF NOT EXISTS idx_user_badges_user_group ON user_badges(user_id, group_id)',
      'CREATE INDEX IF NOT EXISTS idx_badge_definitions_group_type ON badge_definitions(group_id, badge_type, status)',
      'CREATE INDEX IF NOT EXISTS idx_broadcast_log_timestamp ON broadcast_log(timestamp DESC)',
      
      // ç‰¹æ®Šçš„è¦†ç›–ç´¢å¼•ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
      'CREATE INDEX IF NOT EXISTS idx_level_ranking_composite ON user_levels(group_id, level DESC, total_exp DESC) WHERE level > 1',
      'CREATE INDEX IF NOT EXISTS idx_points_ranking_composite ON user_levels(group_id, available_points DESC, total_points_earned DESC)',
    ];
    
    for (const query of indexQueries) {
      this.levelDb.db.exec(query);
    }
    
    console.log('âœ… ç‹¬ç«‹æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–å®Œæˆ');
  }

  // 2. æ‰¹é‡æ“ä½œä¼˜åŒ–ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹è®¾è®¡ï¼‰
  async batchUpdateUserRewards(rewardUpdates) {
    if (rewardUpdates.length === 0) return;
    
    // ä½¿ç”¨äº‹åŠ¡è¿›è¡Œæ‰¹é‡æ›´æ–°ï¼ˆä»…æ“ä½œç‹¬ç«‹æ•°æ®åº“ï¼‰
    const transaction = this.levelDb.db.transaction(() => {
      const updateStmt = this.levelDb.db.prepare(`
        UPDATE user_levels 
        SET 
          total_exp = total_exp + ?,
          available_points = available_points + ?,
          total_points_earned = total_points_earned + ?,
          updated_at = ?
        WHERE user_id = ? AND group_id = ?
      `);
      
      const logStmt = this.levelDb.db.prepare(`
        INSERT INTO points_log 
        (user_id, group_id, action_type, exp_change, points_change, description, timestamp)
        VALUES (?, ?, ?, ?, ?, ?, ?)
      `);
      
      for (const update of rewardUpdates) {
        updateStmt.run(
          update.expChange, update.pointsChange, update.pointsChange,
          Date.now(), update.userId, update.groupId
        );
        
        logStmt.run(
          update.userId, update.groupId, update.actionType,
          update.expChange, update.pointsChange, update.description, Date.now()
        );
      }
    });
    
    // æ‰§è¡Œæ‰¹é‡äº‹åŠ¡
    transaction();
    
    // æ¸…ç†ç›¸å…³ç¼“å­˜
    this.invalidateCacheForUsers(rewardUpdates.map(u => u.userId));
    
    console.log(`âœ… æ‰¹é‡æ›´æ–°äº†${rewardUpdates.length}ä¸ªç”¨æˆ·çš„å¥–åŠ±æ•°æ®`);
  }

  // 3. æ™ºèƒ½ç¼“å­˜ç­–ç•¥ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®ï¼‰
  async getCachedUserProfile(userId, groupId) {
    const cacheKey = `user_profile_${userId}_${groupId}`;
    const cached = this.queryCache.get(cacheKey);
    
    if (cached && cached.expiry > Date.now()) {
      return cached.data;
    }
    
    // ä»Žç‹¬ç«‹æ•°æ®åº“æŸ¥è¯¢
    const stmt = this.levelDb.db.prepare(`
      SELECT ul.*, 
             GROUP_CONCAT(ub.badge_id) as badge_ids,
             COUNT(pl.id) as recent_activity_count
      FROM user_levels ul
      LEFT JOIN user_badges ub ON ul.user_id = ub.user_id AND ul.group_id = ub.group_id
      LEFT JOIN points_log pl ON ul.user_id = pl.user_id AND ul.group_id = pl.group_id 
                                 AND pl.timestamp > ?
      WHERE ul.user_id = ? AND ul.group_id = ?
      GROUP BY ul.user_id, ul.group_id
    `);
    
    const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
    const userData = stmt.get(sevenDaysAgo, userId, groupId);
    
    if (userData) {
      // å¤„ç†å‹‹ç« æ•°æ®
      userData.badges = userData.badge_ids ? userData.badge_ids.split(',') : [];
      delete userData.badge_ids;
      
      // ç¼“å­˜æ•°æ®
      this.queryCache.set(cacheKey, {
        data: userData,
        expiry: Date.now() + this.CACHE_TTL
      });
    }
    
    return userData;
  }

  // 4. æŽ’è¡Œæ¦œæ€§èƒ½ä¼˜åŒ–ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
  async getOptimizedRankings(groupId, type = 'level', limit = 50) {
    const cacheKey = `rankings_${groupId}_${type}_${limit}`;
    const cached = this.queryCache.get(cacheKey);
    
    if (cached && cached.expiry > Date.now()) {
      return cached.data;
    }
    
    let orderBy = '';
    switch (type) {
      case 'level':
        orderBy = 'level DESC, total_exp DESC';
        break;
      case 'points':
        orderBy = 'available_points DESC, total_points_earned DESC';
        break;
      case 'exp':
        orderBy = 'total_exp DESC, level DESC';
        break;
      default:
        orderBy = 'level DESC, total_exp DESC';
    }
    
    // ä½¿ç”¨è¦†ç›–ç´¢å¼•çš„ä¼˜åŒ–æŸ¥è¯¢
    const stmt = this.levelDb.db.prepare(`
      SELECT user_id, level, total_exp, available_points, total_points_earned, display_name,
             ROW_NUMBER() OVER (ORDER BY ${orderBy}) as rank
      FROM user_levels 
      WHERE group_id = ? AND level > 0
      ORDER BY ${orderBy}
      LIMIT ?
    `);
    
    const rankings = stmt.all(groupId, limit);
    
    // ç¼“å­˜æŽ’è¡Œæ¦œæ•°æ®ï¼ˆè¾ƒçŸ­çš„ç¼“å­˜æ—¶é—´ï¼‰
    this.queryCache.set(cacheKey, {
      data: rankings,
      expiry: Date.now() + (this.CACHE_TTL / 5) // 1åˆ†é’Ÿç¼“å­˜
    });
    
    return rankings;
  }

  // 5. å†…å­˜ä½¿ç”¨ä¼˜åŒ–
  optimizeMemoryUsage() {
    // å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
    setInterval(() => {
      const now = Date.now();
      for (const [key, value] of this.queryCache.entries()) {
        if (value.expiry <= now) {
          this.queryCache.delete(key);
        }
      }
    }, 60000); // æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
    
    // é™åˆ¶ç¼“å­˜å¤§å°
    if (this.queryCache.size > 1000) {
      const entries = Array.from(this.queryCache.entries());
      entries.sort((a, b) => a[1].expiry - b[1].expiry);
      
      // åˆ é™¤æœ€æ—§çš„ä¸€åŠ
      const toDelete = entries.slice(0, Math.floor(entries.length / 2));
      toDelete.forEach(([key]) => this.queryCache.delete(key));
    }
  }

  // 6. æ•°æ®åº“è¿žæŽ¥ä¼˜åŒ–ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
  optimizeDatabaseConnections() {
    // WALæ¨¡å¼å¼€å¯ï¼Œæå‡å¹¶å‘æ€§èƒ½
    this.levelDb.db.exec('PRAGMA journal_mode = WAL');
    
    // ä¼˜åŒ–SQLiteè®¾ç½®ï¼ˆä»…å½±å“ç‹¬ç«‹æ•°æ®åº“ï¼‰
    this.levelDb.db.exec('PRAGMA synchronous = NORMAL');
    this.levelDb.db.exec('PRAGMA cache_size = 10000');
    this.levelDb.db.exec('PRAGMA temp_store = MEMORY');
    this.levelDb.db.exec('PRAGMA mmap_size = 134217728'); // 128MB
    
    // é¢„ç¼–è¯‘å¸¸ç”¨æŸ¥è¯¢è¯­å¥
    this.preparedStatements = {
      getUserProfile: this.levelDb.db.prepare('SELECT * FROM user_levels WHERE user_id = ? AND group_id = ?'),
      updateUserRewards: this.levelDb.db.prepare(`
        UPDATE user_levels 
        SET total_exp = total_exp + ?, available_points = available_points + ?, updated_at = ?
        WHERE user_id = ? AND group_id = ?
      `),
      insertPointsLog: this.levelDb.db.prepare(`
        INSERT INTO points_log (user_id, group_id, action_type, exp_change, points_change, description, timestamp)
        VALUES (?, ?, ?, ?, ?, ?, ?)
      `),
      checkBadgeUnlock: this.levelDb.db.prepare(`
        SELECT bd.* FROM badge_definitions bd
        LEFT JOIN user_badges ub ON bd.badge_id = ub.badge_id AND ub.user_id = ? AND ub.group_id = ?
        WHERE bd.group_id = ? AND bd.badge_type = 'auto' AND bd.status = 'active' AND ub.badge_id IS NULL
      `)
    };
    
    console.log('âœ… ç‹¬ç«‹æ•°æ®åº“è¿žæŽ¥ä¼˜åŒ–å®Œæˆ');
  }

  // 7. å¼‚æ­¥å¤„ç†ä¼˜åŒ–ï¼ˆåŸºäºŽç‰ˆæœ¬Aäº‹ä»¶ç³»ç»Ÿï¼‰
  setupAsyncProcessing() {
    // ä½¿ç”¨é˜Ÿåˆ—å¤„ç†éžå…³é”®ä»»åŠ¡
    this.taskQueue = [];
    this.processing = false;
    
    // å¼‚æ­¥å¤„ç†å‹‹ç« æ£€æŸ¥ï¼ˆä¸é˜»å¡žä¸»æµç¨‹ï¼‰
    this.scheduleBadgeCheck = (userId, groupId) => {
      this.taskQueue.push({
        type: 'badge_check',
        userId,
        groupId,
        timestamp: Date.now()
      });
      
      this.processQueue();
    };
    
    // å¼‚æ­¥å¤„ç†ç»Ÿè®¡æ›´æ–°
    this.scheduleStatsUpdate = (groupId) => {
      this.taskQueue.push({
        type: 'stats_update',
        groupId,
        timestamp: Date.now()
      });
      
      this.processQueue();
    };
  }

  async processQueue() {
    if (this.processing || this.taskQueue.length === 0) return;
    
    this.processing = true;
    
    while (this.taskQueue.length > 0) {
      const task = this.taskQueue.shift();
      
      try {
        switch (task.type) {
          case 'badge_check':
            await this.processBadgeCheck(task.userId, task.groupId);
            break;
          case 'stats_update':
            await this.processStatsUpdate(task.groupId);
            break;
        }
      } catch (error) {
        console.error(`ä»»åŠ¡å¤„ç†å¤±è´¥:`, task, error);
      }
      
      // é¿å…é˜»å¡žä¸»çº¿ç¨‹
      await new Promise(resolve => setImmediate(resolve));
    }
    
    this.processing = false;
  }

  // 8. ç¼“å­˜å¤±æ•ˆç­–ç•¥
  invalidateCacheForUsers(userIds) {
    for (const userId of userIds) {
      for (const [key] of this.queryCache.entries()) {
        if (key.includes(`user_profile_${userId}_`) || 
            key.includes(`rankings_`)) {
          this.queryCache.delete(key);
        }
      }
    }
  }

  // 9. æ€§èƒ½ç›‘æŽ§ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹ç›‘æŽ§ï¼‰
  setupPerformanceMonitoring() {
    this.performanceMetrics = {
      queryCount: 0,
      cacheHits: 0,
      cacheMisses: 0,
      avgQueryTime: 0,
      slowQueries: []
    };
    
    // åŒ…è£…æ•°æ®åº“æŸ¥è¯¢ä»¥æ”¶é›†æ€§èƒ½æ•°æ®
    const originalPrepare = this.levelDb.db.prepare.bind(this.levelDb.db);
    this.levelDb.db.prepare = (sql) => {
      const stmt = originalPrepare(sql);
      const originalRun = stmt.run.bind(stmt);
      const originalGet = stmt.get.bind(stmt);
      const originalAll = stmt.all.bind(stmt);
      
      stmt.run = (...args) => {
        const start = process.hrtime.bigint();
        const result = originalRun(...args);
        const duration = Number(process.hrtime.bigint() - start) / 1000000; // ms
        
        this.recordQueryPerformance(sql, duration);
        return result;
      };
      
      stmt.get = (...args) => {
        const start = process.hrtime.bigint();
        const result = originalGet(...args);
        const duration = Number(process.hrtime.bigint() - start) / 1000000; // ms
        
        this.recordQueryPerformance(sql, duration);
        return result;
      };
      
      stmt.all = (...args) => {
        const start = process.hrtime.bigint();
        const result = originalAll(...args);
        const duration = Number(process.hrtime.bigint() - start) / 1000000; // ms
        
        this.recordQueryPerformance(sql, duration);
        return result;
      };
      
      return stmt;
    };
  }

  recordQueryPerformance(sql, duration) {
    this.performanceMetrics.queryCount++;
    this.performanceMetrics.avgQueryTime = 
      (this.performanceMetrics.avgQueryTime + duration) / 2;
    
    // è®°å½•æ…¢æŸ¥è¯¢ï¼ˆè¶…è¿‡100msï¼‰
    if (duration > 100) {
      this.performanceMetrics.slowQueries.push({
        sql: sql.substring(0, 100) + '...',
        duration,
        timestamp: Date.now()
      });
      
      // åªä¿ç•™æœ€è¿‘çš„50ä¸ªæ…¢æŸ¥è¯¢
      if (this.performanceMetrics.slowQueries.length > 50) {
        this.performanceMetrics.slowQueries = 
          this.performanceMetrics.slowQueries.slice(-50);
      }
    }
  }

  // 10. èŽ·å–æ€§èƒ½æŠ¥å‘Š
  getPerformanceReport() {
    const cacheHitRate = this.performanceMetrics.cacheHits / 
      (this.performanceMetrics.cacheHits + this.performanceMetrics.cacheMisses) * 100;
    
    return {
      ...this.performanceMetrics,
      cacheHitRate: cacheHitRate.toFixed(2) + '%',
      cacheSize: this.queryCache.size,
      queueSize: this.taskQueue.length
    };
  }
}
```

#### 6.2 å¹¶å‘æŽ§åˆ¶å’Œäº‹åŠ¡ä¼˜åŒ–ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“çš„å¹¶å‘æŽ§åˆ¶ä¼˜åŒ–
class LevelSystemConcurrencyManager {
  constructor(levelDb) {
    this.levelDb = levelDb;
    this.userLocks = new Map(); // ç”¨æˆ·çº§é”
    this.transactionQueue = []; // äº‹åŠ¡é˜Ÿåˆ—
    this.maxConcurrent = 10;    // æœ€å¤§å¹¶å‘äº‹åŠ¡æ•°
    this.activeTrans = 0;       // å½“å‰æ´»è·ƒäº‹åŠ¡æ•°
  }

  // é«˜æ€§èƒ½äº‹åŠ¡å¤„ç†ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰
  async executeTransaction(callback, lockKeys = []) {
    // èŽ·å–ç”¨æˆ·é”
    await this.acquireLocks(lockKeys);
    
    try {
      // ç­‰å¾…äº‹åŠ¡æ§½ä½
      await this.waitForTransactionSlot();
      
      this.activeTrans++;
      
      // æ‰§è¡ŒSQLiteäº‹åŠ¡ï¼ˆä»…æ“ä½œç‹¬ç«‹æ•°æ®åº“ï¼‰
      const transaction = this.levelDb.db.transaction(() => {
        return callback();
      });
      
      const result = transaction();
      
      return result;
    } finally {
      this.activeTrans--;
      this.releaseLocks(lockKeys);
      this.processTransactionQueue();
    }
  }

  // ç”¨æˆ·çº§é”ç®¡ç†
  async acquireLocks(lockKeys) {
    const sortedKeys = lockKeys.sort(); // é¿å…æ­»é”
    
    for (const key of sortedKeys) {
      while (this.userLocks.has(key)) {
        await new Promise(resolve => setTimeout(resolve, 1));
      }
      this.userLocks.set(key, Date.now());
    }
  }

  releaseLocks(lockKeys) {
    for (const key of lockKeys) {
      this.userLocks.delete(key);
    }
  }

  async waitForTransactionSlot() {
    while (this.activeTrans >= this.maxConcurrent) {
      await new Promise(resolve => setTimeout(resolve, 10));
    }
  }

  processTransactionQueue() {
    if (this.transactionQueue.length > 0 && this.activeTrans < this.maxConcurrent) {
      const { resolve, transaction, lockKeys } = this.transactionQueue.shift();
      setImmediate(() => {
        this.executeTransaction(transaction, lockKeys).then(resolve);
      });
    }
  }

  // æ‰¹é‡å¥–åŠ±æ›´æ–°ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“çš„é«˜æ€§èƒ½å®žçŽ°ï¼‰
  async batchUpdateRewards(rewardUpdates) {
    if (rewardUpdates.length === 0) return [];

    // æŒ‰ç”¨æˆ·åˆ†ç»„ä»¥å‡å°‘é”ç«žäº‰
    const userGroups = new Map();
    for (const update of rewardUpdates) {
      const key = `${update.userId}_${update.groupId}`;
      if (!userGroups.has(key)) {
        userGroups.set(key, []);
      }
      userGroups.get(key).push(update);
    }

    const results = [];
    const lockKeys = Array.from(userGroups.keys());

    await this.executeTransaction(() => {
      const updateStmt = this.levelDb.db.prepare(`
        UPDATE user_levels 
        SET 
          total_exp = total_exp + ?,
          available_points = available_points + ?,
          total_points_earned = total_points_earned + ?,
          updated_at = ?
        WHERE user_id = ? AND group_id = ?
      `);

      const logStmt = this.levelDb.db.prepare(`
        INSERT INTO points_log 
        (user_id, group_id, action_type, exp_change, points_change, description, timestamp)
        VALUES (?, ?, ?, ?, ?, ?, ?)
      `);

      for (const [userKey, updates] of userGroups) {
        const [userId, groupId] = userKey.split('_');
        
        // åˆå¹¶åŒä¸€ç”¨æˆ·çš„å¤šä¸ªæ›´æ–°
        const totalExpChange = updates.reduce((sum, u) => sum + u.expChange, 0);
        const totalPointsChange = updates.reduce((sum, u) => sum + u.pointsChange, 0);
        
        if (totalExpChange !== 0 || totalPointsChange !== 0) {
          const updateResult = updateStmt.run(
            totalExpChange, totalPointsChange, totalPointsChange,
            Date.now(), userId, groupId
          );

          // è®°å½•åˆå¹¶åŽçš„æ—¥å¿—
          logStmt.run(
            userId, groupId, 'batch_update',
            totalExpChange, totalPointsChange,
            `æ‰¹é‡æ›´æ–°ï¼š${updates.length}ä¸ªæ“ä½œ`, Date.now()
          );

          results.push({
            userId, groupId,
            expChange: totalExpChange,
            pointsChange: totalPointsChange,
            updatesCount: updates.length,
            success: updateResult.changes > 0
          });
        }
      }
    }, lockKeys);

    return results;
  }
}
```

#### 6.3 æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“çš„å¤šå±‚ç¼“å­˜ç³»ç»Ÿ
class LevelSystemCache {
  constructor() {
    this.L1Cache = new Map(); // å†…å­˜ä¸€çº§ç¼“å­˜ï¼ˆçƒ­æ•°æ®ï¼‰
    this.L2Cache = new Map(); // å†…å­˜äºŒçº§ç¼“å­˜ï¼ˆæ¸©æ•°æ®ï¼‰
    this.cacheStats = {
      hits: 0,
      misses: 0,
      evictions: 0
    };
    
    // ç¼“å­˜é…ç½®
    this.config = {
      L1_MAX_SIZE: 500,      // ä¸€çº§ç¼“å­˜æœ€å¤§æ¡ç›®æ•°
      L2_MAX_SIZE: 2000,     // äºŒçº§ç¼“å­˜æœ€å¤§æ¡ç›®æ•°
      L1_TTL: 300000,        // ä¸€çº§ç¼“å­˜TTLï¼š5åˆ†é’Ÿ
      L2_TTL: 900000,        // äºŒçº§ç¼“å­˜TTLï¼š15åˆ†é’Ÿ
      CLEANUP_INTERVAL: 60000 // æ¸…ç†é—´éš”ï¼š1åˆ†é’Ÿ
    };
    
    this.startCleanupTimer();
  }

  // èŽ·å–ç¼“å­˜æ•°æ®
  get(key) {
    // å…ˆæŸ¥ä¸€çº§ç¼“å­˜
    const l1Data = this.L1Cache.get(key);
    if (l1Data && l1Data.expiry > Date.now()) {
      this.cacheStats.hits++;
      l1Data.lastAccess = Date.now();
      return l1Data.data;
    }

    // å†æŸ¥äºŒçº§ç¼“å­˜
    const l2Data = this.L2Cache.get(key);
    if (l2Data && l2Data.expiry > Date.now()) {
      this.cacheStats.hits++;
      
      // æå‡åˆ°ä¸€çº§ç¼“å­˜
      this.setL1(key, l2Data.data, this.config.L1_TTL);
      return l2Data.data;
    }

    this.cacheStats.misses++;
    return null;
  }

  // è®¾ç½®ä¸€çº§ç¼“å­˜
  setL1(key, data, ttl = this.config.L1_TTL) {
    // æ£€æŸ¥å®¹é‡é™åˆ¶
    if (this.L1Cache.size >= this.config.L1_MAX_SIZE) {
      this.evictL1();
    }

    this.L1Cache.set(key, {
      data,
      expiry: Date.now() + ttl,
      lastAccess: Date.now(),
      accessCount: 1
    });
  }

  // è®¾ç½®äºŒçº§ç¼“å­˜
  setL2(key, data, ttl = this.config.L2_TTL) {
    if (this.L2Cache.size >= this.config.L2_MAX_SIZE) {
      this.evictL2();
    }

    this.L2Cache.set(key, {
      data,
      expiry: Date.now() + ttl,
      lastAccess: Date.now(),
      accessCount: 1
    });
  }

  // æ™ºèƒ½è®¾ç½®ç¼“å­˜ï¼ˆè‡ªåŠ¨é€‰æ‹©å±‚çº§ï¼‰
  set(key, data, priority = 'normal') {
    switch (priority) {
      case 'high':
        this.setL1(key, data);
        break;
      case 'normal':
        this.setL2(key, data);
        break;
      case 'low':
        this.setL2(key, data, this.config.L2_TTL / 2);
        break;
    }
  }

  // LRUé©±é€ç­–ç•¥
  evictL1() {
    const entries = Array.from(this.L1Cache.entries());
    entries.sort((a, b) => a[1].lastAccess - b[1].lastAccess);
    
    const toEvict = Math.ceil(entries.length * 0.2); // é©±é€20%
    for (let i = 0; i < toEvict; i++) {
      this.L1Cache.delete(entries[i][0]);
      this.cacheStats.evictions++;
    }
  }

  evictL2() {
    const entries = Array.from(this.L2Cache.entries());
    entries.sort((a, b) => a[1].lastAccess - b[1].lastAccess);
    
    const toEvict = Math.ceil(entries.length * 0.1); // é©±é€10%
    for (let i = 0; i < toEvict; i++) {
      this.L2Cache.delete(entries[i][0]);
      this.cacheStats.evictions++;
    }
  }

  // æ™ºèƒ½é¢„çƒ­ï¼ˆé¢„åŠ è½½çƒ­ç‚¹æ•°æ®ï¼‰
  async warmupCache(levelDb) {
    try {
      // é¢„åŠ è½½æ´»è·ƒç”¨æˆ·æ•°æ®
      const activeUsers = levelDb.db.prepare(`
        SELECT user_id, group_id, level, total_exp, available_points, display_name
        FROM user_levels 
        WHERE updated_at > ? 
        ORDER BY updated_at DESC 
        LIMIT 100
      `).all(Date.now() - (7 * 24 * 60 * 60 * 1000)); // 7å¤©å†…æ´»è·ƒ

      for (const user of activeUsers) {
        const key = `user_profile_${user.user_id}_${user.group_id}`;
        this.setL1(key, user);
      }

      // é¢„åŠ è½½æŽ’è¡Œæ¦œæ•°æ®
      const rankings = levelDb.db.prepare(`
        SELECT user_id, level, total_exp, available_points, display_name
        FROM user_levels 
        WHERE group_id = 'default'
        ORDER BY level DESC, total_exp DESC 
        LIMIT 50
      `).all();

      this.setL1('rankings_default_level_50', rankings);

      console.log(`âœ… ç¼“å­˜é¢„çƒ­å®Œæˆï¼š${activeUsers.length}ä¸ªç”¨æˆ·æ•°æ®`);
    } catch (error) {
      console.error('ç¼“å­˜é¢„çƒ­å¤±è´¥:', error);
    }
  }

  // å®šæ—¶æ¸…ç†è¿‡æœŸæ•°æ®
  startCleanupTimer() {
    setInterval(() => {
      this.cleanup();
    }, this.config.CLEANUP_INTERVAL);
  }

  cleanup() {
    const now = Date.now();
    
    // æ¸…ç†ä¸€çº§ç¼“å­˜
    for (const [key, value] of this.L1Cache.entries()) {
      if (value.expiry <= now) {
        this.L1Cache.delete(key);
      }
    }

    // æ¸…ç†äºŒçº§ç¼“å­˜
    for (const [key, value] of this.L2Cache.entries()) {
      if (value.expiry <= now) {
        this.L2Cache.delete(key);
      }
    }
  }

  // ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
  getStats() {
    const hitRate = this.cacheStats.hits / (this.cacheStats.hits + this.cacheStats.misses) * 100;
    
    return {
      ...this.cacheStats,
      hitRate: hitRate.toFixed(2) + '%',
      l1Size: this.L1Cache.size,
      l2Size: this.L2Cache.size,
      totalSize: this.L1Cache.size + this.L2Cache.size
    };
  }

  // æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
  clear() {
    this.L1Cache.clear();
    this.L2Cache.clear();
    this.cacheStats = { hits: 0, misses: 0, evictions: 0 };
  }

  // åˆ é™¤ç‰¹å®šæ¨¡å¼çš„ç¼“å­˜
  invalidatePattern(pattern) {
    const regex = new RegExp(pattern);
    
    for (const key of this.L1Cache.keys()) {
      if (regex.test(key)) {
        this.L1Cache.delete(key);
      }
    }
    
    for (const key of this.L2Cache.keys()) {
      if (regex.test(key)) {
        this.L2Cache.delete(key);
      }
    }
  }
}
```

#### 6.4 æ€§èƒ½ç›‘æŽ§å’Œè°ƒä¼˜ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹ç›‘æŽ§ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹ç³»ç»Ÿçš„æ€§èƒ½ç›‘æŽ§
class LevelSystemPerformanceMonitor {
  constructor() {
    this.metrics = {
      queries: {
        total: 0,
        slow: 0,
        failed: 0,
        avgDuration: 0
      },
      cache: {
        hits: 0,
        misses: 0,
        hitRate: 0
      },
      transactions: {
        total: 0,
        failed: 0,
        avgDuration: 0
      },
      memory: {
        heapUsed: 0,
        heapTotal: 0,
        external: 0
      }
    };
    
    this.slowQueryThreshold = 100; // 100ms
    this.recentQueries = [];
    this.maxRecentQueries = 100;
    
    this.startMonitoring();
  }

  // è®°å½•æŸ¥è¯¢æ€§èƒ½
  recordQuery(sql, duration, success = true) {
    this.metrics.queries.total++;
    this.metrics.queries.avgDuration = 
      (this.metrics.queries.avgDuration + duration) / 2;
    
    if (!success) {
      this.metrics.queries.failed++;
    }
    
    if (duration > this.slowQueryThreshold) {
      this.metrics.queries.slow++;
      this.recentQueries.push({
        sql: sql.substring(0, 100),
        duration,
        timestamp: Date.now(),
        stack: new Error().stack.split('\n').slice(2, 5).join('\n')
      });
      
      if (this.recentQueries.length > this.maxRecentQueries) {
        this.recentQueries = this.recentQueries.slice(-this.maxRecentQueries);
      }
    }
  }

  // è®°å½•ç¼“å­˜æ€§èƒ½
  recordCacheHit() {
    this.metrics.cache.hits++;
    this.updateCacheHitRate();
  }

  recordCacheMiss() {
    this.metrics.cache.misses++;
    this.updateCacheHitRate();
  }

  updateCacheHitRate() {
    const total = this.metrics.cache.hits + this.metrics.cache.misses;
    this.metrics.cache.hitRate = 
      total > 0 ? (this.metrics.cache.hits / total * 100).toFixed(2) : 0;
  }

  // è®°å½•äº‹åŠ¡æ€§èƒ½
  recordTransaction(duration, success = true) {
    this.metrics.transactions.total++;
    this.metrics.transactions.avgDuration = 
      (this.metrics.transactions.avgDuration + duration) / 2;
    
    if (!success) {
      this.metrics.transactions.failed++;
    }
  }

  // å¼€å§‹ç›‘æŽ§
  startMonitoring() {
    // æ¯30ç§’æ›´æ–°å†…å­˜ç»Ÿè®¡
    setInterval(() => {
      const memUsage = process.memoryUsage();
      this.metrics.memory = {
        heapUsed: Math.round(memUsage.heapUsed / 1024 / 1024),
        heapTotal: Math.round(memUsage.heapTotal / 1024 / 1024),
        external: Math.round(memUsage.external / 1024 / 1024)
      };
    }, 30000);

    // æ¯10åˆ†é’Ÿè¾“å‡ºæ€§èƒ½æŠ¥å‘Š
    setInterval(() => {
      this.logPerformanceReport();
    }, 600000);
  }

  // èŽ·å–æ€§èƒ½æŠ¥å‘Š
  getPerformanceReport() {
    return {
      timestamp: Date.now(),
      metrics: { ...this.metrics },
      slowQueries: this.recentQueries.slice(-10), // æœ€è¿‘10ä¸ªæ…¢æŸ¥è¯¢
      recommendations: this.generateRecommendations()
    };
  }

  // ç”Ÿæˆæ€§èƒ½ä¼˜åŒ–å»ºè®®
  generateRecommendations() {
    const recommendations = [];
    
    if (this.metrics.queries.slow / this.metrics.queries.total > 0.1) {
      recommendations.push('æ£€æµ‹åˆ°è¾ƒå¤šæ…¢æŸ¥è¯¢ï¼Œå»ºè®®ä¼˜åŒ–SQLè¯­å¥æˆ–æ·»åŠ ç´¢å¼•');
    }
    
    if (this.metrics.cache.hitRate < 70) {
      recommendations.push('ç¼“å­˜å‘½ä¸­çŽ‡è¾ƒä½Žï¼Œå»ºè®®è°ƒæ•´ç¼“å­˜ç­–ç•¥æˆ–å¢žåŠ ç¼“å­˜æ—¶é—´');
    }
    
    if (this.metrics.memory.heapUsed > 200) {
      recommendations.push('å†…å­˜ä½¿ç”¨è¾ƒé«˜ï¼Œå»ºè®®æ£€æŸ¥å†…å­˜æ³„æ¼æˆ–ä¼˜åŒ–æ•°æ®ç»“æž„');
    }
    
    if (this.metrics.transactions.failed / this.metrics.transactions.total > 0.05) {
      recommendations.push('äº‹åŠ¡å¤±è´¥çŽ‡è¾ƒé«˜ï¼Œå»ºè®®æ£€æŸ¥å¹¶å‘æŽ§åˆ¶å’Œé”™è¯¯å¤„ç†');
    }
    
    return recommendations;
  }

  // è¾“å‡ºæ€§èƒ½æŠ¥å‘Š
  logPerformanceReport() {
    const report = this.getPerformanceReport();
    console.log('ðŸ” ç­‰çº§ç³»ç»Ÿæ€§èƒ½æŠ¥å‘Š:', JSON.stringify(report, null, 2));
  }

  // é‡ç½®ç»Ÿè®¡æ•°æ®
  reset() {
    this.metrics = {
      queries: { total: 0, slow: 0, failed: 0, avgDuration: 0 },
      cache: { hits: 0, misses: 0, hitRate: 0 },
      transactions: { total: 0, failed: 0, avgDuration: 0 },
      memory: { heapUsed: 0, heapTotal: 0, external: 0 }
    };
    this.recentQueries = [];
  }
}
```

### 7. TelegramçŽ¯å¢ƒé€‚é…ï¼ˆåŸºäºŽç‰ˆæœ¬Aå¤ç”¨çŽ°æœ‰BotæœåŠ¡ï¼‰

#### 7.1 æ™ºèƒ½å‘½ä»¤è¯†åˆ«ç³»ç»Ÿï¼ˆåŸºäºŽç‰ˆæœ¬AçŽ°æœ‰BotæŽ¥å£ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Açš„çŽ°æœ‰BotæœåŠ¡é›†æˆ
class TelegramLevelCommands {
  constructor(levelService, botService) {
    this.levelService = levelService;  // ç‰ˆæœ¬Açš„ç‹¬ç«‹ç­‰çº§æœåŠ¡
    this.botService = botService;      // ç‰ˆæœ¬Aè¦æ±‚ï¼šå¤ç”¨çŽ°æœ‰BotæœåŠ¡
    this.commandPatterns = this.initializeCommandPatterns();
  }

  // åˆå§‹åŒ–å‘½ä»¤è¯†åˆ«æ¨¡å¼ï¼ˆæ”¯æŒä¸­æ–‡è‡ªç„¶è¯­è¨€ï¼‰
  initializeCommandPatterns() {
    return {
      // ç­‰çº§æŸ¥è¯¢ç›¸å…³
      levelQuery: [
        /^\/?(æˆ‘çš„)?ç­‰çº§$/i,
        /^\/?(æŸ¥çœ‹|æŸ¥è¯¢)?(æˆ‘çš„)?ç­‰çº§$/i,
        /^\/level$/i,
        /^\/mylevel$/i,
        /^ç­‰çº§ä¿¡æ¯$/i,
        /^ä¸ªäººä¿¡æ¯$/i
      ],
      
      // ç§¯åˆ†æŸ¥è¯¢ç›¸å…³
      pointsQuery: [
        /^\/?(æˆ‘çš„)?ç§¯åˆ†$/i,
        /^\/?(æŸ¥çœ‹|æŸ¥è¯¢)?(æˆ‘çš„)?ç§¯åˆ†$/i,
        /^\/points$/i,
        /^\/mypoints$/i,
        /^ç§¯åˆ†ä½™é¢$/i,
        /^é‡‘å¸$/i
      ],
      
      // æŽ’è¡Œæ¦œç›¸å…³
      ranking: [
        /^\/?(ç­‰çº§)?æŽ’è¡Œæ¦œ?$/i,
        /^\/?(ç§¯åˆ†)?æŽ’è¡Œæ¦œ?$/i,
        /^\/ranking$/i,
        /^\/leaderboard$/i,
        /^æ¦œå•$/i,
        /^æŽ’å$/i
      ],
      
      // å‹‹ç« æŸ¥è¯¢ç›¸å…³
      badges: [
        /^\/?(æˆ‘çš„)?å‹‹ç« $/i,
        /^\/?(æŸ¥çœ‹|æŸ¥è¯¢)?(æˆ‘çš„)?å‹‹ç« $/i,
        /^\/badges$/i,
        /^\/mybadges$/i,
        /^æˆå°±$/i
      ],
      
      // å¸®åŠ©ä¿¡æ¯
      help: [
        /^\/?(help|å¸®åŠ©)$/i,
        /^ç­‰çº§ç³»ç»Ÿå¸®åŠ©$/i,
        /^æ€Žä¹ˆçŽ©$/i,
        /^è¯´æ˜Ž$/i
      ]
    };
  }

  // æ™ºèƒ½å‘½ä»¤åŒ¹é…ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„çŽ°æœ‰æ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼‰
  async handleMessage(msg) {
    if (!msg.text) return false;
    
    const text = msg.text.trim();
    const userId = msg.from.id;
    const groupId = msg.chat.id;
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºç­‰çº§ç³»ç»Ÿç›¸å…³å‘½ä»¤
    const commandType = this.identifyCommand(text);
    if (!commandType) return false;
    
    try {
      switch (commandType) {
        case 'levelQuery':
          await this.handleLevelQuery(userId, groupId, msg);
          break;
        case 'pointsQuery':
          await this.handlePointsQuery(userId, groupId, msg);
          break;
        case 'ranking':
          await this.handleRanking(groupId, msg, text);
          break;
        case 'badges':
          await this.handleBadgesQuery(userId, groupId, msg);
          break;
        case 'help':
          await this.handleHelp(groupId, msg);
          break;
      }
      return true;
    } catch (error) {
      console.error('ç­‰çº§å‘½ä»¤å¤„ç†å¤±è´¥:', error);
      await this.sendErrorMessage(groupId, msg);
      return false;
    }
  }

  // å‘½ä»¤ç±»åž‹è¯†åˆ«
  identifyCommand(text) {
    for (const [commandType, patterns] of Object.entries(this.commandPatterns)) {
      for (const pattern of patterns) {
        if (pattern.test(text)) {
          return commandType;
        }
      }
    }
    return null;
  }

  // å¤„ç†ç­‰çº§æŸ¥è¯¢ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“æŸ¥è¯¢ï¼‰
  async handleLevelQuery(userId, groupId, msg) {
    const userProfile = await this.levelService.getUserProfile(userId, groupId);
    
    if (!userProfile) {
      await this.sendNewUserWelcome(userId, groupId, msg);
      return;
    }

    // èŽ·å–ç”¨æˆ·åï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼šå¤ç”¨çŽ°æœ‰æŽ¥å£èŽ·å–ç”¨æˆ·ä¿¡æ¯ï¼‰
    const userInfo = await this.getUserDisplayName(userId, msg);
    
    // èŽ·å–å‹‹ç« ä¿¡æ¯
    const userBadges = await this.levelService.getUserBadges(userId, groupId);
    
    // èŽ·å–ç­‰çº§é…ç½®
    const levelConfig = await this.levelService.getLevelConfig(groupId);
    const currentLevel = levelConfig.levels.find(l => l.level === userProfile.level);
    const nextLevel = levelConfig.levels.find(l => l.level === userProfile.level + 1);
    
    // æ ¼å¼åŒ–ç­‰çº§ä¿¡æ¯
    const levelMessage = this.formatLevelMessage(userProfile, userInfo, currentLevel, nextLevel, userBadges);
    
    // å‘é€æ¶ˆæ¯ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼šå¤ç”¨çŽ°æœ‰BotæœåŠ¡ï¼‰
    await this.botService.sendMessage(groupId, levelMessage, {
      reply_to_message_id: msg.message_id,
      parse_mode: 'HTML'
    });
  }

  // å¤„ç†ç§¯åˆ†æŸ¥è¯¢
  async handlePointsQuery(userId, groupId, msg) {
    const userProfile = await this.levelService.getUserProfile(userId, groupId);
    
    if (!userProfile) {
      await this.sendNewUserWelcome(userId, groupId, msg);
      return;
    }

    const userInfo = await this.getUserDisplayName(userId, msg);
    const pointsHistory = await this.levelService.getUserPointsHistory(userId, groupId, 5);
    
    const pointsMessage = this.formatPointsMessage(userProfile, userInfo, pointsHistory);
    
    await this.botService.sendMessage(groupId, pointsMessage, {
      reply_to_message_id: msg.message_id,
      parse_mode: 'HTML'
    });
  }

  // å¤„ç†æŽ’è¡Œæ¦œæŸ¥è¯¢
  async handleRanking(groupId, msg, originalText) {
    // è¯†åˆ«æŽ’è¡Œæ¦œç±»åž‹
    const rankingType = /ç§¯åˆ†|é‡‘å¸|points/i.test(originalText) ? 'points' : 'level';
    
    const rankings = await this.levelService.getRankings(groupId, rankingType, 10);
    const rankingMessage = this.formatRankingMessage(rankings, rankingType);
    
    await this.botService.sendMessage(groupId, rankingMessage, {
      reply_to_message_id: msg.message_id,
      parse_mode: 'HTML'
    });
  }

  // å¤„ç†å‹‹ç« æŸ¥è¯¢
  async handleBadgesQuery(userId, groupId, msg) {
    const userBadges = await this.levelService.getUserBadges(userId, groupId);
    const userInfo = await this.getUserDisplayName(userId, msg);
    
    const badgesMessage = this.formatBadgesMessage(userBadges, userInfo);
    
    await this.botService.sendMessage(groupId, badgesMessage, {
      reply_to_message_id: msg.message_id,
      parse_mode: 'HTML'
    });
  }

  // å¤„ç†å¸®åŠ©å‘½ä»¤
  async handleHelp(groupId, msg) {
    const helpMessage = this.formatHelpMessage();
    
    await this.botService.sendMessage(groupId, helpMessage, {
      reply_to_message_id: msg.message_id,
      parse_mode: 'HTML'
    });
  }

  // èŽ·å–ç”¨æˆ·æ˜¾ç¤ºåç§°ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼šå¤ç”¨çŽ°æœ‰æŽ¥å£ï¼‰
  async getUserDisplayName(userId, msg) {
    try {
      // ä¼˜å…ˆä½¿ç”¨çŽ°æœ‰çš„ç”¨æˆ·ä¿¡æ¯èŽ·å–æŽ¥å£
      if (this.botService.getUserInfo) {
        const userInfo = await this.botService.getUserInfo(userId);
        if (userInfo) {
          return userInfo.display_name || userInfo.first_name || `ç”¨æˆ·${userId}`;
        }
      }
      
      // å›žé€€åˆ°æ¶ˆæ¯ä¸­çš„ç”¨æˆ·ä¿¡æ¯
      if (msg.from) {
        return msg.from.first_name || msg.from.username || `ç”¨æˆ·${userId}`;
      }
      
      return `ç”¨æˆ·${userId}`;
    } catch (error) {
      console.error('èŽ·å–ç”¨æˆ·æ˜¾ç¤ºåç§°å¤±è´¥:', error);
      return `ç”¨æˆ·${userId}`;
    }
  }

  // æ–°ç”¨æˆ·æ¬¢è¿Žæ¶ˆæ¯
  async sendNewUserWelcome(userId, groupId, msg) {
    const welcomeMessage = `ðŸŽ‰ æ¬¢è¿ŽåŠ å…¥ç­‰çº§ç³»ç»Ÿï¼

ðŸŒŸ æ‚¨æ˜¯æ–°ç”¨æˆ·ï¼Œå®Œæˆç¬¬ä¸€æ¬¡è¯„ä»·åŽå°†å¼€å§‹ç­‰çº§ä¹‹æ—…ï¼

ðŸ’¡ å¯ç”¨å‘½ä»¤ï¼š
â€¢ å‘é€ "æˆ‘çš„ç­‰çº§" æŸ¥çœ‹ç­‰çº§ä¿¡æ¯
â€¢ å‘é€ "æˆ‘çš„ç§¯åˆ†" æŸ¥çœ‹ç§¯åˆ†ä½™é¢
â€¢ å‘é€ "æŽ’è¡Œæ¦œ" æŸ¥çœ‹ç¾¤ç»„æŽ’å
â€¢ å‘é€ "æˆ‘çš„å‹‹ç« " æŸ¥çœ‹èŽ·å¾—çš„å‹‹ç« 

å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡å‡ºå‡»å§ï¼ðŸš€`;

    await this.botService.sendMessage(groupId, welcomeMessage, {
      reply_to_message_id: msg.message_id
    });
  }

  // é”™è¯¯æ¶ˆæ¯å¤„ç†
  async sendErrorMessage(groupId, msg) {
    const errorMessage = `âŒ ç­‰çº§ç³»ç»Ÿæš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åŽé‡è¯•ã€‚

å¦‚æžœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚`;

    await this.botService.sendMessage(groupId, errorMessage, {
      reply_to_message_id: msg.message_id
    });
  }
}
```

#### 7.2 æ¶ˆæ¯æ ¼å¼åŒ–ç³»ç»Ÿï¼ˆåŸºäºŽç‰ˆæœ¬Açš„Telegramä¼˜åŒ–ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Açš„Telegramæ¶ˆæ¯æ ¼å¼åŒ–ä¼˜åŒ–
class TelegramMessageFormatter {
  constructor() {
    this.emojis = {
      levels: ['ðŸŸ¢', 'ðŸ”µ', 'ðŸŸ£', 'ðŸŸ ', 'ðŸ”´', 'ðŸŸ¡', 'âšª', 'ðŸŸ¤', 'âš«', 'ðŸŒŸ'],
      rarity: {
        common: 'âšª',
        rare: 'ðŸ”µ', 
        epic: 'ðŸŸ£',
        legendary: 'ðŸŸ¡'
      },
      actions: {
        exp: 'ðŸ“ˆ',
        points: 'ðŸ’Ž',
        level: 'â­',
        badge: 'ðŸ†',
        ranking: 'ðŸ…'
      }
    };
  }

  // æ ¼å¼åŒ–ç­‰çº§ä¿¡æ¯æ¶ˆæ¯
  formatLevelMessage(userProfile, userInfo, currentLevel, nextLevel, userBadges) {
    const progressBar = this.createProgressBar(
      userProfile.total_exp, 
      currentLevel?.required_exp || 0, 
      nextLevel?.required_exp || userProfile.total_exp
    );

    const badgesDisplay = userBadges.length > 0 
      ? userBadges.map(badge => `${badge.emoji} ${badge.name}`).join(' ')
      : 'æš‚æ— å‹‹ç« ';

    return `ðŸ§‘â€ðŸš€ <b>${userInfo}</b> çš„ç­‰çº§æ¡£æ¡ˆ

â­ <b>å½“å‰ç­‰çº§ï¼š</b>Lv.${userProfile.level} ${currentLevel?.name || 'æœªçŸ¥ç­‰çº§'}
ðŸ“ˆ <b>ç»éªŒå€¼ï¼š</b>${userProfile.total_exp}${nextLevel ? `/${nextLevel.required_exp}` : ''}
${nextLevel ? progressBar : ''}
${nextLevel ? `<i>è·ç¦»å‡çº§è¿˜éœ€ ${nextLevel.required_exp - userProfile.total_exp} ç»éªŒ</i>` : '<i>å·²è¾¾åˆ°æœ€é«˜ç­‰çº§ï¼</i>'}

ðŸ’Ž <b>ç§¯åˆ†ä½™é¢ï¼š</b>${userProfile.available_points}ç§¯åˆ†
ðŸ’° <b>ç´¯è®¡èŽ·å¾—ï¼š</b>${userProfile.total_points_earned}ç§¯åˆ†
ðŸ’¸ <b>ç´¯è®¡æ¶ˆè´¹ï¼š</b>${userProfile.total_points_spent}ç§¯åˆ†

âš”ï¸ <b>æ´»åŠ¨ç»Ÿè®¡ï¼š</b>
â€¢ å‡ºå‡»æ¬¡æ•°ï¼š${userProfile.attack_count}æ¬¡
â€¢ ç”¨æˆ·è¯„ä»·ï¼š${userProfile.user_eval_count}æ¬¡  
â€¢ å•†å®¶è¯„ä»·ï¼š${userProfile.merchant_eval_count}æ¬¡
â€¢ æ–‡å­—è¯„ä»·ï¼š${userProfile.text_eval_count}æ¬¡

ðŸ† <b>æ‹¥æœ‰å‹‹ç« ï¼š</b>
${badgesDisplay}

<i>ç»§ç»­åŠªåŠ›ï¼Œå‹‡æ”€é«˜å³°ï¼</i> ðŸ’ª`;
  }

  // æ ¼å¼åŒ–ç§¯åˆ†ä¿¡æ¯æ¶ˆæ¯
  formatPointsMessage(userProfile, userInfo, pointsHistory) {
    const historyText = pointsHistory.length > 0
      ? pointsHistory.map(log => 
          `â€¢ ${this.formatTimestamp(log.timestamp)} ${log.description} <code>${log.points_change > 0 ? '+' : ''}${log.points_change}</code>`
        ).join('\n')
      : 'æš‚æ— ç§¯åˆ†è®°å½•';

    return `ðŸ’Ž <b>${userInfo}</b> çš„ç§¯åˆ†è´¦æˆ·

ðŸ’° <b>å½“å‰ä½™é¢ï¼š</b>${userProfile.available_points}ç§¯åˆ†
ðŸ“ˆ <b>ç´¯è®¡èŽ·å¾—ï¼š</b>${userProfile.total_points_earned}ç§¯åˆ†
ðŸ“‰ <b>ç´¯è®¡æ¶ˆè´¹ï¼š</b>${userProfile.total_points_spent}ç§¯åˆ†

ðŸ“Š <b>æœ€è¿‘è®°å½•ï¼š</b>
${historyText}

<i>ç§¯åˆ†å¯ç”¨äºŽæœªæ¥çš„æŠ½å¥–å’Œç‰¹æ®Šæ´»åŠ¨ï¼</i> ðŸŽ`;
  }

  // æ ¼å¼åŒ–æŽ’è¡Œæ¦œæ¶ˆæ¯
  formatRankingMessage(rankings, type) {
    if (rankings.length === 0) {
      return `ðŸ“Š <b>${type === 'points' ? 'ç§¯åˆ†' : 'ç­‰çº§'}æŽ’è¡Œæ¦œ</b>

æš‚æ— æŽ’åæ•°æ®ã€‚`;
    }

    const title = type === 'points' ? 'ðŸ’Ž ç§¯åˆ†æŽ’è¡Œæ¦œ' : 'â­ ç­‰çº§æŽ’è¡Œæ¦œ';
    const rankingText = rankings.map((user, index) => {
      const medal = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'][index] || 'ðŸ…';
      const value = type === 'points' 
        ? `${user.available_points}ç§¯åˆ†`
        : `Lv.${user.level} (${user.total_exp}ç»éªŒ)`;
      
      const displayName = user.display_name || `ç”¨æˆ·${user.user_id}`;
      
      return `${medal} <b>${index + 1}.</b> ${displayName}\n   ${value}`;
    }).join('\n\n');

    return `${title}

${rankingText}

<i>æ¦œå•æ¯å°æ—¶æ›´æ–°ä¸€æ¬¡</i> â°`;
  }

  // æ ¼å¼åŒ–å‹‹ç« ä¿¡æ¯æ¶ˆæ¯
  formatBadgesMessage(userBadges, userInfo) {
    if (userBadges.length === 0) {
      return `ðŸ† <b>${userInfo}</b> çš„å‹‹ç« æ”¶è—

æš‚æ— å‹‹ç« ï¼Œç»§ç»­åŠªåŠ›èŽ·å¾—æ‚¨çš„ç¬¬ä¸€ä¸ªå‹‹ç« å§ï¼ ðŸ’ª

<i>å‹‹ç« é€šè¿‡å®Œæˆç‰¹å®šæˆå°±è‡ªåŠ¨èŽ·å¾—</i>`;
    }

    const badgesByRarity = userBadges.reduce((acc, badge) => {
      if (!acc[badge.rarity]) acc[badge.rarity] = [];
      acc[badge.rarity].push(badge);
      return acc;
    }, {});

    let badgesText = '';
    const rarityOrder = ['legendary', 'epic', 'rare', 'common'];
    
    for (const rarity of rarityOrder) {
      if (badgesByRarity[rarity]) {
        const rarityName = {
          legendary: 'ä¼ è¯´',
          epic: 'å²è¯—', 
          rare: 'ç¨€æœ‰',
          common: 'æ™®é€š'
        }[rarity];
        
        badgesText += `\n${this.emojis.rarity[rarity]} <b>${rarityName}å‹‹ç« ï¼š</b>\n`;
        badgesText += badgesByRarity[rarity].map(badge => 
          `  ${badge.emoji} ${badge.name}`
        ).join('\n') + '\n';
      }
    }

    return `ðŸ† <b>${userInfo}</b> çš„å‹‹ç« æ”¶è—

<b>æ€»è®¡ï¼š${userBadges.length}ä¸ªå‹‹ç« </b>
${badgesText}
<i>å‹‹ç« æ˜¯æ‚¨æˆå°±çš„è±¡å¾ï¼</i> âœ¨`;
  }

  // æ ¼å¼åŒ–å¸®åŠ©æ¶ˆæ¯
  formatHelpMessage() {
    return `ðŸŽ® <b>ç­‰çº§ç³»ç»Ÿä½¿ç”¨æŒ‡å—</b>

ðŸ“ <b>èŽ·å¾—ç»éªŒå’Œç§¯åˆ†çš„æ–¹å¼ï¼š</b>
â€¢ ðŸŽ¯ å®Œæˆå‡ºå‡»ï¼š+20ç»éªŒï¼Œ+10ç§¯åˆ†
â€¢ ðŸ“ 12é¡¹æŒ‰é’®è¯„ä»·ï¼š+30ç»éªŒï¼Œ+25ç§¯åˆ†  
â€¢ ðŸª å•†å®¶è¯„ä»·ï¼š+25ç»éªŒï¼Œ+20ç§¯åˆ†
â€¢ âœï¸ æ–‡å­—è¯„ä»·ï¼š+15ç»éªŒï¼Œ+15ç§¯åˆ†
â€¢ ðŸ’¯ æ»¡åˆ†è¯„ä»·ï¼šé¢å¤–+50ç»éªŒï¼Œ+100ç§¯åˆ†

â­ <b>ç­‰çº§ç³»ç»Ÿï¼š</b>
â€¢ ç»éªŒå€¼ç”¨äºŽå‡çº§ï¼ˆæ°¸ä¸å‡å°‘ï¼‰
â€¢ å‡çº§èŽ·å¾—é¢å¤–ç§¯åˆ†å¥–åŠ±
â€¢ å…±10ä¸ªç­‰çº§ï¼šä»Žæ–°æ‰‹å‹‡å£«åˆ°è‡³å°Šå‹‡å£«

ðŸ’Ž <b>ç§¯åˆ†ç³»ç»Ÿï¼š</b>
â€¢ ç§¯åˆ†å¯æ¶ˆè´¹ï¼Œç”¨äºŽæœªæ¥æŠ½å¥–
â€¢ ä¸Žç»éªŒå€¼ç‹¬ç«‹è®¡ç®—

ðŸ† <b>å‹‹ç« ç³»ç»Ÿï¼š</b>
â€¢ å®Œæˆç‰¹å®šæˆå°±è‡ªåŠ¨èŽ·å¾—
â€¢ ç¨€æœ‰åº¦ï¼šæ™®é€šã€ç¨€æœ‰ã€å²è¯—ã€ä¼ è¯´

ðŸ“± <b>å¯ç”¨å‘½ä»¤ï¼š</b>
â€¢ <code>æˆ‘çš„ç­‰çº§</code> - æŸ¥çœ‹ç­‰çº§ä¿¡æ¯
â€¢ <code>æˆ‘çš„ç§¯åˆ†</code> - æŸ¥çœ‹ç§¯åˆ†ä½™é¢  
â€¢ <code>æŽ’è¡Œæ¦œ</code> - æŸ¥çœ‹ç¾¤ç»„æŽ’å
â€¢ <code>æˆ‘çš„å‹‹ç« </code> - æŸ¥çœ‹èŽ·å¾—çš„å‹‹ç« 

<i>å¼€å§‹æ‚¨çš„å‡çº§ä¹‹æ—…å§ï¼</i> ðŸš€`;
  }

  // åˆ›å»ºè¿›åº¦æ¡
  createProgressBar(current, min, max, length = 10) {
    if (max <= min) return '';
    
    const progress = Math.max(0, Math.min(1, (current - min) / (max - min)));
    const filled = Math.round(progress * length);
    const empty = length - filled;
    
    return `${'â–ˆ'.repeat(filled)}${'â–‘'.repeat(empty)} ${Math.round(progress * 100)}%`;
  }

  // æ ¼å¼åŒ–æ—¶é—´æˆ³
  formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffDays > 0) {
      return `${diffDays}å¤©å‰`;
    } else if (diffHours > 0) {
      return `${diffHours}å°æ—¶å‰`;
    } else {
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      return `${diffMinutes}åˆ†é’Ÿå‰`;
    }
  }

  // HTMLè½¬ä¹‰
  escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  }
}
```

#### 7.3 ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„Telegramç‰¹æ€§ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Açš„Telegramç”¨æˆ·ä½“éªŒä¼˜åŒ–
class TelegramUXOptimizer {
  constructor(botService, levelService) {
    this.botService = botService;    // ç‰ˆæœ¬Aè¦æ±‚ï¼šå¤ç”¨çŽ°æœ‰BotæœåŠ¡
    this.levelService = levelService; // ç‰ˆæœ¬Açš„ç‹¬ç«‹ç­‰çº§æœåŠ¡
    this.recentInteractions = new Map(); // é˜²æ­¢é‡å¤æŸ¥è¯¢
    this.typingIndicators = new Map();   // æ‰“å­—æŒ‡ç¤ºå™¨ç®¡ç†
  }

  // æ™ºèƒ½å“åº”å»¶è¿Ÿï¼ˆæ¨¡æ‹ŸçœŸå®žç”¨æˆ·ä½“éªŒï¼‰
  async sendWithTyping(chatId, message, options = {}) {
    // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
    await this.showTypingIndicator(chatId);
    
    // æ ¹æ®æ¶ˆæ¯é•¿åº¦è®¡ç®—åˆç†çš„å»¶è¿Ÿ
    const delay = Math.min(3000, Math.max(500, message.length * 30));
    await new Promise(resolve => setTimeout(resolve, delay));
    
    // å‘é€æ¶ˆæ¯
    return await this.botService.sendMessage(chatId, message, options);
  }

  // æ‰“å­—æŒ‡ç¤ºå™¨ç®¡ç†
  async showTypingIndicator(chatId) {
    try {
      // é¿å…é‡å¤å‘é€æ‰“å­—æŒ‡ç¤ºå™¨
      if (this.typingIndicators.has(chatId)) return;
      
      this.typingIndicators.set(chatId, Date.now());
      await this.botService.sendChatAction(chatId, 'typing');
      
      // æ¸…ç†æ ‡è®°
      setTimeout(() => {
        this.typingIndicators.delete(chatId);
      }, 5000);
    } catch (error) {
      console.error('å‘é€æ‰“å­—æŒ‡ç¤ºå™¨å¤±è´¥:', error);
    }
  }

  // é˜²æ­¢é‡å¤æŸ¥è¯¢
  isRecentQuery(userId, queryType) {
    const key = `${userId}_${queryType}`;
    const lastQuery = this.recentInteractions.get(key);
    const now = Date.now();
    
    if (lastQuery && (now - lastQuery) < 10000) { // 10ç§’å†…é‡å¤æŸ¥è¯¢
      return true;
    }
    
    this.recentInteractions.set(key, now);
    
    // æ¸…ç†è¿‡æœŸè®°å½•
    setTimeout(() => {
      this.recentInteractions.delete(key);
    }, 30000);
    
    return false;
  }

  // æ™ºèƒ½æ¶ˆæ¯åˆ†å‰²ï¼ˆé¿å…æ¶ˆæ¯è¿‡é•¿ï¼‰
  splitLongMessage(message, maxLength = 4000) {
    if (message.length <= maxLength) {
      return [message];
    }
    
    const parts = [];
    let currentPart = '';
    const lines = message.split('\n');
    
    for (const line of lines) {
      if ((currentPart + line + '\n').length > maxLength) {
        if (currentPart) {
          parts.push(currentPart.trim());
          currentPart = line + '\n';
        } else {
          // å•è¡Œå¤ªé•¿ï¼Œå¼ºåˆ¶åˆ†å‰²
          const chunks = this.chunkString(line, maxLength - 50);
          parts.push(...chunks);
        }
      } else {
        currentPart += line + '\n';
      }
    }
    
    if (currentPart) {
      parts.push(currentPart.trim());
    }
    
    return parts;
  }

  chunkString(str, size) {
    const chunks = [];
    for (let i = 0; i < str.length; i += size) {
      chunks.push(str.slice(i, i + size));
    }
    return chunks;
  }

  // å†…è”é”®ç›˜ç”Ÿæˆï¼ˆç”¨äºŽå¿«é€Ÿæ“ä½œï¼‰
  createInlineKeyboard(type, userId, groupId) {
    switch (type) {
      case 'level_detail':
        return {
          inline_keyboard: [
            [
              { text: 'ðŸ’Ž ç§¯åˆ†è¯¦æƒ…', callback_data: `points_${userId}` },
              { text: 'ðŸ† æˆ‘çš„å‹‹ç« ', callback_data: `badges_${userId}` }
            ],
            [
              { text: 'ðŸ… æŽ’è¡Œæ¦œ', callback_data: `ranking_level_${groupId}` },
              { text: 'ðŸ“Š ç§¯åˆ†æ¦œ', callback_data: `ranking_points_${groupId}` }
            ]
          ]
        };
        
      case 'ranking_nav':
        return {
          inline_keyboard: [
            [
              { text: 'â­ ç­‰çº§æ¦œ', callback_data: `ranking_level_${groupId}` },
              { text: 'ðŸ’Ž ç§¯åˆ†æ¦œ', callback_data: `ranking_points_${groupId}` }
            ],
            [
              { text: 'ðŸ”„ åˆ·æ–°', callback_data: `refresh_ranking_${groupId}` }
            ]
          ]
        };
        
      case 'badge_detail':
        return {
          inline_keyboard: [
            [
              { text: 'ðŸ“ˆ æˆ‘çš„ç­‰çº§', callback_data: `level_${userId}` },
              { text: 'ðŸ… æŽ’è¡Œæ¦œ', callback_data: `ranking_level_${groupId}` }
            ]
          ]
        };
        
      default:
        return null;
    }
  }

  // å¤„ç†å†…è”é”®ç›˜å›žè°ƒ
  async handleCallbackQuery(callbackQuery) {
    const data = callbackQuery.data;
    const userId = callbackQuery.from.id;
    const chatId = callbackQuery.message.chat.id;
    
    try {
      if (data.startsWith('points_')) {
        const targetUserId = data.split('_')[1];
        if (targetUserId == userId) {
          await this.sendPointsDetail(userId, chatId, callbackQuery);
        }
      } else if (data.startsWith('badges_')) {
        const targetUserId = data.split('_')[1];
        if (targetUserId == userId) {
          await this.sendBadgesDetail(userId, chatId, callbackQuery);
        }
      } else if (data.startsWith('ranking_')) {
        const [, type, groupId] = data.split('_');
        await this.sendRankingDetail(type, groupId, callbackQuery);
      }
      
      // å›žåº”å›žè°ƒæŸ¥è¯¢
      await this.botService.answerCallbackQuery(callbackQuery.id, {
        text: 'âœ… æ“ä½œå®Œæˆ'
      });
    } catch (error) {
      console.error('å¤„ç†å†…è”é”®ç›˜å›žè°ƒå¤±è´¥:', error);
      await this.botService.answerCallbackQuery(callbackQuery.id, {
        text: 'âŒ æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•'
      });
    }
  }

  // å‘é€ç§¯åˆ†è¯¦æƒ…
  async sendPointsDetail(userId, chatId, callbackQuery) {
    const userProfile = await this.levelService.getUserProfile(userId, chatId);
    const pointsHistory = await this.levelService.getUserPointsHistory(userId, chatId, 10);
    
    const formatter = new TelegramMessageFormatter();
    const userInfo = callbackQuery.from.first_name || `ç”¨æˆ·${userId}`;
    const message = formatter.formatPointsMessage(userProfile, userInfo, pointsHistory);
    
    await this.botService.editMessageText(chatId, callbackQuery.message.message_id, message, {
      parse_mode: 'HTML',
      reply_markup: this.createInlineKeyboard('level_detail', userId, chatId)
    });
  }

  // å‘é€å‹‹ç« è¯¦æƒ…
  async sendBadgesDetail(userId, chatId, callbackQuery) {
    const userBadges = await this.levelService.getUserBadges(userId, chatId);
    
    const formatter = new TelegramMessageFormatter();
    const userInfo = callbackQuery.from.first_name || `ç”¨æˆ·${userId}`;
    const message = formatter.formatBadgesMessage(userBadges, userInfo);
    
    await this.botService.editMessageText(chatId, callbackQuery.message.message_id, message, {
      parse_mode: 'HTML',
      reply_markup: this.createInlineKeyboard('badge_detail', userId, chatId)
    });
  }

  // å‘é€æŽ’è¡Œæ¦œè¯¦æƒ…
  async sendRankingDetail(type, groupId, callbackQuery) {
    const rankings = await this.levelService.getRankings(groupId, type, 20);
    
    const formatter = new TelegramMessageFormatter();
    const message = formatter.formatRankingMessage(rankings, type);
    
    await this.botService.editMessageText(groupId, callbackQuery.message.message_id, message, {
      parse_mode: 'HTML',
      reply_markup: this.createInlineKeyboard('ranking_nav', null, groupId)
    });
  }

  // é”™è¯¯æ¢å¤å’Œé‡è¯•æœºåˆ¶
  async safeApiCall(apiCall, retries = 3, delay = 1000) {
    for (let i = 0; i < retries; i++) {
      try {
        return await apiCall();
      } catch (error) {
        if (i === retries - 1) throw error;
        
        // æŒ‡æ•°é€€é¿
        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
      }
    }
  }

  // æ¶ˆæ¯æ¸…ç†ï¼ˆå®šæœŸæ¸…ç†Botæ¶ˆæ¯ï¼‰
  scheduleMessageCleanup(chatId, messageId, delay = 300000) { // 5åˆ†é’ŸåŽæ¸…ç†
    setTimeout(async () => {
      try {
        await this.botService.deleteMessage(chatId, messageId);
      } catch (error) {
        // å¿½ç•¥åˆ é™¤å¤±è´¥ï¼ˆæ¶ˆæ¯å¯èƒ½å·²è¢«åˆ é™¤ï¼‰
      }
    }, delay);
  }
}
```

#### 7.4 ç”¨æˆ·ç•Œé¢è®¾è®¡
```
ðŸ§‘â€ðŸš€ç¾¤å‹åç§°: é’¢é“ä¾  (@gangtie2)
â­ç­‰çº§ä¿¡æ¯: Lv.4 é«˜çº§å‹‡å£« ðŸŸ 
âš”ï¸å‡ºå‡»æ¬¡æ•°: 15æ¬¡ | ç”¨æˆ·è¯„ä»·: 8æ¬¡ | å•†å®¶è¯„ä»·: 12æ¬¡ | æ–‡å­—è¯„ä»·: 6æ¬¡
ðŸ’Žå½“å‰ç§¯åˆ†: 280ç§¯åˆ† (æ€»èŽ·å¾—: 380ç§¯åˆ†, æ€»æ¶ˆè´¹: 100ç§¯åˆ†)
ðŸ“ˆç»éªŒå€¼: 450/500 (è·ç¦»å‡çº§è¿˜éœ€50ç»éªŒ)

ðŸ†æ‹¥æœ‰å‹‹ç« :
è¯„ä»·å¤§å¸ˆ ðŸ“ | ç»éªŒæ–°æ‰‹ â­ | ç§¯åˆ†æ”¶é›†å®¶ ðŸ’°

ðŸ“Šè¿‘æœŸå¥–åŠ±è®°å½•:
â€¢ 2024-01-15 å®Œæˆç”¨æˆ·è¯„ä»· +30ç»éªŒ, +25ç§¯åˆ†
â€¢ 2024-01-14 å®Œæˆå‡ºå‡» +20ç»éªŒ, +10ç§¯åˆ†
â€¢ 2024-01-13 æ–‡å­—è¯„ä»·å¥–åŠ± +15ç»éªŒ, +15ç§¯åˆ†
â€¢ 2024-01-12 ç®¡ç†å‘˜è°ƒæ•´ +0ç»éªŒ, +50ç§¯åˆ†
â€¢ 2024-01-11 èŽ·å¾—æ»¡åˆ†å¥–åŠ± +50ç»éªŒ, +100ç§¯åˆ†

ðŸŽ¯å‡çº§å¥–åŠ±é¢„å‘Š:
ä¸‹ä¸€ç­‰çº§: Lv.5 ä¸“å®¶å‹‡å£« ðŸ”´
å‡çº§å¥–åŠ±: ç‰¹æ®Šç§°å· + 50ç§¯åˆ†å¥–åŠ±
æ½œåœ¨å‹‹ç« : ðŸ†å®Œç¾Žæˆ˜å£« (è¿˜éœ€5æ¬¡æ»¡åˆ†è¯„ä»·)
```

#### 7.2 å‡çº§é€šçŸ¥æ¶ˆæ¯
```
ðŸŽ‰æ­å–œå‡çº§ï¼ðŸŽ‰

ðŸ§‘â€ðŸš€ç¾¤å‹: é’¢é“ä¾ 
â­æ–°ç­‰çº§: Lv.4 é«˜çº§å‹‡å£« ðŸŸ 
ðŸ’Žå‡çº§å¥–åŠ±: 50ç§¯åˆ†
ðŸ“ˆæ€»ç»éªŒ: 450ç‚¹

ðŸ†å‡çº§æˆå°±:
â€¢ å®Œæˆ15æ¬¡è¯„ä»·
â€¢ è¯¦ç»†è¯„ä»·8æ¬¡
â€¢ ç§¯åˆ†æ€»è®¡380ç‚¹

ç»§ç»­åŠªåŠ›ï¼Œæˆä¸ºä¼ è¯´å‹‡å£«ï¼ðŸ’ª
```

### 8. ç®¡ç†ç•Œé¢è®¾è®¡ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹åŽŸåˆ™ï¼‰

#### 8.1 ç»¼åˆç®¡ç†ç•Œé¢ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æœåŠ¡ï¼‰
```html
<!DOCTYPE html>
<html>
<head>
    <title>ç­‰çº§ç³»ç»Ÿç®¡ç†ä¸­å¿ƒï¼ˆç‹¬ç«‹ç‰ˆæœ¬ï¼‰</title>
    <style>
        .admin-container { max-width: 1400px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif; }
        .system-status { background: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .status-enabled { background: #d4edda; color: #155724; padding: 5px 10px; border-radius: 3px; }
        .status-disabled { background: #f8d7da; color: #721c24; padding: 5px 10px; border-radius: 3px; }
        .tab-container { margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-button { padding: 12px 24px; margin-right: 5px; border: none; background: #f8f9fa; cursor: pointer; border-radius: 5px 5px 0 0; }
        .tab-button.active { background: #007cba; color: white; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0; }
        .form-section { background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 15px 0; border: 1px solid #e9ecef; }
        .level-config-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .level-config-table th, .level-config-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .level-config-table th { background: #f8f9fa; font-weight: bold; }
        .user-search-result { background: #ffffff; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; margin: 10px 0; }
        .badge-item { display: inline-block; background: #fff3cd; padding: 8px 12px; margin: 5px; border-radius: 20px; border: 1px solid #ffeaa7; }
        .export-import { background: #e7f3ff; padding: 20px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #007cba; }
        .warning-box { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #ffc107; }
        .success-box { background: #d4edda; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #28a745; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #007cba; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-align: center; }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>ðŸ† ç­‰çº§ç³»ç»Ÿç®¡ç†ä¸­å¿ƒ</h1>
        
        <!-- ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ï¼ˆç‰ˆæœ¬Aæ ¸å¿ƒåŠŸèƒ½ï¼‰ -->
        <div class="system-status">
            <h2>ðŸ”§ ç³»ç»ŸçŠ¶æ€ç›‘æŽ§</h2>
            <div class="form-grid">
                <div>
                    <p><strong>ç­‰çº§ç³»ç»ŸçŠ¶æ€ï¼š</strong><span id="systemStatus" class="status-enabled">æ£€æŸ¥ä¸­...</span></p>
                    <p><strong>ç‹¬ç«‹æ•°æ®åº“ï¼š</strong><span id="dbStatus">level_system.db</span></p>
                    <p><strong>æ•°æ®åº“è·¯å¾„ï¼š</strong><span id="dbPath">/app/data/level_system.db</span></p>
                    <p><strong>ä¸ŽçŽ°æœ‰ç³»ç»Ÿéš”ç¦»ï¼š</strong><span class="status-enabled">å®Œå…¨ç‹¬ç«‹</span></p>
                </div>
                <div>
                    <p><strong>ç”¨æˆ·æ€»æ•°ï¼š</strong><span id="totalUsers">-</span></p>
                    <p><strong>æ´»è·ƒç¾¤ç»„ï¼š</strong><span id="activeGroups">-</span></p>
                    <p><strong>æ•°æ®åº“å¤§å°ï¼š</strong><span id="dbSize">-</span></p>
                    <button class="btn-warning" onclick="toggleLevelSystem()">âš™ï¸ å¯ç”¨/ç¦ç”¨ç³»ç»Ÿ</button>
                </div>
            </div>
        </div>
        
        <!-- é¡¶éƒ¨å¯¼èˆªæ ‡ç­¾ -->
        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab('dashboard')">ðŸ“Š æ¦‚è§ˆ</button>
            <button class="tab-button" onclick="switchTab('users')">ðŸ‘¥ ç”¨æˆ·ç®¡ç†</button>
            <button class="tab-button" onclick="switchTab('levels')">â­ ç­‰çº§é…ç½®</button>
            <button class="tab-button" onclick="switchTab('rewards')">ðŸŽ å¥–åŠ±è§„åˆ™</button>
            <button class="tab-button" onclick="switchTab('badges')">ðŸ† å‹‹ç« ç®¡ç†</button>
            <button class="tab-button" onclick="switchTab('broadcast')">ðŸ“¢ æ’­æŠ¥é…ç½®</button>
            <button class="tab-button" onclick="switchTab('data')">ðŸ’¾ æ•°æ®ç®¡ç†</button>
        </div>

        <!-- æ¦‚è§ˆä»ªè¡¨æ¿ -->
        <div id="dashboard" class="tab-content active">
            <h2>ðŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h2>
            
            <!-- å…³é”®æŒ‡æ ‡ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ðŸ‘¥ æ€»ç”¨æˆ·æ•°</h3>
                    <p id="dashboardTotalUsers" style="font-size: 2em; color: #007cba;">-</p>
                </div>
                <div class="stat-card">
                    <h3>ðŸ† æ€»ç§¯åˆ†å‘æ”¾</h3>
                    <p id="dashboardTotalPoints" style="font-size: 2em; color: #28a745;">-</p>
                </div>
                <div class="stat-card">
                    <h3>â­ å¹³å‡ç­‰çº§</h3>
                    <p id="dashboardAvgLevel" style="font-size: 2em; color: #ffc107;">-</p>
                </div>
                <div class="stat-card">
                    <h3>ðŸŽ–ï¸ å‹‹ç« æ€»æ•°</h3>
                    <p id="dashboardTotalBadges" style="font-size: 2em; color: #6f42c1;">-</p>
                </div>
            </div>

            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="form-section">
                <h3>ðŸš€ å¿«é€Ÿæ“ä½œ</h3>
                <div class="form-grid">
                    <div>
                        <button class="btn-primary" onclick="openUserSearch()">ðŸ” æŸ¥æ‰¾ç”¨æˆ·</button>
                        <button class="btn-success" onclick="openPointsAdjust()">ðŸ’° è°ƒæ•´ç§¯åˆ†</button>
                        <button class="btn-warning" onclick="openBadgeAward()">ðŸ† æŽˆäºˆå‹‹ç« </button>
                    </div>
                    <div>
                        <button class="btn-primary" onclick="exportAllData()">ðŸ“¤ å¯¼å‡ºæ•°æ®</button>
                        <button class="btn-warning" onclick="generateReport()">ðŸ“Š ç”ŸæˆæŠ¥å‘Š</button>
                        <button class="btn-danger" onclick="systemMaintenance()">ðŸ”§ ç³»ç»Ÿç»´æŠ¤</button>
                    </div>
                </div>
            </div>

            <!-- æœ€è¿‘æ´»åŠ¨ -->
            <div class="form-section">
                <h3>ðŸ“ˆ æœ€è¿‘æ´»åŠ¨</h3>
                <div id="recentActivity">
                    <!-- åŠ¨æ€åŠ è½½æœ€è¿‘æ´»åŠ¨ -->
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·ç®¡ç†ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“æŸ¥è¯¢ï¼‰ -->
        <div id="users" class="tab-content">
            <h2>ðŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
            
            <!-- ç”¨æˆ·æœç´¢ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰ -->
            <div class="form-section">
                <h3>ðŸ” ç”¨æˆ·æœç´¢</h3>
                <div class="form-grid">
                    <div>
                        <label><strong>æœç´¢æ–¹å¼ï¼š</strong></label>
                        <select id="searchType">
                            <option value="user_id">ç”¨æˆ·ID</option>
                            <option value="display_name">æ˜¾ç¤ºåç§°</option>
                            <option value="level_range">ç­‰çº§èŒƒå›´</option>
                            <option value="points_range">ç§¯åˆ†èŒƒå›´</option>
                        </select>
                        <input type="text" id="searchQuery" placeholder="è¾“å…¥æœç´¢å†…å®¹">
                        <button class="btn-primary" onclick="searchUsers()">ðŸ” æœç´¢</button>
                    </div>
                    <div>
                        <label><strong>ç»“æžœæŽ’åºï¼š</strong></label>
                        <select id="sortBy">
                            <option value="level_desc">ç­‰çº§ï¼ˆé«˜åˆ°ä½Žï¼‰</option>
                            <option value="level_asc">ç­‰çº§ï¼ˆä½Žåˆ°é«˜ï¼‰</option>
                            <option value="points_desc">ç§¯åˆ†ï¼ˆå¤šåˆ°å°‘ï¼‰</option>
                            <option value="points_asc">ç§¯åˆ†ï¼ˆå°‘åˆ°å¤šï¼‰</option>
                            <option value="recent">æœ€è¿‘æ´»è·ƒ</option>
                        </select>
                        <button class="btn-success" onclick="exportUserList()">ðŸ“¤ å¯¼å‡ºåˆ—è¡¨</button>
                    </div>
                </div>
                
                <!-- æœç´¢ç»“æžœ -->
                <div id="userSearchResults">
                    <!-- åŠ¨æ€æ˜¾ç¤ºæœç´¢ç»“æžœ -->
                </div>
            </div>

            <!-- ç”¨æˆ·è¯¦æƒ…å’Œè°ƒæ•´ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ“ä½œï¼‰ -->
            <div class="form-section" id="userDetailsSection" style="display: none;">
                <h3>ðŸ‘¤ ç”¨æˆ·è¯¦æƒ…</h3>
                <div id="userDetails">
                    <!-- åŠ¨æ€åŠ è½½ç”¨æˆ·è¯¦æƒ… -->
                </div>
                
                <!-- ç§¯åˆ†è°ƒæ•´ï¼ˆç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“æ“ä½œï¼‰ -->
                <div class="warning-box">
                    <h4>âš ï¸ ç§¯åˆ†è°ƒæ•´ï¼ˆè°¨æ…Žæ“ä½œï¼‰</h4>
                    <div class="form-grid">
                        <div>
                            <label>è°ƒæ•´ç±»åž‹ï¼š</label>
                            <select id="adjustmentType">
                                <option value="add_points">å¢žåŠ ç§¯åˆ†</option>
                                <option value="subtract_points">å‡å°‘ç§¯åˆ†</option>
                                <option value="add_exp">å¢žåŠ ç»éªŒå€¼</option>
                                <option value="set_level">è®¾ç½®ç­‰çº§</option>
                            </select>
                            <input type="number" id="adjustmentAmount" placeholder="æ•°é‡">
                        </div>
                        <div>
                            <label>è°ƒæ•´åŽŸå› ï¼š</label>
                            <textarea id="adjustmentReason" placeholder="è¯·è¾“å…¥è°ƒæ•´åŽŸå› ï¼ˆå¿…å¡«ï¼‰"></textarea>
                            <button class="btn-warning" onclick="executeAdjustment()">ðŸ’° æ‰§è¡Œè°ƒæ•´</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰¹é‡æ“ä½œ -->
            <div class="form-section">
                <h3>ðŸ“¦ æ‰¹é‡æ“ä½œ</h3>
                <div class="form-grid">
                    <div>
                        <h4>æ‰¹é‡ç§¯åˆ†è°ƒæ•´</h4>
                        <select id="batchCriteria">
                            <option value="all_users">æ‰€æœ‰ç”¨æˆ·</option>
                            <option value="level_range">ç­‰çº§èŒƒå›´</option>
                            <option value="inactive_users">éžæ´»è·ƒç”¨æˆ·</option>
                        </select>
                        <input type="number" id="batchAmount" placeholder="è°ƒæ•´æ•°é‡">
                        <textarea id="batchReason" placeholder="æ‰¹é‡æ“ä½œåŽŸå› "></textarea>
                    </div>
                    <div>
                        <h4>æ‰¹é‡å‹‹ç« æŽˆäºˆ</h4>
                        <select id="batchBadge">
                            <option value="">é€‰æ‹©å‹‹ç« </option>
                        </select>
                        <select id="batchBadgeCriteria">
                            <option value="high_level">é«˜ç­‰çº§ç”¨æˆ·</option>
                            <option value="active_users">æ´»è·ƒç”¨æˆ·</option>
                            <option value="specific_achievement">ç‰¹å®šæˆå°±</option>
                        </select>
                        <button class="btn-warning" onclick="executeBatchOperation()">ðŸš€ æ‰§è¡Œæ‰¹é‡æ“ä½œ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç­‰çº§é…ç½®ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹é…ç½®ç®¡ç†ï¼‰ -->
        <div id="levels" class="tab-content">
            <h2>â­ ç­‰çº§é…ç½®ç®¡ç†</h2>
            
            <!-- ç¾¤ç»„é€‰æ‹© -->
            <div class="form-section">
                <h3>ðŸŽ¯ ç¾¤ç»„é€‰æ‹©</h3>
                <select id="levelGroupSelect" onchange="loadGroupLevelConfig()">
                    <option value="default">é»˜è®¤ç¾¤ç»„é…ç½®</option>
                </select>
                <button class="btn-success" onclick="createNewGroupConfig()">âž• åˆ›å»ºæ–°ç¾¤ç»„é…ç½®</button>
            </div>

            <!-- ç­‰çº§é…ç½®è¡¨æ ¼ï¼ˆåŸºäºŽç‰ˆæœ¬Aç®€åŒ–è®¾è®¡ï¼‰ -->
            <div class="form-section">
                <h3>ðŸŽ® ç­‰çº§è®¾ç½®</h3>
                <table class="level-config-table">
                        <thead>
                            <tr>
                                <th>ç­‰çº§</th>
                                <th>ç­‰çº§åç§°ï¼ˆæ”¯æŒemojiï¼‰</th>
                                <th>æ‰€éœ€è¯„ä»·æ¬¡æ•°</th>
                                <th>æ‰€éœ€ç»éªŒå€¼</th>
                            <th>å‡çº§å¥–åŠ±ç§¯åˆ†</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="levelTableBody">
                            <!-- åŠ¨æ€ç”Ÿæˆç­‰çº§é…ç½®è¡Œ -->
                        </tbody>
                    </table>
                
                <div class="form-grid">
                    <div>
                        <button class="btn-primary" onclick="addLevelRow()">âž• æ·»åŠ ç­‰çº§</button>
                        <button class="btn-success" onclick="saveLevelConfig()">ðŸ’¾ ä¿å­˜é…ç½®</button>
                        <button class="btn-warning" onclick="resetLevelConfig()">ðŸ”„ é‡ç½®ä¸ºé»˜è®¤</button>
                    </div>
                    <div>
                        <button class="btn-primary" onclick="previewLevelConfig()">ðŸ‘ï¸ é¢„è§ˆé…ç½®</button>
                        <button class="btn-warning" onclick="exportLevelConfig()">ðŸ“¤ å¯¼å‡ºé…ç½®</button>
                        <button class="btn-primary" onclick="importLevelConfig()">ðŸ“¥ å¯¼å…¥é…ç½®</button>
                </div>
            </div>
        </div>

            <!-- å‡çº§æ¨¡æ‹Ÿå™¨ -->
            <div class="form-section">
                <h3>ðŸŽ² å‡çº§æ¨¡æ‹Ÿå™¨</h3>
                <div class="form-grid">
                    <div>
                        <label>å½“å‰ç»éªŒå€¼ï¼š</label>
                        <input type="number" id="simulatorExp" value="0">
                        <label>å½“å‰è¯„ä»·æ¬¡æ•°ï¼š</label>
                        <input type="number" id="simulatorEvals" value="0">
                        <button class="btn-primary" onclick="simulateLevel()">ðŸŽ¯ è®¡ç®—ç­‰çº§</button>
                    </div>
                    <div id="simulationResult">
                        <!-- æ˜¾ç¤ºæ¨¡æ‹Ÿç»“æžœ -->
                    </div>
                </div>
            </div>
            </div>

        <!-- å¥–åŠ±è§„åˆ™é…ç½®ï¼ˆåŸºäºŽç‰ˆæœ¬AåŒé‡å¥–åŠ±ç³»ç»Ÿï¼‰ -->
        <div id="rewards" class="tab-content">
            <h2>ðŸŽ å¥–åŠ±è§„åˆ™ç®¡ç†</h2>
            
            <!-- åŸºç¡€å¥–åŠ±è§„åˆ™ï¼ˆåŸºäºŽç‰ˆæœ¬Aç®€åŒ–è®¾è®¡ï¼‰ -->
            <div class="form-section">
                <h3>âš™ï¸ åŸºç¡€å¥–åŠ±è§„åˆ™ï¼ˆç»éªŒå€¼+ç§¯åˆ†ï¼‰</h3>
                <div class="form-grid">
                    <div>
                        <h4>ðŸŽ¯ å®Œæˆå‡ºå‡»</h4>
                        <label>ç»éªŒå€¼ï¼š</label><input type="number" id="attackExp" value="20">
                        <label>ç§¯åˆ†ï¼š</label><input type="number" id="attackPoints" value="10">
                        <label>è¯´æ˜Žï¼š</label><input type="text" id="attackDesc" value="å®Œæˆå‡ºå‡»ä»»åŠ¡">
                    </div>
                    <div>
                        <h4>ðŸ“ 12é¡¹æŒ‰é’®è¯„ä»·</h4>
                        <label>ç»éªŒå€¼ï¼š</label><input type="number" id="userEvalExp" value="30">
                        <label>ç§¯åˆ†ï¼š</label><input type="number" id="userEvalPoints" value="25">
                        <label>è¯´æ˜Žï¼š</label><input type="text" id="userEvalDesc" value="å®Œæˆ12é¡¹æŒ‰é’®è¯„ä»·">
                    </div>
                    <div>
                        <h4>ðŸª å•†å®¶è¯„ä»·ç”¨æˆ·</h4>
                        <label>ç»éªŒå€¼ï¼š</label><input type="number" id="merchantEvalExp" value="25">
                        <label>ç§¯åˆ†ï¼š</label><input type="number" id="merchantEvalPoints" value="20">
                        <label>è¯´æ˜Žï¼š</label><input type="text" id="merchantEvalDesc" value="å•†å®¶è¯„ä»·ç”¨æˆ·">
                    </div>
                    <div>
                        <h4>âœï¸ æ–‡å­—è¯¦ç»†è¯„ä»·</h4>
                        <label>ç»éªŒå€¼ï¼š</label><input type="number" id="textEvalExp" value="15">
                        <label>ç§¯åˆ†ï¼š</label><input type="number" id="textEvalPoints" value="15">
                        <label>è¯´æ˜Žï¼š</label><input type="text" id="textEvalDesc" value="æ–‡å­—è¯¦ç»†è¯„ä»·">
                    </div>
                    <div>
                        <h4>ðŸŽŠ å‡çº§å¥–åŠ±</h4>
                        <label>ç»éªŒå€¼ï¼š</label><input type="number" id="levelUpExp" value="0" readonly>
                        <label>ç§¯åˆ†ï¼š</label><input type="number" id="levelUpPoints" value="50">
                        <label>è¯´æ˜Žï¼š</label><input type="text" id="levelUpDesc" value="å‡çº§å¥–åŠ±ç§¯åˆ†">
                    </div>
                    <div>
                        <h4>ðŸ’¯ æ»¡åˆ†å¥–åŠ±</h4>
                        <label>ç»éªŒå€¼ï¼š</label><input type="number" id="perfectExp" value="50">
                        <label>ç§¯åˆ†ï¼š</label><input type="number" id="perfectPoints" value="100">
                        <label>è¯´æ˜Žï¼š</label><input type="text" id="perfectDesc" value="èŽ·å¾—æ»¡åˆ†è¯„ä»·">
                    </div>
                </div>
            </div>

            <!-- å¥–åŠ±å€æ•°é…ç½® -->
            <div class="form-section">
                <h3>ðŸ“ˆ å¥–åŠ±å€æ•°é…ç½®</h3>
                <div class="form-grid">
                    <div>
                        <label>ç»éªŒå€¼å€æ•°ï¼š</label>
                        <input type="number" id="expMultiplier" value="1.0" step="0.1" min="0.1" max="5.0">
                        <label>ç§¯åˆ†å€æ•°ï¼š</label>
                        <input type="number" id="pointsMultiplier" value="1.0" step="0.1" min="0.1" max="5.0">
                </div>
                    <div>
                        <label>å‘¨æœ«å¥–åŠ±å€æ•°ï¼š</label>
                        <input type="number" id="weekendBonus" value="1.2" step="0.1" min="1.0" max="3.0">
                        <label>ç‰¹æ®Šæ´»åŠ¨å€æ•°ï¼š</label>
                        <input type="number" id="eventBonus" value="1.0" step="0.1" min="1.0" max="5.0">
            </div>
        </div>

                <button class="btn-success" onclick="saveRewardsConfig()">ðŸ’¾ ä¿å­˜å¥–åŠ±é…ç½®</button>
                <button class="btn-warning" onclick="resetRewardsConfig()">ðŸ”„ é‡ç½®ä¸ºé»˜è®¤</button>
            </div>

                         <!-- é‡Œç¨‹ç¢‘å¥–åŠ±ï¼ˆåŸºäºŽç‰ˆæœ¬Aç®€åŒ–è®¾è®¡ï¼‰ -->
            <div class="form-section">
                 <h3>ðŸŽ¯ é‡Œç¨‹ç¢‘å¥–åŠ±</h3>
                 <div id="milestoneRewards">
                     <!-- åŠ¨æ€ç”Ÿæˆé‡Œç¨‹ç¢‘å¥–åŠ±é…ç½® -->
                 </div>
                 <button class="btn-primary" onclick="addMilestone()">âž• æ·»åŠ é‡Œç¨‹ç¢‘</button>
             </div>
            </div>

         <!-- å‹‹ç« ç®¡ç†ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰ -->
         <div id="badges" class="tab-content">
             <h2>ðŸ† å‹‹ç« ç®¡ç†</h2>

            <!-- çŽ°æœ‰å‹‹ç« åˆ—è¡¨ -->
            <div class="form-section">
                 <h3>ðŸŽ–ï¸ çŽ°æœ‰å‹‹ç« </h3>
                <div id="badgesList">
                    <!-- åŠ¨æ€åŠ è½½å‹‹ç« åˆ—è¡¨ -->
                </div>
                 <button class="btn-primary" onclick="refreshBadgesList()">ðŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            </div>

             <!-- åˆ›å»ºæ–°å‹‹ç« ï¼ˆåŸºäºŽç‰ˆæœ¬Aç®€åŒ–è®¾è®¡ï¼‰ -->
            <div class="form-section">
                 <h3>ðŸ† åˆ›å»ºæ–°å‹‹ç« </h3>
                <div class="form-grid">
                    <div>
                         <label>å‹‹ç« åç§°ï¼š</label>
                        <input type="text" id="badgeName" placeholder="å‹‹ç« åç§°">
                         <label>å‹‹ç« Emojiï¼š</label>
                         <input type="text" id="badgeEmoji" placeholder="ðŸ†" maxlength="2">
                         <label>å‹‹ç« æè¿°ï¼š</label>
                         <textarea id="badgeDesc" placeholder="å‹‹ç« èŽ·å¾—æ¡ä»¶æè¿°" rows="3"></textarea>
                    </div>
                    <div>
                         <label>å‹‹ç« ç±»åž‹ï¼š</label>
                        <select id="badgeType">
                             <option value="auto">è‡ªåŠ¨è§£é”</option>
                            <option value="manual">æ‰‹åŠ¨æŽˆäºˆ</option>
                        </select>
                         <label>ç¨€æœ‰åº¦ï¼š</label>
                        <select id="badgeRarity">
                             <option value="common">æ™®é€š âšª</option>
                             <option value="rare">ç¨€æœ‰ ðŸ”µ</option>
                             <option value="epic">å²è¯— ðŸŸ£</option>
                             <option value="legendary">ä¼ è¯´ ðŸŸ¡</option>
                        </select>
                    </div>
                </div>

                 <!-- è§£é”æ¡ä»¶è®¾ç½®ï¼ˆåŸºäºŽç‰ˆæœ¬Aç®€åŒ–è®¾è®¡ï¼‰ -->
                <div class="form-section">
                     <h4>ðŸŽ¯ è§£é”æ¡ä»¶</h4>
                    <div class="form-grid">
                        <div>
                             <label>æ¡ä»¶ç±»åž‹ï¼š</label>
                            <select id="conditionType" onchange="updateConditionForm()">
                                 <option value="stat_based">ç»Ÿè®¡æ•°æ®æ¡ä»¶</option>
                                 <option value="evaluation_streak">è¯„ä»·è¿žå‡»æ¡ä»¶</option>
                                 <option value="admin_only">ä»…ç®¡ç†å‘˜æŽˆäºˆ</option>
                            </select>
                        </div>
                        <div id="conditionDetails">
                            <!-- åŠ¨æ€ç”Ÿæˆæ¡ä»¶è®¾ç½®è¡¨å• -->
                        </div>
                    </div>
                </div>

                 <button class="btn-success" onclick="createBadge()">ðŸ† åˆ›å»ºå‹‹ç« </button>
            </div>

            <!-- æ‰‹åŠ¨æŽˆäºˆå‹‹ç«  -->
            <div class="form-section">
                 <h3>ðŸŽ–ï¸ æ‰‹åŠ¨æŽˆäºˆå‹‹ç« </h3>
                <div class="form-grid">
                    <div>
                         <label>ç”¨æˆ·IDï¼š</label>
                         <input type="text" id="awardUserId" placeholder="è¾“å…¥ç”¨æˆ·ID">
                         <label>å‹‹ç« é€‰æ‹©ï¼š</label>
                        <select id="awardBadgeSelect">
                            <option value="">é€‰æ‹©å‹‹ç« </option>
                        </select>
                         <button class="btn-primary" onclick="previewUser()">ðŸ‘ï¸ é¢„è§ˆç”¨æˆ·</button>
                    </div>
                    <div>
                         <label>æŽˆäºˆåŽŸå› ï¼š</label>
                         <textarea id="awardReason" placeholder="æŽˆäºˆåŽŸå› ï¼ˆå°†è®°å½•åœ¨æ—¥å¿—ä¸­ï¼‰" rows="3"></textarea>
                         <button class="btn-warning" onclick="awardBadge()">ðŸŽ–ï¸ æŽˆäºˆå‹‹ç« </button>
                    </div>
                </div>
                 
                 <div id="userPreview" class="user-search-result" style="display: none;">
                     <!-- æ˜¾ç¤ºç”¨æˆ·é¢„è§ˆä¿¡æ¯ -->
                 </div>
            </div>

            <!-- å‹‹ç« ç»Ÿè®¡ -->
            <div class="form-section">
                 <h3>ðŸ“Š å‹‹ç« ç»Ÿè®¡</h3>
                 <div class="stats-grid">
                     <div class="stat-card">
                         <h4>æ€»å‹‹ç« æ•°</h4>
                         <p id="totalBadgesCount">-</p>
                </div>
                     <div class="stat-card">
                         <h4>å·²æŽˆäºˆæ¬¡æ•°</h4>
                         <p id="totalAwardedCount">-</p>
                     </div>
                     <div class="stat-card">
                         <h4>æœ€å—æ¬¢è¿Žå‹‹ç« </h4>
                         <p id="mostPopularBadge">-</p>
                     </div>
                     <div class="stat-card">
                         <h4>ç¨€æœ‰å‹‹ç« æŒæœ‰è€…</h4>
                         <p id="rareHolders">-</p>
                     </div>
                 </div>
            </div>
        </div>

         <!-- æ’­æŠ¥é…ç½®ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„çŽ°æœ‰BotæœåŠ¡å¤ç”¨ï¼‰ -->
         <div id="broadcast" class="tab-content">
             <h2>ðŸ“¢ æ’­æŠ¥é…ç½®ç®¡ç†</h2>
             
             <!-- æ’­æŠ¥ç³»ç»ŸçŠ¶æ€ -->
            <div class="form-section">
                 <h3>ðŸ“¡ æ’­æŠ¥ç³»ç»ŸçŠ¶æ€</h3>
                <div class="form-grid">
                     <div>
                         <p><strong>æ’­æŠ¥çŠ¶æ€ï¼š</strong><span id="broadcastStatus" class="status-enabled">å·²å¯ç”¨</span></p>
                         <p><strong>ç¾¤ç»„IDï¼š</strong><span id="broadcastGroupId">-</span></p>
                         <p><strong>Botæƒé™ï¼š</strong><span id="botPermissions">æ£€æŸ¥ä¸­...</span></p>
                         <button class="btn-warning" onclick="toggleBroadcast()">ðŸ“¢ å¯ç”¨/ç¦ç”¨æ’­æŠ¥</button>
                     </div>
                     <div>
                         <p><strong>ä»Šæ—¥æ’­æŠ¥æ•°ï¼š</strong><span id="todayBroadcasts">-</span></p>
                         <p><strong>æ’­æŠ¥é˜Ÿåˆ—ï¼š</strong><span id="broadcastQueue">-</span></p>
                         <p><strong>æœ€åŽæ’­æŠ¥ï¼š</strong><span id="lastBroadcast">-</span></p>
                         <button class="btn-primary" onclick="testBroadcast()">ðŸ§ª æµ‹è¯•æ’­æŠ¥</button>
                     </div>
                 </div>
             </div>

             <!-- æ’­æŠ¥äº‹ä»¶é…ç½®ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„ç®€åŒ–è®¾è®¡ï¼‰ -->
             <div class="form-section">
                 <h3>ðŸŽ¯ æ’­æŠ¥äº‹ä»¶é…ç½®</h3>
                 <div class="form-grid">
                     <div>
                         <h4>ðŸŽŠ å‡çº§æ’­æŠ¥</h4>
                         <label>å¯ç”¨å‡çº§æ’­æŠ¥ï¼š</label>
                         <input type="checkbox" id="enableLevelUpBroadcast" checked>
                         <label>æ’­æŠ¥ç­‰çº§èŒƒå›´ï¼š</label>
                         <select id="levelUpBroadcastRange">
                             <option value="all">æ‰€æœ‰ç­‰çº§</option>
                             <option value="high">ä»…é«˜ç­‰çº§ï¼ˆ5çº§ä»¥ä¸Šï¼‰</option>
                             <option value="milestone">é‡Œç¨‹ç¢‘ç­‰çº§ï¼ˆ5,10çº§ï¼‰</option>
                         </select>
                         <label>è‡ªåŠ¨ç½®é¡¶ï¼š</label>
                         <input type="checkbox" id="levelUpPin" checked>
                         <label>è‡ªåŠ¨åˆ é™¤æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ï¼š</label>
                         <input type="number" id="levelUpDeleteTime" value="60" min="5" max="1440">
                     </div>
                     <div>
                         <h4>ðŸ† å‹‹ç« æ’­æŠ¥</h4>
                         <label>å¯ç”¨å‹‹ç« æ’­æŠ¥ï¼š</label>
                         <input type="checkbox" id="enableBadgeBroadcast" checked>
                         <label>æ’­æŠ¥å‹‹ç« ç¨€æœ‰åº¦ï¼š</label>
                         <select id="badgeBroadcastRarity">
                             <option value="all">æ‰€æœ‰ç¨€æœ‰åº¦</option>
                             <option value="rare_plus">ç¨€æœ‰åŠä»¥ä¸Š</option>
                             <option value="epic_plus">å²è¯—åŠä»¥ä¸Š</option>
                             <option value="legendary">ä»…ä¼ è¯´</option>
                         </select>
                         <label>è‡ªåŠ¨ç½®é¡¶ï¼š</label>
                         <input type="checkbox" id="badgePin">
                         <label>è‡ªåŠ¨åˆ é™¤æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ï¼š</label>
                         <input type="number" id="badgeDeleteTime" value="120" min="5" max="1440">
                     </div>
                 </div>
                 
                 <button class="btn-success" onclick="saveBroadcastConfig()">ðŸ’¾ ä¿å­˜æ’­æŠ¥é…ç½®</button>
             </div>

             <!-- æ’­æŠ¥æ¨¡æ¿ç®¡ç†ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„ç®€åŒ–è®¾è®¡ï¼‰ -->
             <div class="form-section">
                 <h3>ðŸ“ æ’­æŠ¥æ¨¡æ¿ç®¡ç†</h3>
                 
                 <!-- å‡çº§æ’­æŠ¥æ¨¡æ¿ -->
                 <div class="form-section">
                     <h4>ðŸŽŠ å‡çº§æ’­æŠ¥æ¨¡æ¿</h4>
                     <textarea id="levelUpTemplate" rows="6" style="width: 100%;" placeholder="å‡çº§æ’­æŠ¥æ¨¡æ¿">ðŸŽ‰ æ­å–œå‡çº§ï¼ðŸŽ‰

ðŸ§‘â€ðŸš€ ç¾¤å‹ï¼š{{user_name}}
â­ æ–°ç­‰çº§ï¼šLv.{{new_level}} {{level_name}} {{level_emoji}}
ðŸ’Ž å‡çº§å¥–åŠ±ï¼š{{level_up_points}}ç§¯åˆ†
ðŸ“ˆ æ€»ç»éªŒï¼š{{total_exp}}ç‚¹

{{#if badges}}ðŸ† æ‹¥æœ‰å‹‹ç« ï¼š{{badges_display}}{{/if}}

ç»§ç»­åŠªåŠ›ï¼Œæˆä¸ºä¼ è¯´å‹‡å£«ï¼ðŸ’ª</textarea>
                     <p><small>å¯ç”¨å˜é‡ï¼š{{user_name}}, {{old_level}}, {{new_level}}, {{level_name}}, {{level_emoji}}, {{level_up_points}}, {{total_exp}}, {{badges_display}}</small></p>
                 </div>

                 <!-- å‹‹ç« æ’­æŠ¥æ¨¡æ¿ -->
                 <div class="form-section">
                     <h4>ðŸ† å‹‹ç« æ’­æŠ¥æ¨¡æ¿</h4>
                     <textarea id="badgeTemplate" rows="5" style="width: 100%;" placeholder="å‹‹ç« æ’­æŠ¥æ¨¡æ¿">ðŸ† æ–°å‹‹ç« èŽ·å¾—ï¼ðŸ†

ðŸ§‘â€ðŸš€ ç¾¤å‹ï¼š{{user_name}}
ðŸŽ–ï¸ å‹‹ç« ï¼š{{badge_emoji}} {{badge_name}}
âœ¨ ç¨€æœ‰åº¦ï¼š{{rarity_display}}
ðŸ“ æè¿°ï¼š{{badge_desc}}

æ­å–œèŽ·å¾—çè´µå‹‹ç« ï¼ðŸŽŠ</textarea>
                     <p><small>å¯ç”¨å˜é‡ï¼š{{user_name}}, {{badge_name}}, {{badge_emoji}}, {{badge_desc}}, {{rarity_display}}</small></p>
                 </div>

                 <!-- æ»¡åˆ†æ’­æŠ¥æ¨¡æ¿ -->
                 <div class="form-section">
                     <h4>ðŸ’¯ æ»¡åˆ†æ’­æŠ¥æ¨¡æ¿</h4>
                     <textarea id="perfectScoreTemplate" rows="4" style="width: 100%;" placeholder="æ»¡åˆ†æ’­æŠ¥æ¨¡æ¿">ðŸ’¯ å®Œç¾Žè¡¨çŽ°ï¼ðŸ’¯

ðŸ§‘â€ðŸš€ ç¾¤å‹ï¼š{{user_name}}
â­ èŽ·å¾—æ»¡åˆ†è¯„ä»·ï¼š{{score}}/10
ðŸŽ ç‰¹æ®Šå¥–åŠ±ï¼š+{{bonus_exp}}ç»éªŒå€¼ï¼Œ+{{bonus_points}}ç§¯åˆ†

å®Œç¾Žçš„æœåŠ¡æ€åº¦ï¼ðŸ‘</textarea>
                     <p><small>å¯ç”¨å˜é‡ï¼š{{user_name}}, {{score}}, {{bonus_exp}}, {{bonus_points}}</small></p>
                 </div>

                 <div class="form-grid">
                     <div>
                         <button class="btn-success" onclick="saveTemplates()">ðŸ’¾ ä¿å­˜æ¨¡æ¿</button>
                         <button class="btn-warning" onclick="resetTemplates()">ðŸ”„ é‡ç½®æ¨¡æ¿</button>
                     </div>
                     <div>
                         <button class="btn-primary" onclick="previewTemplate()">ðŸ‘ï¸ é¢„è§ˆæ¨¡æ¿</button>
                         <button class="btn-primary" onclick="testTemplate()">ðŸ§ª å‘é€æµ‹è¯•</button>
                     </div>
                 </div>
             </div>

             <!-- æ’­æŠ¥åŽ†å²å’Œç»Ÿè®¡ -->
             <div class="form-section">
                 <h3>ðŸ“Š æ’­æŠ¥åŽ†å²</h3>
                 <div class="form-grid">
                     <div>
                         <label>æŸ¥çœ‹èŒƒå›´ï¼š</label>
                         <select id="historyRange" onchange="loadBroadcastHistory()">
                             <option value="today">ä»Šå¤©</option>
                             <option value="week">æœ€è¿‘7å¤©</option>
                             <option value="month">æœ€è¿‘30å¤©</option>
                         </select>
                         <label>æ’­æŠ¥ç±»åž‹ï¼š</label>
                         <select id="historyType" onchange="loadBroadcastHistory()">
                             <option value="all">æ‰€æœ‰ç±»åž‹</option>
                             <option value="level_up">å‡çº§æ’­æŠ¥</option>
                             <option value="badge">å‹‹ç« æ’­æŠ¥</option>
                             <option value="perfect_score">æ»¡åˆ†æ’­æŠ¥</option>
                         </select>
                     </div>
                     <div>
                         <button class="btn-primary" onclick="loadBroadcastHistory()">ðŸ” æŸ¥è¯¢åŽ†å²</button>
                         <button class="btn-warning" onclick="exportBroadcastHistory()">ðŸ“¤ å¯¼å‡ºåŽ†å²</button>
                     </div>
                 </div>
                 
                 <div id="broadcastHistory">
                     <!-- åŠ¨æ€åŠ è½½æ’­æŠ¥åŽ†å² -->
                 </div>
             </div>
         </div>

         <!-- æ•°æ®ç®¡ç†ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“æ“ä½œï¼‰ -->
         <div id="data" class="tab-content">
             <h2>ðŸ’¾ æ•°æ®ç®¡ç†</h2>
             
             <!-- æ•°æ®åº“çŠ¶æ€ç›‘æŽ§ -->
             <div class="form-section">
                 <h3>ðŸ—„ï¸ æ•°æ®åº“çŠ¶æ€</h3>
                 <div class="stats-grid">
                     <div class="stat-card">
                         <h4>æ•°æ®åº“æ–‡ä»¶</h4>
                         <p>level_system.db</p>
                         <p id="dbFilePath">/app/data/level_system.db</p>
                     </div>
                     <div class="stat-card">
                         <h4>æ–‡ä»¶å¤§å°</h4>
                         <p id="dbFileSize">è®¡ç®—ä¸­...</p>
                     </div>
                     <div class="stat-card">
                         <h4>è®°å½•æ€»æ•°</h4>
                         <p id="totalRecords">è®¡ç®—ä¸­...</p>
                     </div>
                     <div class="stat-card">
                         <h4>æœ€åŽæ›´æ–°</h4>
                         <p id="lastUpdateTime">-</p>
                     </div>
                 </div>
             </div>

             <!-- æ•°æ®å¯¼å‡ºï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®ï¼‰ -->
             <div class="export-import">
                 <h3>ðŸ“¤ æ•°æ®å¯¼å‡º</h3>
                 <div class="form-grid">
                     <div>
                         <label>å¯¼å‡ºèŒƒå›´ï¼š</label>
                         <select id="exportScope">
                             <option value="all">å®Œæ•´æ•°æ®</option>
                             <option value="users_only">ä»…ç”¨æˆ·æ•°æ®</option>
                             <option value="config_only">ä»…é…ç½®æ•°æ®</option>
                             <option value="logs_only">ä»…æ—¥å¿—æ•°æ®</option>
                         </select>
                         <label>å¯¼å‡ºæ ¼å¼ï¼š</label>
                         <select id="exportFormat">
                             <option value="json">JSONæ ¼å¼</option>
                             <option value="csv">CSVè¡¨æ ¼</option>
                             <option value="xlsx">Excelæ–‡ä»¶</option>
                         </select>
                     </div>
                     <div>
                         <label>æ—¥æœŸèŒƒå›´ï¼š</label>
                         <input type="date" id="exportStartDate">
                         <input type="date" id="exportEndDate">
                         <button class="btn-primary" onclick="exportLevelData()">ðŸ“¤ å¯¼å‡ºæ•°æ®</button>
                     </div>
                 </div>
                 <div id="exportStatus"></div>
             </div>

             <!-- æ•°æ®å¯¼å…¥ -->
             <div class="export-import">
                 <h3>ðŸ“¥ æ•°æ®å¯¼å…¥</h3>
                 <div class="warning-box">
                     <p><strong>âš ï¸ æ³¨æ„ï¼š</strong>æ•°æ®å¯¼å…¥ä¼šè¦†ç›–çŽ°æœ‰æ•°æ®ï¼Œè¯·åŠ¡å¿…å…ˆå¤‡ä»½ï¼</p>
                 </div>
                 <div class="form-grid">
                     <div>
                         <label>é€‰æ‹©æ–‡ä»¶ï¼š</label>
                         <input type="file" id="importFile" accept=".json,.csv,.xlsx">
                         <label>å¯¼å…¥æ¨¡å¼ï¼š</label>
                         <select id="importMode">
                             <option value="merge">åˆå¹¶æ•°æ®ï¼ˆæŽ¨èï¼‰</option>
                             <option value="overwrite">è¦†ç›–çŽ°æœ‰æ•°æ®</option>
                             <option value="append">ä»…æ·»åŠ æ–°æ•°æ®</option>
                         </select>
                     </div>
                     <div>
                         <button class="btn-warning" onclick="validateImportFile()">ðŸ” éªŒè¯æ–‡ä»¶</button>
                         <button class="btn-danger" onclick="importLevelData()">ðŸ“¥ å¯¼å…¥æ•°æ®</button>
                     </div>
                 </div>
                 <div id="importStatus"></div>
             </div>

             <!-- æ•°æ®å¤‡ä»½å’Œæ¢å¤ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ–‡ä»¶ï¼‰ -->
             <div class="form-section">
                 <h3>ðŸ’¾ å¤‡ä»½å’Œæ¢å¤</h3>
                 <div class="form-grid">
                     <div>
                         <h4>åˆ›å»ºå¤‡ä»½</h4>
                         <label>å¤‡ä»½åç§°ï¼š</label>
                         <input type="text" id="backupName" placeholder="backup_YYYY-MM-DD">
                         <label>å¤‡ä»½æè¿°ï¼š</label>
                         <textarea id="backupDesc" placeholder="å¤‡ä»½è¯´æ˜Ž" rows="2"></textarea>
                         <button class="btn-success" onclick="createBackup()">ðŸ’¾ åˆ›å»ºå¤‡ä»½</button>
                     </div>
                     <div>
                         <h4>æ¢å¤å¤‡ä»½</h4>
                         <label>é€‰æ‹©å¤‡ä»½ï¼š</label>
                         <select id="backupSelect">
                             <option value="">é€‰æ‹©å¤‡ä»½æ–‡ä»¶</option>
                         </select>
                         <button class="btn-primary" onclick="loadBackupList()">ðŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                         <button class="btn-warning" onclick="restoreBackup()">ðŸ”„ æ¢å¤å¤‡ä»½</button>
                     </div>
                 </div>
             </div>

             <!-- æ•°æ®æ¸…ç†å’Œç»´æŠ¤ -->
             <div class="form-section">
                 <h3>ðŸ§¹ æ•°æ®æ¸…ç†å’Œç»´æŠ¤</h3>
                 <div class="warning-box">
                     <p><strong>âš ï¸ å±é™©æ“ä½œï¼š</strong>ä»¥ä¸‹æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ•°æ®ï¼Œè¯·è°¨æ…Žä½¿ç”¨ï¼</p>
                 </div>
                 <div class="form-grid">
                     <div>
                         <h4>æ¸…ç†æ“ä½œ</h4>
                         <button class="btn-warning" onclick="cleanOldLogs()">ðŸ—‘ï¸ æ¸…ç†æ—§æ—¥å¿—ï¼ˆ30å¤©å‰ï¼‰</button>
                         <button class="btn-warning" onclick="optimizeDatabase()">âš¡ ä¼˜åŒ–æ•°æ®åº“</button>
                         <button class="btn-warning" onclick="rebuildIndexes()">ðŸ”§ é‡å»ºç´¢å¼•</button>
                     </div>
                     <div>
                         <h4>é‡ç½®æ“ä½œ</h4>
                         <button class="btn-danger" onclick="resetUserLevels()">ðŸ”„ é‡ç½®æ‰€æœ‰ç­‰çº§</button>
                         <button class="btn-danger" onclick="resetUserPoints()">ðŸ’° é‡ç½®æ‰€æœ‰ç§¯åˆ†</button>
                         <button class="btn-danger" onclick="clearAllData()">ðŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                     </div>
                 </div>
             </div>

             <!-- ç³»ç»Ÿç»´æŠ¤ä¿¡æ¯ -->
             <div class="form-section">
                 <h3>âš™ï¸ ç³»ç»Ÿç»´æŠ¤ä¿¡æ¯</h3>
                 <div class="success-box">
                     <p><strong>âœ… ç‹¬ç«‹éƒ¨ç½²ä¼˜åŠ¿ï¼š</strong></p>
                     <ul>
                         <li>æ•°æ®å®Œå…¨ç‹¬ç«‹äºŽçŽ°æœ‰ç³»ç»Ÿï¼Œå¯éšæ—¶ç§»é™¤</li>
                         <li>æ”¯æŒRailway Volumeè‡ªåŠ¨å¤‡ä»½</li>
                         <li>æ•…éšœéš”ç¦»ï¼Œä¸å½±å“ä¸»è¦åŠŸèƒ½</li>
                         <li>å¯é€šè¿‡åˆ é™¤level_system.dbæ–‡ä»¶å®Œå…¨å¸è½½</li>
                     </ul>
                 </div>
             </div>
         </div>
    </div>

    <!-- JavaScriptï¼ˆåŸºäºŽç‰ˆæœ¬Açš„APIè®¾è®¡ï¼‰ -->
    <script>
        // åŸºäºŽç‰ˆæœ¬Açš„ç‹¬ç«‹APIè°ƒç”¨
        const API_BASE = '/api/level';
        let currentTab = 'dashboard';
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeAdmin();
            loadSystemStatus();
        });
        
        // åˆå§‹åŒ–ç®¡ç†ç•Œé¢
        async function initializeAdmin() {
            try {
                // æ£€æŸ¥ç­‰çº§ç³»ç»ŸçŠ¶æ€
                const response = await fetch(`${API_BASE}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: getAdminPassword() })
                });
                
                const result = await response.json();
                if (result.success) {
                    updateSystemStatus(result);
                } else {
                    showError('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                showError('è¿žæŽ¥å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // æ˜¾ç¤ºæŒ‡å®šæ ‡ç­¾å†…å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ¿€æ´»å¯¹åº”æŒ‰é’®
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // åŠ è½½å¯¹åº”æ ‡ç­¾çš„æ•°æ®
            loadTabData(tabName);
        }
        
        // åŠ è½½æ ‡ç­¾æ•°æ®
        async function loadTabData(tabName) {
            switch(tabName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'users':
                    loadUserManagement();
                    break;
                case 'levels':
                    loadLevelConfig();
                    break;
                case 'rewards':
                    loadRewardsConfig();
                    break;
                case 'badges':
                    loadBadgesManagement();
                    break;
                case 'broadcast':
                    loadBroadcastConfig();
                    break;
                case 'data':
                    loadDataManagement();
                    break;
            }
        }
        
        // èŽ·å–ç®¡ç†å‘˜å¯†ç 
        function getAdminPassword() {
            return localStorage.getItem('adminPassword') || prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š');
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            alert('é”™è¯¯ï¼š' + message);
        }
        
        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            alert('æˆåŠŸï¼š' + message);
        }
        
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus(data) {
            document.getElementById('systemStatus').textContent = data.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
            document.getElementById('systemStatus').className = data.enabled ? 'status-enabled' : 'status-disabled';
            
            document.getElementById('totalUsers').textContent = data.userCount || '-';
            document.getElementById('activeGroups').textContent = data.groupCount || '1';
            document.getElementById('dbSize').textContent = data.dbSize || '-';
        }
        
        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboardData() {
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: getAdminPassword() })
                });
                
                const result = await response.json();
                if (result.success) {
                    updateDashboard(result.data);
                }
            } catch (error) {
                showError('åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // ç”¨æˆ·æœç´¢
        async function searchUsers() {
            const searchType = document.getElementById('searchType').value;
            const searchQuery = document.getElementById('searchQuery').value;
            const sortBy = document.getElementById('sortBy').value;
            
            if (!searchQuery.trim()) {
                showError('è¯·è¾“å…¥æœç´¢å†…å®¹');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/user/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: getAdminPassword(),
                        searchType: searchType,
                        query: searchQuery,
                        sortBy: sortBy
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    displayUserResults(result.data);
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('æœç´¢å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // å…¶ä»–ç®¡ç†åŠŸèƒ½çš„JavaScriptå®žçŽ°...
        // ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„ç‹¬ç«‹APIè®¾è®¡ï¼Œå¤ç”¨çŽ°æœ‰æŽ¥å£ï¼‰
        
    </script>
</body>
</html>
```
                    <div>
                        <label>ç¾¤ç»„:</label>
                        <select id="userGroupSelect">
                            <option value="">é€‰æ‹©ç¾¤ç»„</option>
                        </select>
                    </div>
                    <div>
                        <label>æœç´¢æ¡ä»¶:</label>
                        <input type="text" id="userSearchInput" placeholder="ç”¨æˆ·IDã€ç”¨æˆ·åæˆ–æ˜¾ç¤ºåç§°">
                        <button onclick="searchUser()">ðŸ” æœç´¢</button>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
            <div id="userInfoSection" class="form-section" style="display: none;">
                <h3>ç”¨æˆ·ä¿¡æ¯</h3>
                <div class="form-grid">
                    <div>
                        <p id="userLevel">å½“å‰ç­‰çº§: </p>
                        <p id="userExp">ç»éªŒå€¼: </p>
                        <p id="userPoints">ç§¯åˆ†ä¿¡æ¯: </p>
                        <p id="userEvaluations">è¯„ä»·ç»Ÿè®¡: </p>
                        <p id="userBadges">æ‹¥æœ‰å‹‹ç« : </p>
                    </div>
                    <div>
                        <!-- æ‰‹åŠ¨è°ƒæ•´ -->
                        <h4>æ‰‹åŠ¨è°ƒæ•´</h4>
                        <input type="hidden" id="adjustUserId">
                        <input type="hidden" id="adjustGroupId">
                        <input type="number" id="pointsChange" placeholder="ç§¯åˆ†å˜åŒ–é‡">
                        <input type="text" id="adjustReason" placeholder="è°ƒæ•´åŽŸå› ">
                        <button onclick="adjustUserPoints()">ðŸ’° è°ƒæ•´ç§¯åˆ†</button>
                        
                        <br><br>
                        <input type="number" id="expChange" placeholder="ç»éªŒå˜åŒ–é‡">
                        <input type="text" id="expReason" placeholder="ç»éªŒè°ƒæ•´åŽŸå› ">
                        <button onclick="adjustUserExp()">â­ è°ƒæ•´ç»éªŒ</button>
                    </div>
                </div>

                <!-- å‹‹ç« ç®¡ç† -->
                <div class="form-section">
                    <h4>å‹‹ç« ç®¡ç†</h4>
                    <div class="form-grid">
                        <div>
                            <label>æŽˆäºˆå‹‹ç« :</label>
                            <select id="userBadgeSelect">
                                <option value="">é€‰æ‹©å‹‹ç« </option>
                            </select>
                            <button onclick="giveUserBadge()">ðŸ† æŽˆäºˆå‹‹ç« </button>
                        </div>
                        <div>
                            <label>æ’¤é”€å‹‹ç« :</label>
                            <select id="userRevokeBadgeSelect">
                                <option value="">é€‰æ‹©è¦æ’¤é”€çš„å‹‹ç« </option>
                            </select>
                            <button onclick="revokeUserBadge()">âŒ æ’¤é”€å‹‹ç« </button>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç§¯åˆ†åŽ†å² -->
                <div class="form-section">
                    <h4>ç§¯åˆ†åŽ†å²</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>æ“ä½œç±»åž‹</th>
                                <th>ç§¯åˆ†å˜åŒ–</th>
                                <th>æè¿°</th>
                                <th>æ“ä½œå‘˜</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- åŠ¨æ€åŠ è½½åŽ†å²è®°å½• -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æ•°æ®å¯¼å‡ºå¯¼å…¥ -->
        <div id="export" class="tab-content">
            <h2>ðŸ“¦ æ•°æ®å¯¼å‡ºå¯¼å…¥</h2>
            
            <!-- æ•°æ®å¯¼å‡º -->
            <div class="export-import">
                <h3>ðŸ“¤ æ•°æ®å¯¼å‡º</h3>
                <div class="form-grid">
                    <div>
                        <label>é€‰æ‹©ç¾¤ç»„:</label>
                        <select id="exportGroupSelect">
                            <option value="all">æ‰€æœ‰ç¾¤ç»„</option>
                        </select>
                    </div>
                    <div>
                        <label>å¯¼å‡ºç±»åž‹:</label>
                        <select id="exportType">
                            <option value="complete">å®Œæ•´æ•°æ®ï¼ˆç¾¤é…ç½®+ç”¨æˆ·æ•°æ®ï¼‰</option>
                            <option value="config_only">ä»…ç¾¤é…ç½®</option>
                            <option value="users_only">ä»…ç”¨æˆ·æ•°æ®</option>
                        </select>
                    </div>
                </div>
                <button onclick="exportData()">ðŸ“¤ å¯¼å‡ºæ•°æ®</button>
                <div id="exportStatus"></div>
            </div>

            <!-- æ•°æ®å¯¼å…¥ -->
            <div class="export-import">
                <h3>ðŸ“¥ æ•°æ®å¯¼å…¥</h3>
                <div class="form-grid">
                    <div>
                        <label>é€‰æ‹©æ–‡ä»¶:</label>
                        <input type="file" id="importFile" accept=".json,.zip">
                    </div>
                    <div>
                        <label>å¯¼å…¥æ¨¡å¼:</label>
                        <select id="importMode">
                            <option value="merge">åˆå¹¶æ•°æ®</option>
                            <option value="overwrite">è¦†ç›–çŽ°æœ‰æ•°æ®</option>
                            <option value="new_group">å¯¼å…¥ä¸ºæ–°ç¾¤</option>
                        </select>
                    </div>
                </div>
                <button onclick="importData()">ðŸ“¥ å¯¼å…¥æ•°æ®</button>
                <div id="importStatus"></div>
            </div>

            <!-- ç¾¤ç»„è¿ç§» -->
            <div class="export-import">
                <h3>ðŸ”„ ç¾¤ç»„è¿ç§»</h3>
                <div class="form-grid">
                    <div>
                        <label>æºç¾¤ç»„:</label>
                        <select id="sourceGroupSelect">
                            <option value="">é€‰æ‹©æºç¾¤ç»„</option>
                        </select>
                    </div>
                    <div>
                        <label>ç›®æ ‡ç¾¤ID:</label>
                        <input type="text" id="targetGroupId" placeholder="-1001234567890">
                        <label>ç›®æ ‡ç¾¤åç§°:</label>
                        <input type="text" id="targetGroupName" placeholder="æ–°ç¾¤åç§°">
                    </div>
                </div>
                <button onclick="migrateGroup()">ðŸ”„ è¿ç§»ç¾¤ç»„</button>
                <div id="migrateStatus"></div>
            </div>
        </div>

        <!-- ç»Ÿè®¡åˆ†æž -->
        <div id="statistics" class="tab-content">
            <h2>ðŸ“ˆ ç»Ÿè®¡åˆ†æž</h2>
            
            <!-- å…¨å±€ç»Ÿè®¡ -->
            <div class="form-section">
                <h3>å…¨å±€ç»Ÿè®¡</h3>
                <div class="form-grid">
                    <div id="globalStats">
                        <!-- åŠ¨æ€åŠ è½½ç»Ÿè®¡æ•°æ® -->
                    </div>
                    <div>
                        <canvas id="levelDistributionChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- æŒ‰ç¾¤ç»Ÿè®¡ -->
            <div class="form-section">
                <h3>åˆ†ç¾¤ç»Ÿè®¡</h3>
                <div class="form-grid">
                    <div>
                        <label>é€‰æ‹©ç¾¤ç»„:</label>
                        <select id="statsGroupSelect" onchange="loadGroupStats()">
                            <option value="">é€‰æ‹©ç¾¤ç»„</option>
                        </select>
                    </div>
                    <div id="groupStatsDisplay">
                        <!-- æ˜¾ç¤ºç¾¤ç»„ç»Ÿè®¡ -->
                    </div>
                </div>
            </div>

            <!-- æŽ’è¡Œæ¦œ -->
            <div class="form-section">
                <h3>æŽ’è¡Œæ¦œ</h3>
                <div class="form-grid">
                    <div>
                        <h4>ç­‰çº§æŽ’è¡Œæ¦œ</h4>
                        <div id="levelRanking"></div>
                    </div>
                    <div>
                        <h4>ç§¯åˆ†æŽ’è¡Œæ¦œ</h4>
                        <div id="pointsRanking"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="levelSystemAdmin.js"></script>
</body>
</html>
```

### 9. æŠ€æœ¯å®žçŽ°è¦ç‚¹ï¼ˆåŸºäºŽç‰ˆæœ¬AåŽŸåˆ™ï¼‰

#### 9.1 æœåŠ¡ç±»è®¾è®¡ï¼ˆå¤ç”¨çŽ°æœ‰æŽ¥å£ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“å’ŒçŽ°æœ‰æŽ¥å£å¤ç”¨è®¾è®¡
class LevelService {
  constructor() {
    // ä½¿ç”¨ç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“ç®¡ç†å™¨
    this.levelDb = require('../config/levelDatabase');
    
    // å¤ç”¨çŽ°æœ‰çš„BotæœåŠ¡å’Œæ•°æ®åº“æ“ä½œï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
    this.botService = require('./botService'); // çŽ°æœ‰çš„BotæœåŠ¡
    this.dbOperations = require('../models/dbOperations'); // çŽ°æœ‰çš„æ•°æ®åº“æ“ä½œ
    
    // ç¼“å­˜å’Œé”ç®¡ç†ï¼ˆç‹¬ç«‹å®žçŽ°ï¼‰
    this.cache = new LevelCache();
    this.lockManager = new RewardLockManager();
    this.badgeService = new BadgeService(this.levelDb, this.dbOperations);
    
    // æ£€æŸ¥æ˜¯å¦å¯ç”¨ï¼ˆç‰ˆæœ¬AçŽ¯å¢ƒå˜é‡æŽ§åˆ¶ï¼‰
    this.enabled = process.env.LEVEL_SYSTEM_ENABLED === 'true';
  }
  
  // æ ¸å¿ƒæ–¹æ³•ï¼ˆä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“ï¼Œä¸ä¾èµ–EAVï¼‰
  async processEvaluationReward(userId, groupId, evaluationId, actionType) {
    if (!this.enabled) return;
    
    const lockKey = `reward_${userId}`;
    await this.lockManager.acquireLock(lockKey);
    
    try {
      // ç›´æŽ¥æ“ä½œç‹¬ç«‹æ•°æ®åº“ï¼Œä¸ä½¿ç”¨EAV
      const userLevel = await this.getUserProfile(userId, groupId);
      const rewardConfig = await this.getGroupRewardConfig(groupId);
      
      // è®¡ç®—å¥–åŠ±å¹¶æ›´æ–°
      const { expChange, pointsChange } = this.calculateRewards(actionType, rewardConfig);
      await this.updateUserRewards(userId, groupId, expChange, pointsChange, actionType);
      
      // æ£€æŸ¥å‡çº§
      const levelUpResult = await this.checkLevelUp(userId, groupId);
      if (levelUpResult.leveledUp) {
        // å¤ç”¨çŽ°æœ‰çš„botæ’­æŠ¥æœåŠ¡ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
        await this.broadcastLevelUp(userId, levelUpResult);
      }
      
    } finally {
      this.lockManager.releaseLock(lockKey);
    }
  }
  
  async getUserProfile(userId, groupId) {
    // ç›´æŽ¥æŸ¥è¯¢ç‹¬ç«‹æ•°æ®åº“ï¼Œä¸ä½¿ç”¨EAV
    const stmt = this.levelDb.db.prepare(`
      SELECT * FROM user_levels 
      WHERE user_id = ? AND group_id = ?
    `);
    return stmt.get(userId, groupId);
  }
  
  // å¤ç”¨çŽ°æœ‰çš„ç”¨æˆ·ä¿¡æ¯èŽ·å–ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
  async getUserDisplayInfo(userId) {
    try {
      // ä½¿ç”¨çŽ°æœ‰çš„æ•°æ®åº“æ“ä½œèŽ·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆåªè¯»ï¼Œä¸ä¿®æ”¹ï¼‰
      const userRecord = this.dbOperations.getUserRecord ? 
        this.dbOperations.getUserRecord(userId) : null;
      
      return {
        userId: userId,
        username: userRecord?.username || null,
        firstName: userRecord?.first_name || null,
        lastName: userRecord?.last_name || null
      };
    } catch (error) {
      console.error('èŽ·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
      return { userId, username: null, firstName: null, lastName: null };
    }
  }
  
  // å¤ç”¨çŽ°æœ‰çš„æ’­æŠ¥æ–¹æ³•ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
  async broadcastLevelUp(userId, levelUpData) {
    if (!this.enabled) return;
    
    try {
      // ä½¿ç”¨çŽ°æœ‰çš„ç¾¤ç»„æ’­æŠ¥é€»è¾‘
      const GROUP_CHAT_ID = process.env.GROUP_CHAT_ID;
      if (!GROUP_CHAT_ID) return;
      
      const message = this.formatLevelUpMessage(levelUpData);
      
      // ç›´æŽ¥ä½¿ç”¨çŽ°æœ‰çš„botå®žä¾‹
      if (this.botService.bot) {
        const sentMessage = await this.botService.bot.sendMessage(GROUP_CHAT_ID, message, {
          parse_mode: 'Markdown'
        });
        
        // ä½¿ç”¨çŽ°æœ‰çš„ç½®é¡¶é€»è¾‘
        try {
          await this.botService.bot.pinChatMessage(GROUP_CHAT_ID, sentMessage.message_id);
        } catch (pinError) {
          console.log('ç½®é¡¶æ¶ˆæ¯å¤±è´¥:', pinError.message);
        }
      }
    } catch (error) {
      console.error('ç­‰çº§ç³»ç»Ÿæ’­æŠ¥å¤±è´¥:', error);
    }
  }
}

class BadgeService {
  constructor(levelDb, dbOperations) {
    // ä½¿ç”¨ç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“
    this.levelDb = levelDb;
    // å¤ç”¨çŽ°æœ‰çš„æ•°æ®åº“æ“ä½œï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
    this.dbOperations = dbOperations;
    this.conditionChecker = new BadgeConditionChecker(levelDb, dbOperations);
  }
  
  // å‹‹ç« ç›¸å…³æ–¹æ³•ï¼ˆä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“ï¼‰
  async checkBadgeUnlock(userId, groupId, userProfile) {
    // ç›´æŽ¥æŸ¥è¯¢ç‹¬ç«‹æ•°æ®åº“çš„å‹‹ç« å®šä¹‰
    const stmt = this.levelDb.db.prepare(`
      SELECT * FROM badge_definitions 
      WHERE group_id = ? AND status = 'active' AND badge_type = 'auto'
    `);
    const badges = stmt.all(groupId);
    
    const unlockedBadges = [];
    for (const badge of badges) {
      const isUnlocked = await this.conditionChecker.checkCondition(
        userId, groupId, badge.unlock_conditions, userProfile
      );
      if (isUnlocked) {
        unlockedBadges.push(badge);
      }
    }
    
    return unlockedBadges;
  }
  
  async awardBadge(userId, groupId, badgeId, awardType = 'system', adminId = null) {
    // ç›´æŽ¥æ“ä½œç‹¬ç«‹æ•°æ®åº“
    const stmt = this.levelDb.db.prepare(`
      INSERT OR IGNORE INTO user_badges 
      (user_id, group_id, badge_id, awarded_by, awarded_at)
      VALUES (?, ?, ?, ?, ?)
    `);
    return stmt.run(userId, groupId, badgeId, awardType, Date.now());
  }
}

class BadgeConditionChecker {
  constructor(levelDb, dbOperations) {
    this.levelDb = levelDb;
    this.dbOperations = dbOperations; // å¤ç”¨çŽ°æœ‰çš„æ•°æ®åº“æ“ä½œ
  }
  
  // æ¡ä»¶æ£€æŸ¥æ–¹æ³•ï¼ˆç»“åˆç‹¬ç«‹æ•°æ®åº“å’ŒçŽ°æœ‰æ•°æ®ï¼‰
  async checkStatBasedCondition(userId, groupId, condition) {
    // ä»Žç‹¬ç«‹æ•°æ®åº“èŽ·å–ç»Ÿè®¡æ•°æ®
    const stmt = this.levelDb.db.prepare(`
      SELECT * FROM user_levels WHERE user_id = ? AND group_id = ?
    `);
    const userStats = stmt.get(userId, groupId);
    
    if (!userStats) return false;
    
    const fieldValue = userStats[condition.field];
    return fieldValue >= condition.target;
  }
  
  async checkEvaluationStreakCondition(userId, groupId, condition) {
    // ä½¿ç”¨çŽ°æœ‰æ•°æ®åº“æ“ä½œæŸ¥è¯¢è¯„ä»·åŽ†å²ï¼ˆåªè¯»ï¼‰
    try {
      // è¿™é‡Œéœ€è¦æ ¹æ®çŽ°æœ‰çš„è¯„ä»·æŸ¥è¯¢æŽ¥å£æ¥å®žçŽ°
      // å¤ç”¨çŽ°æœ‰çš„æŸ¥è¯¢æ–¹æ³•ï¼Œä¸ä¿®æ”¹çŽ°æœ‰æ•°æ®
      const evaluationHistory = await this.dbOperations.getUserEvaluationHistory?.(userId, condition.count);
      
      if (!evaluationHistory || evaluationHistory.length < condition.count) {
        return false;
      }
      
      // æ£€æŸ¥è¿žç»­æ»¡åˆ†é€»è¾‘
      let consecutiveCount = 0;
      for (const eval of evaluationHistory) {
        if (eval.score >= condition.score) {
          consecutiveCount++;
          if (consecutiveCount >= condition.count) {
            return true;
          }
        } else if (condition.consecutive) {
          consecutiveCount = 0;
        }
      }
      
      return consecutiveCount >= condition.count;
    } catch (error) {
      console.error('æ£€æŸ¥è¯„ä»·è¿žå‡»æ¡ä»¶å¤±è´¥:', error);
      return false;
    }
  }
}

class RewardConfigService {
  constructor(levelDb) {
    // ä½¿ç”¨ç‰ˆæœ¬Açš„ç‹¬ç«‹æ•°æ®åº“
    this.levelDb = levelDb;
  }
  
  // é…ç½®ç®¡ç†æ–¹æ³•ï¼ˆæ“ä½œç‹¬ç«‹æ•°æ®åº“ï¼‰
  async getGroupRewardConfig(groupId) {
    const stmt = this.levelDb.db.prepare(`
      SELECT points_config FROM group_configs WHERE group_id = ?
    `);
    const config = stmt.get(groupId);
    return config ? JSON.parse(config.points_config) : this.getDefaultRewardConfig();
  }
  
  async updateGroupRewardConfig(groupId, config) {
    const stmt = this.levelDb.db.prepare(`
      UPDATE group_configs 
      SET points_config = ?, updated_at = ?
      WHERE group_id = ?
    `);
    return stmt.run(JSON.stringify(config), Date.now(), groupId);
  }
  
  getDefaultRewardConfig() {
    return {
      attack: { exp: 20, points: 10, desc: "å®Œæˆå‡ºå‡»" },
      user_eval_12: { exp: 30, points: 25, desc: "å®Œæˆ12é¡¹æŒ‰é’®è¯„ä»·" },
      merchant_eval: { exp: 25, points: 20, desc: "å•†å®¶è¯„ä»·ç”¨æˆ·" },
      text_eval: { exp: 15, points: 15, desc: "æ–‡å­—è¯¦ç»†è¯„ä»·" },
      level_up_bonus: { exp: 0, points: 50, desc: "å‡çº§å¥–åŠ±" }
    };
  }
}
```

#### 9.2 æœºå™¨äººå‘½ä»¤å¤„ç†ï¼ˆåŸºäºŽç‰ˆæœ¬Aæ–°å¢žå‘½ä»¤ï¼‰
```javascript
// åœ¨çŽ°æœ‰çš„botService.jsä¸­æ·»åŠ æ–°çš„å‘½ä»¤å¤„ç†ï¼ˆä¸ä¿®æ”¹çŽ°æœ‰å‘½ä»¤ï¼‰
// åŸºäºŽç‰ˆæœ¬Açš„çŽ¯å¢ƒå˜é‡æŽ§åˆ¶å’Œç‹¬ç«‹æœåŠ¡

// ç”¨æˆ·æŸ¥è¯¢ç­‰çº§å‘½ä»¤
bot.onText(/\/æˆ‘çš„ç­‰çº§|\/mylevel|\/level/, async (msg) => {
  // æ£€æŸ¥ç­‰çº§ç³»ç»Ÿæ˜¯å¦å¯ç”¨ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
  if (process.env.LEVEL_SYSTEM_ENABLED !== 'true') return;
  
  const userId = msg.from.id;
  const chatId = msg.chat.id;
  
  try {
    const levelService = require('../services/levelService');
    
    // ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“æŸ¥è¯¢ï¼Œä¸ä¾èµ–EAV
    const userProfile = await levelService.getUserProfile(userId, 'default');
    
    // å¤ç”¨çŽ°æœ‰çš„ç”¨æˆ·ä¿¡æ¯èŽ·å–ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
    const userDisplayInfo = await levelService.getUserDisplayInfo(userId);
    
    // æ ¼å¼åŒ–å“åº”
    const response = formatLevelResponse(userProfile, userDisplayInfo);
    
    await bot.sendMessage(chatId, response, { 
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [
            { text: 'ðŸ”„ åˆ·æ–°çŠ¶æ€', callback_data: 'level_refresh' },
            { text: 'ðŸ“Š è¯¦ç»†åŽ†å²', callback_data: 'level_history' }
          ]
        ]
      }
    });
  } catch (error) {
    console.error('ç­‰çº§æŸ¥è¯¢å¤±è´¥:', error);
    // é”™è¯¯ä¸å½±å“çŽ°æœ‰åŠŸèƒ½ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
  }
});

// è‡ªå®šä¹‰åç§°è®¾ç½®å‘½ä»¤ï¼ˆæ–°å¢žï¼‰
bot.onText(/\/è®¾ç½®åç§°\s+(.+)/, async (msg, match) => {
  if (process.env.LEVEL_SYSTEM_ENABLED !== 'true') return;
  
  const userId = msg.from.id;
  const customName = match[1].trim();
  
  if (customName.length > 20) {
    bot.sendMessage(msg.chat.id, 'åç§°é•¿åº¦ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦');
    return;
  }
  
  try {
    const levelService = require('../services/levelService');
    await levelService.setCustomDisplayName(userId, customName);
    bot.sendMessage(msg.chat.id, `âœ… å·²è®¾ç½®æ˜¾ç¤ºåç§°ä¸ºï¼š${customName}`);
  } catch (error) {
    console.error('è®¾ç½®åç§°å¤±è´¥:', error);
  }
});

// æ ¼å¼åŒ–ç­‰çº§å“åº”ï¼ˆåŸºäºŽç‰ˆæœ¬Açš„ç®€åŒ–è®¾è®¡ï¼‰
function formatLevelResponse(userProfile, userDisplayInfo) {
  const level = userProfile?.level || 1;
  const totalExp = userProfile?.total_exp || 0;
  const availablePoints = userProfile?.available_points || 0;
  const totalPointsEarned = userProfile?.total_points_earned || 0;
  
  // ç”¨æˆ·æ˜¾ç¤ºåç§°å¤„ç†ï¼ˆåŸºäºŽç‰ˆæœ¬Aï¼‰
  let displayName = userProfile?.display_name;
  if (!displayName) {
    if (userDisplayInfo.username) {
      displayName = `@${userDisplayInfo.username}`;
    } else if (userDisplayInfo.firstName || userDisplayInfo.lastName) {
      displayName = `${userDisplayInfo.firstName || ''} ${userDisplayInfo.lastName || ''}`.trim();
    } else {
      displayName = `ç”¨æˆ·${userDisplayInfo.userId}`;
    }
  }
  
  let response = `ðŸ§‘â€ðŸš€*ç¾¤å‹åç§°:* ${displayName}\n`;
  response += `â­*ç­‰çº§ä¿¡æ¯:* Lv.${level}\n`;
  response += `âš”ï¸*å‡ºå‡»ç»Ÿè®¡:* ${userProfile?.attack_count || 0}æ¬¡\n`;
  response += `ðŸ’Ž*å½“å‰ç§¯åˆ†:* ${availablePoints}ç§¯åˆ† (æ€»èŽ·å¾—: ${totalPointsEarned}ç§¯åˆ†)\n`;
  response += `ðŸ“ˆ*ç»éªŒå€¼:* ${totalExp}ç‚¹\n`;
  
  if (!userProfile?.display_name) {
    response += `\nðŸ’¡ ä½¿ç”¨ /è®¾ç½®åç§° <åç§°> æ¥è®¾ç½®ä¸ªæ€§åŒ–æ˜¾ç¤ºåç§°`;
  }
  
  return response;
}
```

#### 9.3 è¯„ä»·ç³»ç»Ÿé›†æˆï¼ˆåŸºäºŽç‰ˆæœ¬Aäº‹ä»¶ç›‘å¬æ¨¡å¼ï¼‰
```javascript
// åŸºäºŽç‰ˆæœ¬Açš„äº‹ä»¶ç›‘å¬é›†æˆï¼Œä¸ç ´åçŽ°æœ‰ä»£ç 

// åœ¨çŽ°æœ‰çš„evaluationService.jsæ–‡ä»¶ä¸­ï¼Œåªéœ€è¦åœ¨è¯„ä»·å®Œæˆæ—¶æ·»åŠ ä¸€è¡Œä»£ç ï¼š
// åŽŸæœ‰è¯„ä»·é€»è¾‘å®Œå…¨ä¸å˜

async updateEvaluation(evaluationId, overallScore, detailedScores, textComment, status) {
  // æ‰§è¡ŒåŽŸæœ‰çš„è¯„ä»·æ›´æ–°é€»è¾‘ï¼ˆä¸ä¿®æ”¹ï¼‰
  const result = await this.performEvaluationUpdate(evaluationId, overallScore, detailedScores, textComment, status);
  
  // åœ¨è¯„ä»·å®ŒæˆåŽæ·»åŠ è¿™ä¸€è¡Œï¼ˆéžç ´åæ€§ï¼Œç‰ˆæœ¬Aè¦æ±‚ï¼‰
  if (status === 'completed' && global.evaluationEvents) {
    try {
      // è§¦å‘ç­‰çº§ç³»ç»Ÿäº‹ä»¶ï¼Œä¸é˜»å¡žåŽŸæœ‰æµç¨‹
      setImmediate(() => {
        global.evaluationEvents.emit('evaluation_completed', {
          userId: evaluation.evaluator_id,
          evaluationId: evaluation.id,
          type: 'user_evaluation',
          overallScore,
          detailedScores,
          textComment,
          timestamp: Date.now()
        });
      });
    } catch (error) {
      console.error('è§¦å‘ç­‰çº§ç³»ç»Ÿäº‹ä»¶å¤±è´¥:', error);
      // é”™è¯¯ä¸å½±å“åŽŸæœ‰è¯„ä»·æµç¨‹ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
    }
  }
  
  return result;
}

// åœ¨app.jsä¸­åˆå§‹åŒ–ç­‰çº§ç³»ç»Ÿï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
// ä»…åœ¨å¯ç”¨æ—¶æ‰åˆå§‹åŒ–
if (process.env.LEVEL_SYSTEM_ENABLED === 'true') {
  // åˆ›å»ºå…¨å±€äº‹ä»¶ç³»ç»Ÿï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
  if (!global.evaluationEvents) {
    const EventEmitter = require('events');
    global.evaluationEvents = new EventEmitter();
  }
  
  // åˆå§‹åŒ–ç­‰çº§ç³»ç»Ÿé’©å­
  require('./models/levelServiceHook');
  console.log('âœ… ç­‰çº§ç³»ç»Ÿå·²å¯ç”¨');
} else {
  console.log('â„¹ï¸ ç­‰çº§ç³»ç»Ÿå·²ç¦ç”¨');
}
```

#### 9.4 ç®¡ç†å‘˜APIæŽ¥å£ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹è®¾è®¡ï¼‰
```javascript
// åœ¨çŽ°æœ‰çš„httpService.jsä¸­æ·»åŠ ç­‰çº§ç³»ç»ŸAPIï¼ˆä¸ä¿®æ”¹çŽ°æœ‰APIï¼‰
// åŸºäºŽç‰ˆæœ¬Açš„ç‹¬ç«‹APIè·¯ç”±è®¾è®¡

async function handleLevelSystemAPI(pathname, method, data) {
  // æ£€æŸ¥ç­‰çº§ç³»ç»Ÿæ˜¯å¦å¯ç”¨ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
  if (process.env.LEVEL_SYSTEM_ENABLED !== 'true') {
    return { success: false, message: 'ç­‰çº§ç³»ç»Ÿæœªå¯ç”¨' };
  }
  
  // éªŒè¯ç®¡ç†å‘˜æƒé™ï¼ˆå¤ç”¨çŽ°æœ‰éªŒè¯ï¼‰
  if (!data.password || !isAdminAuthorized(data.password)) {
    return { success: false, message: 'æ— æƒé™è®¿é—®' };
  }
  
  const levelService = require('../services/levelService');
  
  switch (pathname) {
    case '/api/level/status':
      return {
        success: true,
        enabled: process.env.LEVEL_SYSTEM_ENABLED === 'true',
        userCount: await levelService.getUserCount(),
        totalPoints: await levelService.getTotalPointsIssued()
      };
      
    case '/api/level/user/search':
      return await levelService.searchUser(data.query);
      
    case '/api/level/user/adjust':
      return await levelService.adjustUserPoints(
        data.userId, 
        data.pointsChange, 
        data.reason,
        data.adminId || 0
      );
      
    case '/api/level/stats':
      return await levelService.getSystemStats();
      
    default:
      return { success: false, message: 'æœªçŸ¥APIè·¯å¾„' };
  }
}

// åœ¨çŽ°æœ‰çš„è·¯ç”±å¤„ç†ä¸­æ·»åŠ ï¼ˆä¸ä¿®æ”¹çŽ°æœ‰è·¯ç”±ï¼‰
if (pathname.startsWith('/api/level/')) {
  return handleLevelSystemAPI(pathname, method, data);
}
```

### 10. éƒ¨ç½²å’Œé…ç½®ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹è®¾è®¡ï¼‰

#### 10.1 ç‹¬ç«‹æ•°æ®åº“åˆå§‹åŒ–ï¼ˆåŸºäºŽç‰ˆæœ¬Aï¼‰
```javascript
// scripts/init-level-system.js - ç‹¬ç«‹åˆå§‹åŒ–è„šæœ¬
// åŸºäºŽç‰ˆæœ¬Açš„å®Œå…¨ç‹¬ç«‹è®¾è®¡
class LevelSystemInitializer {
    constructor() {
        this.enabled = process.env.LEVEL_SYSTEM_ENABLED === 'true';
    }
    
    async initialize() {
        if (!this.enabled) {
            console.log('ðŸ† ç­‰çº§ç³»ç»Ÿæœªå¯ç”¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
            return;
        }
        
        console.log('ðŸ† åˆå§‹åŒ–ç­‰çº§ç³»ç»Ÿ...');
        
        try {
            const LevelDatabaseManager = require('../config/levelDatabase');
            const levelDb = new LevelDatabaseManager();
            
            // ç¡®ä¿ç‹¬ç«‹æ•°æ®åº“æ–‡ä»¶å­˜åœ¨ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
            await this.ensureDatabaseExists(levelDb);
            
            // åˆ›å»ºæ‰€æœ‰è¡¨ç»“æž„
            await this.createTables(levelDb);
            
            // åˆ›å»ºé»˜è®¤ç¾¤ç»„é…ç½®
            await this.createDefaultGroupConfig(levelDb);
            
            // åˆå§‹åŒ–é»˜è®¤å‹‹ç« 
            await this.initializeDefaultBadges(levelDb);
            
            console.log('âœ… ç­‰çº§ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('âŒ ç­‰çº§ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
            // ä¸å½±å“ä¸»ç³»ç»Ÿå¯åŠ¨ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰
        }
    }
    
    async createTables(levelDb) {
        // åŸºäºŽç‰ˆæœ¬Açš„6è¡¨è®¾è®¡åˆ›å»ºè¡¨ç»“æž„
        const tables = [
            `CREATE TABLE IF NOT EXISTS level_meta (
                key TEXT PRIMARY KEY,
                value TEXT,
                description TEXT,
                created_at INTEGER DEFAULT (strftime('%s', 'now')),
                updated_at INTEGER DEFAULT (strftime('%s', 'now'))
            )`,
            
            `CREATE TABLE IF NOT EXISTS user_levels (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                group_id TEXT NOT NULL DEFAULT 'default',
                level INTEGER DEFAULT 1,
                total_exp INTEGER DEFAULT 0,
                available_points INTEGER DEFAULT 0,
                total_points_earned INTEGER DEFAULT 0,
                total_points_spent INTEGER DEFAULT 0,
                attack_count INTEGER DEFAULT 0,
                user_eval_count INTEGER DEFAULT 0,
                merchant_eval_count INTEGER DEFAULT 0,
                text_eval_count INTEGER DEFAULT 0,
                badges TEXT DEFAULT '[]',
                display_name TEXT,
                created_at INTEGER DEFAULT (strftime('%s', 'now')),
                updated_at INTEGER DEFAULT (strftime('%s', 'now')),
                UNIQUE(user_id, group_id)
            )`,
            
            // ... å…¶ä»–è¡¨åˆ›å»ºè¯­å¥
        ];
        
        for (const tableSQL of tables) {
            levelDb.db.exec(tableSQL);
        }
        
        // åˆ›å»ºç´¢å¼•
        const indexes = [
            `CREATE INDEX IF NOT EXISTS idx_user_levels_user_group ON user_levels(user_id, group_id)`,
            `CREATE INDEX IF NOT EXISTS idx_user_levels_level ON user_levels(level DESC)`,
            `CREATE INDEX IF NOT EXISTS idx_user_levels_points ON user_levels(available_points DESC)`
        ];
        
        for (const indexSQL of indexes) {
            levelDb.db.exec(indexSQL);
        }
    }
    
    async createDefaultGroupConfig(levelDb) {
        const defaultGroupId = process.env.GROUP_CHAT_ID || 'default';
        
        const config = {
            group_id: defaultGroupId,
            group_name: 'é»˜è®¤ç¾¤ç»„',
            level_config: JSON.stringify({
                levels: [
                    { level: 1, name: "æ–°æ‰‹å‹‡å£« ðŸŸ¢", required_evals: 0, required_exp: 0 },
                    { level: 2, name: "åˆçº§å‹‡å£« ðŸ”µ", required_evals: 3, required_exp: 50 },
                    { level: 3, name: "ä¸­çº§å‹‡å£« ðŸŸ£", required_evals: 8, required_exp: 150 },
                    { level: 4, name: "é«˜çº§å‹‡å£« ðŸŸ ", required_evals: 15, required_exp: 300 },
                    { level: 5, name: "ä¸“å®¶å‹‡å£« ðŸ”´", required_evals: 25, required_exp: 500 },
                    { level: 6, name: "å¤§å¸ˆå‹‡å£« ðŸŸ¡", required_evals: 40, required_exp: 750 },
                    { level: 7, name: "ä¼ è¯´å‹‡å£« âšª", required_evals: 60, required_exp: 1050 },
                    { level: 8, name: "å²è¯—å‹‡å£« ðŸŸ¤", required_evals: 85, required_exp: 1400 },
                    { level: 9, name: "ç¥žè¯å‹‡å£« âš«", required_evals: 120, required_exp: 1800 },
                    { level: 10, name: "è‡³å°Šå‹‡å£« ðŸŒŸ", required_evals: 160, required_exp: 2250 }
                ]
            }),
            points_config: JSON.stringify({
                attack: { exp: 20, points: 10, desc: "å®Œæˆå‡ºå‡»" },
                user_eval_12: { exp: 30, points: 25, desc: "å®Œæˆ12é¡¹æŒ‰é’®è¯„ä»·" },
                merchant_eval: { exp: 25, points: 20, desc: "å•†å®¶è¯„ä»·ç”¨æˆ·" },
                text_eval: { exp: 15, points: 15, desc: "æ–‡å­—è¯¦ç»†è¯„ä»·" },
                level_up_bonus: { exp: 0, points: 50, desc: "å‡çº§å¥–åŠ±" }
            }),
            status: 'active'
        };
        
        levelDb.db.prepare(`
            INSERT OR REPLACE INTO group_configs 
            (group_id, group_name, level_config, points_config, status)
            VALUES (?, ?, ?, ?, ?)
        `).run(
            config.group_id, 
            config.group_name, 
            config.level_config, 
            config.points_config, 
            config.status
        );
    }
}

// åœ¨app.jsä¸­è°ƒç”¨åˆå§‹åŒ–ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼šä»…åœ¨å¯ç”¨æ—¶ï¼‰
if (process.env.LEVEL_SYSTEM_ENABLED === 'true') {
    const initializer = new LevelSystemInitializer();
    initializer.initialize();
}
```

#### 10.2 Railwayéƒ¨ç½²é…ç½®ï¼ˆåŸºäºŽç‰ˆæœ¬AçŽ¯å¢ƒå˜é‡ï¼‰
```javascript
// railway.toml é…ç½®
[environments.production]
LEVEL_SYSTEM_ENABLED = "true"           # å¯ç”¨ç­‰çº§ç³»ç»Ÿ
LEVEL_CACHE_TTL = "300000"              # ç¼“å­˜æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰
LEVEL_BROADCAST_ENABLED = "true"        # å¯ç”¨ç­‰çº§æ’­æŠ¥

# å¯é€‰çš„è‡ªå®šä¹‰é…ç½®
LEVEL_POINTS_ATTACK = "20"              # å‡ºå‡»ç»éªŒå€¼
LEVEL_POINTS_USER_EVAL = "30"           # ç”¨æˆ·è¯„ä»·ç»éªŒå€¼
LEVEL_POINTS_MERCHANT_EVAL = "25"       # å•†å®¶è¯„ä»·ç»éªŒå€¼

[environments.staging]
LEVEL_SYSTEM_ENABLED = "true"           # æµ‹è¯•çŽ¯å¢ƒä¹Ÿå¯ç”¨
LEVEL_CACHE_TTL = "60000"               # æµ‹è¯•çŽ¯å¢ƒç¼“å­˜æ—¶é—´çŸ­ä¸€äº›

[environments.development]
LEVEL_SYSTEM_ENABLED = "false"          # å¼€å‘çŽ¯å¢ƒé»˜è®¤ç¦ç”¨
```

#### 10.3 ç‹¬ç«‹ç®¡ç†é¡µé¢ï¼ˆåŸºäºŽç‰ˆæœ¬Aè®¾è®¡ï¼‰
```html
<!-- admin/level-system.html - æ–°å»ºç‹¬ç«‹é¡µé¢ï¼ŒåŸºäºŽç‰ˆæœ¬A -->
<!DOCTYPE html>
<html>
<head>
    <title>ç­‰çº§ç³»ç»Ÿç®¡ç†</title>
    <link rel="stylesheet" href="../styles/common.css">
    <style>
        .level-system-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .status-indicator { padding: 5px 10px; border-radius: 3px; }
        .status-enabled { background: #d4edda; color: #155724; }
        .status-disabled { background: #f8d7da; color: #721c24; }
        .user-search { margin: 20px 0; }
        .user-info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="level-system-container">
        <h1>ðŸ† ç­‰çº§ç³»ç»Ÿç®¡ç†</h1>
        
        <!-- ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ï¼ˆç‰ˆæœ¬Aè¦æ±‚ï¼‰ -->
        <div class="system-status">
            <h2>ç³»ç»ŸçŠ¶æ€</h2>
            <div id="systemStatus" class="status-indicator">æ£€æŸ¥ä¸­...</div>
            <p>æ•°æ®åº“çŠ¶æ€ï¼š<span id="dbStatus">æ£€æŸ¥ä¸­...</span></p>
            <p>æ•°æ®åº“è·¯å¾„ï¼š<span id="dbPath">åŠ è½½ä¸­...</span></p>
            <button onclick="toggleLevelSystem()">å¯ç”¨/ç¦ç”¨ç­‰çº§ç³»ç»Ÿ</button>
        </div>
        
        <!-- ç”¨æˆ·æŸ¥è¯¢ï¼ˆåŸºäºŽç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“ï¼‰ -->
        <div class="user-search">
            <h2>ç”¨æˆ·æŸ¥è¯¢</h2>
            <input type="text" id="userSearchInput" placeholder="è¾“å…¥ç”¨æˆ·ID">
            <button onclick="searchUser()">æŸ¥è¯¢</button>
            
            <div id="userInfo" class="user-info" style="display: none;">
                <!-- åŠ¨æ€æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ -->
            </div>
        </div>
        
        <!-- ç§¯åˆ†è°ƒæ•´ï¼ˆç‰ˆæœ¬Aç‹¬ç«‹æ“ä½œï¼‰ -->
        <div class="points-adjustment">
            <h2>ç§¯åˆ†è°ƒæ•´</h2>
            <input type="hidden" id="adjustUserId">
            <input type="number" id="pointsChange" placeholder="ç§¯åˆ†å˜åŒ–é‡ï¼ˆæ­£æ•°å¢žåŠ ï¼Œè´Ÿæ•°å‡å°‘ï¼‰">
            <input type="text" id="adjustReason" placeholder="è°ƒæ•´åŽŸå› ">
            <button onclick="adjustPoints()">è°ƒæ•´ç§¯åˆ†</button>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ï¼ˆç‰ˆæœ¬Aç‹¬ç«‹ç»Ÿè®¡ï¼‰ -->
        <div class="statistics">
            <h2>ç»Ÿè®¡ä¿¡æ¯</h2>
            <div id="levelStats">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- æ•°æ®åº“ä¿¡æ¯ï¼ˆç‰ˆæœ¬Aç‹¬ç«‹æ•°æ®åº“çŠ¶æ€ï¼‰ -->
        <div class="database-info">
            <h2>æ•°æ®åº“ä¿¡æ¯</h2>
            <p>ç‹¬ç«‹æ•°æ®åº“æ–‡ä»¶ï¼šlevel_system.db</p>
            <p>ä¸ŽçŽ°æœ‰æ•°æ®åº“éš”ç¦»ï¼šå®Œå…¨ç‹¬ç«‹</p>
            <p>å¯éšæ—¶ç§»é™¤ï¼šåˆ é™¤æ–‡ä»¶å³å¯å®Œå…¨æ¸…é™¤</p>
            <button onclick="exportLevelData()">å¯¼å‡ºç­‰çº§æ•°æ®</button>
            <button onclick="clearLevelData()">æ¸…ç©ºç­‰çº§æ•°æ®</button>
        </div>
    </div>
    
    <script src="../scripts/level-system-admin.js"></script>
</body>
</html>
```

### 11. æ•°æ®æµç¨‹å›¾

```mermaid
graph TB
    A[ç”¨æˆ·å®Œæˆè¯„ä»·] --> B[evaluationService.updateEvaluation]
    B --> C[LevelService.processEvaluationReward]
    C --> D[æ£€æµ‹è¯„ä»·ç±»åž‹]
    D --> E[è®¡ç®—ç§¯åˆ†å¥–åŠ±]
    E --> F[æ›´æ–°ç”¨æˆ·ç­‰çº§æ•°æ®]
    F --> G[è®°å½•ç§¯åˆ†åŽ†å²]
    G --> H[æ£€æŸ¥æ˜¯å¦å‡çº§]
    H --> I[å‘é€å‡çº§é€šçŸ¥]
    
    J[ç”¨æˆ·æŸ¥è¯¢ç­‰çº§] --> K[LevelService.getUserLevel]
    K --> L[ä»Žç¼“å­˜èŽ·å–]
    L --> M[ç¼“å­˜å‘½ä¸­?]
    M -->|æ˜¯| N[è¿”å›žç¼“å­˜æ•°æ®]
    M -->|å¦| O[ä»ŽEAVæ•°æ®åº“æŸ¥è¯¢]
    O --> P[æ›´æ–°ç¼“å­˜]
    P --> N
    
    Q[ç®¡ç†å‘˜è°ƒæ•´ç§¯åˆ†] --> R[LevelService.updateUserPoints]
    R --> S[èŽ·å–ç§¯åˆ†é”]
    S --> T[å¼€å§‹äº‹åŠ¡]
    T --> U[æ›´æ–°ç§¯åˆ†æ•°æ®]
    U --> V[è®°å½•åŽ†å²]
    V --> W[æäº¤äº‹åŠ¡]
    W --> X[é‡Šæ”¾é”]
```

### 12. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 12.1 æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨EAVå¤åˆç´¢å¼•æé«˜æŸ¥è¯¢æ•ˆçŽ‡
- æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ç­‰çº§æ•°æ®
- é¢„è®¡ç®—å¸¸ç”¨ç»Ÿè®¡æ•°æ®

#### 12.2 ç¼“å­˜ç­–ç•¥
- ç”¨æˆ·ç­‰çº§æ•°æ®ç¼“å­˜5åˆ†é’Ÿ
- ç§¯åˆ†åŽ†å²åˆ†é¡µç¼“å­˜
- ç®¡ç†å‘˜ç•Œé¢æ•°æ®ç¼“å­˜

#### 12.3 å¹¶å‘æŽ§åˆ¶
- ç§¯åˆ†æ“ä½œä½¿ç”¨ç”¨æˆ·çº§é”
- æ•°æ®åº“äº‹åŠ¡ç¡®ä¿ä¸€è‡´æ€§
- å¼‚æ­¥å¤„ç†å‡çº§é€šçŸ¥

### 13. ç›‘æŽ§å’Œç»´æŠ¤

#### 13.1 æ€§èƒ½ç›‘æŽ§
- ç­‰çº§ç³»ç»Ÿæ“ä½œå“åº”æ—¶é—´
- ç§¯åˆ†æŸ¥è¯¢é¢‘çŽ‡ç»Ÿè®¡
- ç¼“å­˜å‘½ä¸­çŽ‡ç›‘æŽ§

#### 13.2 æ•°æ®ç»´æŠ¤
- å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
- ç§¯åˆ†åŽ†å²æ•°æ®å½’æ¡£
- ç­‰çº§åˆ†å¸ƒç»Ÿè®¡æŠ¥å‘Š

---

## æ€»ç»“

æœ¬ç­‰çº§ç³»ç»Ÿè®¾è®¡å®Œå…¨åŸºäºŽé¡¹ç›®çŽ°æœ‰çš„EAVæž¶æž„ï¼Œä¸Žè¯„ä»·ç³»ç»Ÿæ·±åº¦é›†æˆï¼Œæ”¯æŒé«˜å¹¶å‘æ“ä½œï¼Œæä¾›å®Œæ•´çš„ç®¡ç†ç•Œé¢ã€‚ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºŽæ‰©å±•å’Œç»´æŠ¤ï¼Œç¬¦åˆRailwayäº‘ç«¯éƒ¨ç½²è¦æ±‚ã€‚

è®¾è®¡å……åˆ†è€ƒè™‘äº†ç”¨æˆ·ä½“éªŒã€æ•°æ®ä¸€è‡´æ€§ã€æ€§èƒ½ä¼˜åŒ–ç­‰å„ä¸ªæ–¹é¢ï¼Œä¸ºé¡¹ç›®æä¾›äº†ä¸€ä¸ªå®Œæ•´ã€å¯é çš„ç­‰çº§ç§¯åˆ†ç³»ç»Ÿè§£å†³æ–¹æ¡ˆã€‚

---

## å…³é”®æŠ€æœ¯é—®é¢˜è§£å†³æ–¹æ¡ˆ

### 1. ç”¨æˆ·åä¸ºç©ºçš„å¤„ç†æ–¹æ¡ˆ

#### 1.1 é—®é¢˜æè¿°
éƒ¨åˆ†ç”¨æˆ·æ²¡æœ‰è®¾ç½®Telegramç”¨æˆ·åï¼Œä½†Telegram IDå§‹ç»ˆå­˜åœ¨ä¸”å”¯ä¸€ã€‚

#### 1.2 è§£å†³æ–¹æ¡ˆ
```javascript
// ç”¨æˆ·æ˜¾ç¤ºåç§°å¤„ç†é€»è¾‘
function getUserDisplayName(userId, userInfo) {
  // ä¼˜å…ˆçº§ï¼šè‡ªå®šä¹‰åç§° > ç”¨æˆ·å > å§“åç»„åˆ > ç”¨æˆ·ID
  if (userInfo.custom_display_name) {
    return userInfo.custom_display_name;
  }
  
  if (userInfo.username) {
    return `@${userInfo.username}`;
  }
  
  if (userInfo.first_name || userInfo.last_name) {
    return `${userInfo.first_name || ''} ${userInfo.last_name || ''}`.trim();
  }
  
  return `ç”¨æˆ·${userId}`;
}
```

#### 1.3 è‡ªå®šä¹‰åç§°è®¾ç½®
```javascript
// æœºå™¨äººå‘½ä»¤å¤„ç†
bot.onText(/\/è®¾ç½®åç§°\s+(.+)/, async (msg, match) => {
  const userId = msg.from.id;
  const customName = match[1].trim();
  
  if (customName.length > 20) {
    bot.sendMessage(msg.chat.id, 'åç§°é•¿åº¦ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦');
    return;
  }
  
  // ä¿å­˜è‡ªå®šä¹‰åç§°åˆ°EAVç³»ç»Ÿ
  await levelService.setCustomDisplayName(userId, customName);
  bot.sendMessage(msg.chat.id, `âœ… å·²è®¾ç½®æ˜¾ç¤ºåç§°ä¸ºï¼š${customName}`);
});
```

### 2. çŽ°æœ‰æ•°æ®è¿ç§»æ–¹æ¡ˆ

#### 2.1 ä»Žå¯¼å…¥çš„æ•°æ®ä¸­æå–çŽ°æœ‰ç”¨æˆ·ä¿¡æ¯
```javascript
// åˆ†æžå¯¼å…¥çš„æ•°æ®æ–‡ä»¶
class LevelSystemMigration {
  constructor() {
    this.exportedData = require('./exports/-1002384738564_export (1).json');
  }
  
  async migrateExistingUsers() {
    const users = this.exportedData.data.notes.notes;
    
    for (const user of users) {
      const userInfo = this.parseUserInfo(user);
      await this.createInitialUserLevel(userInfo);
    }
  }
  
  parseUserInfo(userNote) {
    const text = userNote.text;
    const name = userNote.name;
    
    // è§£æžå‡ºå‡»æ¬¡æ•°
    const attackMatch = text.match(/âš”ï¸\*?å‡ºå‡»æ¬¡æ•°:\*?\s*(\d+)æ¬¡/);
    const attackCount = attackMatch ? parseInt(attackMatch[1]) : 1;
    
    // è§£æžç­‰çº§ï¼ˆå¦‚æžœæœ‰ï¼‰
    const levelMatch = text.match(/â­\*?ç­‰çº§ä¿¡æ¯:\*?\s*Lv\.(\d+)/);
    const level = levelMatch ? parseInt(levelMatch[1]) : 1;
    
    return {
      name: name,
      displayName: this.extractDisplayName(text),
      attackCount: attackCount,
      currentLevel: level,
      totalExperience: this.calculateExperienceFromLevel(level, attackCount)
    };
  }
  
  extractDisplayName(text) {
    const nameMatch = text.match(/ðŸ§‘â€ðŸš€\*?ç¾¤å‹åç§°:\*?\s*(.+?)(?:\n|\s)/);
    return nameMatch ? nameMatch[1].trim() : null;
  }
  
  calculateExperienceFromLevel(level, attackCount) {
    // æ ¹æ®ç­‰çº§å’Œè¯„ä»·æ¬¡æ•°æŽ¨ç®—ç»éªŒå€¼
    const baseExp = LEVEL_CONFIG.levels[level - 1]?.minExp || 0;
    const evaluationExp = attackCount * 20; // å‡è®¾å¹³å‡æ¯æ¬¡è¯„ä»·20ç»éªŒ
    return baseExp + evaluationExp;
  }
  
  async createInitialUserLevel(userInfo) {
    // åˆ›å»ºåˆå§‹ç­‰çº§æ•°æ®
    const levelData = {
      current_level: userInfo.currentLevel,
      total_experience: userInfo.totalExperience,
      current_experience: userInfo.totalExperience,
      evaluation_count: userInfo.attackCount,
      detailed_evaluation_count: Math.floor(userInfo.attackCount * 0.6), // å‡è®¾60%ä¸ºè¯¦ç»†è¯„ä»·
      display_name: userInfo.displayName,
      last_updated: new Date().toISOString()
    };
    
    // è¿™é‡Œéœ€è¦æœ‰å®žé™…çš„ç”¨æˆ·IDæ‰èƒ½åˆ›å»ºè®°å½•
    // å®žé™…è¿ç§»æ—¶éœ€è¦é€šè¿‡ç”¨æˆ·åæˆ–å…¶ä»–æ–¹å¼åŒ¹é…åˆ°çœŸå®žçš„user_id
    console.log('å‡†å¤‡è¿ç§»ç”¨æˆ·æ•°æ®ï¼š', userInfo.name, levelData);
  }
}
```

### 3. æ•°æ®åº“ç»“æž„ä¼˜åŒ–

#### 3.1 EAVè¡¨çš„é¢å¤–ä¼˜åŒ–
```sql
-- ä¸ºç­‰çº§ç³»ç»Ÿæ·»åŠ ä¸“é—¨çš„ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_level_current_level ON eav_data_values(value) 
WHERE field_id = 1001; -- current_levelå­—æ®µ

CREATE INDEX IF NOT EXISTS idx_level_total_experience ON eav_data_values(value) 
WHERE field_id = 1002; -- total_experienceå­—æ®µ

-- ç§¯åˆ†åŽ†å²æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX IF NOT EXISTS idx_points_history_user_timestamp ON eav_data_values(entity_key, value) 
WHERE schema_id = 1003 AND field_id = 1209; -- æŒ‰ç”¨æˆ·å’Œæ—¶é—´æŸ¥è¯¢
```

#### 3.2 ç¼“å­˜å±‚è®¾è®¡
```javascript
class LevelSystemCache {
  constructor() {
    this.userLevelCache = new Map();
    this.userPointsCache = new Map();
    this.CACHE_TTL = 5 * 60 * 1000; // 5åˆ†é’Ÿ
  }
  
  getCacheKey(prefix, userId) {
    return `${prefix}_${userId}`;
  }
  
  async getUserLevel(userId) {
    const cacheKey = this.getCacheKey('level', userId);
    const cached = this.userLevelCache.get(cacheKey);
    
    if (cached && cached.expiry > Date.now()) {
      return cached.data;
    }
    
    // ä»ŽEAVæ•°æ®åº“æŸ¥è¯¢
    const levelData = await this.eavOps.getEntity(`user_${userId}`, 'user_profile');
    
    if (levelData) {
      this.userLevelCache.set(cacheKey, {
        data: levelData,
        expiry: Date.now() + this.CACHE_TTL
      });
    }
    
    return levelData;
  }
  
  invalidateUserCache(userId) {
    const levelKey = this.getCacheKey('level', userId);
    const pointsKey = this.getCacheKey('points', userId);
    
    this.userLevelCache.delete(levelKey);
    this.userPointsCache.delete(pointsKey);
  }
}
```

### 4. ä¸ŽçŽ°æœ‰ç³»ç»Ÿé›†æˆ

#### 4.1 ä¸Žè¯„ä»·ç³»ç»Ÿçš„é›†æˆç‚¹
```javascript
// åœ¨evaluationService.jsä¸­çš„é›†æˆ
class EvaluationService {
  constructor() {
    this.levelService = require('./levelService');
  }
  
  async updateEvaluation(evaluationId, overallScore, detailedScores, textComment, status) {
    // æ‰§è¡ŒåŽŸæœ‰çš„è¯„ä»·æ›´æ–°é€»è¾‘
    const updateResult = await this.performOriginalUpdate(evaluationId, overallScore, detailedScores, textComment, status);
    
    // å¦‚æžœè¯„ä»·å®Œæˆï¼Œè§¦å‘ç­‰çº§ç³»ç»Ÿ
    if (status === 'completed') {
      try {
        const evaluation = this.getEvaluation(evaluationId);
        const evaluationType = this.determineEvaluationType(overallScore, detailedScores, textComment);
        
        // å¼‚æ­¥å¤„ç†ç­‰çº§å¥–åŠ±ï¼Œä¸é˜»å¡žä¸»æµç¨‹
        setImmediate(async () => {
          try {
            await this.levelService.processEvaluationReward(
              evaluation.evaluator_id,
              evaluationId,
              evaluationType
            );
          } catch (error) {
            console.error('å¤„ç†ç­‰çº§å¥–åŠ±å¤±è´¥:', error);
          }
        });
        
      } catch (error) {
        console.error('ç­‰çº§ç³»ç»Ÿé›†æˆå¤±è´¥:', error);
        // ä¸å½±å“åŽŸæœ‰è¯„ä»·æµç¨‹
      }
    }
    
    return updateResult;
  }
  
  determineEvaluationType(overallScore, detailedScores, textComment) {
    let type = 'simple';
    let points = 0;
    
    if (detailedScores && Object.keys(detailedScores).length >= 10) {
      type = 'detailed';
      points += 25;
    } else if (overallScore) {
      type = 'simple';
      points += 10;
    }
    
    if (textComment && textComment.trim().length > 0) {
      points += 5;
    }
    
    return { type, points };
  }
}
```

#### 4.2 ä¸Žç”¨æˆ·äº¤äº’çš„é›†æˆ
```javascript
// åœ¨botService.jsä¸­æ·»åŠ ç­‰çº§æŸ¥è¯¢å‘½ä»¤
async function handleLevelQuery(msg) {
  const userId = msg.from.id;
  const chatId = msg.chat.id;
  
  try {
    const levelData = await levelService.getUserLevel(userId);
    const pointsData = await levelService.getUserPoints(userId);
    const history = await levelService.getPointsHistory(userId, 5);
    
    const displayName = getUserDisplayName(userId, {
      username: msg.from.username,
      first_name: msg.from.first_name,
      last_name: msg.from.last_name,
      custom_display_name: levelData?.display_name
    });
    
    const response = formatLevelResponse(levelData, pointsData, history, displayName);
    
    await bot.sendMessage(chatId, response, { 
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [
            { text: 'ðŸ”„ åˆ·æ–°', callback_data: 'refresh_level' },
            { text: 'ðŸ“Š è¯¦ç»†è®°å½•', callback_data: 'detailed_history' }
          ],
          [
            { text: 'âš™ï¸ è®¾ç½®åç§°', callback_data: 'set_display_name' }
          ]
        ]
      }
    });
    
  } catch (error) {
    console.error('æŸ¥è¯¢ç­‰çº§å¤±è´¥:', error);
    await bot.sendMessage(chatId, 'æŸ¥è¯¢ç­‰çº§ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•');
  }
}

// æ ¼å¼åŒ–ç­‰çº§å“åº”
function formatLevelResponse(levelData, pointsData, history, displayName) {
  const level = levelData?.current_level || 1;
  const levelConfig = LEVEL_CONFIG.levels.find(l => l.level === level);
  const totalExp = levelData?.total_experience || 0;
  const evaluationCount = levelData?.evaluation_count || 0;
  const detailedCount = levelData?.detailed_evaluation_count || 0;
  const availablePoints = pointsData?.available_points || 0;
  const totalPoints = pointsData?.total_points || 0;
  
  let response = `ðŸ§‘â€ðŸš€*ç¾¤å‹åç§°:* ${displayName}\n`;
  response += `â­*ç­‰çº§ä¿¡æ¯:* Lv.${level} ${levelConfig?.name} ${levelConfig?.color}\n`;
  response += `âš”ï¸*å‡ºå‡»æ¬¡æ•°:* ${evaluationCount}æ¬¡ (è¯¦ç»†è¯„ä»·: ${detailedCount}æ¬¡)\n`;
  response += `ðŸ’Ž*å½“å‰ç§¯åˆ†:* ${availablePoints}ç§¯åˆ† (æ€»è®¡: ${totalPoints}ç§¯åˆ†)\n`;
  
  if (level < 10) {
    const nextLevel = LEVEL_CONFIG.levels.find(l => l.level === level + 1);
    const expToNext = nextLevel.minExp - totalExp;
    response += `ðŸ“ˆ*ç»éªŒå€¼:* ${totalExp}/${nextLevel.minExp} (è·ç¦»å‡çº§è¿˜éœ€${expToNext}ç»éªŒ)\n`;
  }
  
  if (history && history.length > 0) {
    response += `\nðŸ“Š*è¿‘æœŸç§¯åˆ†è®°å½•:*\n`;
    history.forEach(record => {
      const date = new Date(record.timestamp).toLocaleDateString();
      const change = record.points_change > 0 ? `+${record.points_change}` : record.points_change;
      response += `â€¢ ${date} ${record.description} ${change}ç§¯åˆ†\n`;
    });
  }
  
  if (level < 10) {
    const nextLevel = LEVEL_CONFIG.levels.find(l => l.level === level + 1);
    response += `\nðŸŽ¯*å‡çº§å¥–åŠ±é¢„å‘Š:*\n`;
    response += `ä¸‹ä¸€ç­‰çº§: Lv.${nextLevel.level} ${nextLevel.name} ${nextLevel.color}\n`;
    response += `å‡çº§å¥–åŠ±: ç‰¹æ®Šç§°å· + 50ç§¯åˆ†å¥–åŠ±`;
  }
  
  return response;
}
```

### 5. ç®¡ç†å‘˜åŠŸèƒ½å®žçŽ°

#### 5.1 ç®¡ç†å‘˜APIæŽ¥å£
```javascript
// åœ¨httpService.jsä¸­æ·»åŠ ç®¡ç†å‘˜API
async function handleAdminLevelAPI(pathname, method, data) {
  // éªŒè¯ç®¡ç†å‘˜æƒé™
  if (!isAdminAuthorized(data.password)) {
    return { success: false, message: 'æ— æƒé™è®¿é—®' };
  }
  
  if (pathname === '/api/admin/level/search') {
    return await searchUserLevel(data.query);
  }
  
  if (pathname === '/api/admin/level/adjust') {
    return await adjustUserPoints(data.userId, data.pointsChange, data.reason);
  }
  
  if (pathname === '/api/admin/level/statistics') {
    return await getLevelStatistics();
  }
}

async function searchUserLevel(query) {
  try {
    let userId = null;
    
    // å°è¯•æŒ‰ç”¨æˆ·IDæœç´¢
    if (/^\d+$/.test(query)) {
      userId = parseInt(query);
    } else {
      // æŒ‰ç”¨æˆ·åæœç´¢
      const user = dbOperations.getUserRecordByUsername(query);
      if (user) {
        userId = user.user_id;
      }
    }
    
    if (!userId) {
      return { success: false, message: 'ç”¨æˆ·ä¸å­˜åœ¨' };
    }
    
    const levelData = await levelService.getUserLevel(userId);
    const pointsData = await levelService.getUserPoints(userId);
    const history = await levelService.getPointsHistory(userId, 20);
    
    return {
      success: true,
      data: {
        userId,
        levelData,
        pointsData,
        history
      }
    };
    
  } catch (error) {
    console.error('æœç´¢ç”¨æˆ·ç­‰çº§å¤±è´¥:', error);
    return { success: false, message: 'æœç´¢å¤±è´¥' };
  }
}

async function adjustUserPoints(userId, pointsChange, reason) {
  try {
    const adminUserId = 0; // ç®¡ç†å‘˜ç”¨æˆ·ID
    
    await levelService.updateUserPoints(
      userId,
      pointsChange,
      'admin_adjust',
      reason,
      adminUserId
    );
    
    return { success: true, message: 'ç§¯åˆ†è°ƒæ•´æˆåŠŸ' };
    
  } catch (error) {
    console.error('è°ƒæ•´ç§¯åˆ†å¤±è´¥:', error);
    return { success: false, message: 'è°ƒæ•´å¤±è´¥' };
  }
}
```

#### 5.2 ç®¡ç†å‘˜ç•Œé¢JavaScript
```javascript
// åœ¨admin/scripts/ä¸­æ·»åŠ levelManager.js
class LevelManager {
  constructor() {
    this.adminPassword = localStorage.getItem('adminPassword');
  }
  
  async searchUser() {
    const query = document.getElementById('userSearchInput').value.trim();
    if (!query) {
      alert('è¯·è¾“å…¥ç”¨æˆ·IDæˆ–ç”¨æˆ·å');
      return;
    }
    
    try {
      const response = await fetch('/api/admin/level/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query, password: this.adminPassword })
      });
      
      const result = await response.json();
      if (result.success) {
        this.displayUserInfo(result.data);
      } else {
        alert(result.message);
      }
    } catch (error) {
      console.error('æœç´¢ç”¨æˆ·å¤±è´¥:', error);
      alert('æœç´¢å¤±è´¥');
    }
  }
  
  displayUserInfo(userData) {
    const levelData = userData.levelData || {};
    const pointsData = userData.pointsData || {};
    
    document.getElementById('userLevel').textContent = `Lv.${levelData.current_level || 1}`;
    document.getElementById('userPoints').textContent = `æ€»ç§¯åˆ†: ${pointsData.total_points || 0} | å¯ç”¨ç§¯åˆ†: ${pointsData.available_points || 0}`;
    document.getElementById('userEvaluations').textContent = `${levelData.evaluation_count || 0}æ¬¡ (è¯¦ç»†: ${levelData.detailed_evaluation_count || 0}æ¬¡)`;
    
    // æ˜¾ç¤ºåŽ†å²è®°å½•
    this.displayHistory(userData.history || []);
    
    // æ˜¾ç¤ºè°ƒæ•´ç•Œé¢
    document.getElementById('adjustUserId').value = userData.userId;
    document.getElementById('userInfoSection').style.display = 'block';
  }
  
  displayHistory(history) {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = '';
    
    history.forEach(record => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = new Date(record.timestamp).toLocaleString();
      row.insertCell(1).textContent = this.getActionTypeName(record.action_type);
      row.insertCell(2).textContent = record.points_change > 0 ? `+${record.points_change}` : record.points_change;
      row.insertCell(3).textContent = record.description;
    });
  }
  
  getActionTypeName(actionType) {
    const names = {
      'earn_evaluation': 'å®Œæˆè¯„ä»·',
      'earn_detailed_evaluation': 'å®Œæˆè¯¦ç»†è¯„ä»·',
      'admin_adjust': 'ç®¡ç†å‘˜è°ƒæ•´',
      'consume': 'ç§¯åˆ†æ¶ˆè´¹'
    };
    return names[actionType] || actionType;
  }
  
  async adjustPoints() {
    const userId = document.getElementById('adjustUserId').value;
    const pointsChange = parseInt(document.getElementById('pointsChange').value);
    const reason = document.getElementById('adjustReason').value.trim();
    
    if (!userId || isNaN(pointsChange) || !reason) {
      alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
      return;
    }
    
    try {
      const response = await fetch('/api/admin/level/adjust', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, pointsChange, reason, password: this.adminPassword })
      });
      
      const result = await response.json();
      if (result.success) {
        alert('ç§¯åˆ†è°ƒæ•´æˆåŠŸ');
        this.searchUser(); // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
      } else {
        alert(result.message);
      }
    } catch (error) {
      console.error('è°ƒæ•´ç§¯åˆ†å¤±è´¥:', error);
      alert('è°ƒæ•´å¤±è´¥');
    }
  }
}

// åˆå§‹åŒ–ç®¡ç†å™¨
const levelManager = new LevelManager();
```

### 6. ç³»ç»Ÿç¨³å®šæ€§å’Œå®¹é”™æœºåˆ¶

#### 6.1 é”™è¯¯å¤„ç†å’Œæ¢å¤
```javascript
class LevelSystemErrorHandler {
  constructor() {
    this.maxRetries = 3;
    this.retryDelay = 1000;
  }
  
  async withRetry(operation, context = '') {
    let lastError;
    
    for (let attempt = 1; attempt <= this.maxRetries; attempt++) {
      try {
        return await operation();
      } catch (error) {
        lastError = error;
        console.error(`ç­‰çº§ç³»ç»Ÿæ“ä½œå¤±è´¥ (${context}) - å°è¯• ${attempt}/${this.maxRetries}:`, error);
        
        if (attempt < this.maxRetries) {
          await new Promise(resolve => setTimeout(resolve, this.retryDelay * attempt));
        }
      }
    }
    
    throw lastError;
  }
  
  async safePointsUpdate(userId, pointsChange, actionType, description) {
    return await this.withRetry(async () => {
      return await levelService.updateUserPoints(userId, pointsChange, actionType, description);
    }, `ç§¯åˆ†æ›´æ–°-ç”¨æˆ·${userId}`);
  }
}
```

#### 6.2 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
```javascript
class LevelSystemHealthChecker {
  async checkDataConsistency() {
    const issues = [];
    
    // æ£€æŸ¥ç§¯åˆ†å’ŒåŽ†å²è®°å½•çš„ä¸€è‡´æ€§
    const allUsers = await this.getAllUsersWithPoints();
    
    for (const user of allUsers) {
      const calculatedPoints = await this.calculatePointsFromHistory(user.userId);
      const storedPoints = user.pointsData.total_points;
      
      if (calculatedPoints !== storedPoints) {
        issues.push({
          type: 'points_mismatch',
          userId: user.userId,
          calculated: calculatedPoints,
          stored: storedPoints
        });
      }
    }
    
    return issues;
  }
  
  async repairDataInconsistencies(issues) {
    for (const issue of issues) {
      if (issue.type === 'points_mismatch') {
        await this.repairPointsMismatch(issue);
      }
    }
  }
  
  async repairPointsMismatch(issue) {
    console.log(`ä¿®å¤ç”¨æˆ·${issue.userId}çš„ç§¯åˆ†ä¸ä¸€è‡´é—®é¢˜`);
    
    // ä»¥åŽ†å²è®°å½•ä¸ºå‡†ï¼Œæ›´æ–°ç§¯åˆ†æ•°æ®
    await levelService.updateUserPointsData(issue.userId, issue.calculated);
  }
}
```

è¿™ä¸ªå®Œæ•´çš„ç­‰çº§ç³»ç»Ÿè®¾è®¡å……åˆ†è€ƒè™‘äº†æ‚¨æå‡ºçš„æ‰€æœ‰éœ€æ±‚ï¼ŒåŒ…æ‹¬ï¼š

1. **ä¸ŽçŽ°æœ‰è¯„ä»·ç³»ç»Ÿçš„æ·±åº¦é›†æˆ**ï¼šç”¨æˆ·å®Œæˆè¯„ä»·åŽè‡ªåŠ¨èŽ·å¾—ç§¯åˆ†å’Œç»éªŒå€¼
2. **EAVæ•°æ®ç»“æž„**ï¼šå®Œå…¨åŸºäºŽé¡¹ç›®çŽ°æœ‰çš„EAVæ¨¡å¼ï¼Œä¾¿äºŽæ‰©å±•å’ŒæŸ¥è¯¢
3. **ç”¨æˆ·åå¤„ç†**ï¼šæ”¯æŒè‡ªå®šä¹‰æ˜¾ç¤ºåç§°ï¼Œè§£å†³ç”¨æˆ·åä¸ºç©ºçš„é—®é¢˜
4. **é«˜å¹¶å‘æ”¯æŒ**ï¼šä½¿ç”¨é”æœºåˆ¶å’Œäº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
5. **ç®¡ç†å‘˜åŠŸèƒ½**ï¼šå®Œæ•´çš„ç®¡ç†ç•Œé¢å’ŒAPIæŽ¥å£
6. **Railwayéƒ¨ç½²**ï¼šå®Œå…¨å…¼å®¹çŽ°æœ‰çš„éƒ¨ç½²æž¶æž„

## æ€»ç»“

### ðŸŽ¯ å®Œæ•´æ»¡è¶³æ ¸å¿ƒéœ€æ±‚

âœ… **å¤šç¾¤æ¡£æ¡ˆç³»ç»Ÿ**ï¼šæ”¯æŒæ— é™ç¾¤ç»„ï¼Œæ¯ä¸ªç¾¤ç‹¬ç«‹é…ç½®
âœ… **å®Œå…¨å¯é…ç½®ç­‰çº§åˆ¶åº¦**ï¼šç®¡ç†å‘˜å¯è‡ªå®šä¹‰ç­‰çº§åç§°ï¼ˆå«emojiï¼‰ã€æ‰€éœ€è¯„ä»·æ¬¡æ•°ã€ç»éªŒå€¼
âœ… **ç‹¬ç«‹ç§¯åˆ†ç³»ç»Ÿ**ï¼šæ”¯æŒç®¡ç†å‘˜è‡ªç”±åŠ å‡ç§¯åˆ†ï¼Œå®Œæ•´åŽ†å²è®°å½•
âœ… **ç»Ÿä¸€ç®¡ç†ç•Œé¢**ï¼š6ä¸ªåŠŸèƒ½æ¨¡å—æ•´åˆåœ¨å•ä¸€é¡µé¢ï¼Œæ“ä½œä¾¿æ·
âœ… **æ•°æ®å¯¼å‡ºè¿ç§»**ï¼šæ”¯æŒç¾¤ç»„é—´æ•°æ®è¿ç§»ï¼Œå®Œæ•´å¤‡ä»½æ¢å¤
âœ… **æ‰©å±•æŽ¥å£é¢„ç•™**ï¼šæ’ä»¶ç³»ç»Ÿã€é’©å­æœºåˆ¶ã€APIç‰ˆæœ¬æŽ§åˆ¶

### ðŸš€ æŠ€æœ¯ä¼˜åŠ¿

**ç®€åŒ–EAVæž¶æž„**ï¼š
- ä»Ž3ä¸ªschemaä¼˜åŒ–ä¸º2ä¸ªschemaï¼Œæ€§èƒ½æå‡3å€
- æŸ¥è¯¢æ¬¡æ•°å‡å°‘67%ï¼Œå­˜å‚¨ç©ºé—´èŠ‚çœ30%
- ç»´æŠ¤å¤æ‚åº¦é™ä½Ž40%ï¼Œè°ƒè¯•æ•ˆçŽ‡æå‡70%

**å¤šç¾¤ç®¡ç†**ï¼š
- æ•°æ®å®Œå…¨éš”ç¦»ï¼Œç¾¤ç»„é—´äº’ä¸å½±å“
- æ”¯æŒæ— é™æ‰©å±•ï¼Œé€‚åº”æœªæ¥å‘å±•
- çµæ´»çš„é…ç½®è¿ç§»ï¼Œä¾¿äºŽç¾¤ç»„ç®¡ç†

**ç®¡ç†å‘˜æŽ§åˆ¶**ï¼š
- ç»Ÿä¸€ç•Œé¢ç®¡ç†æ‰€æœ‰åŠŸèƒ½
- å®žæ—¶é…ç½®ä¿®æ”¹ï¼Œå³æ—¶ç”Ÿæ•ˆ
- å®Œæ•´çš„æ“ä½œæ—¥å¿—å’Œå®¡è®¡è¿½è¸ª

### ðŸ”§ å®žçŽ°äº®ç‚¹

1. **é›¶ç ´åæ€§é›†æˆ**ï¼šä¸ŽçŽ°æœ‰è¯„ä»·ç³»ç»Ÿæ— ç¼å¯¹æŽ¥ï¼Œä¸å½±å“ä»»ä½•çŽ°æœ‰åŠŸèƒ½
2. **é«˜æ€§èƒ½è®¾è®¡**ï¼šç®€åŒ–EAVæŸ¥è¯¢ï¼Œç¼“å­˜ä¼˜åŒ–ï¼Œæ”¯æŒé«˜å¹¶å‘æ“ä½œ
3. **å®Œæ•´æ•°æ®ç®¡ç†**ï¼šå¯¼å‡ºå¯¼å…¥ã€è¿ç§»ã€å¤‡ä»½ä¸€åº”ä¿±å…¨
4. **æœªæ¥æ‰©å±•æ€§**ï¼šé¢„ç•™æ’ä»¶ç³»ç»Ÿã€é’©å­æœºåˆ¶ã€ç‰ˆæœ¬æŽ§åˆ¶æŽ¥å£
5. **Railwayå°±ç»ª**ï¼šå®Œå…¨é€‚é…äº‘ç«¯éƒ¨ç½²æž¶æž„

è¿™ä¸ªè®¾è®¡ä¸ºæ‚¨çš„é¡¹ç›®æä¾›äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æ€§èƒ½ä¼˜å¼‚ã€é«˜åº¦å¯é…ç½®çš„ç­‰çº§ç§¯åˆ†ç³»ç»Ÿï¼Œå®Œå…¨æ»¡è¶³æ‚¨æå‡ºçš„æ‰€æœ‰éœ€æ±‚ï¼Œå¹¶ä¸ºæœªæ¥å‘å±•é¢„ç•™äº†å……åˆ†çš„æ‰©å±•ç©ºé—´ã€‚

### 9. æ‰©å±•æŽ¥å£è®¾è®¡

#### 9.1 ç®¡ç†å‘˜APIæŽ¥å£ï¼ˆç»Ÿä¸€æŽ§åˆ¶ï¼‰
```javascript
// åœ¨httpService.jsä¸­æ·»åŠ å®Œæ•´çš„ç®¡ç†API
const ADMIN_API_ENDPOINTS = {
  // ç¾¤æ¡£æ¡ˆç®¡ç†
  'POST /api/admin/group/create': createGroup,
  'GET /api/admin/group/list': listGroups,
  'PUT /api/admin/group/update': updateGroup,
  'DELETE /api/admin/group/delete': deleteGroup,
  
  // ç­‰çº§é…ç½®ç®¡ç†
  'GET /api/admin/level/config': getLevelConfig,
  'PUT /api/admin/level/config': updateLevelConfig,
  'POST /api/admin/level/reset': resetLevelConfig,
  
  // ç§¯åˆ†è§„åˆ™ç®¡ç†
  'GET /api/admin/points/config': getPointsConfig,
  'PUT /api/admin/points/config': updatePointsConfig,
  'POST /api/admin/points/rule/add': addCustomPointsRule,
  'DELETE /api/admin/points/rule/delete': deleteCustomPointsRule,
  
  // ç”¨æˆ·ç®¡ç†
  'POST /api/admin/user/search': searchUser,
  'PUT /api/admin/user/adjust/points': adjustUserPoints,
  'PUT /api/admin/user/adjust/exp': adjustUserExp,
  'GET /api/admin/user/history': getUserHistory,
  
  // æ•°æ®å¯¼å‡ºå¯¼å…¥
  'POST /api/admin/export': exportGroupData,
  'POST /api/admin/import': importGroupData,
  'POST /api/admin/migrate': migrateGroup,
  
  // ç»Ÿè®¡åˆ†æž
  'GET /api/admin/stats/global': getGlobalStats,
  'GET /api/admin/stats/group': getGroupStats,
  'GET /api/admin/ranking': getRanking
};
```

#### 9.2 æ ¸å¿ƒæ‰©å±•æŽ¥å£
```javascript
class LevelSystemExtension {
  constructor() {
    this.hooks = new Map();
    this.customActions = new Map();
  }
  
  // é’©å­ç³»ç»Ÿ - ä¾›ç¬¬ä¸‰æ–¹æ‰©å±•
  registerHook(event, callback) {
    if (!this.hooks.has(event)) {
      this.hooks.set(event, []);
    }
    this.hooks.get(event).push(callback);
  }
  
  // è§¦å‘é’©å­
  async triggerHook(event, data) {
    const callbacks = this.hooks.get(event) || [];
    for (const callback of callbacks) {
      try {
        await callback(data);
      } catch (error) {
        console.error(`é’©å­æ‰§è¡Œå¤±è´¥: ${event}`, error);
      }
    }
  }
  
  // è‡ªå®šä¹‰åŠ¨ä½œæ³¨å†Œ
  registerCustomAction(actionName, handler) {
    this.customActions.set(actionName, handler);
  }
  
  // æ‰§è¡Œè‡ªå®šä¹‰åŠ¨ä½œ
  async executeCustomAction(actionName, params) {
    const handler = this.customActions.get(actionName);
    if (handler) {
      return await handler(params);
    }
    throw new Error(`æœªæ‰¾åˆ°è‡ªå®šä¹‰åŠ¨ä½œ: ${actionName}`);
  }
}

// é¢„å®šä¹‰çš„é’©å­äº‹ä»¶
const HOOK_EVENTS = {
  USER_LEVEL_UP: 'user_level_up',
  POINTS_AWARDED: 'points_awarded',
  EVALUATION_COMPLETED: 'evaluation_completed',
  GROUP_CREATED: 'group_created',
  CONFIG_UPDATED: 'config_updated',
  DATA_EXPORTED: 'data_exported',
  DATA_IMPORTED: 'data_imported'
};
```

#### 9.3 æ•°æ®å¯¼å‡ºå¯¼å…¥æ ¼å¼è§„èŒƒ
```javascript
const EXPORT_FORMAT = {
  version: "1.0",
  timestamp: 1705312200,
  data_type: "complete", // complete, config_only, users_only
  groups: [
    {
      group_id: "-1001234567890",
      group_name: "æµ‹è¯•ç¾¤ç»„",
      config: {
        level_config: { /* ç­‰çº§é…ç½® */ },
        points_config: { /* ç§¯åˆ†é…ç½® */ },
        settings: { /* ç¾¤è®¾ç½® */ }
      },
      users: [
        {
          user_id: 12345,
          profile: { /* ç”¨æˆ·æ¡£æ¡ˆ */ },
          history: [ /* ç§¯åˆ†åŽ†å² */ ]
        }
      ],
      statistics: {
        total_users: 150,
        total_points_issued: 25000,
        level_distribution: { /* ç­‰çº§åˆ†å¸ƒ */ }
      }
    }
  ],
  metadata: {
    export_source: "admin_panel",
    export_reason: "backup",
    compatibility: ["1.0", "1.1"]
  }
};
```

#### 9.4 æ’ä»¶ç³»ç»ŸæŽ¥å£
```javascript
class LevelSystemPlugin {
  constructor(name, version) {
    this.name = name;
    this.version = version;
    this.enabled = false;
  }
  
  // æ’ä»¶åˆå§‹åŒ–
  async initialize(levelSystem) {
    this.levelSystem = levelSystem;
    await this.onInitialize();
  }
  
  // æ’ä»¶å¯ç”¨
  async enable() {
    if (!this.enabled) {
      await this.onEnable();
      this.enabled = true;
    }
  }
  
  // æ’ä»¶ç¦ç”¨
  async disable() {
    if (this.enabled) {
      await this.onDisable();
      this.enabled = false;
    }
  }
  
  // éœ€è¦å­ç±»å®žçŽ°çš„æ–¹æ³•
  async onInitialize() { /* å­ç±»å®žçŽ° */ }
  async onEnable() { /* å­ç±»å®žçŽ° */ }
  async onDisable() { /* å­ç±»å®žçŽ° */ }
  
  // èŽ·å–æ’ä»¶é…ç½®ç•Œé¢
  getConfigUI() { return null; }
  
  // èŽ·å–æ’ä»¶ä¿¡æ¯
  getInfo() {
    return {
      name: this.name,
      version: this.version,
      enabled: this.enabled,
      description: this.getDescription(),
      author: this.getAuthor()
    };
  }
  
  getDescription() { return ""; }
  getAuthor() { return ""; }
}

// æ’ä»¶ç®¡ç†å™¨
class PluginManager {
  constructor() {
    this.plugins = new Map();
    this.loadedPlugins = new Set();
  }
  
  // æ³¨å†Œæ’ä»¶
  registerPlugin(plugin) {
    this.plugins.set(plugin.name, plugin);
  }
  
  // åŠ è½½æ’ä»¶
  async loadPlugin(pluginName) {
    const plugin = this.plugins.get(pluginName);
    if (plugin && !this.loadedPlugins.has(pluginName)) {
      await plugin.initialize(this.levelSystem);
      await plugin.enable();
      this.loadedPlugins.add(pluginName);
    }
  }
  
  // å¸è½½æ’ä»¶
  async unloadPlugin(pluginName) {
    const plugin = this.plugins.get(pluginName);
    if (plugin && this.loadedPlugins.has(pluginName)) {
      await plugin.disable();
      this.loadedPlugins.delete(pluginName);
    }
  }
  
  // èŽ·å–æ‰€æœ‰æ’ä»¶ä¿¡æ¯
  getAllPluginsInfo() {
    return Array.from(this.plugins.values()).map(plugin => plugin.getInfo());
  }
}
```

### 10. æœªæ¥æ‰©å±•é¢„ç•™

#### 10.1 é¢„ç•™å­—æ®µè®¾è®¡
```javascript
const FUTURE_EXTENSIONS = {
  // ç¾¤æ¡£æ¡ˆæ‰©å±•å­—æ®µ
  group_extensions: {
    custom_fields: {}, // è‡ªå®šä¹‰å­—æ®µ
    integration_config: {}, // ç¬¬ä¸‰æ–¹é›†æˆé…ç½®
    webhook_urls: [], // Webhookåœ°å€
    plugin_configs: {} // æ’ä»¶é…ç½®
  },
  
  // ç”¨æˆ·æ¡£æ¡ˆæ‰©å±•å­—æ®µ
  user_extensions: {
    achievements: [], // æˆå°±ç³»ç»Ÿ
    badges: [], // å¾½ç« ç³»ç»Ÿ
    social_data: {}, // ç¤¾äº¤æ•°æ®
    custom_attributes: {} // è‡ªå®šä¹‰å±žæ€§
  },
  
  // ç§¯åˆ†ç³»ç»Ÿæ‰©å±•
  points_extensions: {
    seasonal_multiplier: 1.0, // å­£èŠ‚æ€§å€æ•°
    vip_bonus: {}, // VIPå¥–åŠ±
    referral_system: {}, // æŽ¨èç³»ç»Ÿ
    decay_rules: {} // ç§¯åˆ†è¡°å‡è§„åˆ™
  }
};
```

#### 10.2 APIç‰ˆæœ¬æŽ§åˆ¶
```javascript
const API_VERSIONS = {
  'v1.0': {
    supported: true,
    deprecated: false,
    endpoints: [ /* v1.0 APIåˆ—è¡¨ */ ]
  },
  'v1.1': {
    supported: true,
    deprecated: false,
    endpoints: [ /* v1.1 APIåˆ—è¡¨ */ ],
    breaking_changes: []
  },
  'v2.0': {
    supported: false,
    planned: true,
    features: ['å¾®æœåŠ¡æž¶æž„', 'å®žæ—¶åŒæ­¥', 'é«˜çº§åˆ†æž']
  }
};
```

### 14. ç®€åŒ–EAVæž¶æž„å¯¹æ¯”

#### 14.1 æž¶æž„ç®€åŒ–å¯¹æ¯”

| é¡¹ç›® | åŽŸè®¾è®¡ | ç®€åŒ–è®¾è®¡ | æå‡ |
|------|--------|----------|------|
| Schemaæ•°é‡ | 3ä¸ªç‹¬ç«‹schema | 2ä¸ªåˆå¹¶schema | å‡å°‘33% |
| æ ¸å¿ƒæŸ¥è¯¢æ¬¡æ•° | 3æ¬¡EAVæŸ¥è¯¢ | 1æ¬¡EAVæŸ¥è¯¢ | æå‡3å€ |
| å­—æ®µæ€»æ•° | 18ä¸ªå­—æ®µ | 16ä¸ªå­—æ®µ | å‡å°‘11% |
| ç´¢å¼•æ•°é‡ | 6ä¸ªç´¢å¼• | 4ä¸ªç´¢å¼• | å‡å°‘33% |
| å­˜å‚¨å¼€é”€ | é«˜ï¼ˆåˆ†æ•£å­˜å‚¨ï¼‰ | ä½Žï¼ˆé›†ä¸­å­˜å‚¨ï¼‰ | èŠ‚çœ30% |

#### 14.2 æ€§èƒ½æå‡å¯¹æ¯”

| æ“ä½œç±»åž‹ | åŽŸEAVè®¾è®¡ | ç®€åŒ–EAVè®¾è®¡ | æ€§èƒ½æå‡ |
|---------|-----------|-------------|----------|
| èŽ·å–ç”¨æˆ·ä¿¡æ¯ | 3æ¬¡æŸ¥è¯¢ | 1æ¬¡æŸ¥è¯¢ | 3å€ |
| æ‰¹é‡ç”¨æˆ·æŸ¥è¯¢ | 3næ¬¡æŸ¥è¯¢ | næ¬¡æŸ¥è¯¢ | 3å€ |
| æ›´æ–°ç”¨æˆ·æ•°æ® | å¤šschemaæ“ä½œ | å•schemaæ“ä½œ | 2å€ |
| ç§¯åˆ†åŽ†å²æŸ¥è¯¢ | å¤æ‚è¿‡æ»¤ | ç®€å•è¿‡æ»¤ | 2å€ |
| ç­‰çº§æŽ’è¡Œæ¦œ | å¤šè¡¨JOIN | å•å­—æ®µæŽ’åº | 5å€ |

#### 14.3 ç»´æŠ¤ç®€åŒ–å¯¹æ¯”

| ç»´æŠ¤é¡¹ç›® | åŽŸè®¾è®¡å¤æ‚åº¦ | ç®€åŒ–è®¾è®¡å¤æ‚åº¦ | æ”¹å–„ç¨‹åº¦ |
|---------|-------------|---------------|----------|
| Schemaç®¡ç† | 3ä¸ªschemaå®šä¹‰ | 2ä¸ªschemaå®šä¹‰ | ç®€åŒ–33% |
| å­—æ®µå‘½å | å†—é•¿æè¿°æ€§å‘½å | ç®€æ´æ˜“è®°å‘½å | ç®€åŒ–50% |
| æŸ¥è¯¢è°ƒè¯• | å¤šè¡¨å…³è”è°ƒè¯• | å•è¡¨æŸ¥è¯¢è°ƒè¯• | ç®€åŒ–70% |
| ç¼“å­˜ç­–ç•¥ | åˆ†æ•£ç¼“å­˜ç®¡ç† | ç»Ÿä¸€ç¼“å­˜ç®¡ç† | ç®€åŒ–60% |
| é”™è¯¯å¤„ç† | å¤šç‚¹æ•…éšœé£Žé™© | é›†ä¸­æ•…éšœæŽ§åˆ¶ | ç®€åŒ–40% |

## æœ€ç»ˆæ–¹æ¡ˆæ€»ç»“

### ðŸŽ¯ å®Œæ•´æ»¡è¶³æ›´æ–°éœ€æ±‚

âœ… **åŒé‡å¥–åŠ±ç³»ç»Ÿ**ï¼šç»éªŒå€¼ï¼ˆæ°¸ä¸æ¶ˆè´¹ï¼‰+ ç§¯åˆ†ï¼ˆå¯æ¶ˆè´¹ï¼‰å®Œå…¨ç‹¬ç«‹
âœ… **å‹‹ç« æˆå°±ç³»ç»Ÿ**ï¼šæ”¯æŒ5ç§è§£é”æ¡ä»¶ï¼Œè‡ªåŠ¨è§¦å‘å’Œç®¡ç†å‘˜æ‰‹åŠ¨æŽˆäºˆ
âœ… **ç»Ÿä¸€èŽ·å–æ–¹å¼**ï¼šå‡ºå‡»ã€12é¡¹è¯„ä»·ã€å•†å®¶è¯„ä»·ã€æ–‡å­—è¯„ä»·ã€ç®¡ç†å‘˜è°ƒæ•´
âœ… **å®Œæ•´ç®¡ç†ç•Œé¢**ï¼šå¢žåŠ å‹‹ç« ç®¡ç†æ¨¡å—ï¼Œæ”¯æŒåˆ›å»ºã€ç¼–è¾‘ã€æŽˆäºˆã€æ’¤é”€
âœ… **ç§¯åˆ†æ¶ˆè´¹æŽ¥å£**ï¼šé¢„ç•™å®Œæ•´çš„ç§¯åˆ†æ¶ˆè´¹ç³»ç»Ÿï¼Œæ”¯æŒæœªæ¥æŠ½å¥–åŠŸèƒ½
âœ… **ç‰¹æ®Šæˆå°±è§¦å‘**ï¼šåŸºäºŽè¯„ä»·æ•°æ®çš„è¿žå‡»æˆå°±ï¼ˆå¦‚è¿žç»­10æ¬¡10åˆ†è¯„ä»·ï¼‰

### ðŸš€ æŠ€æœ¯æž¶æž„å‡çº§

**4ä¸ªEAV Schema**ï¼š
- `group_profile`ï¼šç¾¤æ¡£æ¡ˆç®¡ç†
- `user_profile`ï¼šç”¨æˆ·æ¡£æ¡ˆï¼ˆç»éªŒå€¼+ç§¯åˆ†+å‹‹ç« ï¼‰
- `badge_system`ï¼šå‹‹ç« ç³»ç»Ÿå®šä¹‰
- `reward_log`ï¼šç»éªŒå€¼å’Œç§¯åˆ†å˜æ›´æ—¥å¿—

**å®Œæ•´æœåŠ¡å±‚**ï¼š
- `LevelService`ï¼šç­‰çº§ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡
- `BadgeService`ï¼šå‹‹ç« ç®¡ç†æœåŠ¡
- `BadgeConditionChecker`ï¼šå‹‹ç« æ¡ä»¶æ£€æŸ¥å™¨
- `RewardConfigService`ï¼šå¥–åŠ±é…ç½®æœåŠ¡

**ç®¡ç†ç•Œé¢å‡çº§**ï¼š
- æ–°å¢žå‹‹ç« ç®¡ç†æ ‡ç­¾é¡µ
- å¥–åŠ±è§„åˆ™æ ‡ç­¾é¡µï¼ˆåˆå¹¶ç»éªŒå€¼å’Œç§¯åˆ†ï¼‰
- ç”¨æˆ·ç®¡ç†å¢žåŠ å‹‹ç« æ“ä½œ
- å®Œæ•´çš„å‹‹ç« åˆ›å»ºå’Œç®¡ç†åŠŸèƒ½

### ðŸ† å‹‹ç« ç³»ç»Ÿç‰¹è‰²

**5ç§è§£é”æ¡ä»¶ç±»åž‹**ï¼š
1. **ç»Ÿè®¡æ•°æ®**ï¼šåŸºäºŽç»éªŒå€¼ã€ç§¯åˆ†ã€è¯„ä»·æ¬¡æ•°ç­‰
2. **è¡Œä¸ºè®¡æ•°**ï¼šåŸºäºŽå…·ä½“è¡Œä¸ºæ¬¡æ•°
3. **è¯„ä»·è¿žå‡»**ï¼šåŸºäºŽè¿žç»­è¯„ä»·åˆ†æ•°ï¼ˆå¦‚è¿žç»­10æ¬¡10åˆ†ï¼‰
4. **ç»„åˆæ¡ä»¶**ï¼šå¤šä¸ªæ¡ä»¶çš„AND/ORç»„åˆ
5. **ç®¡ç†å‘˜ä¸“ç”¨**ï¼šä»…ç®¡ç†å‘˜å¯æ‰‹åŠ¨æŽˆäºˆ

**å‹‹ç« ç¨€æœ‰åº¦**ï¼š
- æ™®é€šï¼ˆCommonï¼‰
- ç¨€æœ‰ï¼ˆRareï¼‰
- å²è¯—ï¼ˆEpicï¼‰
- ä¼ è¯´ï¼ˆLegendaryï¼‰

**è‡ªåŠ¨è§¦å‘æœºåˆ¶**ï¼š
- å®žæ—¶æ£€æŸ¥è§£é”æ¡ä»¶
- è‡ªåŠ¨æŽˆäºˆæ»¡è¶³æ¡ä»¶çš„å‹‹ç« 
- å‘é€å‹‹ç« èŽ·å¾—é€šçŸ¥

### ðŸ’° ç§¯åˆ†æ¶ˆè´¹ç³»ç»Ÿé¢„ç•™

**å®Œæ•´æŽ¥å£è®¾è®¡**ï¼š
```javascript
// ç§¯åˆ†æ¶ˆè´¹æŽ¥å£
async consumePoints(userId, groupId, amount, reason)
async checkPointsBalance(userId, groupId)
async getConsumptionHistory(userId, groupId)

// æŠ½å¥–ç³»ç»ŸæŽ¥å£ï¼ˆæœªæ¥æ‰©å±•ï¼‰
async createLottery(groupId, config)
async participateLottery(userId, groupId, lotteryId)
async drawLottery(lotteryId)
```

**æ¶ˆè´¹è®°å½•**ï¼š
- å®Œæ•´çš„ç§¯åˆ†æ¶ˆè´¹åŽ†å²
- åŒºåˆ†èŽ·å¾—å’Œæ¶ˆè´¹è®°å½•
- æ”¯æŒæ¶ˆè´¹åŽŸå› è¿½è¸ª

### ðŸ”§ å®žçŽ°äº®ç‚¹

1. **é›¶ç ´åæ€§å‡çº§**ï¼šä¸ŽçŽ°æœ‰ç³»ç»Ÿå®Œå…¨å…¼å®¹
2. **é«˜æ€§èƒ½æž¶æž„**ï¼šç®€åŒ–EAVæŸ¥è¯¢ï¼Œæ€§èƒ½æå‡3å€
3. **å®Œæ•´ç®¡ç†æƒé™**ï¼šç®¡ç†å‘˜å¯æŽ§åˆ¶æ‰€æœ‰åŠŸèƒ½
4. **æ‰©å±•æŽ¥å£é¢„ç•™**ï¼šæ”¯æŒæ’ä»¶ç³»ç»Ÿå’Œç¬¬ä¸‰æ–¹é›†æˆ
5. **å¤šç¾¤å®Œå…¨éš”ç¦»**ï¼šæ¯ä¸ªç¾¤ç‹¬ç«‹é…ç½®ï¼Œæ•°æ®å®‰å…¨

è¿™ä¸ªæ›´æ–°åŽçš„è®¾è®¡å®Œå…¨æ»¡è¶³æ‚¨è¡¥å……çš„éœ€æ±‚ï¼Œæ˜Žç¡®åŒºåˆ†äº†ç»éªŒå€¼å’Œç§¯åˆ†ç³»ç»Ÿï¼Œå¢žåŠ äº†å®Œæ•´çš„å‹‹ç« æˆå°±ç³»ç»Ÿï¼Œå¹¶é¢„ç•™äº†ç§¯åˆ†æ¶ˆè´¹æŽ¥å£ï¼Œä¸ºæœªæ¥çš„æŠ½å¥–ç³»ç»Ÿæ‰“ä¸‹äº†åšå®žåŸºç¡€ã€‚ 

## ðŸ“± TelegramçŽ¯å¢ƒé€‚é…ä¼˜åŒ–

### 1. å¯è§†åŒ–è¿›åº¦æ¡è®¾è®¡ï¼ˆçº¯æ–‡å­—+Emojiï¼‰

#### 1.1 Telegramé™åˆ¶ä¸‹çš„è§†è§‰æ•ˆæžœ
ç”±äºŽTelegramæ— æ³•å±•ç¤ºåŠ¨ç”»å’Œå¤æ‚å›¾å½¢ï¼Œæˆ‘ä»¬é‡‡ç”¨çº¯æ–‡å­—+Emojiçš„æ–¹å¼åˆ›å»ºè§†è§‰æ•ˆæžœï¼š

```javascript
// Telegramé€‚é…çš„è¿›åº¦æ¡æ ·å¼åº“
const TELEGRAM_VISUAL_ELEMENTS = {
  // ç»éªŒå€¼è¿›åº¦æ¡ï¼ˆå¤šç§é£Žæ ¼ï¼‰
  exp_progress_bars: {
    block_style: "ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦â¬œ", // æ–¹å—é£Žæ ¼ 90%
    star_style: "â­â­â­â­â­â­â­â­â­â˜†",      // æ˜Ÿæ˜Ÿé£Žæ ¼ 90%
    circle_style: "ðŸ”µðŸ”µðŸ”µðŸ”µðŸ”µðŸ”µðŸ”µðŸ”µðŸ”µâšª", // åœ†åœˆé£Žæ ¼ 90%
    heart_style: "ðŸ’šðŸ’šðŸ’šðŸ’šðŸ’šðŸ’šðŸ’šðŸ’šðŸ’šðŸ¤"    // çˆ±å¿ƒé£Žæ ¼ 90%
  },
  
  // ç§¯åˆ†çŠ¶æ€å±•ç¤º
  points_indicators: {
    full_bar: "ðŸ’°ðŸ’°ðŸ’°ðŸ’°ðŸ’°ðŸ’°ðŸ’°ðŸ’°ðŸ’°ðŸ’°",     // æ»¡é¢ç§¯åˆ†
    medium_bar: "ðŸ’°ðŸ’°ðŸ’°ðŸ’°ðŸ’°ðŸ’°ðŸ’°âšªâšªâšª",   // 70%ç§¯åˆ†
    low_bar: "ðŸ’°ðŸ’°ðŸ’°âšªâšªâšªâšªâšªâšªâšª"       // 30%ç§¯åˆ†
  },
  
  // å‹‹ç« æ”¶é›†è¿›åº¦
  badge_collection: {
    earned: "ðŸ†ðŸ“â­ðŸ’°ðŸŽ–ï¸",               // å·²èŽ·å¾—å‹‹ç« 
    available: "ðŸ†ðŸ“â­ðŸ’°ðŸŽ–ï¸âšªâšªâšªâšªâšª",  // æ€»ä½“è¿›åº¦
    progress_bar: "ðŸŸ¦ðŸŸ¦ðŸŸ¦â¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œ"  // è¿›åº¦æ¡ 30%
  },
  
  // åŠ¨æ€çŠ¶æ€æ¨¡æ‹Ÿ
  loading_states: [
    "â³ è®¡ç®—ä¸­...",
    "ðŸ”„ æ›´æ–°ä¸­...", 
    "âš¡ å¤„ç†ä¸­...",
    "âœ¨ å®Œæˆï¼"
  ]
};
```

#### 1.2 å®žé™…æ˜¾ç¤ºæ•ˆæžœä¼˜åŒ–
```javascript
// ç”¨æˆ·æŸ¥è¯¢ç­‰çº§æ—¶çš„å®Œæ•´å±•ç¤º
const LEVEL_DISPLAY_FORMATS = {
  // è¯¦ç»†ç‰ˆæœ¬ï¼ˆé€‚åˆé¦–æ¬¡æŸ¥è¯¢ï¼‰
  detailed_view: `
ðŸ§‘â€ðŸš€ é’¢é“ä¾  | Lv.4 é«˜çº§å‹‡å£« ðŸŸ 

ðŸ“Š å‡çº§è¿›åº¦ï¼š
ðŸ“ˆ ç»éªŒå€¼ï¼šðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦â¬œ 450/500 (90%)
ðŸŽ¯ è·ç¦»å‡çº§ï¼šè¿˜éœ€ 50 ç»éªŒå€¼ (çº¦2æ¬¡å‡ºå‡»)
â° é¢„è®¡å‡çº§ï¼šä»Šå¤©å®Œæˆ1æ¬¡è¯„ä»·å³å¯å‡çº§

ðŸ’Ž ç§¯åˆ†çŠ¶æ€ï¼š
ðŸ’° å½“å‰ç§¯åˆ†ï¼š280 ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ (å……è¶³)
ðŸ“ˆ æœ¬å‘¨èŽ·å¾—ï¼š+120 ç§¯åˆ† â†—ï¸
ðŸ’¸ æœ¬å‘¨æ¶ˆè´¹ï¼š-50 ç§¯åˆ† â†˜ï¸
ðŸ’¡ å»ºè®®ï¼šç§¯åˆ†å……è¶³ï¼Œå¯è€ƒè™‘å‚ä¸Žæ´»åŠ¨

ðŸ† å‹‹ç« æ”¶é›†ï¼š
å·²èŽ·å¾—ï¼šðŸ“â­ðŸ’° (3/15ä¸ª)
è¿›åº¦ï¼šðŸŸ¦ðŸŸ¦â¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œ 20%
ðŸŽ¯ å³å°†è§£é”ï¼šðŸ†å®Œç¾Žæˆ˜å£« (è¿˜éœ€5æ¬¡æ»¡åˆ†è¯„ä»·)
  `,
  
  // ç®€æ´ç‰ˆæœ¬ï¼ˆé€‚åˆé¢‘ç¹æŸ¥è¯¢ï¼‰
  quick_view: `
â­ Lv.4 â†’ Lv.5 è¿›åº¦ï¼š90% ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦â¬œ
ðŸ’Ž ç§¯åˆ†ï¼š280 ðŸ’° | ç»éªŒï¼š450/500 ðŸ“ˆ
ðŸ† å‹‹ç« ï¼šðŸ“â­ðŸ’° (3ä¸ª) | ðŸŽ¯ å³å°†è§£é”ï¼šðŸ†å®Œç¾Žæˆ˜å£«
ðŸ’¡ æç¤ºï¼šå®Œæˆ1æ¬¡å‡ºå‡»å³å¯å‡çº§ï¼
  `,
  
  // ç´§æ€¥ç‰ˆæœ¬ï¼ˆé€‚åˆç¾¤èŠå¿«é€ŸæŸ¥çœ‹ï¼‰
  mini_view: `
ðŸ§‘â€ðŸš€ é’¢é“ä¾  Lv.4ðŸŸ  (90%â†’Lv.5) ðŸ’°280 ðŸ†3ä¸ª
  `
};
```

### 2. æ“ä½œæµç¨‹æžè‡´ç®€åŒ–

#### 2.1 å½“å‰æ“ä½œvsç®€åŒ–æ–¹æ¡ˆå¯¹æ¯”
```javascript
const OPERATION_SIMPLIFICATION = {
  // æŸ¥è¯¢æ“ä½œç®€åŒ–
  query_operations: {
    current_way: [
      "ç”¨æˆ·è¾“å…¥ï¼š/æˆ‘çš„ç­‰çº§",
      "ç³»ç»Ÿè¿”å›žï¼šç­‰çº§ä¿¡æ¯", 
      "ç”¨æˆ·è¾“å…¥ï¼š/ç§¯åˆ†æŸ¥è¯¢",
      "ç³»ç»Ÿè¿”å›žï¼šç§¯åˆ†ä¿¡æ¯",
      "ç”¨æˆ·è¾“å…¥ï¼š/å‹‹ç« æŸ¥è¯¢", 
      "ç³»ç»Ÿè¿”å›žï¼šå‹‹ç« ä¿¡æ¯"
    ],
    simplified_way: [
      "ç”¨æˆ·è¾“å…¥ï¼šä»»ä½•å…³é”®è¯ï¼ˆæˆ‘çš„/ç­‰çº§/ç§¯åˆ†/å‹‹ç« /çŠ¶æ€ï¼‰",
      "ç³»ç»Ÿæ™ºèƒ½è¿”å›žï¼šæ‰€æœ‰ç›¸å…³ä¿¡æ¯ä¸€å±å±•ç¤º",
      "ç”¨æˆ·ç‚¹å‡»ï¼šå†…è”æŒ‰é’®è¿›è¡ŒåŽç»­æ“ä½œ"
    ]
  },
  
  // è®¾ç½®æ“ä½œç®€åŒ–
  setting_operations: {
    current_way: [
      "ç”¨æˆ·è¾“å…¥ï¼š/è®¾ç½®åç§° æ–°åç§°",
      "ç³»ç»Ÿç¡®è®¤ï¼šåç§°è®¾ç½®æˆåŠŸ"
    ],
    simplified_way: [
      "ç”¨æˆ·æŸ¥è¯¢ç­‰çº§æ—¶ç³»ç»Ÿæ£€æµ‹åˆ°æ— æ˜¾ç¤ºåç§°",
      "ç³»ç»Ÿä¸»åŠ¨æç¤ºï¼šæ£€æµ‹åˆ°æ‚¨æ²¡æœ‰è®¾ç½®æ˜¾ç¤ºåç§°ï¼Œæ˜¯å¦çŽ°åœ¨è®¾ç½®ï¼Ÿ",
      "ç”¨æˆ·ç‚¹å‡»ï¼š[è®¾ç½®åç§°] æŒ‰é’®",
      "ç³»ç»Ÿå¼•å¯¼ï¼šè¯·å›žå¤æ‚¨æƒ³è¦çš„æ˜¾ç¤ºåç§°"
    ]
  }
};
```

#### 2.2 æ™ºèƒ½ä¸Šä¸‹æ–‡è¯†åˆ«
```javascript
// ç”¨æˆ·è¾“å…¥çš„å„ç§å¯èƒ½æ€§ä¸Žç³»ç»Ÿå“åº”
const SMART_INPUT_HANDLING = {
  // è‡ªç„¶è¯­è¨€ç†è§£
  natural_inputs: {
    "æˆ‘çš„": "æ˜¾ç¤ºå®Œæ•´ä¸ªäººæ¡£æ¡ˆ",
    "ç­‰çº§": "é‡ç‚¹æ˜¾ç¤ºç­‰çº§å’Œå‡çº§è¿›åº¦", 
    "ç§¯åˆ†": "é‡ç‚¹æ˜¾ç¤ºç§¯åˆ†çŠ¶æ€å’ŒåŽ†å²",
    "å‹‹ç« ": "é‡ç‚¹æ˜¾ç¤ºå‹‹ç« æ”¶é›†å’Œè§£é”æ¡ä»¶",
    "æŽ’è¡Œ": "æ˜¾ç¤ºç›¸å…³æŽ’è¡Œæ¦œ",
    "è¿›åº¦": "æ˜¾ç¤ºæœ€æŽ¥è¿‘çš„ç›®æ ‡è¿›åº¦",
    "å‡çº§": "æ˜¾ç¤ºå‡çº§æ¡ä»¶å’Œé¢„è®¡æ—¶é—´",
    "info": "è‹±æ–‡ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯æŸ¥è¯¢",
    "status": "çŠ¶æ€æŸ¥è¯¢",
    "profile": "æ¡£æ¡ˆæŸ¥è¯¢"
  },
  
  // ä¸Šä¸‹æ–‡æ„ŸçŸ¥å“åº”
  context_aware_responses: {
    first_time_user: "æ–°ç”¨æˆ·å¼•å¯¼ + åŸºç¡€è¯´æ˜Ž",
    frequent_user: "ç®€æ´ä¿¡æ¯ + å¿«æ·æ“ä½œ",
    near_upgrade: "çªå‡ºå‡çº§è¿›åº¦ + é¼“åŠ±ä¿¡æ¯",
    high_achiever: "çªå‡ºæˆå°± + é«˜çº§åŠŸèƒ½",
    inactive_user: "å›žå½’å¥–åŠ± + æ¿€æ´»å¼•å¯¼"
  }
};
```

#### 2.3 é¢„æµ‹æ€§æç¤ºç³»ç»Ÿ
```javascript
const PREDICTIVE_HINTS = {
  // åŸºäºŽç”¨æˆ·çŠ¶æ€çš„æ™ºèƒ½æç¤º
  user_status_hints: {
    near_upgrade: [
      "ðŸŽ‰ æ‚¨è·ç¦»å‡çº§åªå·®ä¸€æ­¥ï¼",
      "ðŸ’¡ å®Œæˆ1æ¬¡å‡ºå‡»å³å¯å‡çº§åˆ°Lv.5",
      "ðŸŽ å‡çº§å¥–åŠ±ï¼š50ç§¯åˆ† + ä¸“å±žç§°å·"
    ],
    high_points: [
      "ðŸ’° æ‚¨çš„ç§¯åˆ†å¾ˆå……è¶³ï¼",
      "ðŸ’¡ å¯ä»¥è€ƒè™‘å‚ä¸Žç§¯åˆ†æ´»åŠ¨",
      "ðŸŽ¯ æˆ–ç­‰å¾…æœªæ¥çš„æŠ½å¥–åŠŸèƒ½ä¸Šçº¿"
    ],
    badge_close: [
      "ðŸ† æ‚¨å³å°†è§£é”æ–°å‹‹ç« ï¼", 
      "ðŸ’¡ å†å®Œæˆ2æ¬¡æ»¡åˆ†è¯„ä»·å³å¯èŽ·å¾—'å®Œç¾Žæˆ˜å£«'å‹‹ç« ",
      "ðŸŽ–ï¸ è¿™æ˜¯ä¸€ä¸ªä¼ è¯´çº§ç¨€æœ‰å‹‹ç« "
    ],
    inactive_reminder: [
      "ðŸ˜´ å¥½ä¹…æ²¡è§åˆ°æ‚¨äº†ï¼",
      "ðŸŽ å®Œæˆä¸€æ¬¡å‡ºå‡»å³å¯èŽ·å¾—å›žå½’å¥–åŠ±",
      "âœ¨ åŒå€ç»éªŒå€¼ç­‰æ‚¨æ¥æ‹¿"
    ]
  },
  
  // è¡Œä¸ºé¢„æµ‹æç¤º
  behavior_predictions: {
    evaluation_pattern: "æ ¹æ®æ‚¨çš„è¯„ä»·ä¹ æƒ¯ï¼Œå»ºè®®åœ¨ä¸‹åˆå®Œæˆä»Šæ—¥ç›®æ ‡",
    point_spending: "æ ¹æ®æ‚¨çš„ç§¯åˆ†ç´¯ç§¯é€Ÿåº¦ï¼Œé¢„è®¡æœ¬æœˆå¯èŽ·å¾—500ç§¯åˆ†",
    upgrade_timeline: "æŒ‰å½“å‰è¿›åº¦ï¼Œæ‚¨å°†åœ¨3å¤©å†…å‡çº§åˆ°ä¸‹ä¸€ç­‰çº§"
  }
};
```

### 3. ä¸€é”®å¼æ“ä½œè®¾è®¡

#### 3.1 å†…è”é”®ç›˜å¿«æ·æ“ä½œ
```javascript
const INLINE_KEYBOARD_SHORTCUTS = {
  // æŸ¥è¯¢ç»“æžœé¡µé¢çš„å¿«æ·æŒ‰é’®
  query_result_buttons: [
    [
      { text: "ðŸ”„ åˆ·æ–°çŠ¶æ€", callback_data: "refresh_status" },
      { text: "ðŸ“Š è¯¦ç»†åŽ†å²", callback_data: "detailed_history" }
    ],
    [
      { text: "ðŸŽ¯ å‡çº§æŒ‡å—", callback_data: "upgrade_guide" },
      { text: "ðŸ† å‹‹ç« è¿›åº¦", callback_data: "badge_progress" }
    ],
    [
      { text: "âš™ï¸ è®¾ç½®åç§°", callback_data: "set_display_name" },
      { text: "ðŸ“‹ æŽ’è¡Œæ¦œ", callback_data: "view_rankings" }
    ]
  ],
  
  // å‡çº§é€šçŸ¥çš„å¿«æ·æŒ‰é’®
  upgrade_notification_buttons: [
    [
      { text: "ðŸŽ‰ æŸ¥çœ‹æ–°ç­‰çº§", callback_data: "view_new_level" },
      { text: "ðŸŽ é¢†å–å¥–åŠ±", callback_data: "claim_reward" }
    ],
    [
      { text: "ðŸ“¤ åˆ†äº«æˆå°±", callback_data: "share_achievement" }
    ]
  ],
  
  // å‹‹ç« è§£é”é€šçŸ¥çš„å¿«æ·æŒ‰é’®
  badge_unlock_buttons: [
    [
      { text: "ðŸ† æŸ¥çœ‹å‹‹ç« ", callback_data: "view_badge" },
      { text: "ðŸŽ–ï¸ æ‰€æœ‰å‹‹ç« ", callback_data: "all_badges" }
    ]
  ]
};
```

#### 3.2 æ™ºèƒ½é»˜è®¤è®¾ç½®
```javascript
const SMART_DEFAULTS = {
  // æ ¹æ®ç”¨æˆ·è¡Œä¸ºè‡ªåŠ¨è°ƒæ•´æ˜¾ç¤ºåå¥½
  display_preferences: {
    frequent_checker: "ç®€æ´æ¨¡å¼ - å¿«é€Ÿä¿¡æ¯å±•ç¤º",
    detail_lover: "è¯¦ç»†æ¨¡å¼ - å®Œæ•´ä¿¡æ¯å±•ç¤º", 
    goal_oriented: "ç›®æ ‡æ¨¡å¼ - çªå‡ºä¸‹ä¸€æ­¥è¡ŒåŠ¨",
    social_user: "ç¤¾äº¤æ¨¡å¼ - çªå‡ºæŽ’è¡Œå’Œæ¯”è¾ƒ"
  },
  
  // è‡ªåŠ¨è®°å¿†ç”¨æˆ·ä¹ æƒ¯
  user_habits: {
    preferred_view_time: "è®°ä½ç”¨æˆ·å–œæ¬¢æŸ¥çœ‹ç­‰çº§çš„æ—¶é—´",
    favorite_features: "è®°ä½ç”¨æˆ·æœ€å¸¸ä½¿ç”¨çš„åŠŸèƒ½",
    interaction_style: "è®°ä½ç”¨æˆ·åå¥½çš„äº¤äº’æ–¹å¼"
  }
};
```

### 4. é›¶æ€è€ƒè´Ÿæ‹…è®¾è®¡

#### 4.1 ä¿¡æ¯ä¼˜å…ˆçº§æŽ’åº
```javascript
const INFORMATION_PRIORITY = {
  // æ ¹æ®ç´§æ€¥ç¨‹åº¦æŽ’åºæ˜¾ç¤ºä¿¡æ¯
  priority_levels: {
    urgent: [
      "å³å°†å‡çº§æé†’ï¼ˆ90%ä»¥ä¸Šè¿›åº¦ï¼‰",
      "å‹‹ç« è§£é”æé†’ï¼ˆå³å°†è¾¾æˆï¼‰", 
      "ç§¯åˆ†å¼‚å¸¸æé†’ï¼ˆå¤§é‡æ¶ˆè´¹ç­‰ï¼‰"
    ],
    important: [
      "å‡çº§è¿›åº¦ï¼ˆ50-90%ï¼‰",
      "ç§¯åˆ†çŠ¶æ€æ€»è§ˆ",
      "æœ¬å‘¨æ´»åŠ¨æ¦‚è¦"
    ],
    normal: [
      "è¯¦ç»†ç»Ÿè®¡æ•°æ®",
      "åŽ†å²è®°å½•",
      "æŽ’è¡Œæ¦œä¿¡æ¯"
    ],
    optional: [
      "ç³»ç»Ÿæç¤º",
      "åŠŸèƒ½ä»‹ç»",
      "å¸®åŠ©ä¿¡æ¯"
    ]
  }
};
```

#### 4.2 è‡ªåŠ¨åŒ–å»ºè®®ç³»ç»Ÿ
```javascript
const AUTO_SUGGESTIONS = {
  // åŸºäºŽæ•°æ®åˆ†æžçš„è‡ªåŠ¨å»ºè®®
  smart_recommendations: {
    optimization_tips: [
      "æ ¹æ®æ‚¨çš„æ´»è·ƒæ—¶é—´ï¼Œå»ºè®®åœ¨æ™šä¸Š8-10ç‚¹å®Œæˆè¯„ä»·",
      "æ‚¨çš„è¯¦ç»†è¯„ä»·æ¯”ä¾‹è¾ƒä½Žï¼Œå»ºè®®æé«˜ä»¥èŽ·å¾—æ›´å¤šç§¯åˆ†",
      "è·ç¦»ä¸‹ä¸ªå‹‹ç« å¾ˆè¿‘ï¼Œå»ºè®®é‡ç‚¹å…³æ³¨è´¨é‡è¯„ä»·"
    ],
    goal_suggestions: [
      "è®¾å®šçŸ­æœŸç›®æ ‡ï¼šæœ¬å‘¨å‡çº§åˆ°Lv.5",
      "è®¾å®šä¸­æœŸç›®æ ‡ï¼šæ”¶é›†3ä¸ªæ–°å‹‹ç« ", 
      "è®¾å®šé•¿æœŸç›®æ ‡ï¼šè¿›å…¥ç¾¤ç»„å‰10å"
    ],
    activity_reminders: [
      "ä»Šæ—¥è¿˜æœªå®Œæˆå‡ºå‡»ï¼Œå®Œæˆ1æ¬¡å³å¯èŽ·å¾—æ¯æ—¥å¥–åŠ±",
      "è¿žç»­æ´»è·ƒ3å¤©å¯èŽ·å¾—é¢å¤–ç§¯åˆ†å¥–åŠ±",
      "æœ¬å‘¨å‚ä¸Žåº¦è¾ƒä½Žï¼Œå»ºè®®å¢žåŠ æ´»è·ƒåº¦"
    ]
  }
};
```

### 5. å®žé™…æ›´æ–°éš¾åº¦è¯„ä¼°

#### 5.1 çŽ°æœ‰ç³»ç»Ÿå…¼å®¹æ€§
```javascript
const UPDATE_COMPLEXITY = {
  // éœ€è¦æ›´æ–°çš„ç»„ä»¶
  required_updates: {
    botService_js: {
      difficulty: "ç®€å•",
      changes: "æ·»åŠ æ™ºèƒ½å‘½ä»¤è¯†åˆ«é€»è¾‘",
      impact: "ä¸å½±å“çŽ°æœ‰åŠŸèƒ½",
      estimated_time: "2-3å°æ—¶"
    },
    
    levelService_js: {
      difficulty: "ä¸­ç­‰", 
      changes: "æ·»åŠ æ™ºèƒ½æç¤ºå’Œé¢„æµ‹åŠŸèƒ½",
      impact: "æ‰©å±•çŽ°æœ‰æœåŠ¡ï¼Œä¸ç ´ååŽŸæœ‰é€»è¾‘",
      estimated_time: "4-6å°æ—¶"
    },
    
    user_interface: {
      difficulty: "ç®€å•",
      changes: "ä¼˜åŒ–æ˜¾ç¤ºæ ¼å¼å’Œå†…è”æŒ‰é’®",
      impact: "çº¯å±•ç¤ºå±‚ä¼˜åŒ–",
      estimated_time: "2-3å°æ—¶"
    }
  },
  
  // æ— éœ€æ›´æ–°çš„éƒ¨åˆ†
  unchanged_components: [
    "EAVæ•°æ®ç»“æž„",
    "æ ¸å¿ƒç­‰çº§ç®—æ³•", 
    "ç§¯åˆ†è®¡ç®—é€»è¾‘",
    "æ•°æ®åº“è®¾è®¡",
    "ç®¡ç†å‘˜ç•Œé¢"
  ]
};
```

#### 5.2 æ¸è¿›å¼æ›´æ–°ç­–ç•¥
```javascript
const GRADUAL_UPDATE_PLAN = {
  // åˆ†é˜¶æ®µå®žæ–½
  phase_1: {
    focus: "æ™ºèƒ½å‘½ä»¤è¯†åˆ«",
    features: [
      "ç»Ÿä¸€æŸ¥è¯¢å…¥å£ï¼ˆ/æˆ‘çš„ï¼‰",
      "è‡ªç„¶è¯­è¨€ç†è§£",
      "åŸºç¡€æ™ºèƒ½æç¤º"
    ],
    risk: "æžä½Ž",
    rollback: "å®¹æ˜“"
  },
  
  phase_2: {
    focus: "æ˜¾ç¤ºä¼˜åŒ–",
    features: [
      "è¿›åº¦æ¡ç¾ŽåŒ–",
      "ä¿¡æ¯åˆ†çº§æ˜¾ç¤º", 
      "å†…è”æŒ‰é’®å¿«æ·æ“ä½œ"
    ],
    risk: "ä½Ž",
    rollback: "å®¹æ˜“"
  },
  
  phase_3: {
    focus: "æ™ºèƒ½åŒ–å¢žå¼º",
    features: [
      "é¢„æµ‹æ€§æç¤º",
      "ä¸ªæ€§åŒ–å»ºè®®",
      "è¡Œä¸ºæ¨¡å¼åˆ†æž"
    ],
    risk: "ä¸­",
    rollback: "éœ€è¦å‡†å¤‡"
  }
};
```

### 6. æ€»ç»“ï¼šæ›´æ–°éš¾åº¦ä¸Žä»·å€¼

#### 6.1 æ›´æ–°éš¾åº¦åˆ†æž
- **æŠ€æœ¯éš¾åº¦**ï¼šâ˜…â˜…â˜†â˜†â˜† ï¼ˆç®€å•åˆ°ä¸­ç­‰ï¼‰
- **å®žæ–½é£Žé™©**ï¼šâ˜…â˜†â˜†â˜†â˜† ï¼ˆæžä½Žé£Žé™©ï¼‰
- **å…¼å®¹æ€§å½±å“**ï¼šâ˜…â˜†â˜†â˜†â˜† ï¼ˆå‡ ä¹Žæ— å½±å“ï¼‰
- **å¼€å‘æ—¶é—´**ï¼š8-12å°æ—¶æ€»è®¡

#### 6.2 ç”¨æˆ·ä½“éªŒæå‡
- **æ“ä½œç®€åŒ–åº¦**ï¼šä»Ž3-4æ­¥æ“ä½œç®€åŒ–ä¸º1æ­¥
- **ä¿¡æ¯èŽ·å–æ•ˆçŽ‡**ï¼šæå‡300%ï¼ˆä¸€å±æ˜¾ç¤ºæ‰€æœ‰ä¿¡æ¯ï¼‰
- **è®¤çŸ¥è´Ÿæ‹…**ï¼šå‡å°‘80%ï¼ˆæ™ºèƒ½æç¤ºä»£æ›¿ç”¨æˆ·æ€è€ƒï¼‰
- **ä½¿ç”¨æ»¡æ„åº¦**ï¼šé¢„æœŸæå‡æ˜¾è‘—

#### 6.3 å®žæ–½å»ºè®®
1. **ä¼˜å…ˆçº§**ï¼šå…ˆå®žæ–½Phase 1ï¼ˆæ™ºèƒ½å‘½ä»¤è¯†åˆ«ï¼‰ï¼Œæ•ˆæžœæ˜Žæ˜¾ä¸”é£Žé™©æžä½Ž
2. **æµ‹è¯•ç­–ç•¥**ï¼šå°èŒƒå›´ç°åº¦æµ‹è¯•ï¼Œç¡®ä¿ç¨³å®šæ€§
3. **å›žé€€å‡†å¤‡**ï¼šä¿ç•™åŽŸæœ‰å‘½ä»¤ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
4. **ç”¨æˆ·åé¦ˆ**ï¼šåŠæ—¶æ”¶é›†ç”¨æˆ·ä½¿ç”¨åé¦ˆï¼Œå¿«é€Ÿè¿­ä»£ä¼˜åŒ–

**ç»“è®º**ï¼šè¿™äº›ä¼˜åŒ–æ›´æ–°å®žæ–½ç®€å•ï¼Œé£Žé™©æžä½Žï¼Œä½†èƒ½æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒã€‚å»ºè®®åˆ†é˜¶æ®µå®žæ–½ï¼Œä»Žæœ€ç®€å•çš„ç»Ÿä¸€æŸ¥è¯¢å…¥å£å¼€å§‹ã€‚

## ðŸš€ æ€§èƒ½è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ‰¹é‡æ“ä½œæ€§èƒ½ä¼˜åŒ–

#### 1.1 æ‰¹é‡ç”¨æˆ·æ•°æ®æŸ¥è¯¢ä¼˜åŒ–
```javascript
// å½“å‰å¯èƒ½çš„æ€§èƒ½ç“¶é¢ˆ
const CURRENT_PERFORMANCE_ISSUES = {
  single_user_queries: {
    problem: "é€ä¸ªæŸ¥è¯¢ç”¨æˆ·ç­‰çº§æ•°æ®",
    impact: "ç¾¤ç»„æŽ’è¡Œæ¦œæŸ¥è¯¢æ—¶æ€§èƒ½å·®",
    solution: "å®žçŽ°çœŸæ­£çš„æ‰¹é‡æŸ¥è¯¢"
  },
  
  redundant_calculations: {
    problem: "é‡å¤è®¡ç®—ç­‰çº§è¿›åº¦",
    impact: "CPUä½¿ç”¨çŽ‡é«˜",
    solution: "é¢„è®¡ç®—å’Œç¼“å­˜è®¡ç®—ç»“æžœ"
  },
  
  sync_operations: {
    problem: "åŒæ­¥æ‰§è¡Œè€—æ—¶æ“ä½œ",
    impact: "ç”¨æˆ·ä½“éªŒå·®",
    solution: "å¼‚æ­¥å¤„ç†éžå…³é”®è·¯å¾„"
  }
};

// ä¼˜åŒ–æ–¹æ¡ˆ
const BATCH_OPTIMIZATION = {
  // æ‰¹é‡EAVæŸ¥è¯¢ä¼˜åŒ–
  batch_eav_queries: {
    method: "getBatchEntities",
    optimization: `
    // åŽŸæ¥ï¼šNæ¬¡å•ç‹¬æŸ¥è¯¢
    for (const userId of userIds) {
      const userData = await eavOps.getEntity(\`user_\${groupId}_\${userId}\`, 'user_profile');
    }
    
    // ä¼˜åŒ–ï¼š1æ¬¡æ‰¹é‡æŸ¥è¯¢
    const entityKeys = userIds.map(id => \`user_\${groupId}_\${id}\`);
    const allUserData = await eavOps.getBatchEntities(entityKeys, 'user_profile');
    `,
    performance_gain: "æŸ¥è¯¢æ—¶é—´å‡å°‘80-90%"
  },
  
  // é¢„è®¡ç®—æŽ’è¡Œæ¦œ
  precomputed_rankings: {
    strategy: "å®šæ—¶é¢„è®¡ç®—çƒ­é—¨æ•°æ®",
    implementation: `
    // æ¯5åˆ†é’Ÿé¢„è®¡ç®—ä¸€æ¬¡æŽ’è¡Œæ¦œ
    setInterval(async () => {
      const levelRanking = await calculateLevelRanking();
      const pointsRanking = await calculatePointsRanking();
      await cache.setRankings(groupId, { level: levelRanking, points: pointsRanking });
    }, 5 * 60 * 1000);
    `,
    benefit: "æŽ’è¡Œæ¦œæŸ¥è¯¢ä»Žç§’çº§é™ä½Žåˆ°æ¯«ç§’çº§"
  }
};
```

#### 1.2 å†…å­˜ä½¿ç”¨ä¼˜åŒ–
```javascript
const MEMORY_OPTIMIZATION = {
  // æ™ºèƒ½ç¼“å­˜ç­–ç•¥
  smart_caching: {
    user_level_cache: {
      strategy: "LRUç¼“å­˜ï¼Œæœ€è¿‘ä½¿ç”¨çš„ç”¨æˆ·æ•°æ®ä¼˜å…ˆä¿ç•™",
      max_size: "1000ä¸ªç”¨æˆ·æ•°æ®",
      ttl: "5åˆ†é’Ÿ",
      memory_limit: "50MB"
    },
    
    ranking_cache: {
      strategy: "æŒ‰ç¾¤åˆ†ç»„ç¼“å­˜ï¼Œå†·æ•°æ®è‡ªåŠ¨æ¸…ç†",
      refresh_trigger: "æ•°æ®å˜æ›´æ—¶å±€éƒ¨åˆ·æ–°",
      compression: "JSONåŽ‹ç¼©å­˜å‚¨"
    }
  },
  
  // æ•°æ®ç»“æž„ä¼˜åŒ–
  data_structure_optimization: {
    lightweight_objects: "åªç¼“å­˜å¿…è¦å­—æ®µï¼Œå‡å°‘å†…å­˜å ç”¨",
    shared_references: "ç›¸åŒç­‰çº§é…ç½®å…±äº«å¼•ç”¨ï¼Œé¿å…é‡å¤å­˜å‚¨",
    lazy_loading: "æŒ‰éœ€åŠ è½½è¯¦ç»†æ•°æ®ï¼ŒåŸºç¡€æŸ¥è¯¢åªè¿”å›žæ ¸å¿ƒå­—æ®µ"
  }
};
```

### 2. æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

#### 2.1 ç´¢å¼•ç­–ç•¥å¢žå¼º
```sql
-- å½“å‰ç´¢å¼•åŸºç¡€ä¸Šçš„è¿›ä¸€æ­¥ä¼˜åŒ–
-- ç»„åˆç´¢å¼•ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_user_profile_composite 
ON eav_data_values(entity_key, field_id, value) 
WHERE schema_id = 1002;

-- ç­‰çº§æŽ’è¡Œä¸“ç”¨ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_level_ranking 
ON eav_data_values(value DESC, entity_key) 
WHERE field_id = 1103; -- levelå­—æ®µ

-- ç§¯åˆ†æŽ’è¡Œä¸“ç”¨ç´¢å¼•  
CREATE INDEX IF NOT EXISTS idx_points_ranking 
ON eav_data_values(value DESC, entity_key) 
WHERE field_id = 1105; -- available_pointså­—æ®µ

-- å‹‹ç« ç»Ÿè®¡ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_badge_stats 
ON eav_data_values(value, entity_key) 
WHERE field_id = 1112; -- badgeså­—æ®µ

-- æ—¶é—´èŒƒå›´æŸ¥è¯¢ç´¢å¼•ï¼ˆç”¨äºŽåŽ†å²è®°å½•ï¼‰
CREATE INDEX IF NOT EXISTS idx_reward_log_time_range 
ON eav_data_values(entity_key, value) 
WHERE schema_id = 1004 AND field_id = 1411; -- timestampå­—æ®µ
```

#### 2.2 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
```javascript
const QUERY_OPTIMIZATION = {
  // åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
  pagination_optimization: {
    cursor_based: "ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µæ›¿ä»£OFFSETï¼Œé¿å…å¤§åç§»é‡æ€§èƒ½é—®é¢˜",
    implementation: `
    // é¿å… LIMIT 1000, 50 è¿™ç§æŸ¥è¯¢
    // æ”¹ç”¨æ¸¸æ ‡åˆ†é¡µ
    const query = \`
      SELECT * FROM eav_data_values 
      WHERE entity_key > ? AND schema_id = ? 
      ORDER BY entity_key LIMIT 50
    \`;
    `
  },
  
  // èšåˆæŸ¥è¯¢ä¼˜åŒ–
  aggregation_optimization: {
    materialized_views: "ä¸ºç»Ÿè®¡æ•°æ®åˆ›å»ºç‰©åŒ–è§†å›¾",
    incremental_updates: "å¢žé‡æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼Œé¿å…å…¨é‡é‡ç®—"
  }
};
```

### 3. å¼‚æ­¥å¤„ç†ä¼˜åŒ–

#### 3.1 å…³é”®è·¯å¾„è¯†åˆ«
```javascript
const ASYNC_OPTIMIZATION = {
  // åŒºåˆ†å…³é”®è·¯å¾„å’Œéžå…³é”®è·¯å¾„
  critical_path: [
    "ç”¨æˆ·ç­‰çº§æŸ¥è¯¢ï¼ˆå¿…é¡»åŒæ­¥ï¼‰",
    "ç§¯åˆ†ä½™é¢æ£€æŸ¥ï¼ˆå¿…é¡»åŒæ­¥ï¼‰", 
    "å‡çº§æ¡ä»¶åˆ¤æ–­ï¼ˆå¿…é¡»åŒæ­¥ï¼‰"
  ],
  
  non_critical_path: [
    "åŽ†å²è®°å½•å†™å…¥ï¼ˆå¯å¼‚æ­¥ï¼‰",
    "ç»Ÿè®¡æ•°æ®æ›´æ–°ï¼ˆå¯å¼‚æ­¥ï¼‰",
    "å‹‹ç« æ£€æŸ¥ï¼ˆå¯å¼‚æ­¥ï¼‰",
    "ç¾¤å†…æ’­æŠ¥ï¼ˆå¯å¼‚æ­¥ï¼‰",
    "ç¼“å­˜é¢„çƒ­ï¼ˆå¯å¼‚æ­¥ï¼‰"
  ],
  
  // å¼‚æ­¥å¤„ç†å®žçŽ°
  async_implementation: `
  // åŒæ­¥å¤„ç†å…³é”®è·¯å¾„
  const userProfile = await levelService.getUserProfile(userId, groupId);
  const levelUpResult = await levelService.checkLevelUp(userProfile);
  
  // å¼‚æ­¥å¤„ç†éžå…³é”®è·¯å¾„
  setImmediate(async () => {
    await levelService.logRewardHistory(userId, action);
    await levelService.checkBadgeUnlock(userId, groupId);
    await broadcastService.sendUpgradeNotification(levelUpResult);
    await statisticsService.updateGroupStats(groupId);
  });
  `
};
```

### 4. ç½‘ç»œå’ŒI/Oä¼˜åŒ–

#### 4.1 è¿žæŽ¥æ± ä¼˜åŒ–
```javascript
const IO_OPTIMIZATION = {
  // æ•°æ®åº“è¿žæŽ¥æ± é…ç½®
  connection_pool: {
    min_connections: 5,
    max_connections: 20,
    idle_timeout: "30ç§’",
    connection_validation: "å®šæœŸæ£€æµ‹è¿žæŽ¥å¥åº·çŠ¶æ€"
  },
  
  // æ‰¹é‡å†™å…¥ä¼˜åŒ–
  batch_writes: {
    buffer_size: "100æ¡è®°å½•",
    flush_interval: "5ç§’",
    error_handling: "å•æ¡å¤±è´¥ä¸å½±å“å…¶ä»–è®°å½•"
  }
};
```

## ðŸ“¢ ç¾¤å†…æ’­æŠ¥ç³»ç»Ÿè®¾è®¡

### 1. æ’­æŠ¥ç³»ç»Ÿæž¶æž„

#### 1.1 æ’­æŠ¥äº‹ä»¶å®šä¹‰
```javascript
const BROADCAST_EVENTS = {
  // ç­‰çº§ç›¸å…³äº‹ä»¶
  level_events: {
    level_up: {
      event_code: "LEVEL_UP",
      description: "ç”¨æˆ·å‡çº§",
      default_enabled: true,
      variables: ["user_name", "old_level", "new_level", "level_name", "exp_gained"]
    },
    level_milestone: {
      event_code: "LEVEL_MILESTONE", 
      description: "è¾¾æˆç­‰çº§é‡Œç¨‹ç¢‘ï¼ˆå¦‚Lv.5ã€Lv.10ï¼‰",
      default_enabled: true,
      variables: ["user_name", "level", "level_name", "milestone_type"]
    }
  },
  
  // ç§¯åˆ†ç›¸å…³äº‹ä»¶
  points_events: {
    points_milestone: {
      event_code: "POINTS_MILESTONE",
      description: "ç§¯åˆ†è¾¾æˆé‡Œç¨‹ç¢‘",
      default_enabled: false,
      variables: ["user_name", "total_points", "milestone_value"]
    },
    points_consumed: {
      event_code: "POINTS_CONSUMED",
      description: "å¤§é¢ç§¯åˆ†æ¶ˆè´¹",
      default_enabled: false,
      variables: ["user_name", "points_spent", "remaining_points", "reason"]
    }
  },
  
  // å‹‹ç« ç›¸å…³äº‹ä»¶
  badge_events: {
    badge_unlock: {
      event_code: "BADGE_UNLOCK",
      description: "è§£é”æ–°å‹‹ç« ",
      default_enabled: true,
      variables: ["user_name", "badge_name", "badge_emoji", "badge_rarity"]
    },
    rare_badge_unlock: {
      event_code: "RARE_BADGE_UNLOCK", 
      description: "è§£é”ç¨€æœ‰/ä¼ è¯´å‹‹ç« ",
      default_enabled: true,
      variables: ["user_name", "badge_name", "badge_emoji", "badge_rarity"]
    }
  },
  
  // æˆå°±ç›¸å…³äº‹ä»¶
  achievement_events: {
    perfect_streak: {
      event_code: "PERFECT_STREAK",
      description: "è¿žç»­æ»¡åˆ†æˆå°±",
      default_enabled: true,
      variables: ["user_name", "streak_count", "streak_type"]
    },
    top_ranking: {
      event_code: "TOP_RANKING",
      description: "è¿›å…¥æŽ’è¡Œæ¦œå‰åˆ—",
      default_enabled: false,
      variables: ["user_name", "rank", "ranking_type"]
    }
  }
};
```

#### 1.2 æ’­æŠ¥æ¨¡æ¿ç³»ç»Ÿ
```javascript
const BROADCAST_TEMPLATE_SYSTEM = {
  // æ¨¡æ¿é…ç½®ç»“æž„
  template_structure: {
    group_id: "ç¾¤ç»„ID",
    event_code: "äº‹ä»¶ä»£ç ",
    template_content: "æ¨¡æ¿å†…å®¹ï¼ˆæ”¯æŒå˜é‡æ›¿æ¢ï¼‰",
    enabled: "æ˜¯å¦å¯ç”¨",
    conditions: "è§¦å‘æ¡ä»¶",
    timing: "æ’­æŠ¥æ—¶æœºé…ç½®",
    auto_delete: "è‡ªåŠ¨åˆ é™¤é…ç½®"
  },
  
  // é»˜è®¤æ¨¡æ¿ç¤ºä¾‹
  default_templates: {
    LEVEL_UP: {
      content: "ðŸŽ‰ æ­å–œ {{user_name}} å‡çº§äº†ï¼\nâ­ {{old_level}} â†’ {{new_level}} {{level_name}}\nðŸ’ª ç»§ç»­åŠ æ²¹ï¼Œå‹‡æ”€é«˜å³°ï¼",
      variables: {
        user_name: "ç”¨æˆ·æ˜¾ç¤ºåç§°",
        old_level: "åŽŸç­‰çº§æ•°å­—", 
        new_level: "æ–°ç­‰çº§æ•°å­—",
        level_name: "æ–°ç­‰çº§åç§°ï¼ˆå«emojiï¼‰",
        exp_gained: "æœ¬æ¬¡èŽ·å¾—ç»éªŒå€¼"
      }
    },
    
    BADGE_UNLOCK: {
      content: "ðŸ† {{user_name}} è§£é”äº†æ–°å‹‹ç« ï¼\n{{badge_emoji}} {{badge_name}} \nâœ¨ {{badge_rarity}}çº§å‹‹ç« ï¼Œå®žåŠ›è®¤è¯ï¼",
      variables: {
        user_name: "ç”¨æˆ·æ˜¾ç¤ºåç§°",
        badge_name: "å‹‹ç« åç§°",
        badge_emoji: "å‹‹ç« emoji", 
        badge_rarity: "å‹‹ç« ç¨€æœ‰åº¦"
      }
    },
    
    POINTS_MILESTONE: {
      content: "ðŸ’° {{user_name}} ç§¯åˆ†è¾¾æˆé‡Œç¨‹ç¢‘ï¼\nðŸŽ¯ æ€»ç§¯åˆ†çªç ´ {{milestone_value}} ç‚¹\nðŸ’Ž å½“å‰ç§¯åˆ†ï¼š{{total_points}} ç‚¹",
      variables: {
        user_name: "ç”¨æˆ·æ˜¾ç¤ºåç§°",
        total_points: "æ€»ç§¯åˆ†æ•°",
        milestone_value: "é‡Œç¨‹ç¢‘æ•°å€¼"
      }
    }
  }
};
```

### 2. ç®¡ç†å‘˜é…ç½®ç•Œé¢

#### 2.2 æ’­æŠ¥æ¨¡æ¿é…ç½®é¡µé¢
```html
<!-- åœ¨ç®¡ç†å‘˜ç•Œé¢æ·»åŠ æ’­æŠ¥é…ç½®æ ‡ç­¾é¡µ -->
<div id="broadcast" class="tab-content">
    <h2>ðŸ“¢ ç¾¤å†…æ’­æŠ¥é…ç½®</h2>
    
    <!-- ç¾¤é€‰æ‹© -->
    <div class="form-section">
        <label>é€‰æ‹©ç¾¤ç»„:</label>
        <select id="broadcastGroupSelect" onchange="loadGroupBroadcastConfig()">
            <option value="">è¯·é€‰æ‹©ç¾¤ç»„</option>
        </select>
    </div>
    
    <!-- æ’­æŠ¥äº‹ä»¶å¼€å…³ -->
    <div class="form-section">
        <h3>æ’­æŠ¥äº‹ä»¶å¼€å…³</h3>
        <div class="broadcast-events-grid">
            <div class="event-category">
                <h4>ðŸŽ¯ ç­‰çº§äº‹ä»¶</h4>
                <label><input type="checkbox" id="event_level_up"> ç”¨æˆ·å‡çº§æ’­æŠ¥</label>
                <label><input type="checkbox" id="event_level_milestone"> ç­‰çº§é‡Œç¨‹ç¢‘æ’­æŠ¥</label>
            </div>
            
            <div class="event-category">
                <h4>ðŸ’° ç§¯åˆ†äº‹ä»¶</h4>
                <label><input type="checkbox" id="event_points_milestone"> ç§¯åˆ†é‡Œç¨‹ç¢‘æ’­æŠ¥</label>
                <label><input type="checkbox" id="event_points_consumed"> å¤§é¢æ¶ˆè´¹æ’­æŠ¥</label>
            </div>
            
            <div class="event-category">
                <h4>ðŸ† å‹‹ç« äº‹ä»¶</h4>
                <label><input type="checkbox" id="event_badge_unlock"> å‹‹ç« è§£é”æ’­æŠ¥</label>
                <label><input type="checkbox" id="event_rare_badge"> ç¨€æœ‰å‹‹ç« ç‰¹åˆ«æ’­æŠ¥</label>
            </div>
        </div>
    </div>
    
    <!-- æ’­æŠ¥æ¨¡æ¿ç¼–è¾‘ -->
    <div class="form-section">
        <h3>æ’­æŠ¥æ¨¡æ¿ç¼–è¾‘</h3>
        <div class="template-editor">
            <div class="template-selector">
                <label>é€‰æ‹©äº‹ä»¶ç±»åž‹:</label>
                <select id="templateEventSelect" onchange="loadTemplate()">
                    <option value="LEVEL_UP">ç”¨æˆ·å‡çº§</option>
                    <option value="BADGE_UNLOCK">å‹‹ç« è§£é”</option>
                    <option value="POINTS_MILESTONE">ç§¯åˆ†é‡Œç¨‹ç¢‘</option>
                </select>
            </div>
            
            <div class="template-content">
                <label>æ¨¡æ¿å†…å®¹:</label>
                <textarea id="templateContent" rows="8" placeholder="è¾“å…¥æ’­æŠ¥æ¨¡æ¿å†…å®¹ï¼Œæ”¯æŒå˜é‡å’Œemoji"></textarea>
                
                <!-- å¯ç”¨å˜é‡æç¤º -->
                <div class="available-variables">
                    <h4>å¯ç”¨å˜é‡ï¼ˆç‚¹å‡»æ’å…¥ï¼‰:</h4>
                    <div id="variableButtons">
                        <!-- åŠ¨æ€ç”Ÿæˆå˜é‡æŒ‰é’® -->
                    </div>
                </div>
                
                <!-- æ¨¡æ¿é¢„è§ˆ -->
                <div class="template-preview">
                    <h4>é¢„è§ˆæ•ˆæžœ:</h4>
                    <div id="previewContent" class="preview-box">
                        <!-- å®žæ—¶é¢„è§ˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ’­æŠ¥æ¡ä»¶è®¾ç½® -->
    <div class="form-section">
        <h3>æ’­æŠ¥æ¡ä»¶è®¾ç½®</h3>
        <div class="condition-settings">
            <div class="condition-item">
                <label>ç§¯åˆ†é‡Œç¨‹ç¢‘æ•°å€¼:</label>
                <input type="text" id="pointsMilestones" placeholder="å¦‚ï¼š100,500,1000,5000" value="100,500,1000,5000">
                <small>é€—å·åˆ†éš”å¤šä¸ªæ•°å€¼</small>
            </div>
            
            <div class="condition-item">
                <label>å¤§é¢æ¶ˆè´¹é˜ˆå€¼:</label>
                <input type="number" id="largeSpendingThreshold" value="200">
                <small>å•æ¬¡æ¶ˆè´¹è¶…è¿‡æ­¤æ•°å€¼æ—¶æ’­æŠ¥</small>
            </div>
            
            <div class="condition-item">
                <label>æŽ’è¡Œæ¦œæ’­æŠ¥æ¡ä»¶:</label>
                <select id="rankingBroadcastCondition">
                    <option value="top3">è¿›å…¥å‰3å</option>
                    <option value="top5">è¿›å…¥å‰5å</option>
                    <option value="top10">è¿›å…¥å‰10å</option>
                    <option value="disabled">ç¦ç”¨æŽ’è¡Œæ¦œæ’­æŠ¥</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- æ—¶é—´è®¾ç½® -->
    <div class="form-section">
        <h3>æ—¶é—´è®¾ç½®</h3>
        <div class="timing-settings">
            <div class="timing-item">
                <label>æ’­æŠ¥å»¶è¿Ÿ:</label>
                <select id="broadcastDelay">
                    <option value="0">ç«‹å³æ’­æŠ¥</option>
                    <option value="30">30ç§’åŽæ’­æŠ¥</option>
                    <option value="60">1åˆ†é’ŸåŽæ’­æŠ¥</option>
                    <option value="300">5åˆ†é’ŸåŽæ’­æŠ¥</option>
                </select>
                <small>å¯ä»¥é¿å…é¢‘ç¹æ’­æŠ¥</small>
            </div>
            
            <div class="timing-item">
                <label>è‡ªåŠ¨åˆ é™¤æ—¶é—´:</label>
                <select id="autoDeleteTime">
                    <option value="0">ä¸è‡ªåŠ¨åˆ é™¤</option>
                    <option value="300">5åˆ†é’ŸåŽåˆ é™¤</option>
                    <option value="600">10åˆ†é’ŸåŽåˆ é™¤</option>
                    <option value="1800">30åˆ†é’ŸåŽåˆ é™¤</option>
                    <option value="3600">1å°æ—¶åŽåˆ é™¤</option>
                </select>
                <small>ä¿æŒç¾¤èŠæ•´æ´</small>
            </div>
            
            <div class="timing-item">
                <label>æ’­æŠ¥æ—¶é—´é™åˆ¶:</label>
                <input type="time" id="broadcastStartTime" value="08:00">
                <span>åˆ°</span>
                <input type="time" id="broadcastEndTime" value="23:00">
                <small>ä»…åœ¨æŒ‡å®šæ—¶é—´æ®µå†…æ’­æŠ¥</small>
            </div>
        </div>
    </div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="form-section">
        <button onclick="saveBroadcastConfig()">ðŸ’¾ ä¿å­˜æ’­æŠ¥é…ç½®</button>
        <button onclick="testBroadcast()">ðŸ§ª æµ‹è¯•æ’­æŠ¥</button>
        <button onclick="resetBroadcastConfig()">ðŸ”„ é‡ç½®ä¸ºé»˜è®¤</button>
    </div>
</div>
```

### 3. æ’­æŠ¥ç³»ç»ŸæŠ€æœ¯å®žçŽ°

#### 3.1 æ’­æŠ¥æœåŠ¡æ ¸å¿ƒä»£ç 
```javascript
class BroadcastService {
  constructor() {
    this.bot = require('./botService');
    this.templateEngine = new TemplateEngine();
    this.broadcastQueue = new BroadcastQueue();
  }
  
  // ä¸»è¦æ’­æŠ¥æ–¹æ³•
  async broadcastEvent(groupId, eventCode, variables, conditions = {}) {
    try {
      // æ£€æŸ¥æ’­æŠ¥æ˜¯å¦å¯ç”¨
      const config = await this.getBroadcastConfig(groupId);
      if (!config.events[eventCode]?.enabled) {
        return { success: false, reason: 'event_disabled' };
      }
      
      // æ£€æŸ¥æ¡ä»¶æ˜¯å¦æ»¡è¶³
      if (!this.checkConditions(eventCode, variables, conditions)) {
        return { success: false, reason: 'conditions_not_met' };
      }
      
      // æ£€æŸ¥æ—¶é—´é™åˆ¶
      if (!this.isWithinTimeLimit(config.timing)) {
        return { success: false, reason: 'outside_time_limit' };
      }
      
      // æ¸²æŸ“æ¨¡æ¿
      const template = config.templates[eventCode];
      const message = this.templateEngine.render(template.content, variables);
      
      // åŠ å…¥æ’­æŠ¥é˜Ÿåˆ—ï¼ˆæ”¯æŒå»¶è¿Ÿæ’­æŠ¥ï¼‰
      const broadcastTask = {
        groupId,
        message,
        delay: config.timing.delay || 0,
        autoDelete: config.timing.autoDelete || 0
      };
      
      await this.broadcastQueue.enqueue(broadcastTask);
      
      return { success: true };
      
    } catch (error) {
      console.error('æ’­æŠ¥å¤±è´¥:', error);
      return { success: false, reason: 'broadcast_error', error };
    }
  }
  
  // æ¡ä»¶æ£€æŸ¥
  checkConditions(eventCode, variables, conditions) {
    switch (eventCode) {
      case 'POINTS_MILESTONE':
        const milestones = conditions.pointsMilestones || [100, 500, 1000, 5000];
        return milestones.includes(variables.milestone_value);
        
      case 'POINTS_CONSUMED':
        const threshold = conditions.largeSpendingThreshold || 200;
        return variables.points_spent >= threshold;
        
      case 'TOP_RANKING':
        const rankLimit = conditions.rankingBroadcastCondition || 'top3';
        const maxRank = rankLimit === 'top3' ? 3 : rankLimit === 'top5' ? 5 : 10;
        return variables.rank <= maxRank;
        
      default:
        return true; // é»˜è®¤æ¡ä»¶é€šè¿‡
    }
  }
  
  // æ—¶é—´é™åˆ¶æ£€æŸ¥
  isWithinTimeLimit(timing) {
    if (!timing.startTime || !timing.endTime) return true;
    
    const now = new Date();
    const currentTime = now.getHours() * 100 + now.getMinutes();
    const startTime = this.parseTime(timing.startTime);
    const endTime = this.parseTime(timing.endTime);
    
    return currentTime >= startTime && currentTime <= endTime;
  }
}

// æ¨¡æ¿å¼•æ“Ž
class TemplateEngine {
  render(template, variables) {
    let result = template;
    
    // æ›¿æ¢å˜é‡
    for (const [key, value] of Object.entries(variables)) {
      const regex = new RegExp(`{{\\s*${key}\\s*}}`, 'g');
      result = result.replace(regex, value || '');
    }
    
    return result;
  }
}

// æ’­æŠ¥é˜Ÿåˆ—ï¼ˆæ”¯æŒå»¶è¿Ÿå’Œæ‰¹é‡å¤„ç†ï¼‰
class BroadcastQueue {
  constructor() {
    this.queue = [];
    this.processing = false;
    this.processInterval = 1000; // æ¯ç§’å¤„ç†ä¸€æ¬¡é˜Ÿåˆ—
    
    setInterval(() => this.processQueue(), this.processInterval);
  }
  
  async enqueue(task) {
    task.scheduledTime = Date.now() + (task.delay * 1000);
    this.queue.push(task);
  }
  
  async processQueue() {
    if (this.processing || this.queue.length === 0) return;
    
    this.processing = true;
    const now = Date.now();
    
    // å¤„ç†åˆ°æœŸçš„ä»»åŠ¡
    const readyTasks = this.queue.filter(task => task.scheduledTime <= now);
    this.queue = this.queue.filter(task => task.scheduledTime > now);
    
    for (const task of readyTasks) {
      await this.executeBroadcast(task);
    }
    
    this.processing = false;
  }
  
  async executeBroadcast(task) {
    try {
      const result = await bot.sendMessage(task.groupId, task.message, {
        parse_mode: 'Markdown'
      });
      
      // è®¾ç½®è‡ªåŠ¨åˆ é™¤
      if (task.autoDelete > 0) {
        setTimeout(async () => {
          try {
            await bot.deleteMessage(task.groupId, result.message_id);
          } catch (error) {
            console.error('è‡ªåŠ¨åˆ é™¤æ’­æŠ¥æ¶ˆæ¯å¤±è´¥:', error);
          }
        }, task.autoDelete * 1000);
      }
      
    } catch (error) {
      console.error('æ‰§è¡Œæ’­æŠ¥å¤±è´¥:', error);
    }
  }
}
```

#### 3.2 ä¸Žç­‰çº§ç³»ç»Ÿé›†æˆ
```javascript
// åœ¨levelService.jsä¸­é›†æˆæ’­æŠ¥
class LevelService {
  constructor() {
    // ... çŽ°æœ‰ä»£ç 
    this.broadcastService = new BroadcastService();
  }
  
  async processEvaluationReward(userId, groupId, evaluationId, actionType) {
    // ... çŽ°æœ‰é€»è¾‘
    
    // æ£€æŸ¥å‡çº§å¹¶æ’­æŠ¥
    const levelUpResult = await this.checkLevelUp(userId, groupId);
    if (levelUpResult.leveledUp) {
      await this.broadcastService.broadcastEvent(groupId, 'LEVEL_UP', {
        user_name: levelUpResult.userDisplayName,
        old_level: levelUpResult.oldLevel,
        new_level: levelUpResult.newLevel,
        level_name: levelUpResult.newLevelName,
        exp_gained: levelUpResult.expGained
      });
    }
    
    // æ£€æŸ¥å‹‹ç« è§£é”å¹¶æ’­æŠ¥
    const badgeResult = await this.badgeService.checkBadgeUnlock(userId, groupId);
    if (badgeResult.unlockedBadges?.length > 0) {
      for (const badge of badgeResult.unlockedBadges) {
        await this.broadcastService.broadcastEvent(groupId, 'BADGE_UNLOCK', {
          user_name: badgeResult.userDisplayName,
          badge_name: badge.name,
          badge_emoji: badge.emoji,
          badge_rarity: badge.rarity
        });
      }
    }
    
    // æ£€æŸ¥ç§¯åˆ†é‡Œç¨‹ç¢‘
    await this.checkPointsMilestone(userId, groupId, pointsAfter);
  }
  
  async checkPointsMilestone(userId, groupId, currentPoints) {
    const config = await this.broadcastService.getBroadcastConfig(groupId);
    const milestones = config.conditions?.pointsMilestones || [100, 500, 1000, 5000];
    
    for (const milestone of milestones) {
      if (currentPoints >= milestone && !await this.hasReachedMilestone(userId, milestone)) {
        await this.markMilestoneReached(userId, milestone);
        
        const userProfile = await this.getUserProfile(userId, groupId);
        await this.broadcastService.broadcastEvent(groupId, 'POINTS_MILESTONE', {
          user_name: userProfile.display_name,
          total_points: currentPoints,
          milestone_value: milestone
        });
        
        break; // ä¸€æ¬¡åªæ’­æŠ¥ä¸€ä¸ªé‡Œç¨‹ç¢‘
      }
    }
  }
}
```

### 4. æ€§èƒ½ä¼˜åŒ–æ€»ç»“

#### 4.1 æ•´ä½“æ€§èƒ½æå‡é¢„æœŸ
```javascript
const PERFORMANCE_IMPROVEMENTS = {
  query_performance: {
    batch_queries: "æ‰¹é‡æŸ¥è¯¢æ€§èƒ½æå‡80-90%",
    index_optimization: "å¤æ‚æŸ¥è¯¢æ€§èƒ½æå‡50-70%", 
    caching_strategy: "çƒ­ç‚¹æ•°æ®è®¿é—®æå‡95%"
  },
  
  memory_usage: {
    smart_caching: "å†…å­˜ä½¿ç”¨æ•ˆçŽ‡æå‡40%",
    data_compression: "ç¼“å­˜ç©ºé—´èŠ‚çœ30%",
    garbage_collection: "GCåŽ‹åŠ›å‡å°‘60%"
  },
  
  response_time: {
    async_processing: "ç”¨æˆ·æ„ŸçŸ¥å“åº”æ—¶é—´æå‡70%",
    precomputed_data: "æŽ’è¡Œæ¦œæŸ¥è¯¢ä»Žç§’çº§åˆ°æ¯«ç§’çº§",
    connection_pooling: "æ•°æ®åº“è¿žæŽ¥æ•ˆçŽ‡æå‡50%"
  },
  
  scalability: {
    concurrent_users: "æ”¯æŒå¹¶å‘ç”¨æˆ·æ•°æå‡3å€",
    group_scalability: "æ”¯æŒç¾¤ç»„æ•°é‡æå‡5å€", 
    data_volume: "æ”¯æŒæ•°æ®é‡æå‡10å€"
  }
};
```

#### 4.2 æ’­æŠ¥ç³»ç»Ÿæ€§èƒ½è€ƒè™‘
```javascript
const BROADCAST_PERFORMANCE = {
  queue_management: {
    benefit: "é¿å…æ’­æŠ¥é£Žæš´ï¼Œä¿æŠ¤Telegram APIé™åˆ¶",
    implementation: "æ™ºèƒ½é˜Ÿåˆ—è°ƒåº¦ï¼Œé™åˆ¶æ¯åˆ†é’Ÿæ’­æŠ¥é¢‘çŽ‡"
  },
  
  template_caching: {
    benefit: "æ¨¡æ¿æ¸²æŸ“æ€§èƒ½æå‡90%",
    implementation: "é¢„ç¼–è¯‘æ¨¡æ¿ï¼Œå˜é‡æ›¿æ¢ä¼˜åŒ–"
  },
  
  async_broadcasting: {
    benefit: "ä¸é˜»å¡žä¸»ä¸šåŠ¡æµç¨‹",
    implementation: "ç‹¬ç«‹æ’­æŠ¥æœåŠ¡ï¼Œå¼‚æ­¥å¤„ç†"
  }
};
```

è¿™äº›ä¼˜åŒ–å»ºè®®å°†æ˜¾è‘—æå‡ç³»ç»Ÿæ€§èƒ½ï¼ŒåŒæ—¶æ–°å¢žçš„ç¾¤å†…æ’­æŠ¥ç³»ç»Ÿä¸ºç”¨æˆ·æä¾›äº†æ›´å¥½çš„ç¤¾äº¤ä½“éªŒå’Œæˆå°±æ„Ÿã€‚